#in game shops/stores

#define FIND_ABSOLUTE_VALUE PATH
    {VARIABLE i ${PATH}.damage}
    {VARIABLE_OP i multiply ${PATH}.number}
    {VARIABLE {PATH}.absolute_value 0}
    [while]
        [variable]
            name=i
            greater_than=0
        [/variable]
        [do]
            {VARIABLE temp_value $i}
            {VARIABLE_OP temp_value multiply .35}
            {VARIABLE_OP {PATH}.absolute_value add $i}
            {VARIABLE_OP i add -1}
        [/do]
    [/while]
    [if]
        [variable]
            name={PATH}.category
            equals=ranged_weapon
        [/variable]
        [then]
            {VARIABLE_OP {PATH}.absolute_value multiply 1.25}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.human_magic_adjust
            greater_than=0
        [/variable]
        [then]
            {VARIABLE temp_magic_value ${PATH}.human_magic_adjust}
            {VARIABLE_OP temp_magic_value multiply 2}
            {VARIABLE_OP {PATH}.absolute_value add $temp_magic_value}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.dark_magic_adjust
            greater_than=0
        [/variable]
        [then]
            {VARIABLE temp_magic_value ${PATH}.dark_magic_adjust}
            {VARIABLE_OP temp_magic_value multiply 2}
            {VARIABLE_OP {PATH}.absolute_value add $temp_magic_value}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.faerie_magic_adjust
            greater_than=0
        [/variable]
        [then]
            {VARIABLE temp_magic_value ${PATH}.faerie_magic_adjust}
            {VARIABLE_OP temp_magic_value multiply 2}
            {VARIABLE_OP {PATH}.absolute_value add $temp_magic_value}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.runic_magic_adjust
            greater_than=0
        [/variable]
        [then]
            {VARIABLE temp_magic_value ${PATH}.runic_magic_adjust}
            {VARIABLE_OP temp_magic_value multiply 2}
            {VARIABLE_OP {PATH}.absolute_value add $temp_magic_value}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.absolute_value
            less_than=1
        [/variable]
        [then]
            {VARIABLE {PATH}.absolute_value 2}
        [/then]
    [/if]
#enddef

#define CREATE_WEAPON_INSERT_TO_SHOP
    {VARIABLE_OP new_weapon rand "dagger,club,sword,scimitar,saber,mace,hammer,spear,axe,sling,thrown dagger,javelin,bow,crossbow,magestaff,necrostaff,runic_hammer,faerie_staff"}
    [switch]
        variable=new_weapon
        [case]
            value=dagger
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="dagger"
                    user_name="dagger"
                    description=_ "dagger"
                    icon="dagger-human"
                    ground_icon="dagger"
                    range="melee"
                    type="blade"
                    class="light_blade"
                    class_description="Light Blade"
                    damage=3
                    number=2
					body_damage_rate=5
                    deft_damage_rate=25
                    [special_type]
                        backstab=1
                        skirm=1
                    [/special_type]
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=club
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="mace"
                    user_name="club"
                    description=_ "club"
                    icon="club-small"
                    ground_icon="club"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=2
                    number=2
					body_damage_rate=20
                    deft_damage_rate=10
                    material="wood"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=sword
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="sword"
                    user_name="sword"
                    description=_ "sword"
                    icon="sword-human"
                    ground_icon="sword"
                    range="melee"
                    type="blade"
                    class="heavy_blade"
                    class_description="Heavy Blade"
                    damage=5
                    number=2
					body_damage_rate=15
                    deft_damage_rate=15
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
		 [case]
            value=sword
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="sword"
                    user_name="sword"
                    description=_ "scimitar"
                    icon="sword-elven"
                    ground_icon="sword"
                    range="melee"
                    type="blade"
                    class="heavy_blade"
                    class_description="Heavy Blade"
                    damage=5
                    number=2
					body_damage_rate=10
                    deft_damage_rate=20
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=saber
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="sword"
                    user_name="saber"
                    description=_ "saber"
                    icon="saber-human"
                    ground_icon="saber"
                    range="melee"
                    type="blade"
                    class="light_blade"
                    class_description="Light Blade"
                    damage=3
                    number=3
					body_damage_rate=5
                    deft_damage_rate=25
                    [special_type]
                        skirm=1
                    [/special_type]
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=mace
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="mace"
                    user_name="mace"
                    description=_ "mace"
                    icon="mace"
                    ground_icon="mace"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=7
                    number=1
					body_damage_rate=30
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
		[case]
            value=hammer
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="mace"
                    user_name="hammer"
                    description=_ "hammer"
                    icon="hammer-dwarven"
                    ground_icon="hammer-runic"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=7
                    number=1
					body_damage_rate=30
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
		[case]
            value=runic_hammer
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="mace"
                    user_name="hammer"
                    description=_ "runic hammer"
                    icon="hammer-dwarven-runic"
                    ground_icon="hammer-runic"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=5
                    number=1
					body_damage_rate=30
                    material="metal"
					runic_magic_adjust=20
                [/value]
            [/set_variables]
        [/case]
		[case]
            value=faerie_staff
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="magestaff"
                    user_name="magestaff"
                    description=_ "faerie staff"
                    icon="staff-elven"
                    ground_icon="magestaff"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=5
                    number=1
					body_damage_rate=20
                    deft_damage_rate=10
                    faerie_magic_adjust=15
                    material="wood"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=spear
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="spear"
                    user_name="spear"
                    description=_ "spear"
                    icon="spear"
                    ground_icon="spear-fancy"
                    range="melee"
                    type="pierce"
                    class="polearm"
                    class_description="Polearm"
                    damage=5
                    number=2
					body_damage_rate=20
                    deft_damage_rate=10
                    [special_type]
                        throwable=1
                        firststrike=1
                    [/special_type]
                    material="metal"
                    [thrown]
                        name="lob"
                        user_name="spear_thrown"
                        description=_ "thrown spear"
                        icon="javelin-human"
                        range="ranged"
                        type="pierce"
                        class="javelin"
                        class_description="Javelin"
                        damage=5
                        number=1
						body_damage_rate=20
						deft_damage_rate=10
                    [/thrown]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=axe
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="axe"
                    user_name="axe"
                    description=_ "axe"
                    icon="axe"
                    ground_icon="axe"
                    range="melee"
                    type="blade"
                    class="heavy_blade"
                    class_description="Heavy Blade"
                    damage=7
                    number=1
					body_damage_rate=25
                    deft_damage_rate=5
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=sling
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="sling"
                    user_name="sling"
                    description=_ "sling"
                    icon="sling"
                    ground_icon="sling"
                    range="ranged"
                    type="impact"
                    class="lob"
                    class_description="lob"
                    damage=3
                    number=1
					body_damage_rate=20
                    deft_damage_rate=10
                    material="cloth"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=thrown dagger
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="lob"
                    user_name="dagger_thrown"
                    description=_ "thrown dagger"
                    icon="dagger-thrown-human"
                    ground_icon="dagger"
                    range="ranged"
                    type="blade"
                    class="thrown_light_blade"
                    class_description="Thrown Light Blade"
                    damage=2
                    number=2
                    [special_type]
                        allow_poison=1
                    [/special_type]
					body_damage_rate=10
                    deft_damage_rate=20
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=javelin
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="lob"
                    user_name="javelin"
                    description=_ "javelin"
                    icon="javelin-human"
                    ground_icon="spear-fancy"
                    range="ranged"
                    type="pierce"
                    class="javelin"
                    class_description="Javelin"
                    damage=7
                    number=1
					body_damage_rate=20
                    deft_damage_rate=10
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=bow
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="bow"
                    user_name="bow"
                    description=_ "bow"
                    icon="bow"
                    ground_icon="bow"
                    range="ranged"
                    type="pierce"
                    class="bow"
                    class_description="Bow"
                    damage=4
                    number=2
                    deft_damage_rate=30
                    [special_type]
                        marksman=1
                    [/special_type]
                    material="wood"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=crossbow
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="crossbow"
                    user_name="crossbow"
                    description=_ "crossbow"
                    icon="crossbow-human"
                    ground_icon="crossbow"
                    range="ranged"
                    type="pierce"
                    class="crossbow"
                    class_description="Crossbow"
                    damage=10
                    number=1
                    deft_damage_rate=20
                    material="wood"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=magestaff
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="magestaff"
                    user_name="magestaff"
                    description=_ "magestaff"
                    icon="staff-magic"
                    ground_icon="magestaff"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=5
                    number=1
					body_damage_rate=20
                    deft_damage_rate=10
                    human_magic_adjust=20
                    material="wood"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=necrostaff
            [set_variables]
                name=a_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="necrostaff"
                    user_name="necrostaff"
                    description=_ "necromancer staff"
                    icon="staff-necromantic"
                    ground_icon="magestaff"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=5
                    number=1
					body_damage_rate=20
                    deft_damage_rate=10
                    dark_magic_adjust=15
                    [special_type]
                        plague=1
                    [/special_type]
                    material="wood"
                [/value]
            [/set_variables]
        [/case]
		#need to add other magic staves
    [/switch]
    [if]
        [variable]
            name=a_weapon.category
            equals=melee_weapon
        [/variable]
        [or]
            [variable]
                name=a_weapon.category
                equals=ranged_weapon
            [/variable]
        [/or]
        [then]
            [if]
                [variable]
                    name=dungeon_level.cleared
                    less_than=2
                [/variable]
                [then]
                    {VARIABLE_OP new_weapon_attribute rand "rusty,unbalanced,none,none,none"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=dungeon_level.cleared
                    less_than=4
                [/variable]
                [not]
                    [variable]
                        name=dungeon_level.cleared
                        less_than=2
                    [/variable]
                [/not]
                [then]
                    {VARIABLE_OP new_weapon_attribute rand "heavy,light,none,none,none"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=dungeon_level.cleared
                    less_than=6
                [/variable]
                [not]
                    [variable]
                        name=dungeon_level.cleared
                        less_than=4
                    [/variable]
                [/not]
                [then]
                    {VARIABLE_OP new_weapon_attribute rand "heavy,light,balanced,sharp,none,none,none"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=dungeon_level.cleared
                    greater_than_equal_to=6
                [/variable]
                [then]
                    {VARIABLE_OP new_weapon_attribute rand "heavy,light,balanced,sharp,none,none"}
                [/then]
            [/if]

            {VARIABLE weapon_user_name_temp "$a_weapon.description|"}

            [switch]
                variable=new_weapon_attribute
                [case]
                    value=heavy
                    {VARIABLE a_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
                    {VARIABLE_OP a_weapon.damage multiply 1.7}
                    {VARIABLE_OP a_weapon.number add -1}
                    [if]
                        [variable]
                            name=a_weapon.special_type.throwable
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP a_weapon.thrown.damage multiply 1.7}
                            {VARIABLE_OP a_weapon.thrown.number add -1}
                            [if]
                                [variable]
                                    name=a_weapon.number
                                    less_than=1
                                [/variable]
                                [then]
                                    {VARIABLE a_weapon.thrown.number 1}
                                [/then]
                            [/if]
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=a_weapon.number
                            less_than=1
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.number 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=bow
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "long$weapon_user_name_temp|"}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=light
                    {VARIABLE a_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
                    {VARIABLE_OP a_weapon.damage multiply .5}
                    {VARIABLE_OP a_weapon.number add 1}
                    [if]
                        [variable]
                            name=a_weapon.special_type.throwable
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP a_weapon.thrown.damage multiply .5}
                            {VARIABLE_OP a_weapon.thrown.number add 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=sword
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "short $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=rusty
                    {VARIABLE a_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
                    {VARIABLE_OP a_weapon.damage multiply .5}
                    {VARIABLE_OP a_weapon.human_magic_adjust multiply .5}
                    {VARIABLE_OP a_weapon.dark_magic_adjust multiply .5}
					{VARIABLE_OP a_weapon.faerie_magic_adjust multiply .5}
                    {VARIABLE_OP a_weapon.runic_magic_adjust multiply .5}
                    [if]
                        [variable]
                            name=a_weapon.special_type.throwable
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP a_weapon.thrown.damage multiply .5}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=club
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "rotten $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=bow
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "cracked $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=crossbow
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "cracked $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=sling
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "worn $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=magestaff
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "rotten $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=necrostaff
                        [/variable]
						[or]
							[variable]
	                            name=new_weapon
	                            equals=faerie_staff
	                        [/variable]
						[/or]
                        [then]
                            {VARIABLE a_weapon.description "rotten $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=sharp
                    {VARIABLE a_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
                    {VARIABLE_OP a_weapon.damage multiply 1.5}
                    {VARIABLE_OP a_weapon.human_magic_adjust multiply 1.5}
                    {VARIABLE_OP a_weapon.dark_magic_adjust multiply 1.5}
					{VARIABLE_OP a_weapon.faerie_magic_adjust multiply 1.5}
					{VARIABLE_OP a_weapon.runic_magic_adjust multiply 1.5}					
                    [if]
                        [variable]
                            name=a_weapon.special_type.throwable
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP a_weapon.thrown.damage multiply 1.5}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=club
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "crafted $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=bow
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "recurve $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=crossbow
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "recurve $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=sling
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "woven $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=magestaff
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "ebony $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=necrostaff
                        [/variable]
						[or]
							[variable]
	                            name=new_weapon
	                            equals=faerie_staff
	                        [/variable]
						[/or]
                        [then]
                            {VARIABLE a_weapon.description "ebony $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=balanced
                    {VARIABLE a_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
                    {VARIABLE_OP a_weapon.number add 1}
                    [if]
                        [variable]
                            name=a_weapon.special_type.throwable
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP a_weapon.thrown.number add 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=bow
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "flexible $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=crossbow
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "geared $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=sling
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "knotted $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=unbalanced
                    {VARIABLE a_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
                    {VARIABLE_OP a_weapon.number add -1}
                    [if]
                        [variable]
                            name=a_weapon.special_type.throwable
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP a_weapon.thrown.number add -1}
                            [if]
                                [variable]
                                    name=a_weapon.thrown.number
                                    less_than=1
                                [/variable]
                                [then]
                                    {VARIABLE a_weapon.thrown.number 1}
                                [/then]
                            [/if]
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=a_weapon.number
                            less_than=1
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.number 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=bow
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "rigid $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=crossbow
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "rigid $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_weapon
                            equals=sling
                        [/variable]
                        [then]
                            {VARIABLE a_weapon.description "loose $weapon_user_name_temp|"}
                        [/then]
                    [/if]
                [/case]
            [/switch]
            #find the absolute value of the weapon
            {FIND_ABSOLUTE_VALUE a_weapon}
        [/then]
    [/if]
    {APPLY_WEAPON_SPECIAL_DESCRIPTION a_weapon}
    [if]
        [variable]
            name=a_weapon.category
            equals=melee_weapon
        [/variable]
        [then]
            [set_variables]
                name=smithy_shop.weapons.melee
                mode=append
                [insert_tag]
                    name=value
                    variable=a_weapon
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
    [if]
        [variable]
            name=a_weapon.category
            equals=ranged_weapon
        [/variable]
        [then]
            [set_variables]
                name=smithy_shop.weapons.ranged
                mode=append
                [insert_tag]
                    name=value
                    variable=a_weapon
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
#enddef

#define CREATE_ARMOR_INSERT_TO_SHOP
    {VARIABLE_OP new_armor rand "studded leather,leather cap,leather leggings,iron plate,iron greaves,iron helm,mage robe,tempered plate,scale mail,mail greaves,full helm,round shield,tower shield"}
    [switch]
        variable=new_armor
        [case]
            value="studded leather"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
                    category="torso_armor"
                    name="studded_leather"
                    description=_ "studded leather"
                    icon="studded-leather"
                    ground_icon="armor"
                    sprite_image="leather"
                    mov_adjust=-1
                    magic_adjust=-20
                    evade_adjust=-40
                    material=leather
                    [restricts]
                        head=0
                        arms=0
                        legs=0
                        shield=0
                    [/restricts]
                    [resistance]
                        arcane=0
                        blade=15
                        fire=0
                        cold=0
                        impact=5
                        pierce=10
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=5
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=5
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=5
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=5
                            movement=0
                        [/flat]
                        [forest]
                            defense=5
                            movement=0
                        [/forest]
                        [hills]
                            defense=5
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=5
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=5
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=5
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="leather leggings"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
                    category="legs_armor"
                    name="leather_leggings"
                    description=_ "leather leggings"
                    icon="shoes"
                    ground_icon="boots"
                    mov_adjust=0
                    magic_adjust=0
                    evade_adjust=-20
                    material=leather
                    [resistance]
                        arcane=0
                        blade=10
                        fire=0
                        cold=0
                        impact=0
                        pierce=10
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=5
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=5
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=5
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=5
                            movement=0
                        [/flat]
                        [forest]
                            defense=5
                            movement=0
                        [/forest]
                        [hills]
                            defense=5
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=5
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=5
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=5
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="leather cap"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
                    category="head_armor"
                    name="leather_cap"
                    description=_ "leather cap"
                    icon="metal-helm"
                    ground_icon="cap"
                    ranged_adjust=0
                    evade_adjust=-10
                    material=leather
                    [resistance]
                        arcane=0
                        blade=5
                        fire=0
                        cold=0
                        impact=15
                        pierce=0
                    [/resistance]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="iron plate"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
                    category="torso_armor"
                    name="iron_plate"
                    description=_ "iron plate"
                    icon="armour"
                    ground_icon="armor"
                    sprite_image="metal"
                    mov_adjust=-1
                    magic_adjust=-40
                    evade_adjust=-60
                    material=metal
                    [restricts]
                        head=0
                        arms=0
                        legs=0
                        shield=0
                    [/restricts]
                    [resistance]
                        arcane=0
                        blade=40
                        fire=-10
                        cold=-10
                        impact=15
                        pierce=35
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=10
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=15
                            movement=0
                        [/castle]
                        [village]
                            defense=10
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=10
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=10
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=15
                            movement=0
                        [/flat]
                        [forest]
                            defense=10
                            movement=0
                        [/forest]
                        [hills]
                            defense=15
                            movement=0
                        [/hills]
                        [mountains]
                            defense=15
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=15
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=0
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=10
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="iron greaves"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
                    category="legs_armor"
                    name="iron_greaves"
                    description=_ "iron greaves"
                    icon="greaves"
                    ground_icon="greaves"
                    mov_adjust=-1
                    magic_adjust=-10
                    evade_adjust=-40
                    material=metal
                    [resistance]
                        arcane=0
                        blade=25
                        fire=0
                        cold=0
                        impact=5
                        pierce=15
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=10
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=15
                            movement=0
                        [/castle]
                        [village]
                            defense=10
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=10
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=10
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=15
                            movement=0
                        [/flat]
                        [forest]
                            defense=10
                            movement=0
                        [/forest]
                        [hills]
                            defense=15
                            movement=0
                        [/hills]
                        [mountains]
                            defense=10
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=10
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=0
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=10
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="iron helm"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
                    category="head_armor"
                    name="iron_helm"
                    description=_ "iron helm"
                    icon="metal-helm"
                    ground_icon="helmet"
                    ranged_adjust=-30
                    evade_adjust=-20
                    material=metal
                    [resistance]
                        arcane=0
                        blade=15
                        fire=0
                        cold=0
                        impact=10
                        pierce=10
                    [/resistance]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="scale mail"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
                    category="torso_armor"
                    name="scale_mail"
                    description=_ "scale mail"
                    icon="armour"
                    ground_icon="armor"
                    sprite_image="metal"
                    mov_adjust=-1
                    magic_adjust=-20
                    evade_adjust=-40
                    material=metal
                    [restricts]
                        head=0
                        arms=0
                        legs=0
                        shield=0
                    [/restricts]
                    [resistance]
                        arcane=0
                        blade=25
                        fire=0
                        cold=0
                        impact=10
                        pierce=15
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=5
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=5
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=5
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=5
                            movement=0
                        [/flat]
                        [forest]
                            defense=5
                            movement=0
                        [/forest]
                        [hills]
                            defense=5
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=5
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=5
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=5
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="mail greaves"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
                    category="legs_armor"
                    name="mail_greaves"
                    description=_ "mail greaves"
                    icon="greaves"
                    ground_icon="greaves"
                    mov_adjust=0
                    magic_adjust=-10
                    evade_adjust=-30
                    material=metal
                    [resistance]
                        arcane=0
                        blade=20
                        fire=0
                        cold=0
                        impact=0
                        pierce=10
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=5
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=5
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=5
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=5
                            movement=0
                        [/flat]
                        [forest]
                            defense=5
                            movement=0
                        [/forest]
                        [hills]
                            defense=5
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=5
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=5
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=5
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="full helm"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
                    category="head_armor"
                    name="full_helm"
                    description=_ "full helm"
                    icon="metal-helm"
                    ground_icon="helmet"
                    ranged_adjust=-10
                    evade_adjust=-20
                    material=metal
                    [resistance]
                        arcane=0
                        blade=5
                        fire=0
                        cold=0
                        impact=25
                        pierce=0
                    [/resistance]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="tempered plate"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
                    category="torso_armor"
                    name="tempered_plate"
                    description=_ "tempered plate"
                    icon="plate-tempered"
                    ground_icon="armor"
                    sprite_image="metal"
                    mov_adjust=-1
                    magic_adjust=-40
                    evade_adjust=-60
                    material=metal
                    [restricts]
                        head=0
                        arms=0
                        legs=0
                        shield=0
                    [/restricts]
                    [resistance]
                        arcane=0
                        blade=15
                        fire=0
                        cold=0
                        impact=50
                        pierce=5
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=5
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=5
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=5
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=5
                            movement=0
                        [/flat]
                        [forest]
                            defense=5
                            movement=0
                        [/forest]
                        [hills]
                            defense=5
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=5
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=5
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=5
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="mage robe"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
                    category="torso_armor"
                    name="mage_robe"
                    description=_ "mage robe"
                    icon="cloak"
                    ground_icon="robe"
                    sprite_image="wizrobe"
                    mov_adjust=-1
                    magic_adjust=0
                    evade_adjust=-80
                    material=cloth
                    [restricts]
                        head=1
                        arms=0
                        legs=1
                        shield=0
                    [/restricts]
                    [resistance]
                        arcane=0
                        blade=30
                        fire=0
                        cold=0
                        impact=20
                        pierce=20
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=10
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=10
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=10
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=10
                            movement=0
                        [/flat]
                        [forest]
                            defense=10
                            movement=0
                        [/forest]
                        [hills]
                            defense=10
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=10
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=10
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=10
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
		[case]
			value="round shield"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
					category="shield"
					name="shield_round"
					description=_ "round shield"
					icon="rectangular-shield"
					ground_icon="buckler"
					magic_adjust=-60
					material=metal
					evade_adjust=-50
					terrain_recoup=40
					ranged_adjust=-10
					block_wield=1
					block_ranged=0
				[/value]
            [/set_variables]
		[/case]
		[case]
			value="tower shield"
            [set_variables]
                name=an_armor
                mode=replace
                [value]
					category="shield"
					name="shield_tower"
					description=_ "tower shield"
					icon="rectangular-shield"
					ground_icon="buckler"
					magic_adjust=-80
					material=metal
					evade_adjust=-100
					terrain_recoup=80
					ranged_adjust=-20
					block_wield=2
					block_ranged=1
					[special_type]
						steadfast=1
					[/special_type]
				[/value]
            [/set_variables]
		[/case]
    [/switch]
	 [if]
        [variable]
            name=an_armor.category
            equals=shield
        [/variable]
		[then]
            {VARIABLE_OP new_armor_attribute rand "thick,light,polished,rusty,new,battered,none,none,none,none,none,none"}
			{VARIABLE armor_user_name_temp "$an_armor.description|"}
            [switch]
                variable=new_armor_attribute
                [case]
					value=thick
					{VARIABLE an_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=an_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.magic_adjust multiply 1.25}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.evade_adjust multiply 1.25}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.terrain_recoup multiply 1.25}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.ranged_adjust multiply 1.25}
                        [/then]
                    [/if]
				[/case]
				[case]
					value=light
					{VARIABLE an_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=an_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.magic_adjust multiply .8}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.evade_adjust multiply .8}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.terrain_recoup multiply .8}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.ranged_adjust multiply .8}
                        [/then]
                    [/if]
				[/case]
				[case]
					value=polished
					{VARIABLE an_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=an_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.magic_adjust multiply .8}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.evade_adjust multiply .8}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.terrain_recoup multiply 1}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.ranged_adjust multiply .8}
                        [/then]
                    [/if]
				[/case]
				[case]
					value=rusty
					{VARIABLE an_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=an_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.magic_adjust multiply .8}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.evade_adjust multiply .8}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.terrain_recoup multiply .8}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.ranged_adjust multiply .8}
                        [/then]
                    [/if]
				[/case]
				[case]
					value=new
					{VARIABLE an_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=an_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.magic_adjust multiply 1}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.evade_adjust multiply 1}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.terrain_recoup multiply 1.25}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.ranged_adjust multiply 1}
                        [/then]
                    [/if]
				[/case]
				[case]
					value=battered
					{VARIABLE an_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=an_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.magic_adjust multiply 1}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.evade_adjust multiply 1}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.terrain_recoup multiply .8}
                        [/then]
                    [/if]
					[if]
                        [variable]
                            name=an_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.ranged_adjust multiply 1}
                        [/then]
                    [/if]
				[/case]
			[/switch]
			#find the absolute value of the armor
		    {VARIABLE an_armor.absolute_value 0}
		    {VARIABLE i $an_armor.terrain_recoup}
			{VARIABLE_OP i multiply 2}
		    {VARIABLE temp_value $an_armor.magic_adjust}
		    {VARIABLE_OP temp_value multiply .2}
		    {VARIABLE_OP i add $temp_value}
		    {VARIABLE temp_value $an_armor.evade_adjust}
		    {VARIABLE_OP temp_value multiply .2}
		    {VARIABLE_OP i add $temp_value}
			{VARIABLE temp_value $an_armor.ranged_adjust}
		    {VARIABLE_OP temp_value multiply .2}
		    {VARIABLE_OP i add $temp_value}
			{VARIABLE an_armor.absolute_value $i}
			{SHIELD_SPECIAL_DISPLAY "an_armor"}
		[/then]
	[/if]
    [if]
        [variable]
            name=an_armor.category
            equals=torso_armor
        [/variable]
        [or]
            [variable]
                name=an_armor.category
                equals=head_armor
            [/variable]
            [or]
                [variable]
                    name=an_armor.category
                    equals=legs_armor
                [/variable]
            [/or]
        [/or]
        [then]
            {VARIABLE_OP new_armor_attribute rand "thick,light,polished,rusty,new,battered,none,none,none,none,none,none"}

            {VARIABLE weapon_user_name_temp "$an_armor.description|"}
            [switch]
                variable=new_armor_attribute
                [case]
                    value=thick
                    [if]
                        [variable]
                            name=an_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.magic_adjust multiply 1.25}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=an_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.evade_adjust multiply 1.25}
                        [/then]
                    [/if]
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "arcane" "1.2"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "blade" "1.2"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "pierce" "1.2"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "impact" "1.2"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "fire" "1.2"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "cold" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "unwalkable" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "castle" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "village" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "shallow_water" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "deep_water" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "flat" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "forest" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "hills" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "mountains" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "swamp_water" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "sand" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "cave" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "impassable" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "frozen" "1.2"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "fungus" "1.2"}
                    {VARIABLE an_armor.description "thick $weapon_user_name_temp|"}
                [/case]
                [case]
                    value=light
                    [if]
                        [variable]
                            name=an_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.magic_adjust multiply .75}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=an_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.evade_adjust multiply .75}
                        [/then]
                    [/if]
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "arcane" ".8"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "blade" ".8"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "pierce" ".8"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "impact" ".8"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "fire" ".8"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "cold" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "unwalkable" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "castle" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "village" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "shallow_water" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "deep_water" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "flat" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "forest" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "hills" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "mountains" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "swamp_water" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "sand" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "cave" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "impassable" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "frozen" ".8"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "fungus" ".8"}
                    [if]
                        [variable]
                            name=an_armor.material
                            equals=cloth
                        [/variable]
                        [then]
                            {VARIABLE an_armor.description "thin $weapon_user_name_temp|"}
                        [/then]
                        [else]
                            {VARIABLE an_armor.description "light $weapon_user_name_temp|"}
                        [/else]
                    [/if]
                [/case]
                [case]
                    value=polished
                    [if]
                        [variable]
                            name=an_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.magic_adjust multiply .6}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=an_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.evade_adjust multiply .6}
                        [/then]
                    [/if]
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "unwalkable" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "castle" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "village" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "shallow_water" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "deep_water" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "flat" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "forest" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "hills" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "mountains" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "swamp_water" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "sand" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "cave" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "impassable" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "frozen" ".6"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "fungus" ".6"}
                    [switch]
                        variable=an_armor.material
                        [case]
                            value=leather
                            {VARIABLE an_armor.description "oiled $weapon_user_name_temp|"}
                        [/case]
                        [case]
                            value=cloth
                            {VARIABLE an_armor.description "fine $weapon_user_name_temp|"}
                        [/case]
                        [else]
                            {VARIABLE an_armor.description "polished $weapon_user_name_temp|"}
                        [/else]
                    [/switch]
                [/case]
                [case]
                    value=rusty
                    [if]
                        [variable]
                            name=an_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.magic_adjust multiply 1.5}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=an_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP an_armor.evade_adjust multiply 1.5}
                        [/then]
                    [/if]
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "unwalkable" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "castle" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "village" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "shallow_water" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "deep_water" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "flat" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "forest" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "hills" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "mountains" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "swamp_water" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "sand" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "cave" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "impassable" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "frozen" "1.3"}
                    {CREATE_ADJUST_DEFENSE_ONE "an_armor" "fungus" "1.3"}
                    [switch]
                        variable=an_armor.material
                        [case]
                            value=leather
                            {VARIABLE an_armor.description "stiff $weapon_user_name_temp|"}
                        [/case]
                        [case]
                            value=cloth
                            {VARIABLE an_armor.description "stiff $weapon_user_name_temp|"}
                        [/case]
                        [else]
                            {VARIABLE an_armor.description "rusty $weapon_user_name_temp|"}
                        [/else]
                    [/switch]
                [/case]
                [case]
                    value=new
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "arcane" "1.2"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "blade" "1.2"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "pierce" "1.2"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "impact" "1.2"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "fire" "1.2"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "cold" "1.2"}
                    {VARIABLE an_armor.description "$new_armor_attribute| $weapon_user_name_temp|"}
                [/case]
                [case]
                    value=battered
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "arcane" ".8"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "blade" ".8"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "pierce" ".8"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "impact" ".8"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "fire" ".8"}
                    {CREATE_ADJUST_RESISTANCE_ONE "an_armor" "cold" ".8"}
                    [switch]
                        variable=an_armor.material
                        [case]
                            value=leather
                            {VARIABLE an_armor.description "worn $weapon_user_name_temp|"}
                        [/case]
                        [case]
                            value=cloth
                            {VARIABLE an_armor.description "tattered $weapon_user_name_temp|"}
                        [/case]
                        [else]
                            {VARIABLE an_armor.description "$new_armor_attribute| $weapon_user_name_temp|"}
                        [/else]
                    [/switch]
                [/case]
            [/switch]
			#find the absolute value of the armor
		    {VARIABLE an_armor.absolute_value 0}
		    {VARIABLE i $an_armor.resistance.arcane}
		    {VARIABLE_OP i add $an_armor.resistance.blade}
		    {VARIABLE_OP i add $an_armor.resistance.fire}
		    {VARIABLE_OP i add $an_armor.resistance.cold}
		    {VARIABLE_OP i add $an_armor.resistance.impact}
		    {VARIABLE_OP i add $an_armor.resistance.pierce}
		    #needs to flip to negative once that's fixed
		    {VARIABLE temp_value $an_armor.magic_adjust}
		    {VARIABLE_OP temp_value multiply .2}
		    {VARIABLE_OP i add $temp_value}
		    {VARIABLE temp_value $an_armor.evade_adjust}
		    {VARIABLE_OP temp_value multiply .2}
		    {VARIABLE_OP i add $temp_value}
		    {VARIABLE_OP i add -$an_armor.terrain.flat.defense}
		    [while]
		        [variable]
		            name=i
		            greater_than=0
		        [/variable]
		        [do]
		            {VARIABLE_OP an_armor.absolute_value add $i}
		            {VARIABLE_OP i add -1}
		        [/do]
		    [/while]
		    {VARIABLE_OP an_armor.absolute_value multiply .1}
        [/then]
    [/if]

    

    [if]
        [variable]
            name=an_armor.category
            equals=torso_armor
        [/variable]
        [then]
            [set_variables]
                name=smithy_shop.armor.torso
                mode=append
                [insert_tag]
                    name=value
                    variable=an_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
    [if]
        [variable]
            name=an_armor.category
            equals=legs_armor
        [/variable]
        [then]
            [set_variables]
                name=smithy_shop.armor.legs
                mode=append
                [insert_tag]
                    name=value
                    variable=an_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
    [if]
        [variable]
            name=an_armor.category
            equals=head_armor
        [/variable]
        [then]
            [set_variables]
                name=smithy_shop.armor.head
                mode=append
                [insert_tag]
                    name=value
                    variable=an_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
	 [if]
        [variable]
            name=an_armor.category
            equals=shield
        [/variable]
        [then]
            [set_variables]
                name=smithy_shop.armor.shield
                mode=append
                [insert_tag]
                    name=value
                    variable=an_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]

#enddef

#define WESBAND_SMITH_SHOP
    [set_menu_item]
        id=wesband_smith_shop_$inc_menu
        description=_ "Enter shop"
        [filter_location]
            x,y=12,8
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE in_shop 1}
            [while]
                [variable]
                    name=in_shop
                    greater_than=0
                [/variable]
                [do]
                    {CLEAR_VARIABLE shop_item_insert_melee}
                    {FOREACH smithy_shop.weapons.melee i}
						{VARIABLE path "smithy_shop.weapons.melee[$i]"}
                        [fire_event]
							name=weapon_modifiers
						[/fire_event]
                        [set_variables]
                            name=shop_item_insert_melee
                            mode=append
                            [value]
                                message="&"+attacks/$smithy_shop.weapons.melee[$i].icon|.png+"="+_ "$smithy_shop.weapons.melee[$i].description|
`Base: ($smithy_shop.weapons.melee[$i].damage|-$smithy_shop.weapons.melee[$i].number|), Adjusted: ($display_damage|-$display_number|) $smithy_shop.weapons.melee[$i].type|
``$smithy_shop.weapons.melee[$i].special|"="$smithy_shop.weapons.melee[$i].absolute_value"	
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$smithy_shop.weapons.melee[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                            [/message]
                                        [/then]
                                        [else]
                                            {VARIABLE_OP current_unit.personal_gold add -$smithy_shop.weapons.melee[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.inventory.weapons.melee
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=smithy_shop.weapons.melee[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "smithy_shop.weapons.melee[$i]"}
											[modify_side]
												side=$current_unit.side
												gold=$current_unit.personal_gold
											[/modify_side]
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}

                    {CLEAR_VARIABLE shop_item_insert_ranged}
                    {FOREACH smithy_shop.weapons.ranged i}
                        {VARIABLE path "smithy_shop.weapons.ranged[$i]"}
                        [fire_event]
							name=weapon_modifiers
						[/fire_event]
                        [set_variables]
                            name=shop_item_insert_ranged
                            mode=append
                            [value]
                                message="&"+attacks/$smithy_shop.weapons.ranged[$i].icon|.png+"="+_ "$smithy_shop.weapons.ranged[$i].description|
`Base: ($smithy_shop.weapons.ranged[$i].damage|-$smithy_shop.weapons.ranged[$i].number|), Adjusted: ($display_damage|-$display_number|) $smithy_shop.weapons.ranged[$i].type|
``$smithy_shop.weapons.ranged[$i].special|"="$smithy_shop.weapons.ranged[$i].absolute_value"		
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$smithy_shop.weapons.ranged[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                            [/message]
                                        [/then]
                                        [else]
                                            {VARIABLE_OP current_unit.personal_gold add -$smithy_shop.weapons.ranged[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.inventory.weapons.ranged
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=smithy_shop.weapons.ranged[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "smithy_shop.weapons.ranged[$i]"}
											[modify_side]
												side=$current_unit.side
												gold=$current_unit.personal_gold
											[/modify_side]
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}

                    {CLEAR_VARIABLE shop_item_insert_torso}
                    {FOREACH smithy_shop.armor.torso i}
                        [set_variables]
                            name=shop_item_insert_torso
                            mode=append
                            [value]
                                message ="&"+armor/$smithy_shop.armor.torso[$i].icon|.png+"="+_ "$smithy_shop.armor.torso[$i].description|
``$smithy_shop.armor.torso[$i].resistance.arcane|% arcane, $smithy_shop.armor.torso[$i].resistance.blade|% blade, $smithy_shop.armor.torso[$i].resistance.fire|% fire, $smithy_shop.armor.torso[$i].resistance.cold|% cold, $smithy_shop.armor.torso[$i].resistance.impact|% impact, $smithy_shop.armor.torso[$i].resistance.pierce|% pierce
``$smithy_shop.armor.torso[$i].mov_adjust| MP, $smithy_shop.armor.torso[$i].magic_adjust|% magic adj, $smithy_shop.armor.torso[$i].evade_adjust|% evade adj, $smithy_shop.armor.torso[$i].terrain.flat.defense|% def adj"="$smithy_shop.armor.torso[$i].absolute_value"		
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$smithy_shop.armor.torso[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                            [/message]
                                        [/then]
                                        [else]
                                            {VARIABLE_OP current_unit.personal_gold add -$smithy_shop.armor.torso[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.inventory.armor.torso
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=smithy_shop.armor.torso[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "smithy_shop.armor.torso[$i]"}
											[modify_side]
												side=$current_unit.side
												gold=$current_unit.personal_gold
											[/modify_side]
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}

                    {CLEAR_VARIABLE shop_item_insert_legs}
                    {FOREACH smithy_shop.armor.legs i}
                        [set_variables]
                            name=shop_item_insert_legs
                            mode=append
                            [value]
                                message ="&"+armor/$smithy_shop.armor.legs[$i].icon|.png+"="+_ "$smithy_shop.armor.legs[$i].description|
``$smithy_shop.armor.legs[$i].resistance.arcane|% arcane, $smithy_shop.armor.legs[$i].resistance.blade|% blade, $smithy_shop.armor.legs[$i].resistance.fire|% fire, $smithy_shop.armor.legs[$i].resistance.cold|% cold, $smithy_shop.armor.legs[$i].resistance.impact|% impact, $smithy_shop.armor.legs[$i].resistance.pierce|% pierce
``$smithy_shop.armor.legs[$i].mov_adjust| MP, $smithy_shop.armor.legs[$i].magic_adjust|% magic adj, $smithy_shop.armor.legs[$i].evade_adjust|% evade adj, $smithy_shop.armor.legs[$i].terrain.flat.defense|% def adj"="$smithy_shop.armor.legs[$i].absolute_value"									
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$smithy_shop.armor.legs[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                            [/message]
                                        [/then]
                                        [else]
                                            {VARIABLE_OP current_unit.personal_gold add -$smithy_shop.armor.legs[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.inventory.armor.legs
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=smithy_shop.armor.legs[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "smithy_shop.armor.legs[$i]"}
											[modify_side]
												side=$current_unit.side
												gold=$current_unit.personal_gold
											[/modify_side]
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}

                    {CLEAR_VARIABLE shop_item_insert_head}
                    {FOREACH smithy_shop.armor.head i}
                        [set_variables]
                            name=shop_item_insert_head
                            mode=append
                            [value]
                                message ="&"+armor/$smithy_shop.armor.head[$i].icon|.png+"="+_ "$smithy_shop.armor.head[$i].description|
``$smithy_shop.armor.head[$i].resistance.arcane|% arcane, $smithy_shop.armor.head[$i].resistance.blade|% blade, $smithy_shop.armor.head[$i].resistance.fire|% fire, $smithy_shop.armor.head[$i].resistance.cold|% cold, $smithy_shop.armor.head[$i].resistance.impact|% impact, $smithy_shop.armor.head[$i].resistance.pierce|% pierce
``$smithy_shop.armor.head[$i].evade_adjust|% evade adj, $smithy_shop.armor.head[$i].ranged_adjust|% ranged adj"="$smithy_shop.armor.head[$i].absolute_value"									
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$smithy_shop.armor.head[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                            [/message]
                                        [/then]
                                        [else]
                                            {VARIABLE_OP current_unit.personal_gold add -$smithy_shop.armor.head[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.inventory.armor.head
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=smithy_shop.armor.head[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "smithy_shop.armor.head[$i]"}
											[modify_side]
												side=$current_unit.side
												gold=$current_unit.personal_gold
											[/modify_side]
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					
					{CLEAR_VARIABLE shop_item_insert_shield}
                    {FOREACH smithy_shop.armor.shield i}
                        [set_variables]
                            name=shop_item_insert_shield
                            mode=append
                            [value]
                                 message ="&"+armor/$smithy_shop.armor.shield[$i].icon|.png+"="+_ "$smithy_shop.armor.shield[$i].description|
``$smithy_shop.armor.shield[$i].evade_adjust|% evade adjust, $smithy_shop.armor.shield[$i].terrain_recoup|% terrain adjust, $smithy_shop.armor.shield[$i].ranged_adjust|% ranged adj, $smithy_shop.armor.shield[$i].magic_adjust|% magic adj
``$smithy_shop.armor.shield[$i].special"="$smithy_shop.armor.shield[$i].absolute_value"									
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$smithy_shop.armor.shield[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                            [/message]
                                        [/then]
                                        [else]
                                            {VARIABLE_OP current_unit.personal_gold add -$smithy_shop.armor.shield[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.inventory.armor.shield
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=smithy_shop.armor.shield[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "smithy_shop.armor.shield[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}

                    #{VARIABLE creation_gold $current_unit.personal_gold} want to be side gold to personal_golde
                    [message]
                        speaker=narrator
                        message= _ "Welcome to the Wesband smithy. Be sure to check back later, as I frequently get new stock.

`You have $current_unit.personal_gold| gold to spend. Which item will you buy? "
                        [option]
                            message ="&"+check.png+"="End purchase."="+_ "_____"
                            [command]
                                [unstore_unit]
                                    variable=current_unit
                                [/unstore_unit]
                                [modify_side]
                                    side=$current_unit.side
                                    gold=$current_unit.personal_gold
                                [/modify_side]
                                {VARIABLE in_shop 0}
                            [/command]
                        [/option]
                        [option]
                            message ="&"+check.png+"="Sell to store."="+_ "_____"
                            [command]
                                {VARIABLE in_shop 2}
                                [while]
                                    [variable]
                                        name=in_shop
                                        greater_than=1
                                    [/variable]
                                    [do]
                                        {CLEAR_VARIABLE sell_item_insert}
                                        {FOREACH current_unit.inventory.weapons.melee i}
                                            [if]
                                                [variable]
                                                    name=current_unit.inventory.weapons.equiped.id
                                                    equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.inventory.weapons.equiped[1].id
                                                        equals=$i
                                                    [/variable]
                                                    [or]
                                                        [variable]
                                                            name=current_unit.inventory.weapons.equiped[2].id
                                                            equals=$i
                                                        [/variable]
                                                        [or]
                                                            [variable]
                                                                name=current_unit.inventory.weapons.melee[$i].undropable
                                                                equals=1
                                                            [/variable]
                                                        [/or]
                                                    [/or]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.inventory.weapons.melee[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .5}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+attacks/$current_unit.inventory.weapons.melee[$i].icon|.png+"="+_ "$current_unit.inventory.weapons.melee[$i].description|
`Base: $current_unit.inventory.weapons.melee[$i].damage|-$current_unit.inventory.weapons.melee[$i].number| $current_unit.inventory.weapons.melee[$i].type|
``$current_unit.inventory.weapons.melee[$i].special|"="$temp_value"		
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=smithy_shop.items
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.inventory.weapons.melee[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.inventory.weapons.melee[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=i
                                                                        less_than=$current_unit.inventory.weapons.equiped.id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.inventory.weapons.equiped.id add -1}
                                                                    [/then]
                                                                [/if]
                                                                [if]
                                                                    [variable]
                                                                        name=i
                                                                        less_than=$current_unit.inventory.weapons.equiped[1].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.inventory.weapons.equiped[1].id add -1}
                                                                    [/then]
                                                                [/if]
                                                                [if]
                                                                    [variable]
                                                                        name=i
                                                                        less_than=$current_unit.inventory.weapons.equiped[2].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.inventory.weapons.equiped[2].id add -1}
                                                                    [/then]
                                                                [/if]
																[modify_side]
	                                                                side=$current_unit.side
	                                                                gold=$current_unit.personal_gold
	                                                            [/modify_side]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.inventory.weapons.ranged i}
                                            [if]
                                                [variable]
                                                    name=current_unit.inventory.weapons.equiped[5].id
                                                    equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.inventory.weapons.melee[$i].undropable
                                                        equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.inventory.weapons.ranged[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .5}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+attacks/$current_unit.inventory.weapons.ranged[$i].icon|.png+"="+_ "$current_unit.inventory.weapons.ranged[$i].description|
`Base: $current_unit.inventory.weapons.ranged[$i].damage|-$current_unit.inventory.weapons.ranged[$i].number| $current_unit.inventory.weapons.ranged[$i].type|
``$current_unit.inventory.weapons.ranged[$i].special|"="$temp_value"		
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=smithy_shop.items
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.inventory.weapons.ranged[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.inventory.weapons.ranged[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=i
                                                                        less_than=$current_unit.inventory.weapons.equiped[5].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.inventory.weapons.equiped[5].id add -1}
                                                                    [/then]
                                                                [/if]
																[modify_side]
	                                                                side=$current_unit.side
	                                                                gold=$current_unit.personal_gold
	                                                            [/modify_side]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.inventory.armor.torso i}
                                            [if]
                                                [variable]
                                                    name=current_unit.inventory.armor.equiped.id
                                                    equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.inventory.armor.torso[$i].undropable
                                                        equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.inventory.armor.torso[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .5}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+armor/$current_unit.inventory.armor.torso[$i].icon|.png+"="+_ "$current_unit.inventory.armor.torso[$i].description|
``$current_unit.inventory.armor.torso[$i].resistance.arcane|% arcane, $current_unit.inventory.armor.torso[$i].resistance.blade|% blade, $current_unit.inventory.armor.torso[$i].resistance.fire|% fire, $current_unit.inventory.armor.torso[$i].resistance.cold|% cold, $current_unit.inventory.armor.torso[$i].resistance.fire|% fire, $current_unit.inventory.armor.torso[$i].resistance.impact|% impact, $current_unit.inventory.armor.torso[$i].resistance.pierce|% pierce
``$current_unit.inventory.armor.torso[$i].mov_adjust| MP, $current_unit.inventory.armor.torso[$i].magic_adjust|% magic adj, $current_unit.inventory.armor.torso[$i].evade_adjust|% evade adj, $current_unit.inventory.armor.torso[$i].terrain.flat.defense|% def adj"="$temp_value"	
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=smithy_shop.items
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.inventory.armor.torso[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.inventory.armor.torso[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=i
                                                                        less_than=$current_unit.inventory.armor.equiped.id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.inventory.armor.equiped.id add -1}
                                                                    [/then]
                                                                [/if]
																[modify_side]
	                                                                side=$current_unit.side
	                                                                gold=$current_unit.personal_gold
	                                                            [/modify_side]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.inventory.armor.head i}
                                            [if]
                                                [variable]
                                                    name=current_unit.inventory.armor.equiped[1].id
                                                    equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.inventory.armor.head[$i].undropable
                                                        equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.inventory.armor.head[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .5}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+armor/$current_unit.inventory.armor.head[$i].icon|.png+"="+_ "$current_unit.inventory.armor.head[$i].description|
``$current_unit.inventory.armor.head[$i].resistance.arcane|% arcane, $current_unit.inventory.armor.head[$i].resistance.blade|% blade, $current_unit.inventory.armor.head[$i].resistance.fire|% fire, $current_unit.inventory.armor.head[$i].resistance.cold|% cold, $current_unit.inventory.armor.head[$i].resistance.impact|% impact, $current_unit.inventory.armor.head[$i].resistance.pierce|% pierce
``$current_unit.inventory.armor.head[$i].evade_adjust|% evade adj, $current_unit.inventory.armor.head[$i].ranged_adjust|% ranged adj"="$temp_value"
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=smithy_shop.items
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.inventory.armor.head[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.inventory.armor.head[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=i
                                                                        less_than=$current_unit.inventory.armor.equiped[1].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.inventory.armor.equiped[1].id add -1}
                                                                    [/then]
                                                                [/if]
																[modify_side]
	                                                                side=$current_unit.side
	                                                                gold=$current_unit.personal_gold
	                                                            [/modify_side]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
										{FOREACH current_unit.inventory.armor.shield i}
                                            [if]
                                                [variable]
                                                    name=current_unit.inventory.armor.equiped[1].id
                                                    equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.inventory.armor.shield[$i].undropable
                                                        equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.inventory.armor.shield[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .5}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+armor/$current_unit.inventory.armor.shield[$i].icon|.png+"="+_ "$current_unit.inventory.armor.shield[$i].description|
``$current_unit.inventory.armor.shield[$i].resistance.arcane|% arcane, $current_unit.inventory.armor.shield[$i].resistance.blade|% blade, $current_unit.inventory.armor.shield[$i].resistance.fire|% fire, $current_unit.inventory.armor.shield[$i].resistance.cold|% cold, $current_unit.inventory.armor.shield[$i].resistance.impact|% impact, $current_unit.inventory.armor.shield[$i].resistance.pierce|% pierce
``$current_unit.inventory.armor.shield[$i].evade_adjust|% evade adj, $current_unit.inventory.armor.shield[$i].ranged_adjust|% ranged adj"="$temp_value"
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=smithy_shop.items
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.inventory.armor.shield[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.inventory.armor.shield[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=i
                                                                        less_than=$current_unit.inventory.armor.equiped[4].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.inventory.armor.equiped[4].id add -1}
                                                                    [/then]
                                                                [/if]
																[modify_side]
	                                                                side=$current_unit.side
	                                                                gold=$current_unit.personal_gold
	                                                            [/modify_side]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.inventory.armor.legs i}
                                            [if]
                                                [variable]
                                                    name=current_unit.inventory.armor.equiped[3].id
                                                    equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.inventory.armor.legs[$i].undropable
                                                        equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.inventory.armor.legs[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .5}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+armor/$current_unit.inventory.armor.legs[$i].icon|.png+"="+_ "$current_unit.inventory.armor.legs[$i].description|
``$current_unit.inventory.armor.legs[$i].resistance.arcane|% arcane, $current_unit.inventory.armor.legs[$i].resistance.blade|% blade, $current_unit.inventory.armor.legs[$i].resistance.fire|% fire, $current_unit.inventory.armor.legs[$i].resistance.cold|% cold, $current_unit.inventory.armor.legs[$i].resistance.impact|% impact, $current_unit.inventory.armor.legs[$i].resistance.pierce|% pierce
``$current_unit.inventory.armor.legs[$i].mov_adjust| MP, $current_unit.inventory.armor.legs[$i].magic_adjust|% magic adj, $current_unit.inventory.armor.legs[$i].evade_adjust|% evade adj, $current_unit.inventory.armor.legs[$i].terrain.flat.defense|% def adj"="$temp_value"				
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=smithy_shop.items
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.inventory.armor.legs[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.inventory.armor.legs[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=i
                                                                        less_than=$current_unit.inventory.armor.equiped[3].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.inventory.armor.equiped[3].id add -1}
                                                                    [/then]
                                                                [/if]
																[modify_side]
	                                                                side=$current_unit.side
	                                                                gold=$current_unit.personal_gold
	                                                            [/modify_side]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        [if]
                                            [variable]
                                                name=sell_item_insert.length
                                                less_than=1
                                            [/variable]
                                            [then]
                                                [message]
                                                    speaker=narrator
                                                    message=_ "You have no items to sell."
                                                [/message]
                                                {VARIABLE in_shop 1}
                                            [/then]
                                            [else]
                                                [message]
                                                    speaker=narrator
                                                    message= _ "Sell which item?"
                                                    [option]
                                                        message ="&"+check.png+"="End selling."="+_ "_____"
                                                        [command]
                                                            [modify_side]
                                                                side=$current_unit.side
                                                                gold=$current_unit.personal_gold
                                                            [/modify_side]
                                                            {VARIABLE in_shop 1}
                                                        [/command]
                                                    [/option]
                                                    [insert_tag]
                                                        name=option
                                                        variable=sell_item_insert
                                                    [/insert_tag]
                                                [/message]
                                            [/else]
                                        [/if]
                                    [/do]
                                [/while]
                            [/command]
                        [/option]
                        {SHOP_DIVIDER_MELEE_WEAPONS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_melee
                        [/insert_tag]
                        {SHOP_DIVIDER_RANGED_WEAPONS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_ranged
                        [/insert_tag]
                        {SHOP_DIVIDER_TORSO_ARMOR}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_torso
                        [/insert_tag]
                        {SHOP_DIVIDER_LEG_ARMOR}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_legs
                        [/insert_tag]
                        {SHOP_DIVIDER_HEAD_ARMOR}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_head
                        [/insert_tag]
						{SHOP_DIVIDER_SHIELDS}
						 [insert_tag]
                            name=option
                            variable=shop_item_insert_shield
                        [/insert_tag]
                    [/message]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define WESBAND_MAGIC_SHOP
    [set_menu_item]
        id=wesband_magic_shop_$inc_menu
        description=_ "Enter shop"
        [filter_location]
            x,y=11,9
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE in_shop 1}
            [while]
                [variable]
                    name=in_shop
                    greater_than=0
                [/variable]
                [do]
                    {CLEAR_VARIABLE shop_item_insert_potions}
                    {FOREACH magic_shop.potions i}
                        [set_variables]
                            name=shop_item_insert_potions
                            mode=append
                            [value]
                                message="&"+$magic_shop.potions[$i].icon|.png+"="+_ "$magic_shop.potions[$i].description|"="$magic_shop.potions[$i].absolute_value"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$magic_shop.potions[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                            [/message]
                                        [/then]
                                        [else]
                                            {VARIABLE_OP current_unit.personal_gold add -$magic_shop.potions[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.inventory.usables
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=magic_shop.potions[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "magic_shop.potions[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
                    {CLEAR_VARIABLE shop_item_insert_tomes}
                    {FOREACH magic_shop.tomes i}
                        [set_variables]
                            name=shop_item_insert_tomes
                            mode=append
                            [value]
                                message="&"+$magic_shop.tomes[$i].icon|.png+"="+_ "$magic_shop.tomes[$i].description|"="$magic_shop.tomes[$i].absolute_value"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$magic_shop.tomes[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                            [/message]
                                        [/then]
                                        [else]
                                            {VARIABLE_OP current_unit.personal_gold add -$magic_shop.tomes[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.inventory.usables
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=magic_shop.tomes[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "magic_shop.tomes[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}

                    #{VARIABLE creation_gold $current_unit.personal_gold} want to be side gold to personal_golde
                    [message]
                        speaker=narrator
                        message= _ "Welcome to the Wesband magic shoppe. Be sure to check back later, as I frequently get new stock.

`You have $current_unit.personal_gold| gold to spend. Which item will you buy? "
                        [option]
                            message ="&"+check.png+"="End purchase."="+_ "_____"
                            [command]
                                [unstore_unit]
                                    variable=current_unit
                                [/unstore_unit]
                                {CONSTRUCT_UNIT}
                                [modify_side]
                                    side=$current_unit.side
                                    gold=$current_unit.personal_gold
                                [/modify_side]
                                {VARIABLE in_shop 0}
                            [/command]
                        [/option]
                        {SHOP_DIVIDER_POTIONS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_potions
                        [/insert_tag]
                        {SHOP_DIVIDER_TOMES}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_tomes
                        [/insert_tag]
                    [/message]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define WESBAND_TAVERN
    [set_menu_item]
        id=wesband_tavern_$inc_menu
        description=_ "Enter tavern"
        [filter_location]
            x,y=9,8
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
        [command]
			[store_unit]
				variable=hench_query
				[filter]
					side=$side_number
					[not]
						canrecruit=yes
					[/not]
					[filter_wml]
						is_hench=1
					[/filter_wml]
				[/filter]
			[/store_unit]
			{VARIABLE hench_number 0}
			{FOREACH hench_query i}
				{VARIABLE_OP hench_number add 1}
			{NEXT i}
			{CLEAR_VARIABLE hench_query}
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE in_shop 1}
            [while]
                [variable]
                    name=in_shop
                    greater_than=0
                [/variable]
                [do]
                    {CLEAR_VARIABLE tavern_insert}
                    {FOREACH tavern.hench i}
                        [set_variables]
                            name=tavern_insert
                            mode=append
                            [value]
                                message="&"+$tavern.hench[$i].image+"="+_ "$tavern.hench[$i].name|
Type: $tavern.hench[$i].language_name|
Traits:$tavern.hench[$i].modifications.trait.id|, $tavern.hench[$i].modifications.trait[1].id|"="$tavern.hench[$i].cost"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$tavern.hench[$i].cost
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to hire that person!"
                                            [/message]
                                        [/then]
                                        [else]
											[if]
		                                        [variable]
		                                            name=hench_number
		                                            greater_than=0
		                                        [/variable]
												[then]
													[message]
		                                                speaker=narrator
		                                                message=_ "You already have a henchman! Release your current one to recruit another."
		                                            [/message]
													{VARIABLE in_shop 0}
												[/then]
		                                        [else]
		                                            {VARIABLE_OP current_unit.personal_gold add -$tavern.hench[$i].cost}
													{VARIABLE tavern.hench[$i].side $current_unit.side}
													{VARIABLE tavern.hench[$i].is_hench 1}
													{VARIABLE tavern.hench[$i].upkeep 0}
													[unstore_unit]
														variable=tavern.hench[$i]
														find_vacant=yes
														x=$current_unit.x
														y=$current_unit.y
													[/unstore_unit]
													[modify_side]
					                                    side=$current_unit.side
					                                    gold=$current_unit.personal_gold
					                                [/modify_side]
													[unstore_unit]
					                                    variable=current_unit
					                                [/unstore_unit]													
					                                {VARIABLE in_shop 0}
		                                            {CLEAR_VARIABLE "tavern.hench[$i]"}
												[/else]
											[/if]
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
                    [message]
                        speaker=narrator
                        message= _ "In the Wesband Tavern you may hire one henchman at a time.
`Right-click to "Release Henchman"
`You have $current_unit.personal_gold| gold to spend. Who will you take with you?"
                        [option]
                            message ="&"+check.png+"="End purchase."="+_ "_____"
                            [command]
                                [unstore_unit]
                                    variable=current_unit
                                [/unstore_unit]
                                {CONSTRUCT_UNIT}
                                {VARIABLE in_shop 0}
                                [modify_side]
                                    side=$current_unit.side
                                    gold=$current_unit.personal_gold
                                [/modify_side]
                            [/command]
                        [/option]
                        [insert_tag]
                            name=option
                            variable=tavern_insert
                        [/insert_tag]
                    [/message]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#store utils

#define SHOP_DIVIDER_MELEE_WEAPONS
    [option]
        message =_ " "=_ "Weapons: Melee"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_RANGED_WEAPONS
    [option]
        message =_ " "=_ "Weapons: Ranged"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_TORSO_ARMOR
    [option]
        message =_ " "=_ "Armour: Torso"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_LEG_ARMOR
    [option]
        message =_ " "=_ "Armour: Leg"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_HEAD_ARMOR
    [option]
        message =_ " "=_ "Armour: Head"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_SCROLLS
    [option]
        message =_ " "=_ "Scrolls"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_TOMES
    [option]
        message =_ " "=_ "Tomes"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_WANDS
    [option]
        message =_ " "=_ "Wands"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_POTIONS
    [option]
        message =_ " "=_ "Potions"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_SHIELDS
    [option]
        message =_ " "=_ "Armour: Shields"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define CREATE_POTION_INSERT_TO_SHOP
    [set_variables]
        name=a_potion
        mode=replace
        [value]
            user_name="potion"
            icon="potions/potion-red-minor"
            description=_ "Heals 20 damage or cures poison."
            usable_self=1
            usable_other_adj=0
            usable_other_dis=0
            usable_adj=0
            usable_dis=0
            command=potion_heals_20
            infinite=1
            uses=1
            ground_icon="potion-red"
            category=usables
            absolute_value=10
        [/value]
    [/set_variables]
    [set_variables]
        name=magic_shop.potions
        mode=append
        [insert_tag]
            name=value
            variable=a_potion
        [/insert_tag]
    [/set_variables]
#enddef

#define CREATE_TOME_INSERT_TO_SHOP
    [set_variables]
        name=a_tome
        mode=replace
        [value]
            user_name="tome"
            icon="icons/tome"
            description=_ "Tome: Teleport 2 hexes/casting power
Uses simple action"
            usable_self=1
            usable_other_adj=0
            usable_other_dis=0
            usable_adj=0
            usable_dis=0
            command="tome"
            uses=1
            #make book image random
            ground_icon="book1"
            category=usables
            absolute_value=0
            [spell]
                user_name="silver_teleport"
                icon="upgrades/silver_order"
                usable_self=0
                usable_other_adj=0
                usable_other_dis=0
                usable_adj=1
                usable_dis=1
                infinite=1
                command=silver_teleport
                description=_ "Teleport 2 hexes/casting power
Uses simple action"
            [/spell]
        [/value]
    [/set_variables]
    [set_variables]
        name=magic_shop.tomes
        mode=append
        [insert_tag]
            name=value
            variable=a_tome
        [/insert_tag]
    [/set_variables]
#enddef

#define CREATE_HENCH_INSERT_TO_TAVERN
	[if]
		[variable]
			name=dungeon_level.cleared
			less_than=2
		[/variable]
		[then]
			{VARIABLE_OP new_hench rand "Woodsman,Ruffian,Peasant,WBD_Brute,WBD_Civilian,WBD_Initiate,WBD_Nobleman,WBD_Elf,WBD_She-Elf"}
		[/then]
	[/if]
	[if]
		[variable]
			name=dungeon_level.cleared
			less_than=4
		[/variable]
		[not]
			[variable]
				name=dungeon_level.cleared
				less_than=2
			[/variable]
		[/not]
		[then]
			{VARIABLE_OP new_hench rand "Woodsman,Ruffian,Peasant,WBD_Brute,WBD_Civilian,WBD_Initiate,WBD_Nobleman,WBD_Elf,WBD_She-Elf,Dwarvish Fighter,Dwarvish Guardsman,Dwarvish Thunderer,Dwarvish Ulfserker,Elvish Archer,Elvish Fighter,Elvish Shaman,Fencer,Heavy Infantryman,Mage,Bowman,Spearman,Footpad,Thug,Thief,Poacher,Sergeant"}
		[/then]
	[/if]
	[if]
		[variable]
			name=dungeon_level.cleared
			less_than=6
		[/variable]
		[not]
			[variable]
				name=dungeon_level.cleared
				less_than=4
			[/variable]
		[/not]
		[then]
			{VARIABLE_OP new_hench rand "Woodsman,Ruffian,Peasant,WBD_Brute,WBD_Civilian,WBD_Initiate,WBD_Nobleman,WBD_Elf,WBD_She-Elf,Dwarvish Fighter,Dwarvish Guardsman,Dwarvish Thunderer,Dwarvish Ulfserker,Elvish Archer,Elvish Fighter,Elvish Shaman,Fencer,Heavy Infantryman,Mage,Bowman,Spearman,Footpad,Thug,Thief,Poacher,Sergeant,Dwarvish Steelclad,Dwarvish Stalwart,Dwarvish Thunderguard,Dwarvish Berserker,Elvish Marksman,Elvish Ranger,Elvish Captain,Elvish Hero,Elvish Druid,Elvish Sorceress,Duelist,Shock Trooper,Red Mage,White Mage,Longbowman,Javelineer,Pikeman,Swordsman,Outlaw,Bandit,Lieutenant,Rogue,Trapper"}
		[/then]
	[/if]
	[if]
		[variable]
			name=dungeon_level.cleared
			greater_than_equal_to=6
		[/variable]
		[then]
			{VARIABLE_OP new_hench rand "Woodsman,Ruffian,Peasant,WBD_Brute,WBD_Civilian,WBD_Initiate,WBD_Nobleman,WBD_Elf,WBD_She-Elf,Dwarvish Fighter,Dwarvish Guardsman,Dwarvish Thunderer,Dwarvish Ulfserker,Elvish Archer,Elvish Fighter,Elvish Shaman,Fencer,Heavy Infantryman,Mage,Bowman,Spearman,Footpad,Thug,Thief,Poacher,Sergeant,Dwarvish Steelclad,Dwarvish Stalwart,Dwarvish Thunderguard,Dwarvish Berserker,Elvish Marksman,Elvish Ranger,Elvish Captain,Elvish Hero,Elvish Druid,Elvish Sorceress,Duelist,Shock Trooper,Red Mage,White Mage,Longbowman,Javelineer,Pikeman,Swordsman,Outlaw,Bandit,Lieutenant,Rogue,Trapper,Dwarvish Lord,Dwarvish Sentinel,Dwarvish Dragonguard,Elvish Sharpshooter,Elvish Avenger,Elvish Marshal,Elvish Champion,Elvish Shyde,Elvish Enchantress,Master at Arms,Iron Mauler,Arch Mage,Silver Mage,Mage of Light,Master Bowman,Halberdier,Royal Guard,Royal Warrior,Fugitive,Highwayman,General,Assassin,Huntsman,Ranger"}
		[/then]
	[/if]
    
	[unit]
		side=4
		type=$new_hench
		x=1
		y=1
		generate_name=yes
		random_traits=yes
		trandom_gender=yes
		generate_description=yes
	[/unit]
	[store_unit]
		variable=tavern.hench
		mode=append
		[filter]
			x,y=1,1
		[/filter]
		kill=yes
	[/store_unit]
#enddef


