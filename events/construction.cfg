[event]
    name=construct_unit
    first_time_only=no
	
	[if]
        [variable]
            name=current_unit.variables.abilities.illuminates
            numerical_equals=1
        [/variable]
        [and]
            [variable]
                name=current_unit.alignment
                equals="lawful"
            [/variable]
        [/and]
        [then]
			[unstore_unit]
				variable=current_unit
			[/unstore_unit]
            [object]
				id=standing_anim
				name="standing_anim"
				silent=yes
				[filter]
					x=$current_unit.x
					y=$current_unit.y
				[/filter]
				[effect]
				   apply_to=new_animation
				   [standing_anim]
					  start_time=0
					  [frame]
						 halo=halo/illuminates-aura.png
						 duration=100
					  [/frame]
				   [/standing_anim]
				[/effect]
			[/object]
			[store_unit]
				[filter]
					x,y=$current_unit.x,$current_unit.y
				[/filter]
				variable=current_unit
			[/store_unit]
        [/then]
    [/if]
	

	#clear all attacks
	{CLEAR_VARIABLE current_unit.attack}

    #clear traits and reset mana counter trait
	[set_variables]
		name=current_unit.modifications.trait
		mode=replace
		[value]
			id="mana_counter"
			name="mana: $current_unit.variables.abilities.magic_casting.mana|/$current_unit.variables.abilities.magic_casting.max_mana|"
			description=" Available mana / maximum stored mana."
		[/value]
	[/set_variables]

    #clear and rebuild list of weapon types
    {CLEAR_VARIABLE current_unit.variables.inventory.type}
    {FOREACH current_unit.variables.inventory.weapons.melee i}
        {VARIABLE_OP current_unit.variables.inventory.type.$current_unit.variables.inventory.weapons.melee[$i].class| add 1}
        [if]
            [variable]
                name=current_unit.variables.inventory.weapons.melee[$i].special_type.throwable
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP current_unit.variables.inventory.type.$current_unit.variables.inventory.weapons.melee[$i].thrown.class| add 1}
            [/then]
        [/if]
    {NEXT i}

    {FOREACH current_unit.variables.inventory.weapons.ranged i}
        {VARIABLE_OP current_unit.variables.inventory.type.$current_unit.variables.inventory.weapons.ranged[$i].class| add 1}
    {NEXT i}

    #abilities
    {CLEAR_VARIABLE current_unit.abilities}
	
    #illuminates (halo added above via [effect])
    {CLEAR_VARIABLE current_unit.halo}
    [if]
        [variable]
            name=current_unit.variables.abilities.illuminates
            numerical_equals=1
        [/variable]
        [and]
            [variable]
                name=current_unit.alignment
                equals="lawful"
            [/variable]
        [/and]
        [then]
			[set_variables]
				name=current_unit.abilities.illuminates
				mode=append
				[value]
					id="illumination"
					value=25
					max_value=25
					cumulative="no"
					name="illuminates"
					description="Illuminates:
This unit illuminates the surrounding area, making lawful units fight better, and chaotic units fight worse.

Any units adjacent to this unit will fight as if it were dusk when it is night, and as if it were day when it is dusk."
					affect_self="yes"
				[/value]
			[/set_variables]
        [/then]
    [/if]

    #steadfast
    [if]
        [variable]
            name=current_unit.variables.abilities.steadfast
            greater_than=0
        [/variable]
        [and]
            [variable]
                name=current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id|].special_type.steadfast
                numerical_equals=1
            [/variable]
        [/and]
        [then]
			[switch]
				variable=current_unit.variables.abilities.steadfast
				[case]
					value=1
					[set_variables]
						name=current_unit.abilities.resistance
						mode=append
						[value]
							id="steadfast"
							multiply=2
							max_value=40
							apply_to="blade,pierce,impact,fire,cold,arcane"
							[filter_base_value]
								greater_than=0
								less_than_equal_to=40
							[/filter_base_value]	
							name="steadfast"
							description="Steadfast Level 1:
This unit's resistances are doubled, up to a maximum of 40%, when defending. Vulnerabilities are not affected."
							affect_self="yes"
							active_on="defense"
						[/value]
					[/set_variables]
				[/case]
				[case]
					value=2
					[set_variables]
						name=current_unit.abilities.resistance
						mode=append
						[value]
							id="steadfast"
							multiply=2
							max_value=50
							apply_to="blade,pierce,impact,fire,cold,arcane"
							[filter_base_value]
								greater_than=0
								less_than_equal_to=50
							[/filter_base_value]	
							name="steadfast"
							description="Steadfast Level 2:
This unit's resistances are doubled, up to a maximum of 50%, when defending. Vulnerabilities are not affected."
							affect_self="yes"
							active_on="defense"
						[/value]
					[/set_variables]
				[/case]
				[case]
					value=3
					[set_variables]
						name=current_unit.abilities.resistance
						mode=append
						[value]
							id="steadfast"
							multiply=2
							max_value=60
							apply_to="blade,pierce,impact,fire,cold,arcane"
							[filter_base_value]
								greater_than=0
								less_than_equal_to=60
							[/filter_base_value]	
							name="steadfast"
							description="Steadfast Level 3:
This unit's resistances are doubled, up to a maximum of 60%, when defending. Vulnerabilities are not affected."
							affect_self="yes"
							active_on="defense"
						[/value]
					[/set_variables]
				[/case]
			[/switch]
        [/then]
    [/if]

    #leadership
	[if]
		[variable]
			name=current_unit.variables.abilities.cruelty
			numerical_equals=1
		[/variable]
		[then]
			[if]
				[variable]
					name=current_unit.variables.abilities.leadership
					numerical_equals=1
				[/variable]
				[then]
					[set_variables]
						name=current_unit.abilities.leadership
						mode=append
						[value]
							id="leadership"
							name="cruelty"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							description="Leadership Level 1:
This unit can lead friendly units that are next to it, making them fight better.

Adjacent friendly units of lower level will do more damage in battle. When a unit adjacent to, of a lower level than, and on the same side as a unit with Leadership engages in combat, its attacks do 30% more damage times the difference in their levels if chaotic, 20% if non-chaotic."
							value=30
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
									[filter_wml]
										alignment=chaotic
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=20
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
									[filter_wml]
										[not]
											alignment=chaotic
										[/not]
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
					[/set_variables]
				[/then]
			[/if]
			[if]
				[variable]
					name=current_unit.variables.abilities.leadership
					numerical_equals=2
				[/variable]
				[then]
					[set_variables]
						name=current_unit.abilities.leadership
						mode=append
						[value]
							id="leadership"
							name="cruelty"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							description="Leadership Level 2:
This unit can lead friendly units that are next to it, making them fight better.

Adjacent friendly units of lower level will do more damage in battle. When a unit adjacent to, of a lower level than, and on the same side as a unit with Leadership engages in combat, its attacks do 25% more damage times the difference in their levels if chaotic, 20% if non-chaotic."
							value=60
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
									[filter_wml]
										alignment=chaotic
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=40
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
									[filter_wml]
										[not]
											alignment=chaotic
										[/not]
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=30
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=1
									[filter_wml]
										alignment=chaotic
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=20
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=1
									[filter_wml]
										[not]
											alignment=chaotic
										[/not]
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
					[/set_variables]
				[/then]
			[/if]
			[if]
				[variable]
					name=current_unit.variables.abilities.leadership
					numerical_equals=3
				[/variable]
				[then]
					[set_variables]
						name=current_unit.abilities.leadership
						mode=append
						[value]
							id="leadership"
							name="cruelty"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							description="Leadership Level 3:
This unit can lead friendly units that are next to it, making them fight better.

Adjacent friendly units of lower level will do more damage in battle. When a unit adjacent to, of a lower level than, and on the same side as a unit with Leadership engages in combat, its attacks do 25% more damage times the difference in their levels if chaotic, 20% if non-chaotic."
							value=90
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
									[filter_wml]
										alignment=chaotic
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=60
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
									[filter_wml]
										[not]
											alignment=chaotic
										[/not]
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=60
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=1
									[filter_wml]
										alignment=chaotic
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=40
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=1
									[filter_wml]
										[not]
											alignment=chaotic
										[/not]
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=30
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=2
									[filter_wml]
										alignment=chaotic
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=20
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=2
									[filter_wml]
										[not]
											alignment=chaotic
										[/not]
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
					[/set_variables]
				[/then]
			[/if]
			[if]
				[variable]
					name=current_unit.variables.abilities.leadership
					numerical_equals=4
				[/variable]
				[then]
					[set_variables]
						name=current_unit.abilities.leadership
						mode=append
						[value]
							id="leadership"
							name="cruelty"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							description="Leadership Level 4:
This unit can lead friendly units that are next to it, making them fight better.

Adjacent friendly units of lower level will do more damage in battle. When a unit adjacent to, of a lower level than, and on the same side as a unit with Leadership engages in combat, its attacks do 25% more damage times the difference in their levels if chaotic, 20% if non-chaotic."
							value=120
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
									[filter_wml]
										alignment=chaotic
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=80
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
									[filter_wml]
										[not]
											alignment=chaotic
										[/not]
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=90
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=1
									[filter_wml]
										alignment=chaotic
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=60
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=1
									[filter_wml]
										[not]
											alignment=chaotic
										[/not]
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=60
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=2
									[filter_wml]
										alignment=chaotic
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=40
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=2
									[filter_wml]
										[not]
											alignment=chaotic
										[/not]
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=30
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=3
									[filter_wml]
										alignment=chaotic
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=20
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=3
									[filter_wml]
										[not]
											alignment=chaotic
										[/not]
									[/filter_wml]
								[/filter]
							[/affect_adjacent]
						[/value]
					[/set_variables]
				[/then]
			[/if]
		[/then]
		[else]
			[if]
				[variable]
					name=current_unit.variables.abilities.leadership
					numerical_equals=1
				[/variable]
				[then]
					[set_variables]
						name=current_unit.abilities.leadership
						mode=append
						[value]
							id="leadership"
							name="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							description="Leadership Level 1:
This unit can lead friendly units that are next to it, making them fight better.

Adjacent friendly units of lower level will do more damage in battle. When a unit adjacent to, of a lower level than, and on the same side as a unit with Leadership engages in combat, its attacks do 25% more damage times the difference in their levels."
							value=25
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
								[/filter]
							[/affect_adjacent]
						[/value]
					[/set_variables]
				[/then]
			[/if]
			[if]
				[variable]
					name=current_unit.variables.abilities.leadership
					numerical_equals=2
				[/variable]
				[then]
					[set_variables]
						name=current_unit.abilities.leadership
						mode=append
						[value]
							id="leadership"
							name="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							description="Leadership Level 2:
This unit can lead friendly units that are next to it, making them fight better.

Adjacent friendly units of lower level will do more damage in battle. When a unit adjacent to, of a lower level than, and on the same side as a unit with Leadership engages in combat, its attacks do 25% more damage times the difference in their levels."
							value=50
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=25
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=1
								[/filter]
							[/affect_adjacent]
						[/value]
					[/set_variables]
				[/then]
			[/if]
			[if]
				[variable]
					name=current_unit.variables.abilities.leadership
					numerical_equals=3
				[/variable]
				[then]
					[set_variables]
						name=current_unit.abilities.leadership
						mode=append
						[value]
							id="leadership"
							name="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							description="Leadership Level 3:
This unit can lead friendly units that are next to it, making them fight better.

Adjacent friendly units of lower level will do more damage in battle. When a unit adjacent to, of a lower level than, and on the same side as a unit with Leadership engages in combat, its attacks do 25% more damage times the difference in their levels."
							value=75
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=50
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=1
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=25
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=2
								[/filter]
							[/affect_adjacent]
						[/value]
					[/set_variables]
				[/then]
			[/if]
			[if]
				[variable]
					name=current_unit.variables.abilities.leadership
					numerical_equals=4
				[/variable]
				[then]
					[set_variables]
						name=current_unit.abilities.leadership
						mode=append
						[value]
							id="leadership"
							name="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							description="Leadership Level 4:
This unit can lead friendly units that are next to it, making them fight better.

Adjacent friendly units of lower level will do more damage in battle. When a unit adjacent to, of a lower level than, and on the same side as a unit with Leadership engages in combat, its attacks do 25% more damage times the difference in their levels."
							value=100
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=0
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=75
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=1
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=50
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=2
								[/filter]
							[/affect_adjacent]
						[/value]
						[value]
							id="leadership"
							affect_self="no"
							affect_allies="yes"
							cumulative="no"
							value=25
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
								[filter]
									level=3
								[/filter]
							[/affect_adjacent]
						[/value]
					[/set_variables]
				[/then]
			[/if]
		[/else]
	[/if]
		

	#loner
	[if]
		[variable]
			name=current_unit.variables.abilities.loner
			numerical_equals=1
		[/variable]
		[then]
			[set_variables]
				name=current_unit.abilities.leadership
				mode=append
				[value]
					id="loner"
					name="loner"
					affect_self="yes"
					cumulative="no"
					description="Loner
This unit is 25% more effective in combat when not adjacent to any allied units."
					value=25
					[filter]
						[not]
							[filter_adjacent]
								is_enemy="false"
							[/filter_adjacent]
						[/not]
					[/filter]
				[/value]
			[/set_variables]
		[/then]
	[/if]
		
	
	[if]
		[variable]
			name=current_unit.variables.status.protection_armor_magic
			greater_than=0
		[/variable]
		[then]		
			{PROTECTION_ARMOR_MAGIC_APPLY current_unit}
		[/then]
	[/if]
	[if]
		[variable]
			name=current_unit.variables.status.protection_armor_magic
			greater_than=0
		[/variable]
		[then]		
			{PROTECTION_ARMOR_MAGIC_APPLY current_unit}
		[/then]
	[/if]
	[if]
		[variable]
			name=current_unit.variables.phoenix_fire
			greater_than=0
		[/variable]
		[then]	
			{PHOENIX_FIRE_APPLY current_unit}
		[/then]
	[/if]
			
	
	{CLEAR_VARIABLE temp_abilities}

    

    #abstracted movement value for spells (like farsight)
    {VARIABLE current_unit.variables.abstract_moves $current_unit.max_moves}

    #adjust evade for armor
    {VARIABLE add_evade $current_unit.variables.evade_level}
    {VARIABLE_OP add_evade multiply 3}
    {VARIABLE_OP add_evade add $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].evade_adjust}
    {VARIABLE_OP add_evade add $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id|].evade_adjust}
    {VARIABLE_OP add_evade add $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id|].evade_adjust}
    {VARIABLE_OP add_evade add $current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id|].evade_adjust}
	
	#movement adjust for armor
	{VARIABLE max_moves_temp 0}
	[if]
        [variable]
            name=add_evade
            less_than=0
        [/variable]
        [then]
			{VARIABLE max_moves_temp $current_unit.variables.max_moves}
			{VARIABLE add_evade_neg $add_evade}
			{VARIABLE_OP add_evade_neg multiply -1}
			[if]
				[variable]
					name=add_evade
					less_than_equal_to=-10
				[/variable]
				[then]			
					{VARIABLE_OP max_moves_temp multiply "0.$add_evade_neg|"}
				[/then]
				[else]
					{VARIABLE_OP max_moves_temp multiply "0.0$add_evade_neg|"}
				[/else]
			[/if]
			{VARIABLE_OP max_moves_temp round ceil}
		[/then]
	[/if]
	{VARIABLE current_unit.max_moves $current_unit.variables.max_moves}
	{VARIABLE_OP current_unit.max_moves add -$max_moves_temp}
    [if]
        [variable]
            name=current_unit.moves
            greater_than=$current_unit.max_moves
        [/variable]
        [then]
            {VARIABLE current_unit.moves $current_unit.max_moves}
        [/then]
    [/if]
	
    #ranged adjust for armor
    {VARIABLE ranged_adjust $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id|].ranged_adjust}
    {VARIABLE_OP ranged_adjust add $current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id|].ranged_adjust}
    {VARIABLE_OP ranged_adjust add 100}
    [if]
        [variable]
            name=ranged_adjust
            less_than=0
        [/variable]
        [then]
            {VARIABLE ranged_adjust 0}
        [/then]
    [/if]

    #magical adjust for armor
    {VARIABLE magic_adjust_armor $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].magic_adjust}
    {VARIABLE_OP magic_adjust_armor add $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id|].magic_adjust}
    {VARIABLE_OP magic_adjust_armor add $current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id|].magic_adjust}
    {VARIABLE_OP magic_adjust_armor add 100}
    [if]
        [variable]
            name=magic_adjust_armor
            less_than=0
        [/variable]
        [then]
            {VARIABLE magic_adjust_armor 0}
        [/then]
    [/if]

    #human magical adjust for weapon
    {CLEAR_VARIABLE human_magic_adjust_weapon}
    {VARIABLE human_magic_adjust_weapon $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[0].id|].human_magic_adjust}
    {VARIABLE_OP human_magic_adjust_weapon add 100}
    [if]
        [variable]
            name=human_magic_adjust_weapon
            less_than=0
        [/variable]
        [then]
            {VARIABLE human_magic_adjust_weapon 0}
        [/then]
    [/if]

    #dark magical adjust for weapon
    {CLEAR_VARIABLE dark_magic_adjust_weapon}
    {VARIABLE dark_magic_adjust_weapon $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[0].id|].dark_magic_adjust}
    {VARIABLE_OP dark_magic_adjust_weapon add 100}
    [if]
        [variable]
            name=dark_magic_adjust_weapon
            less_than=0
        [/variable]
        [then]
            {VARIABLE dark_magic_adjust_weapon 0}
        [/then]
    [/if]

    #faerie magical adjust for weapon
    {CLEAR_VARIABLE faerie_magic_adjust_weapon}
    {VARIABLE faerie_magic_adjust_weapon $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[0].id|].faerie_magic_adjust}
    {VARIABLE_OP faerie_magic_adjust_weapon add 100}
    [if]
        [variable]
            name=faerie_magic_adjust_weapon
            less_than=0
        [/variable]
        [then]
            {VARIABLE faerie_magic_adjust_weapon 0}
        [/then]
    [/if]

    #runic magical adjust for weapon
    {CLEAR_VARIABLE runic_magic_adjust_weapon}
    {VARIABLE runic_magic_adjust_weapon $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[0].id|].runic_magic_adjust}
    {VARIABLE_OP runic_magic_adjust_weapon add 100}
    [if]
        [variable]
            name=runic_magic_adjust_weapon
            less_than=0
        [/variable]
        [then]
            {VARIABLE runic_magic_adjust_weapon 0}
        [/then]
    [/if]

	#spirit magical adjust for weapon
    {CLEAR_VARIABLE spirit_magic_adjust_weapon}
    {VARIABLE spirit_magic_adjust_weapon $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[0].id|].spirit_magic_adjust}
    {VARIABLE_OP spirit_magic_adjust_weapon add 100}
    [if]
        [variable]
            name=spirit_magic_adjust_weapon
            less_than=0
        [/variable]
        [then]
            {VARIABLE spirit_magic_adjust_weapon 0}
        [/then]
    [/if]

    #skirmisher
    {VARIABLE skirm_allow 0}
    {VARIABLE skirm_allow $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[0].id|].special_type.skirm}
    {VARIABLE skirm_1 1}
    {VARIABLE skirm_2 1}
    [if]
        [variable]
            name=current_unit.variables.inventory.weapons.equipped[1].id
            greater_than=0
        [/variable]
        [then]
            {VARIABLE skirm_1 $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[1].id|].special_type.skirm}
        [/then]
    [/if]
    [if]
        [variable]
            name=current_unit.variables.inventory.weapons.equipped[2].id
            greater_than=0
        [/variable]
        [then]
            {VARIABLE skirm_2 $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[2].id|].special_type.skirm}
        [/then]
    [/if]
    {VARIABLE_OP skirm_allow multiply $skirm_1}
    {VARIABLE_OP skirm_allow multiply $skirm_2}
    [if]
        [variable]
            name=skirm_allow
            numerical_equals=1
        [/variable]
        [and]
            [variable]
                name=add_evade
                greater_than_equal_to=0
            [/variable]
            [and]
                [variable]
                    name=current_unit.variables.abilities.skirm
                    greater_than=0
                [/variable]
            [/and]
        [/and]
        [then]
			[set_variables]
				name=current_unit.abilities.skirmisher
				mode=append
				[value]
					id="skirmisher"
					name="skirmisher"
					affect_self="yes"
					description="Skirmisher: This unit is skilled in moving past enemies quickly, and ignores all enemy Zones of Control."
				[/value]
			[/set_variables]
			[if]
                [variable]
                    name=current_unit.variables.abilities.distract
                    greater_than=0
                [/variable]
				[then]
					[set_variables]
						name=current_unit.abilities.skirmisher
						mode=append
						[value]
							id=distract
							name= _ "distract"
							description= _ "Distract:
This unit negates enemy Zones of Control around itself for allied units (but not for itself)."
							affect_self=no
							affect_allies=yes
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
							[/affect_adjacent]
						[/value]
					[/set_variables]
				[/then]
			[/if]			
        [/then]
    [/if]

    #dash
    {VARIABLE current_unit.variables.status.dash 0}
    [if]
        [variable]
            name=skirm_allow
            numerical_equals=1
        [/variable]
        [and]
            [variable]
                name=add_evade
                greater_than_equal_to=0
            [/variable]
            [and]
                [variable]
                    name=current_unit.variables.abilities.dash
                    greater_than=0
                [/variable]
            [/and]
        [/and]
        [then]
			[set_variables]
				name=current_unit.abilities.dummy
				mode=append
				[value]
					id="dash"
					name="dash"
					description="This unit can use remaining movement points after attacking."
				[/value]
			[/set_variables]
            {VARIABLE current_unit.variables.status.dash 1}
        [/then]
    [/if]

    #forest_ambush
    [if]
        [variable]
            name=current_unit.variables.abilities.ambush_forest
            numerical_equals=1
        [/variable]
        [and]
            [variable]
                name=add_evade
                greater_than_equal_to=0
            [/variable]
        [/and]
        [then]
			[set_variables]
				name=current_unit.abilities.hides
				mode=append
				[value]
					id="ambush_forest"
					name="ambush"
					name_inactive="ambush"
					affect_self="yes"
					description="Ambush:
This unit can hide in forest if wearing only light armor."
					description_inactive="Ambush:
This unit can hide in forest if wearing only light armor."
					[filter_self]
						[filter_location]
							terrain="*^Fp,*^Fet,*^Ft,*^Fpa"
						[/filter_location]
					[/filter_self]
				[/value]
			[/set_variables]
        [/then]
    [/if]

    #mountain ambush   ambush_mountains
    [if]
        [variable]
            name=current_unit.variables.abilities.ambush_mountains
            numerical_equals=1
        [/variable]
        [and]
            [variable]
                name=add_evade
                greater_than_equal_to=0
            [/variable]
        [/and]
        [then]
			[set_variables]
				name=current_unit.abilities.hides
				mode=append
				[value]
					id="ambush_mountains"
					name="ambush"
					name_inactive="ambush"
					affect_self="yes"
					description="Ambush:
This unit can hide in mountains if wearing only light armor."
					description_inactive="Ambush:
This unit can hide in mountains if wearing only light armor."
					[filter_self]
						[filter_location]
							terrain="M*,M*^*"
						[/filter_location]
					[/filter_self]
				[/value]
			[/set_variables]
        [/then]
    [/if]

    #sneak
    [if]
        [variable]
            name=add_evade
            greater_than_equal_to=0
        [/variable]
        [and]
            [variable]
                name=current_unit.variables.abilities.sneak
                greater_than=0
            [/variable]
        [/and]
        [then]
			[set_variables]
				name=current_unit.abilities.hides
				mode=append
				[value]
					id=sneak
					name= _ "sneak"
					name_inactive= _ "sneak"
					description= _ "Sneak: This unit can hide from enemies if it has used no more than half of its movement points and light armor."
					desription_inactive= _ "Sneak: This unit can hide from enemies if it has used no more than half of its movement points and light armor."
					affect_self=yes
					[filter]
						[filter_wml]
							[variables]
								stealthiness=1
							[/variables]
						[/filter_wml]
					[/filter]
				[/value]
			[/set_variables]
			{CALCULATE_STEALTHINESS current_unit}
			{VARIABLE current_unit.status.hidden yes}
        [/then]
    [/if]

    #regenerate
    [if]
        [variable]
            name=current_unit.variables.abilities.regen
            greater_than=0
        [/variable]
        [then]
            {VARIABLE regen_value $current_unit.variables.abilities.regen}
            {VARIABLE_OP regen_value multiply 2}
            {VARIABLE current_unit.abilities.regenerate.value $regen_value}
            {VARIABLE current_unit.abilities.regenerate.id "regenerate"}
            {VARIABLE current_unit.abilities.regenerate.name "regenerate +$regen_value|"}
            [if]
                [variable]
                    name=current_unit.variables.abilities.regen
                    greater_than=3
                [/variable]
                [then]
                    {VARIABLE current_unit.abilities.regenerate.description "Regenerates:
The unit will heal itself $regen_value| HP per turn. If it is poisoned, it will remove the poison instead of healing."}
                    {VARIABLE current_unit.abilities.regenerate.poison "cured"}
                [/then]
                [else]
                    {VARIABLE current_unit.abilities.regenerate.description "Regenerates:
The unit will heal itself $regen_value| HP per turn. If it is poisoned, it will slow the poison until cured."}
                    {VARIABLE current_unit.abilities.regenerate.poison "slowed"}
                [/else]
            [/if]
        [/then]
    [/if]

    #survivalist
    [if]
        [variable]
            name=current_unit.variables.abilities.survivalist
            greater_than=0
        [/variable]
        [then]
            {VARIABLE current_unit.abilities.regenerate[1].value 8}
            {VARIABLE current_unit.abilities.regenerate[1].id "survivalist"}
            {VARIABLE current_unit.abilities.regenerate[1].name "survivalist"}
            {VARIABLE current_unit.abilities.regenerate[1].description "Survivalist:
The unit will heal itself 8 HP per turn if in a forest. If it is poisoned, it will remove the poison instead of healing."}
            {VARIABLE current_unit.abilities.regenerate[1].poison "cured"}
            {VARIABLE current_unit.abilities.regenerate[1].filter_self.filter_location.terrain "*^Fp,*^Fet,*^Ft,*^Fpa"}
        [/then]
    [/if]

    #healthy
    [if]
        [variable]
            name=current_unit.variables.abilities.healthy
            greater_than=0
        [/variable]
        [then]
			[set_variables]
				name=current_unit.modifications.trait
				mode=append
				[value]
					id="healthy"
					name="healthy"
					description="Can rest while moving, halves poison damage."
				[/value]
			[/set_variables]
        [/then]
    [/if]
    #fearless
    [if]
        [variable]
            name=current_unit.variables.abilities.fearless
            greater_than=0
        [/variable]
        [then]
			[set_variables]
				name=current_unit.modifications.trait
				mode=append
				[value]
					id="fearless"
					name="fearless"
					description="Fight normally during unfavorable times of day/night."
				[/value]
			[/set_variables]
        [/then]
    [/if]
	
	#descriptions of spells
	{FOREACH current_unit.variables.inventory.spells i}
		[switch]
			variable=current_unit.variables.inventory.spells[$i].user_name
			[case]
				value=heals
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				[switch]
					variable=current_unit.variables.inventory.spells[$i].command
					[case]
						value=green_healing
						{VARIABLE_OP spell_power_temp multiply 2}
					[/case]
					[case]
						value=spirit_healing
						[if]
							[variable]
								name=current_unit.variables.abilities.benevolent
								greater_than=0
							[/variable]
							[then]
								{VARIABLE_OP spell_power_temp multiply 3}
							[/then]
						[/if]
					[/case]
					[else]
			            {VARIABLE_OP spell_power_temp multiply 3}
					[/else]
				[/switch]
				{VARIABLE_OP spell_power_temp add 4}
				{VARIABLE spell_cost_temp $spell_power_temp}
				{VARIABLE_OP spell_cost_temp divide 4}
				{VARIABLE_OP spell_cost_temp add 1}
				{VARIABLE current_unit.abilities.heals.id "rpg_heals"}
			    {VARIABLE current_unit.abilities.heals.name "heals"}
			    {VARIABLE current_unit.abilities.heals.description "Heals +$spell_power_temp|:
`This can heal $spell_power_temp hit points."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost $spell_cost_temp}
			    [if]
			        [variable]
			            name=spell_power_temp
			            greater_than=7
			        [/variable]
			        [then]
			            {VARIABLE current_unit.abilities.heals[1].id "rpg_cures"}
			            {VARIABLE current_unit.abilities.heals[1].name "cures"}
			            {VARIABLE current_unit.abilities.heals[1].description "Cures:
Instead of healing, this unit will cure poison if the target unit is poisoned."}
						{VARIABLE current_unit.variables.inventory.spells[$i].description "Heals +$spell_power_temp|:
`Heal $spell_power_temp hitpoints. Cure if the unit is poisoned."}
			        [/then]
					[else]
						{VARIABLE current_unit.variables.inventory.spells[$i].description "Heal $spell_power_temp hitpoints."}
					[/else]
				[/if]
			[/case]
			[case]
				value=silver_teleport
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				{VARIABLE_OP spell_power_temp multiply 2}
				{VARIABLE current_unit.abilities.heals.id "rpg_teleport"}
	            {VARIABLE current_unit.abilities.heals.name "teleport"}
	            {VARIABLE current_unit.abilities.heals.description "Teleport:
This unit may teleport $spell_power_temp hexes away granted it is an empty location that the unit can move to normally."}
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Teleport: 
`Teleport $spell_power_temp hexes away."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost 3}
			[/case]
			[case]
				value=phoenix_fire
				{VARIABLE spell_cost_temp $current_unit.variables.abilities.magic_casting.power}
				{VARIABLE_OP spell_cost_temp multiply 2}
				{VARIABLE_OP spell_cost_temp add 2}
				{VARIABLE spell_power_temp $spell_cost_temp}
				{VARIABLE_OP spell_power_temp multiply 2}
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Phoenix Fire:
`Upon death, return to $spell_power_temp hitpoints. Amount decreases by 4 per turn."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost $spell_cost_temp}
			[/case]
			[case]
				value=mapping
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				{VARIABLE_OP spell_power_temp multiply 5}
				{VARIABLE_OP spell_power_temp add 10}
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Magic Mapping:
`Removes shroud within a radius of $spell_power_temp hexes."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost 6}
			[/case]
			[case]
				value=detect_gold
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				{VARIABLE_OP spell_power_temp multiply 4}
				{VARIABLE_OP spell_power_temp add 20}
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Detect Gold:
`Shows gold within a radius of $spell_power_temp hexes."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost 6}
			[/case]
			[case]
				value=detect_units
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				{VARIABLE_OP spell_power_temp multiply 5}
				{VARIABLE_OP spell_power_temp add 15}
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Detect Units:
`Shows units within a radius of $spell_power_temp hexes."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost 6}
			[/case]
			[case]
				value=improved_detect_units
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				{VARIABLE_OP spell_power_temp multiply 4}
				{VARIABLE_OP spell_power_temp add 12}
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Improved Detect Units:
`Shows units within a radius of $spell_power_temp hexes."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost 6}
			[/case]
			[case]
				value=summon_fire_elemental
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				[if]
					[variable]
						name=spell_power_temp
						greater_than=3
					[/variable]
					[then]
						{VARIABLE spell_power_temp 3}
					[/then]
				[/if]
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Summon Fire Elemental:
`Summon a fire elemental with a max level of $spell_power_temp."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost 6}
			[/case]
			[case]
				value=summon_water_elemental
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				[if]
					[variable]
						name=spell_power_temp
						greater_than=3
					[/variable]
					[then]
						{VARIABLE spell_power_temp 3}
					[/then]
				[/if]
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Summon Water Elemental:
`Summon a water elemental with a max level of $spell_power_temp."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost 6}
			[/case]
			[case]
				value=summon_earth_elemental
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				[if]
					[variable]
						name=spell_power_temp
						greater_than=3
					[/variable]
					[then]
						{VARIABLE spell_power_temp 3}
					[/then]
				[/if]
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Summon Earth Elemental:
`Summon an earth elemental with a max level of $spell_power_temp."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost 6}
			[/case]
			[case]
				value=summon_air_elemental
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				[if]
					[variable]
						name=spell_power_temp
						greater_than=3
					[/variable]
					[then]
						{VARIABLE spell_power_temp 3}
					[/then]
				[/if]
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Summon Air Elemental:
`Summon an air elemental with a max level of $spell_power_temp."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost 6}
			[/case]
			[case]
				value=protection_from_poison
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Protection from Poison:
`Protects from poison for $spell_power_temp rounds."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost 6}
			[/case]
			[case]
				value=protection_armor_magic
				{VARIABLE spell_power_temp $current_unit.variables.abilities.magic_casting.power}
				{VARIABLE_OP spell_power_temp multiply 5}
				{VARIABLE current_unit.variables.inventory.spells[$i].description "Magic Armor:
`Grants $spell_power_temp|% resistance. Amount decreases by 5% each round."}
				{VARIABLE current_unit.variables.inventory.spells[$i].mana_cost 6}
			[/case]
		[/switch]
	{NEXT i}
	{CLEAR_VARIABLE spell_power_temp,spell_cost_temp}

    #resistances
    {VARIABLE current_unit.resistance.arcane $current_unit.variables.resistance.arcane}
    {VARIABLE current_unit.resistance.blade $current_unit.variables.resistance.blade}
    {VARIABLE current_unit.resistance.cold $current_unit.variables.resistance.cold}
    {VARIABLE current_unit.resistance.fire $current_unit.variables.resistance.fire}
    {VARIABLE current_unit.resistance.impact $current_unit.variables.resistance.impact}
    {VARIABLE current_unit.resistance.pierce $current_unit.variables.resistance.pierce}

    {VARIABLE temp_resistance.arcane $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].resistance.arcane}
    {VARIABLE temp_resistance.blade $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].resistance.blade}
    {VARIABLE temp_resistance.cold $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].resistance.cold}
    {VARIABLE temp_resistance.fire $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].resistance.fire}
    {VARIABLE temp_resistance.impact $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].resistance.impact}
    {VARIABLE temp_resistance.pierce $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].resistance.pierce}

    {VARIABLE_OP temp_resistance.arcane multiply -1}
    {VARIABLE_OP temp_resistance.blade multiply -1}
    {VARIABLE_OP temp_resistance.cold multiply -1}
    {VARIABLE_OP temp_resistance.fire multiply -1}
    {VARIABLE_OP temp_resistance.impact multiply -1}
    {VARIABLE_OP temp_resistance.pierce multiply -1}

    {VARIABLE_OP current_unit.resistance.arcane add $temp_resistance.arcane}
    {VARIABLE_OP current_unit.resistance.blade add $temp_resistance.blade}
    {VARIABLE_OP current_unit.resistance.cold add $temp_resistance.cold}
    {VARIABLE_OP current_unit.resistance.fire add $temp_resistance.fire}
    {VARIABLE_OP current_unit.resistance.impact add $temp_resistance.impact}
    {VARIABLE_OP current_unit.resistance.pierce add $temp_resistance.pierce}

    {VARIABLE temp_resistance.arcane $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id|].resistance.arcane}
    {VARIABLE temp_resistance.blade $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id|].resistance.blade}
    {VARIABLE temp_resistance.cold $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id|].resistance.cold}
    {VARIABLE temp_resistance.fire $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id|].resistance.fire}
    {VARIABLE temp_resistance.impact $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id|].resistance.impact}
    {VARIABLE temp_resistance.pierce $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id|].resistance.pierce}

    {VARIABLE_OP temp_resistance.arcane multiply -1}
    {VARIABLE_OP temp_resistance.blade multiply -1}
    {VARIABLE_OP temp_resistance.cold multiply -1}
    {VARIABLE_OP temp_resistance.fire multiply -1}
    {VARIABLE_OP temp_resistance.impact multiply -1}
    {VARIABLE_OP temp_resistance.pierce multiply -1}

    {VARIABLE_OP current_unit.resistance.arcane add $temp_resistance.arcane}
    {VARIABLE_OP current_unit.resistance.blade add $temp_resistance.blade}
    {VARIABLE_OP current_unit.resistance.cold add $temp_resistance.cold}
    {VARIABLE_OP current_unit.resistance.fire add $temp_resistance.fire}
    {VARIABLE_OP current_unit.resistance.impact add $temp_resistance.impact}
    {VARIABLE_OP current_unit.resistance.pierce add $temp_resistance.pierce}

    {VARIABLE temp_resistance.arcane $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id|].resistance.arcane}
    {VARIABLE temp_resistance.blade $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id|].resistance.blade}
    {VARIABLE temp_resistance.cold $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id|].resistance.cold}
    {VARIABLE temp_resistance.fire $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id|].resistance.fire}
    {VARIABLE temp_resistance.impact $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id|].resistance.impact}
    {VARIABLE temp_resistance.pierce $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id|].resistance.pierce}

    {VARIABLE_OP temp_resistance.arcane multiply -1}
    {VARIABLE_OP temp_resistance.blade multiply -1}
    {VARIABLE_OP temp_resistance.cold multiply -1}
    {VARIABLE_OP temp_resistance.fire multiply -1}
    {VARIABLE_OP temp_resistance.impact multiply -1}
    {VARIABLE_OP temp_resistance.pierce multiply -1}

    {VARIABLE_OP current_unit.resistance.arcane add $temp_resistance.arcane}
    {VARIABLE_OP current_unit.resistance.blade add $temp_resistance.blade}
    {VARIABLE_OP current_unit.resistance.cold add $temp_resistance.cold}
    {VARIABLE_OP current_unit.resistance.fire add $temp_resistance.fire}
    {VARIABLE_OP current_unit.resistance.impact add $temp_resistance.impact}
    {VARIABLE_OP current_unit.resistance.pierce add $temp_resistance.pierce}

    #terrain defense
    {VARIABLE temp_recoup 100}
    {VARIABLE_OP temp_recoup add -$current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id|].terrain_recoup}

    {CALCULATE_PC_DEFENSE unwalkable current_unit}
	{CALCULATE_PC_DEFENSE castle current_unit}
	{CALCULATE_PC_DEFENSE village current_unit}
	{CALCULATE_PC_DEFENSE shallow_water current_unit}
	{CALCULATE_PC_DEFENSE deep_water current_unit}
	{CALCULATE_PC_DEFENSE flat current_unit}
	{CALCULATE_PC_DEFENSE forest current_unit}
	{CALCULATE_PC_DEFENSE hills current_unit}
	{CALCULATE_PC_DEFENSE mountains current_unit}
	{CALCULATE_PC_DEFENSE swamp_water current_unit}
	{CALCULATE_PC_DEFENSE sand current_unit}
	{CALCULATE_PC_DEFENSE cave current_unit}
	{CALCULATE_PC_DEFENSE impassable current_unit}
	{CALCULATE_PC_DEFENSE frozen current_unit}
	{CALCULATE_PC_DEFENSE fungus current_unit}
	{CALCULATE_PC_DEFENSE reef current_unit}

    #movement costs
	
	[set_variables]
		name=current_unit.movement_costs
		mode=merge
		[value]
			unwalkable=$current_unit.variables.terrain.unwalkable.movement
		    castle=$current_unit.variables.terrain.castle.movement
		    village=$current_unit.variables.terrain.village.movement
		    shallow_water=$current_unit.variables.terrain.shallow_water.movement
		    deep_water=$current_unit.variables.terrain.deep_water.movement
		    flat=$current_unit.variables.terrain.flat.movement
		    forest=$current_unit.variables.terrain.forest.movement
		    hills=$current_unit.variables.terrain.hills.movement
		    mountains=$current_unit.variables.terrain.mountains.movement
		    swamp_water=$current_unit.variables.terrain.swamp_water.movement
		    sand=$current_unit.variables.terrain.sand.movement
		    cave=$current_unit.variables.terrain.cave.movement
		    impassable=$current_unit.variables.terrain.impassable.movement
		    frozen=$current_unit.variables.terrain.frozen.movement
		    fungus=$current_unit.variables.terrain.fungus.movement
		    reef=$current_unit.variables.terrain.reef.movement
		[/value]
	[/set_variables]
	
    #weapons

    #repair thunderstick if worn and tinker high enough
    {FOREACH current_unit.variables.inventory.weapons.ranged i}
    	[if]
    		[variable]
    			name=current_unit.variables.inventory.weapons.ranged[$i].name
    			equals="thunderstick"
    		[/variable]
    		[and]
    			[variable]
    				name=current_unit.variables.inventory.weapons.ranged[$i].damage
    				less_than=$current_unit.variables.inventory.weapons.ranged[$i].max_damage
    			[/variable]
    			[and]
    				[variable]
    					name=current_unit.variables.inventory.weapons.ranged[$i].level
    					less_than_equal_to=$current_unit.variables.abilities.thunderstick_tinker
    				[/variable]
    			[/and]
    		[/and]
    		[then]
    			{VARIABLE current_unit.variables.inventory.weapons.ranged[$i].damage $current_unit.variables.inventory.weapons.ranged[$i].max_damage}
    		[/then]
    	[/if]
    {NEXT i}

	
	#dual/triple wield and weapon modifiers
	[switch]
		variable=current_unit.variables.abilities.wield
		[case]
			value=1
			{MELEE_WEAPON_MODIFIERS 0 ("$current_unit.variables.inventory.weapons.equipped.id") current_unit}
			[if]
				[variable]
					name=current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id|].block_wield
					numerical_not_equals=1
				[/variable]
				[then]
					{MELEE_WEAPON_MODIFIERS 1 ("$current_unit.variables.inventory.weapons.equipped[1].id") current_unit}
				[/then]
			[/if]			
		[/case]
		[case]
			value=2
			{MELEE_WEAPON_MODIFIERS 0 ("$current_unit.variables.inventory.weapons.equipped.id") current_unit}
			{MELEE_WEAPON_MODIFIERS 1 ("$current_unit.variables.inventory.weapons.equipped[1].id") current_unit}
			[if]
				[variable]
					name=current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id|].block_wield
					numerical_not_equals=1
				[/variable]
				[then]
					{MELEE_WEAPON_MODIFIERS 2 ("$current_unit.variables.inventory.weapons.equipped[2].id") current_unit}
				[/then]
			[/if]
		[/case]
		[else]
			{MELEE_WEAPON_MODIFIERS 0 ("$current_unit.variables.inventory.weapons.equipped.id") current_unit}
		[/else]
	[/switch]
	[if]
		[variable]
			name=current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id|].block_ranged
			numerical_not_equals=1
		[/variable]
		[then]
			{RANGED_WEAPON_MODIFIERS ("$current_unit.variables.inventory.weapons.equipped[5].id") current_unit}
		[/then]
	[/if]

	

	#magic attacks

	{ATTACK_SPELL_MODIFIERS current_unit}
	{COLLAPSE_ATTACKS current_unit}

	
	
	#rage and berserk on first weapon only
	[if]
		[variable]
			name=current_unit.variables.abilities.rage
			numerical_equals=1
		[/variable]
		[and]
			[variable]
				name=current_unit.variables.abilities.berserk
				numerical_not_equals=1
			[/variable]
		[/and]
		[then]
			[set_variables]
				name=current_unit.attack.specials.berserk
				mode=append
				[value]
					id="rage"
					name="rage"
					description="Rage:
On offense, combat length with this weapon doubles."
					value=2
					active_on="offense"
				[/value]
			[/set_variables]
		[/then]
	[/if]
	[if]
		[variable]
			name=current_unit.variables.abilities.berserk
			numerical_equals=1
		[/variable]
		[then]
			[set_variables]
				name=current_unit.attack.specials.berserk
				mode=append
				[value]
					id="berserk"
					name="berserk"
					description="Berserk:
On offense, combat length with this weapon triples. On defense, combat length with this weapon doubles."
					value=3
					active_on="offense"
				[/value]
				[value]
					id="berserk"
					value=2
					active_on="defense"
				[/value]
			[/set_variables]
		[/then]
	[/if]
	
	
	
	{FOREACH current_unit.attack i}
	
		#slashdash
		[if]
			[variable]
				name=current_unit.variables.abilities.slashdash
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.slashdash
					equals=1
				[/variable]
			[/and]
			[then]
				{VARIABLE current_unit.attack[$i].slashdash 1}
				[switch]
					variable=current_unit.variables.abilities.slashdash
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="slashdash"
								name="slash&dash"
								description="Slash&Dash Level 1:
When used offensively, every two hits with this weapon grants 1 movement point."
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="slashdash"
								name="slash&dash"
								description="Slash&Dash Level 2:
When used offensively, every hit with this weapon grants 1 movement point."
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="slashdash"
								name="slash&dash"
								description="Slash&Dash Level 3:
When used offensively, every hit with this weapon grants 2 movement points."
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#marksman
		[if]
			[variable]
				name=current_unit.variables.abilities.marksman
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.marksman
					greater_than=0
				[/variable]
			[/and]
			[then]
				[switch]
					variable=current_unit.variables.abilities.marksman
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="marksman"
								name="marksman"
								description="Marksman Level 1:
When used offensively, this attack always has at least a 55% chance to hit."
								value=55
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="marksman"
								name="marksman"
								description="Marksman Level 2:
When used offensively, this attack always has at least a 60% chance to hit."
								value=60
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="marksman"
								name="marksman"
								description="Marksman Level 3:
When used offensively, this attack always has at least a 65% chance to hit."
								value=65
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#orcish marksman
		[if]
			[variable]
				name=current_unit.variables.abilities.marksman_thrown_light_blade
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].class
					equals=thrown_light_blade
				[/variable]
			[/and]
			[then]
				[switch]
					variable=current_unit.variables.abilities.marksman_thrown_light_blade
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="marksman"
								name="marksman"
								description="Marksman Level 1:
When used offensively, this attack always has at least a 50% chance to hit."
								value=50
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="marksman"
								name="marksman"
								description="Marksman Level 2:
When used offensively, this attack always has at least a 55% chance to hit."
								value=55
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="marksman"
								name="marksman"
								description="Marksman Level 3:
When used offensively, this attack always has at least a 60% chance to hit."
								value=60
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#goliath bane
		[if]
			[variable]
				name=current_unit.variables.abilities.goliath_bane
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.goliath_bane
					greater_than=0
				[/variable]
			[/and]
			[then]
				[switch]
					variable=current_unit.variables.abilities.goliath_bane
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.damage
							mode=append
							[value]
								id="goliath_bane"
								name="goliath bane"
								description="Goliath Bane Level 1:
10% damage bonus for each level of the enemy. Offense only."
								multiply=1.1
								active_on="offense"
								[filter_opponent]
									level=1
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.2
								active_on="offense"
								[filter_opponent]
									level=2
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.3
								active_on="offense"
								[filter_opponent]
									level=3
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.4
								active_on="offense"
								[filter_opponent]
									level=4
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.5
								active_on="offense"
								[filter_opponent]
									level=5
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.6
								active_on="offense"
								[filter_opponent]
									level=6
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.7
								active_on="offense"
								[filter_opponent]
									level=7
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.8
								active_on="offense"
								[filter_opponent]
									level=8
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.9
								active_on="offense"
								[filter_opponent]
									level=9
								[/filter_opponent]
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.damage
							mode=append
							[value]
								id="goliath_bane"
								name="goliath bane"
								description="Goliath Bane Level 2:
20% damage bonus for each level of the enemy. Offense only."
								multiply=1.2
								active_on="offense"
								[filter_opponent]
									level=1
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.4
								active_on="offense"
								[filter_opponent]
									level=2
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.6
								active_on="offense"
								[filter_opponent]
									level=3
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.8
								active_on="offense"
								[filter_opponent]
									level=4
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=2.0
								active_on="offense"
								[filter_opponent]
									level=5
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=2.2
								active_on="offense"
								[filter_opponent]
									level=6
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=2.4
								active_on="offense"
								[filter_opponent]
									level=7
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=2.6
								active_on="offense"
								[filter_opponent]
									level=8
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=2.8
								active_on="offense"
								[filter_opponent]
									level=9
								[/filter_opponent]
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.damage
							mode=append
							[value]
								id="goliath_bane"
								name="goliath bane"
								description="Goliath Bane Level 3:
30% damage bonus for each level of the enemy. Offense only."
								multiply=1.3
								active_on="offense"
								[filter_opponent]
									level=1
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.6
								active_on="offense"
								[filter_opponent]
									level=2
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=1.9
								active_on="offense"
								[filter_opponent]
									level=3
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=2.1
								active_on="offense"
								[filter_opponent]
									level=4
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=2.4
								active_on="offense"
								[filter_opponent]
									level=5
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=2.9
								active_on="offense"
								[filter_opponent]
									level=6
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=3.2
								active_on="offense"
								[filter_opponent]
									level=7
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=3.5
								active_on="offense"
								[filter_opponent]
									level=8
								[/filter_opponent]
							[/value]
							[value]
								id="goliath_bane"
								multiply=3.8
								active_on="offense"
								[filter_opponent]
									level=9
								[/filter_opponent]
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#ensnare
		[if]
			[variable]
				name=current_unit.variables.abilities.ensnare
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.ensnare
					greater_than=0
				[/variable]
			[/and]
			[then]
				{VARIABLE current_unit.attack[$i].ensnare 1}
				[switch]
					variable=current_unit.variables.abilities.ensnare
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="ensnare"
								name="ensnare"
								description="Ensnare Level 1:
Each successful strike with this weapon increases the chance to hit by 5%. Active on offense."
								add=0
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="ensnare"
								name="ensnare"
								description="Ensnare Level 2:
Each successful strike with this weapon increases the chance to hit by 10%. Active on offense."
								add=0
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="ensnare"
								name="ensnare"
								description="Ensnare Level 3:
Each successful strike with this weapon increases the chance to hit by 15%. Active on offense."
								add=0
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			[/then]
		[/if]
		[if]
			[variable]
				name=current_unit.variables.abilities.vine_ensnare
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.vine_ensnare
					greater_than=0
				[/variable]
			[/and]
			[then]
				{VARIABLE current_unit.attack[$i].ensnare 1}
				[switch]
					variable=current_unit.variables.abilities.vine_ensnare
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="ensnare"
								name="ensnare"
								description="Ensnare Level 1:
Each successful strike with this spell increases the chance to hit by 5%. Active on offense."
								add=0
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="ensnare"
								name="ensnare"
								description="Ensnare Level 2:
Each successful strike with this spell increases the chance to hit by 10%. Active on offense."
								add=0
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="ensnare"
								name="ensnare"
								description="Ensnare Level 3:
Each successful strike with this spell increases the chance to hit by 15%. Active on offense."
								add=0
								cumulative="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#point&pike
		[if]
			[variable]
				name=current_unit.variables.abilities.pointpike
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.pointpike
					greater_than=0
				[/variable]
			[/and]
			[then]
				{VARIABLE current_unit.attack[$i].pointpike 1}
				{VARIABLE pointpike_percent $current_unit.variables.abilities.pointpike}
				{VARIABLE_OP pointpike_percent multiply 10}
				[set_variables]
					name=current_unit.attack[$i].specials.chance_to_hit
					mode=append
					[value]
						id="pointpike"
						name="point&pike"
						description="Point&Pike Level $current_unit.variables.abilities.pointpike|:
Each miss with this weapon increases the chance to hit by $pointpike_percent|%, which is reset upon a successful hit. Active on offense."
						add=0
						cumulative="yes"
						active_on="offense"
					[/value]
					{POINTPIKE 10}
					{POINTPIKE 20}
					{POINTPIKE 30}
					{POINTPIKE 40}
					{POINTPIKE 50}
					{POINTPIKE 60}
					{POINTPIKE 70}
					{POINTPIKE 80}
					{POINTPIKE 90}
					{POINTPIKE 100}
				[/set_variables]
			[/then]
		[/if]
		
		#slows
		[if]
			[variable]
				name=current_unit.variables.abilities.vine_slows
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.vine_slows
					greater_than=0
				[/variable]
			[/and]
			[then]
				[set_variables]
					name=current_unit.attack[$i].specials.slow
					mode=append
					[value]
						id=slow
				        name= _ "slows"
				        description= _ "Slow:
This attack slows the target until it ends a turn. Slow halves the damage caused by attacks and the movement cost for a slowed unit is doubled. A unit that is slowed will feature a snail icon in its sidebar information when it is selected."
					[/value]
				[/set_variables]
			[/then]
		[/if]
		
		#storm
		[if]
			[variable]
				name=current_unit.variables.abilities.storm
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.storm
					greater_than=0
				[/variable]
				[and]
					[variable]
						name=current_unit.attack[$i].specials.berserk.id
						not_equals=rage
					[/variable]
					[and]
						[variable]
							name=current_unit.attack[$i].specials.berserk.id
							not_equals=berserk
						[/variable]
					[/and]
				[/and]
			[/and]
			[then]
				{VARIABLE storm_allow_normal $current_unit.attack[$i].number}
				[if]
					[variable]
						name=current_unit.variables.abilities.brutal
						greater_than=0
					[/variable]
					[then]
						{VARIABLE_OP storm_allow_normal add 1}
						{VARIABLE_OP storm_allow_normal divide 2}
					[/then]
				[/if]
				{VARIABLE_OP storm_allow_normal add 2}
				{VARIABLE_OP storm_allow_normal add -$current_unit.variables.abilities.storm}
				{VARIABLE storm_allow_firststrike $storm_allow_normal}
				{VARIABLE_OP storm_allow_firststrike add 1}
				[switch]
					variable=current_unit.variables.abilities.storm
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.attacks
							mode=append
							[value]
								id="storm"
								name="storm"
								description="Storm Level 1:
Enemy strikes will stop 2 strikes after this weapon's last strike."
								name_inactive="storm"
								description_inactive="Storm Level 1:
Enemy strikes will stop 2 strikes after this weapon's last strike."
								value=$storm_allow_normal
								cumulative=no
								active_on=offense
								apply_to=defender
								[filter_base_value]
									greater_than=$storm_allow_normal
								[/filter_base_value]
							[/value]
							[value]
								id="storm"
								value=$storm_allow_firststrike
								cumulative=no
								active_on=offense
								apply_to=defender
								[filter_defender]
									[filter_weapon]
										name=firststrike
									[/filter_weapon]
								[/filter_defender]
								[filter_base_value]
									greater_than=$storm_allow_normal
								[/filter_base_value]
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.attacks
							mode=append
							[value]
								id="storm"
								name="storm"
								description="Storm Level 2:
Enemy strikes will stop 1 strike after this weapon's last strike."
								name_inactive="storm"
								description_inactive="Storm Level 2:
Enemy strikes will stop 1 strike after this weapon's last strike."
								value=$storm_allow_normal
								cumulative=no
								active_on=offense
								apply_to=defender
								[filter_base_value]
									greater_than=$storm_allow_normal
								[/filter_base_value]
							[/value]
							[value]
								id="storm"
								value=$storm_allow_firststrike
								cumulative=no
								active_on=offense
								apply_to=defender
								[filter_defender]
									[filter_weapon]
										name=firststrike
									[/filter_weapon]
								[/filter_defender]
								[filter_base_value]
									greater_than=$storm_allow_normal
								[/filter_base_value]
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.attacks
							mode=append
							[value]
								id="storm"
								name="storm"
								description="Storm Level 3:
Enemy strikes will stop after this weapon's last strike."
								name_inactive="storm"
								description_inactive="Storm Level 3:
Enemy strikes will stop after this weapon's last strike."
								value=$storm_allow_normal
								cumulative=no
								active_on=offense
								apply_to=defender
								[filter_base_value]
									greater_than=$storm_allow_normal
								[/filter_base_value]
							[/value]
							[value]
								id="storm"
								value=$storm_allow_firststrike
								cumulative=no
								active_on=offense
								apply_to=defender
								[filter_defender]
									[filter_weapon]
										name=firststrike
									[/filter_weapon]
								[/filter_defender]
								[filter_base_value]
									greater_than=$storm_allow_normal
								[/filter_base_value]
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#brutal assault
		[if]
			[variable]
				name=current_unit.variables.abilities.brutal
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.storm
					greater_than=0
				[/variable]
				[and]
					[variable]
						name=current_unit.attack[$i].specials.berserk.id
						not_equals=rage
					[/variable]
					[and]
						[variable]
							name=current_unit.attack[$i].specials.berserk.id
							not_equals=berserk
						[/variable]
					[/and]
				[/and]
			[/and]
			[then]
				{VARIABLE brutal_damage $current_unit.attack[$i].damage}
				{VARIABLE_OP brutal_damage multiply 1.6}
				{VARIABLE_OP brutal_damage round 0}
				{VARIABLE brutal_number $current_unit.attack[$i].number}
				{VARIABLE_OP brutal_number add 1}
				{VARIABLE_OP brutal_number divide 2}
				[set_variables]
					name=current_unit.attack[$i].specials.damage
					mode=append
					[value]
						id="brutal_damage"
						name="brutal assault"
						description="Brutal Assault:
When attacking, deal 60% more damage per strike, but get half as many strikes."
						name_inactive="brutal assault"
						description_inactive="Brutal Assault:
When attacking, deal 60% more damage per strike, but get half as many strikes."
						value=$brutal_damage
						cumulative=no
						active_on=offense
						apply_to=self
					[/value]
				[/set_variables]
				[set_variables]
					name=current_unit.attack[$i].specials.attacks
					mode=append
					[value]
						id="brutal_number"
						value=$brutal_number
						cumulative=no
						active_on=offense
						apply_to=self
					[/value]
				[/set_variables]
			[/then]
		[/if]
		
		#readied bolt
		[if]
			[variable]
				name=current_unit.variables.abilities.readied_bolt
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.readied_bolt
					greater_than=0
				[/variable]
			[/and]
			[then]
				[set_variables]
					name=current_unit.attack[$i].specials.firststrike
					mode=append
					[value]
						id="readied bolt"
						name="readied bolt"
						description="Readied Bolt:
This attack always strikes first, even when defending."
					[/value]
				[/set_variables]
			[/then]
		[/if]
		
		#firststrike
		[if]
			[variable]
				name=current_unit.variables.abilities.firststrike
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.firststrike
					greater_than=0
				[/variable]
				[and]
					[variable]
						name=current_unit.abilities.skirmisher.id
						not_equals=skirmisher
					[/variable]
				[/and]
			[/and]
			[then]
				[set_variables]
					name=current_unit.attack[$i].specials.firststrike
					mode=append
					[value]
						id="firststrike"
						name="firststrike"
						description="First Strike:
This unit always strikes first with this attack, even if they are defending."
					[/value]
				[/set_variables]
			[/then]
		[/if]
		
		#backstab
		[if]
			[variable]
				name=current_unit.variables.abilities.backstab
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.backstab
					greater_than=0
				[/variable]
			[/and]
			[then]
				[switch]
					variable=current_unit.variables.abilities.backstab
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.damage
							mode=append
							[value]
								id="backstab"
								name="backstab"
								description="Backstab Level 1:
This attack deals double damage if there is an enemy of the target on the opposite side of the target, and that unit is not incapacitated (e.g. turned to stone). Active on offense."
								multiply=2
								backstab="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.damage
							mode=append
							[value]
								id="backstab"
								name="backstab"
								description="Backstab Level 2:
This attack deals 250% damage if there is an enemy of the target on the opposite side of the target, and that unit is not incapacitated (e.g. turned to stone). Active on offense."
								multiply=2.5
								backstab="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.damage
							mode=append
							[value]
								id="backstab"
								name="backstab"
								description="Backstab Level 3:
This attack deals triple damage if there is an enemy of the target on the opposite side of the target, and that unit is not incapacitated (e.g. turned to stone). Active on offense."
								multiply=3
								backstab="yes"
								active_on="offense"
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#target
		[if]
			[variable]
				name=current_unit.variables.abilities.target
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.backstab
					greater_than=0
				[/variable]
			[/and]
			[then]
				[switch]
					variable=current_unit.variables.abilities.target
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="target"
								name="target"
								description="Target Level 1:
This attack deals double damage but strikes are reduced by half. Always active."
							[/value]
						[/set_variables]
						{VARIABLE_OP current_unit.attack[$i].damage multiply 2}
						{VARIABLE_OP current_unit.attack[$i].number multiply .5}
						{VARIABLE_OP current_unit.attack[$i].number round ceil}
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="target"
								name="target"
								description="Target Level 1:
This attack deals 250% damage but strikes are reduced by half. Always active."
							[/value]
						[/set_variables]
						{VARIABLE_OP current_unit.attack[$i].damage multiply 2.5}
						{VARIABLE_OP current_unit.attack[$i].damage round ceil}
						{VARIABLE_OP current_unit.attack[$i].number multiply .5}
						{VARIABLE_OP current_unit.attack[$i].number round ceil}
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="target"
								name="target"
								description="Target Level 1:
This attack deals 300% damage but strikes are reduced by half. Always active."
							[/value]
						[/set_variables]
						{VARIABLE_OP current_unit.attack[$i].damage multiply 3}
						{VARIABLE_OP current_unit.attack[$i].number multiply .5}
						{VARIABLE_OP current_unit.attack[$i].number round ceil}
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#cleave
		[if]
			[variable]
				name=current_unit.variables.abilities.cleave
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.cleave
					greater_than=0
				[/variable]
			[/and]
			[then]
				{VARIABLE current_unit.attack[$i].cleave 1}
				[switch]
					variable=current_unit.variables.abilities.cleave
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="cleave"
								name="cleave"
								description="Cleave Level 1:
Enemy units adjacent to both units in attack with this weapon can take 1/8th of this weapon's damage. Terrain defense and resistances apply, chance to hit reduced to 1/2 normal. Active on offense."
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="cleave"
								name="cleave"
								description="Cleave Level 2:
Enemy units adjacent to both units in attack with this weapon can take 1/6th of this weapon's damage. Terrain defense and resistances apply, chance to hit reduced to 2/3 normal. Active on offense."
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="cleave"
								name="cleave"
								description="Cleave Level 3:
Enemy units adjacent to both units in attack with this weapon can take 1/4th of this weapon's damage. Terrain defense and resistances apply, chance to hit reduced to 3/4 normal. Active on offense."
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#riposte
		[if]
			[variable]
				name=current_unit.variables.abilities.riposte
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.riposte
					greater_than=0
				[/variable]
			[/and]
			[then]
				{VARIABLE current_unit.attack[$i].riposte 1}
				[switch]
					variable=current_unit.variables.abilities.riposte
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="riposte"
								name="riposte"
								name_inactive="riposte"
								description="Riposte Level 1:
If an enemy misses versus this attack, the returning attack will have at least a 60% chance to hit. Active on defense."
								description_inactive="Riposte Level 1:
If an enemy misses versus this attack, the returning attack will have at least a 60% chance to hit. Active on defense."
								value=60
								cumulative="yes"
								active_on=defense
								[filter_self]
									[filter_wml]
										[variables]
											right_of_way=1
										[/variables]
									[/filter_wml]
								[/filter_self]
							[/value]
						[/set_variables]
						{VARIABLE current_unit.attack[$i].defense_weight 1.6}
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="riposte"
								name="riposte"
								name_inactive="riposte"
								description="Riposte Level 2:
If an enemy misses versus this attack, the returning attack will have at least a 80% chance to hit. Active on defense."
								description_inactive="Riposte Level 2:
If an enemy misses versus this attack, the returning attack will have at least a 80% chance to hit. Active on defense."
								value=80
								cumulative="yes"
								active_on=defense
								[filter_self]
									[filter_wml]
										[variables]
											right_of_way=1
										[/variables]
									[/filter_wml]
								[/filter_self]
							[/value]
						[/set_variables]
						{VARIABLE current_unit.attack[$i].defense_weight 1.8}
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.chance_to_hit
							mode=append
							[value]
								id="riposte"
								name="riposte"
								name_inactive="riposte"
								description="Riposte Level 3:
If an enemy misses versus this attack, the returning attack will automatically hit. Active on defense."
								description_inactive="Riposte Level 3:
If an enemy misses versus this attack, the returning attack will automatically hit Active on defense."
								value=100
								cumulative="yes"
								active_on=defense
								[filter_self]
									[filter_wml]
										[variables]
											right_of_way=1
										[/variables]
									[/filter_wml]
								[/filter_self]
							[/value]
						[/set_variables]
						{VARIABLE current_unit.attack[$i].defense_weight 2}
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#remaining ammo
		[if]
			[variable]
				name=current_unit.variables.abilities.remaining_ammo_bow
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.remaining_ammo_bow
					greater_than=0
				[/variable]
			[/and]
			[or]
				[variable]
					name=current_unit.variables.abilities.remaining_ammo_javelin
					greater_than=0
				[/variable]
				[and]
					[variable]
						name=current_unit.attack[$i].special_type.remaining_ammo_javelin
						greater_than=0
					[/variable]
				[/and]
			[/or]
			[or]
				[variable]
					name=current_unit.variables.abilities.remaining_ammo_thrown_light_blade
					greater_than=0
				[/variable]
				[and]
					[variable]
						name=current_unit.attack[$i].special_type.remaining_ammo_thrown_light_blade
						greater_than=0
					[/variable]
				[/and]
			[/or]
			[or]
				[variable]
					name=current_unit.variables.abilities.remaining_ammo_thrown_heavy_blade
					greater_than=0
				[/variable]
				[and]
					[variable]
						name=current_unit.attack[$i].special_type.remaining_ammo_thrown_heavy_blade
						greater_than=0
					[/variable]
				[/and]
			[/or]
			[then]
				{VARIABLE current_unit.attack[$i].remaining_ammo 1}
				[switch]
					variable=current_unit.variables.abilities.remaining_ammo_$current_unit.attack[$i].class|
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="remaining_ammo"
								name="remaining ammo"
								description="Remaining Ammo Level 1:
If any ammo remains after killing a unit with this attack, then it may be used in another attack, minus one strike."
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="remaining_ammo"
								name="remaining ammo"
								description="Remaining Ammo Level 2:
If any ammo remains after killing a unit with this attack, then it may be used in another attack."
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="remaining_ammo"
								name="remaining ammo"
								description="Remaining Ammo Level 3:
If any ammo remains after killing a unit with this attack, then it may be used in another attack, plus one strike."
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#plague
		[if]
			[variable]
				name=current_unit.variables.abilities.plague
				numerical_equals=1
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.plague
					numerical_equals=1
				[/variable]
			[/and]
			[then]
				[set_variables]
					name=current_unit.attack[$i].specials.plague
					mode=append
					[value]
						id="plague"
						name="plague"
						description=_ "Plague:
When a unit is killed by a Plague attack, that unit is replaced with a Walking Corpse on the same side as the unit with the Plague attack. This doesn't work on Undead."
						type="Walking Corpse_MODRPG"
					[/value]
				[/set_variables]
			[/then]
		[/if]
		
		#soultrap
		[if]
			[variable]
				name=current_unit.variables.abilities.soultrap
				numerical_equals=1
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.soultrap
					numerical_equals=1
				[/variable]
			[/and]
			[then]
				[set_variables]
					name=current_unit.attack[$i].specials.plague
					mode=append
					[value]
						id="soultrap"
						name="soul trap"
						description=_ "Soul Trap:
When a unit is killed with a dagger embued with the power of Soul Trap, its spirit doesn't ascend to the next world but instead is trapped to serve its new master."
						type="Trapped Spirit"
					[/value]
				[/set_variables]
			[/then]
		[/if]
		[if]
			[variable]
				name=current_unit.variables.abilities.metal_to_arcane
				numerical_equals=1
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].material
					equals="metal"
				[/variable]
				[and]
					[variable]
						name=current_unit.attack[$i].range
						equals=melee
					[/variable]
				[/and]
			[/and]
			[then]
				{VARIABLE current_unit.attack[$i].type "arcane"}
			[/then]
		[/if]
		
		#bloodlust 
		[if] 
			[variable]
				name=current_unit.variables.abilities.bloodlust
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].range
					equals=melee
				[/variable]
				[and]
					[variable]
						name=current_unit.abilities.skirmisher.id
						not_equals=skirmisher
					[/variable]
				[/and]
			[/and]
			[then]
				{VARIABLE current_unit.attack[$i].bloodlust 1}
				[switch]
					variable=current_unit.variables.abilities.bloodlust
					[case]
						value=1
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="bloodlust"
								name="bloodlust"
								description=_ "Bloodlust Level 1:
If this attack kills the target on the first strike, this unit can attack again."
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=2
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="bloodlust"
								name="bloodlust"
								description=_ "Bloodlust Level 2:
If this attack kills the target within two strikes, this unit can attack again.
If this attack kills the target on the first strike, this unit also recovers one movement point."
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=3
						[set_variables]
							name=current_unit.attack[$i].specials.dummy
							mode=append
							[value]
								id="bloodlust"
								name="bloodlust"
								description=_ "Bloodlust Level 3:
If this attack kills the target within three strikes, this unit can attack again.
If this attack kills the target within two strikes, this unit also recovers one movement point."
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			[/then]
		[/if]
		
		#deadly grace
		[if]
			[variable]
				name=current_unit.variables.abilities.grace
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].range
					equals=melee
				[/variable]
				[and]
					[variable]
			            name=skirm_allow
			            numerical_equals=1
			        [/variable]
			        [and]
			            [variable]
			                name=add_evade
			                greater_than_equal_to=0
			            [/variable]
			            [and]
			                [variable]
			                    name=current_unit.variables.abilities.dash
			                    greater_than=0
			                [/variable]
			            [/and]
			        [/and]
				[/and]
			[/and]
			[then]
				{VARIABLE current_unit.attack[$i].grace 1}
				[set_variables]
					name=current_unit.attack[$i].specials.dummy
					mode=append
					[value]
						id="grace"
						name="deadly grace"
						description=_ "Deadly Grace:
If this unit avoids all defending strikes while using this attack, it can attack again.

NOTE: The defending unit must have the chance to strike at least one time for special to trigger."
					[/value]
				[/set_variables]
			[/then]
		[/if]
	
		#poison weapon special
		[if]
			[variable]
				name=current_unit.variables.abilities.poison_thrown_light_blade
				numerical_equals=1
			[/variable]
			[or]
				[variable]
					name=current_unit.variables.abilities.poison_thrown_light_blade_orc
					numerical_equals=1
				[/variable]
			[/or]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.allow_poison
					numerical_equals=1
				[/variable]
				[and]
					[variable]
						name=current_unit.attack[$i].class
						equals=thrown_light_blade
					[/variable]
				[/and]
			[/and]
			[then]
				{VARIABLE current_unit.attack[$i].specials.poison.id "poison"}
				{VARIABLE current_unit.attack[$i].specials.poison.name "poison"}
				{VARIABLE current_unit.attack[$i].specials.poison.description "Poison:
This attack poisons living targets. Poisoned units lose 8 HP every turn until they are cured or are reduced to 1 HP. Poison can not, of itself, kill a unit."}
				{VARIABLE current_unit.attack[$i].icon "attacks/dagger-thrown-poison-human.png"}
			[/then]
		[/if]
		
		#magical weapon special
		[if]
			[variable]
				name=current_unit.attack[$i].special_type.magical_to_hit
				greater_than=0
			[/variable]
			[then]
				{VARIABLE current_unit.attack[$i].specials.chance_to_hit.id "magical"}
				{VARIABLE current_unit.attack[$i].specials.chance_to_hit.name "magical"}
				{VARIABLE current_unit.attack[$i].specials.chance_to_hit.description "Magical:
This attack always has a 70% chance to hit regardless of the defensive ability of the unit being attacked."}
				{VARIABLE current_unit.attack[$i].specials.chance_to_hit.value 70}
				{VARIABLE current_unit.attack[$i].specials.chance_to_hit.cumulative "no"}
			[/then]
		[/if]
	{NEXT i}
	
	#fire shot
	{FOREACH current_unit.attack i}
		[if]
			[variable]
				name=current_unit.variables.abilities.fire_shot_bow
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].special_type.fire_shot_bow
					greater_than=0
				[/variable]
			[/and]
			[or]
				[variable]
					name=current_unit.variables.abilities.fire_shot_xbow
					greater_than=0
				[/variable]
				[and]
					[variable]
						name=current_unit.attack[$i].special_type.fire_shot_xbow
						greater_than=0
					[/variable]
				[/and]
			[/or]
			[then]
				[set_variables]
					name=current_unit.attack
					mode=append
					to_variable=current_unit.attack[$i]
				[/set_variables]
				{VARIABLE temp_length $current_unit.attack.length}
				{VARIABLE_OP temp_length add -1}
				{VARIABLE current_unit.attack[$temp_length].type fire}
				{VARIABLE_OP current_unit.attack[$temp_length].damage add 2}
				{VARIABLE_OP current_unit.attack[$temp_length].number add -1}
				{VARIABLE current_unit.attack[$temp_length].special_type.fire_shot_bow 0}
				{VARIABLE current_unit.attack[$temp_length].special_type.fire_shot_xbow 0}
			[/then]
		[/if]
	{NEXT i}
	
	#apply variation of whatever weapon is strongest
	{VARIABLE power_check 0}
	{FOREACH current_unit.attack i}
		[if]
			[variable]
				name=current_unit.attack[$i].name
				not_equals="magic missile"
			[/variable]
			[and]
				[variable]
					name=current_unit.attack[$i].name
					not_equals="fireball"
				[/variable]
				[and]
					[variable]
						name=current_unit.attack[$i].name
						not_equals="lightbeam"
					[/variable]
					[and]
						[variable]
							name=current_unit.attack[$i].name
							not_equals="lightning"
						[/variable]
						[and]
							[variable]
								name=current_unit.attack[$i].name
								not_equals="dark wave"
							[/variable]
							[and]
								[variable]
									name=current_unit.attack[$i].name
									not_equals="faerie fire"
								[/variable]
								[and]
									[variable]
										name=current_unit.attack[$i].name
										not_equals="flame blast"
									[/variable]
									[and]
										[variable]
											name=current_unit.attack[$i].name
											not_equals="vines"
										[/variable]
										[and]
											[variable]
												name=current_unit.attack[$i].name
												not_equals="curse"
											[/variable]
										[/and]
									[/and]
								[/and]
							[/and]
						[/and]
					[/and]
				[/and]
			[/and]
			[then]
				{VARIABLE power_check2 $current_unit.attack[$i].damage}
				{VARIABLE_OP power_check2 multiply $current_unit.attack[$i].number}
				[if]
					[variable]
						name=power_check2
						greater_than_equal_to=$power_check
					[/variable]
					[then]
						{VARIABLE appear_number $i}
						{VARIABLE power_check $power_check2}
					[/then]
				[/if]
			[/then]
		[/if]
	{NEXT i}
	{VARIABLE current_unit.variation $current_unit.attack[$appear_number].name}
	
	#here images are poked into "new animation" based on the weapon wielded
	[if]
		[variable]
			name=current_unit.race
			equals=human
		[/variable]
		[then]
			#magic missile
			{VARIABLE current_unit.modifications.object[$e].effect.attack_anim.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object[$e].effect.attack_anim.if.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object[$e].effect.attack_anim.else.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object[$e].effect.attack_anim.frame[1].image "units/human/$current_unit.variation|.png"}
			#fireball
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame.image "units/human/$current_unit.variation|.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame[1].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame[2].image "units/human/$current_unit.variation|.png"}
			#dark wave
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame.image "units/human/$current_unit.variation|.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[1].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[2].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.if.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.else.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[3].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[4].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[5].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[6].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[7].image "units/human/$current_unit.variation|.png"}
			#lightbeam
			{VARIABLE current_unit.modifications.object.effect[3].attack_anim.frame.image "units/human/$current_unit.variation|.png"}
			{VARIABLE current_unit.modifications.object.effect[3].attack_anim.frame[1].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[3].attack_anim.frame[2].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[3].attack_anim.if.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[3].attack_anim.else.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[3].attack_anim.frame[3].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[3].attack_anim.frame[4].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[3].attack_anim.frame[5].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[3].attack_anim.frame[6].image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[3].attack_anim.frame[7].image "units/human/$current_unit.variation|.png"}
			#lightning 1 2 3
			{VARIABLE current_unit.modifications.object.effect[4].attack_anim.if.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[4].attack_anim.else.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[4].attack_anim.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[4].attack_anim.frame[1].image "units/human/$current_unit.variation|.png"}			
			{VARIABLE current_unit.modifications.object.effect[5].attack_anim.if.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[5].attack_anim.else.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[5].attack_anim.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[5].attack_anim.frame[1].image "units/human/$current_unit.variation|.png"}			
			{VARIABLE current_unit.modifications.object.effect[6].attack_anim.if.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[6].attack_anim.else.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[6].attack_anim.frame.image "units/human/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[6].attack_anim.frame[1].image "units/human/$current_unit.variation|.png"}			
		[/then]
	[/if]
	[if]
		[variable]
			name=current_unit.race
			equals=elf
		[/variable]
		[then]
			#faerie fire hit miss
			{VARIABLE current_unit.modifications.object.effect.attack_anim.frame.image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect.attack_anim.frame[1].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect.attack_anim.frame[2].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect.attack_anim.frame[3].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect.attack_anim.frame[4].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect.attack_anim.frame[5].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect.attack_anim.frame[6].image "units/elf/$current_unit.variation|.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame.image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame[1].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame[2].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame[3].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame[4].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame[5].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame[6].image "units/elf/$current_unit.variation|.png"}
			#vines
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame.image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[1].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[2].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[3].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[4].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[5].image "units/elf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[6].image "units/elf/$current_unit.variation|.png"}
		[/then]
	[/if]
	[if]
		[variable]
			name=current_unit.race
			equals=dwarf
		[/variable]
		[then]
			#lightning 1 2 3
			{VARIABLE current_unit.modifications.object.effect.attack_anim.if.frame.image "units/dwarf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect.attack_anim.else.frame.image "units/dwarf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect.attack_anim.frame.image "units/dwarf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect.attack_anim.frame[1].image "units/dwarf/$current_unit.variation|.png"}			
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.if.frame.image "units/dwarf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.else.frame.image "units/dwarf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame.image "units/dwarf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[1].attack_anim.frame[1].image "units/dwarf/$current_unit.variation|.png"}			
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.if.frame.image "units/dwarf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.else.frame.image "units/dwarf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame.image "units/dwarf/$current_unit.variation|-special.png"}
			{VARIABLE current_unit.modifications.object.effect[2].attack_anim.frame[1].image "units/dwarf/$current_unit.variation|.png"}			
		[/then]
	[/if]
	[if]
		[variable]
			name=current_unit.race
			equals=troll
		[/variable]
		[then]
			#flame blast
			{VARIABLE current_unit.modifications.object.effect.attack_anim.frame.image "units/troll/$current_unit.variation|-special.png"}
		[/then]
	[/if]
	[if]
		[variable]
			name=current_unit.race
			equals=orc
		[/variable]
		[then]
			#flame blast
			{VARIABLE current_unit.modifications.object.effect.attack_anim.frame.image "units/orc/$current_unit.variation|-special.png"}
		[/then]
	[/if]
	
	#new replacement for remaining ammo cleanup and attack number assignment
	{VARIABLE unblocked_check 1}
	{VARIABLE_OP unblocked_check add -$current_unit.variables.blocked_attacks}
	{FOREACH current_unit.attack i}
		{VARIABLE current_unit.attack[$i].attack_number $i}
		[if]
			[variable]
				name=current_unit.variables.blocked_attacks
				numerical_equals=1
			[/variable]
			[then]
				[if]
					[variable]
						name=current_unit.attack[$i].class
						equals=$current_unit.variables.weapon_block_class
					[/variable]
					[or]
						[variable]
							name=current_unit.attack[$i].$current_unit.variables.weapon_block_class
							greater_than=0
						[/variable]
					[/or]
					[then]
						[if]
							[variable]
								name=current_unit.variables.ammo_stored
								greater_than_equal_to=0
							[/variable]
							[then]
								{VARIABLE current_unit.variables.base_ammo $current_unit.attack[$i].number}
								[if]
									[variable]
										name=current_unit.variables.current_ammo
										greater_than=$current_unit.variables.base_ammo
									[/variable]
									[then]
										{VARIABLE current_unit.variables.current_ammo $current_unit.variables.base_ammo}
									[/then]
									[else]
										{VARIABLE current_unit.attack[$i].number $current_unit.variables.current_ammo}
									[/else]
								[/if]
								{VARIABLE current_unit.variables.ammo_stored $i}
							[/then]
						[/if]
						{VARIABLE_OP unblocked_check add 1}
					[/then]
					[else]
						{VARIABLE current_unit.attack[$i].attack_weight 0}
					[/else]
				[/if]
			[/then]
		[/if]
	{NEXT i}
	[if]
		[variable]
			name=unblocked_check
			numerical_equals=0
		[/variable]
		[then]
			{VARIABLE current_unit.attacks_left 0}
		[/then]
	[/if]
    [unstore_unit]
        variable=current_unit
    [/unstore_unit]
	#this refreshes the side bar values and image
	[object]
		[filter]
			x,y=$current_unit.x,$current_unit.y
		[/filter]
		silent=yes
		[effect]
			apply_to=status
			remove=aids
		[/effect]
	[/object]
[/event] 