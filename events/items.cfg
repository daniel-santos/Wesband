{SIMPLE_ACTION_EVENT potion_healing POTION_HEALING_EFFECT POTION_HEALING_SETUP}
{SIMPLE_ACTION_EVENT potion_protection_armor POTION_PROTECTION_ARMOR_EFFECT POTION_PROTECTION_ARMOR_SETUP}
{SIMPLE_ACTION_EVENT potion_protection_poison POTION_PROTECTION_POISON_EFFECT POTION_PROTECTION_POISON_SETUP}
{SIMPLE_ACTION_EVENT potion_phoenix_fire POTION_PHOENIX_FIRE_EFFECT POTION_PHOENIX_FIRE_SETUP}
{SIMPLE_ACTION_EVENT potion_detect_units POTION_DETECT_UNITS_EFFECT POTION_DETECT_UNITS_SETUP}
{SIMPLE_ACTION_EVENT potion_improved_detect_units POTION_IMPROVED_DETECT_UNITS_EFFECT POTION_IMPROVED_DETECT_UNITS_SETUP}

{COMPLEX_ACTION_EVENT scroll_detect_gold SCROLL_DETECT_GOLD_EFFECT SCROLL_DETECT_GOLD_SETUP}
{COMPLEX_ACTION_EVENT scroll_summon_fire_elemental SCROLL_SUMMON_FIRE_ELEMENTAL_EFFECT SCROLL_SUMMON_FIRE_ELEMENTAL_SETUP}
{COMPLEX_ACTION_EVENT scroll_summon_water_elemental SCROLL_SUMMON_WATER_ELEMENTAL_EFFECT SCROLL_SUMMON_WATER_ELEMENTAL_SETUP}
{COMPLEX_ACTION_EVENT scroll_summon_earth_elemental SCROLL_SUMMON_EARTH_ELEMENTAL_EFFECT SCROLL_SUMMON_EARTH_ELEMENTAL_SETUP}
{COMPLEX_ACTION_EVENT scroll_summon_air_elemental SCROLL_SUMMON_AIR_ELEMENTAL_EFFECT SCROLL_SUMMON_AIR_ELEMENTAL_SETUP}
{COMPLEX_ACTION_EVENT scroll_mapping SCROLL_MAPPING_EFFECT SCROLL_MAPPING_SETUP}

[event]
    name=create_weapon
    first_time_only=no
    #requires new_weapon_rank to be set
    #need to set if random or predetermined
	[if]
        [variable]
            name=random_weapon_type
            numerical_equals=1
        [/variable]
        [then]
			{PROB_LIST_RANDOM $new_weapon_path}
			{VARIABLE new_weapon_type $random}
        [/then]
    [/if]
    [if]
        [variable]
            name=random_weapon_attribute
            numerical_equals=1
        [/variable]
        [then]
            {VARIABLE_OP new_weapon_attribute rand "rusty,unbalanced,none,none,none,none,none,none,heavy,sharp,light,balanced"}
        [/then]
    [/if]
    {VARIABLE random_weapon_type 0}
    {VARIABLE random_weapon_attribute 0}
	
    [switch]
        variable=new_weapon_type
        [case]
            value=dagger
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="dagger"
                    user_name="dagger"
                    description=_ "dagger"
                    icon="dagger-human"
                    ground_icon="dagger"
                    range="melee"
                    type="blade"
                    class="light_blade"
                    class_description="Light Blade"
                    damage=4
                    number=2
                    body_damage_rate=5
                    deft_damage_rate=15
					body_number_rate=0
                    deft_number_rate=10
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    [special_type]
                        backstab=1
                        skirm=1
						soultrap=1
                    [/special_type]
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=club
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="mace"
                    user_name="club"
                    description=_ "club"
                    icon="club-small"
                    ground_icon="club"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=3
                    number=2
                    body_damage_rate=15
                    deft_damage_rate=5
                    deft_number_rate=5
                    body_number_rate=5
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="wood"
					[special_type]
						storm=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=sword
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="sword"
                    user_name="sword"
                    description=_ "sword"
                    icon="sword-human"
                    ground_icon="sword"
                    range="melee"
                    type="blade"
                    class="heavy_blade"
                    class_description="Heavy Blade"
                    damage=7
                    number=2
                    body_damage_rate=15
                    deft_damage_rate=5
                    deft_number_rate=5
                    body_number_rate=5
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="metal"
					[special_type]
						cleave=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=scimitar
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="sword"
                    user_name="sword"
                    description=_ "scimitar"
                    icon="sword-elven"
                    ground_icon="sword"
                    range="melee"
                    type="blade"
                    class="heavy_blade"
                    class_description="Heavy Blade"
                    damage=7
                    number=2
                    body_damage_rate=5
                    deft_damage_rate=15
                    deft_number_rate=5
                    body_number_rate=5
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="metal"
					[special_type]
						cleave=1
						skirm=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=saber
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="sword"
                    user_name="saber"
                    description=_ "saber"
                    icon="saber-human"
                    ground_icon="saber"
                    range="melee"
                    type="blade"
                    class="light_blade"
                    class_description="Light Blade"
                    damage=6
                    number=2
                    body_damage_rate=5
                    deft_damage_rate=15
					body_number_rate=0
                    deft_number_rate=10
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    [special_type]
                        skirm=1
						riposte=1
						slashdash=1
                    [/special_type]
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
		[case]
            value=epee
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="sword"
                    user_name="epee"
                    description=_ "epee"
                    icon="saber-human"
                    ground_icon="saber"
                    range="melee"
                    type="pierce"
                    class="light_blade"
                    class_description="Light Blade"
                    damage=4
                    number=2
                    body_damage_rate=5
                    deft_damage_rate=15
					body_number_rate=0
                    deft_number_rate=10
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    [special_type]
                        skirm=1
						riposte=1
						slashdash=1
                    [/special_type]
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=mace
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="mace"
                    user_name="mace"
                    description=_ "mace"
                    icon="mace"
                    ground_icon="mace"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=11
                    number=1
                    body_damage_rate=40
					deft_damage_rate=0
					body_number_rate=5
					deft_number_rate=0
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="metal"
					[special_type]
						storm=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=hammer
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="mace"
                    user_name="hammer"
                    description=_ "hammer"
                    icon="hammer-dwarven"
                    ground_icon="hammer-runic"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=11
                    number=1
                    body_damage_rate=30
                    deft_damage_rate=10
                    body_number_rate=5
					deft_number_rate=0
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="metal"
					[special_type]
						storm=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=runic_hammer
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="magestaff"
                    user_name="hammer"
                    description=_ "runic hammer"
                    icon="hammer-dwarven-runic"
                    ground_icon="hammer-runic"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=7
                    number=1
                    body_damage_rate=30
                    deft_damage_rate=10
                    body_number_rate=5
					deft_number_rate=0
                    material="metal"
                    runic_magic_adjust=20
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					spirit_magic_adjust=0
					[special_type]
						storm=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=faerie_staff
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="magestaff"
                    user_name="magestaff"
                    description=_ "faerie staff"
                    icon="staff-elven"
                    ground_icon="magestaff"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=7
                    number=1
                    body_damage_rate=30
                    deft_damage_rate=10
                    deft_number_rate=5
                    body_number_rate=0
                    faerie_magic_adjust=10
					human_magic_adjust=0
					dark_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="wood"
					[special_type]
						storm=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=spear
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="spear"
                    user_name="spear"
                    description=_ "spear"
                    icon="spear"
                    ground_icon="spear-fancy"
                    range="melee"
                    type="pierce"
                    class="polearm"
                    class_description="Polearm"
                    damage=7
                    number=2
                    body_damage_rate=10
                    deft_damage_rate=10
                    deft_number_rate=5
                    body_number_rate=5
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    [special_type]
						skirm=1
                        throwable=1
                        firststrike=1
						pointpike=1
                    [/special_type]
                    material="metal"
                    [thrown]
                        name="javelin"
                        user_name="javelin"
                        description=_ "thrown spear"
                        icon="javelin-human"
                        range="ranged"
                        type="pierce"
                        class="javelin"
                        class_description="Javelin"
                        damage=5
                        number=1
                        body_damage_rate=20
                        deft_damage_rate=20
						deft_number_rate=5
						body_number_rate=0
						[special_type]
							remaining_ammo_javelin=1
	                    [/special_type]
                    [/thrown]
                [/value]
            [/set_variables]
        [/case]
		[case]
            value=pike
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="spear"
                    user_name="pike"
                    description=_ "pike"
                    icon="pike"
                    ground_icon="spear-fancy"
                    range="melee"
                    type="pierce"
                    class="polearm"
                    class_description="Polearm"
                    damage=9
                    number=2
                    body_damage_rate=10
                    deft_damage_rate=10
                    deft_number_rate=5
                    body_number_rate=5
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    [special_type]
                        ensnare=1
                        firststrike=1
						pointpike=1
                    [/special_type]
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=axe
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="axe"
                    user_name="axe"
                    description=_ "axe"
                    icon="axe"
                    ground_icon="axe"
                    range="melee"
                    type="blade"
                    class="heavy_blade"
                    class_description="Heavy Blade"
                    damage=11
                    number=1
                    body_damage_rate=30
                    deft_damage_rate=10
                    body_number_rate=5
					deft_number_rate=0
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="metal"
					[special_type]
						cleave=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=sling
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="lob"
                    user_name="sling"
                    description=_ "sling"
                    icon="sling"
                    ground_icon="sling"
                    range="ranged"
                    type="impact"
                    class="lob"
                    class_description="Lob"
                    damage=3
                    number=1
                    body_damage_rate=20
                    deft_damage_rate=20
					body_number_rate=0
                    deft_number_rate=5
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="cloth"
					[special_type]
						goliath_bane=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=thrown_dagger
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="thrown-light-blade"
                    user_name="dagger_thrown"
                    description=_ "thrown dagger"
                    icon="dagger-thrown-human"
                    ground_icon="dagger"
                    range="ranged"
                    type="blade"
                    class="thrown_light_blade"
                    class_description="Thrown Light Blade"
                    damage=2
                    number=2
                    [special_type]
                        allow_poison=1
						remaining_ammo_thrown_light_blade=1
                    [/special_type]
                    body_damage_rate=5
                    deft_damage_rate=15
					body_number_rate=0
                    deft_number_rate=10
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
		[case]
            value=dart
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="thrown-light-blade"
                    user_name="dagger_thrown"
                    description=_ "dart"
                    icon="dagger-thrown-human"
                    ground_icon="dagger"
                    range="ranged"
                    type="pierce"
                    class="thrown_light_blade"
                    class_description="Thrown Light Blade"
                    damage=2
                    number=2
                    [special_type]
                        allow_poison=1
						remaining_ammo_thrown_light_blade=1
                    [/special_type]
                    body_damage_rate=5
                    deft_damage_rate=15
					body_number_rate=0
                    deft_number_rate=10
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="metal"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=javelin
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="javelin"
                    user_name="javelin"
                    description=_ "javelin"
                    icon="javelin-human"
                    ground_icon="spear-fancy"
                    range="ranged"
                    type="pierce"
                    class="javelin"
                    class_description="Javelin"
                    damage=7
                    number=1
                    body_damage_rate=20
                    deft_damage_rate=20
                    deft_number_rate=5
                    body_number_rate=0
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="metal"
					[special_type]
						remaining_ammo_javelin=1
                    [/special_type]
                [/value]
            [/set_variables]
        [/case]
		[case]
            value=hatchet
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="lob"
                    user_name="hatchet"
                    description=_ "thrown hatchet"
                    icon="hatchet"
                    ground_icon="axe"
                    range="ranged"
                    type="blade"
                    class="thrown_heavy_blade"
                    class_description="Thrown Heavy Blade"
                    damage=7
                    number=1
                    body_damage_rate=20
                    deft_damage_rate=20
                    deft_number_rate=5
                    body_number_rate=0
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="metal"
					[special_type]
						remaining_ammo_thrown_heavy_blade=1
                    [/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=bow
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="bow"
                    user_name="bow"
                    description=_ "bow"
                    icon="bow"
                    ground_icon="bow"
                    range="ranged"
                    type="pierce"
                    class="bow"
                    class_description="Bow"
                    damage=4
                    number=2
					body_damage_rate=0
					body_number_rate=0
                    deft_damage_rate=20
                    deft_number_rate=10
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    [special_type]
                        marksman=1
						fire_shot_bow=1
						remaining_ammo_bow=1
                    [/special_type]
                    material="wood"
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=crossbow
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
                    name="crossbow"
                    user_name="crossbow"
                    description=_ "crossbow"
                    icon="crossbow-human"
                    ground_icon="crossbow"
                    range="ranged"
                    type="pierce"
                    class="crossbow"
                    class_description="Crossbow"
                    damage=7
                    number=1
					body_damage_rate=0
					body_number_rate=0
                    deft_number_rate=0
                    deft_damage_rate=20
					human_magic_adjust=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="wood"
					[special_type]
						readied_bolt=1
						fire_shot_xbow=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=magestaff
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="magestaff"
                    user_name="magestaff"
                    description=_ "magestaff"
                    icon="staff-magic"
                    ground_icon="magestaff"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=7
                    number=1
                    body_damage_rate=30
                    deft_damage_rate=10
                    human_magic_adjust=20
                    deft_number_rate=5
                    body_number_rate=0
					dark_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    material="wood"
					[special_type]
						storm=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value=necrostaff
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="magestaff"
                    user_name="necrostaff"
                    description=_ "necromancer staff"
                    icon="staff-necromantic"
                    ground_icon="magestaff"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=7
                    number=1
                    body_damage_rate=30
                    deft_damage_rate=10
                    deft_number_rate=5
                    body_number_rate=0
					human_magic_adjust=0
					dark_magic_adjust=15
					faerie_magic_adjust=0
					runic_magic_adjust=0
					spirit_magic_adjust=0
                    [special_type]
                        plague=1
						storm=1
                    [/special_type]
                    material="wood"
                [/value]
            [/set_variables]
        [/case]
		[case]
            value=spirit_staff
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="melee_weapon"
                    name="magestaff"
                    user_name="spirit_staff"
                    description=_ "spirit staff"
                    icon="staff-magic"
                    ground_icon="magestaff"
                    range="melee"
                    type="impact"
                    class="bludgeon"
                    class_description="Bludgeon"
                    damage=7
                    number=1
                    body_damage_rate=30
                    deft_damage_rate=10
                    spirit_magic_adjust=20
                    deft_number_rate=5
                    body_number_rate=0
					dark_magic_adjust=0
					human_magic_adjust=0
					faerie_magic_adjust=0
					runic_magic_adjust=0
                    material="wood"
					[special_type]
						storm=1
					[/special_type]
                [/value]
            [/set_variables]
        [/case]
		[case]
            value=thunderstick
            [set_variables]
                name=new_weapon
                mode=replace
                [value]
                    category="ranged_weapon"
					name="thunderstick"
					user_name="thunderstick"
					description=_ "thunderstick"
					ground_icon="thunderstick"
					icon="thunderstick"
					class="none"
					class_description="None"
					range=ranged
					type=pierce
					damage=22
					number=1
					max_damage=22
					level=1
					material="composite"
                [/value]
            [/set_variables]
        [/case]
    [/switch]
	{VARIABLE new_weapon.prob_name $new_weapon_type}
    {VARIABLE weapon_user_name_temp "$new_weapon.description|"}
	
	#apply rank
	{VARIABLE new_weapon_rank_frac $new_weapon_rank}
	{VARIABLE_OP new_weapon_rank_frac multiply .1}
	{VARIABLE_OP new_weapon_rank_frac round 0}
	{VARIABLE_OP new_weapon_rank divide 3}
	{VARIABLE_OP new_weapon_rank multiply 1.25}
	{VARIABLE_OP new_weapon_rank round 0}
	[if]
		[variable]
			name=new_weapon_rank_frac
			greater_than=1
		[/variable]
		[then]
			[if]
		        [variable]
		            name=new_weapon.runic_magic_adjust
		            greater_than=0
		        [/variable]
		        [then]
                    {VARIABLE_OP new_weapon.runic_magic_adjust multiply $new_weapon_rank_frac}
		        [/then]
				[else]
					{VARIABLE new_weapon.runic_magic_adjust 0}
				[/else]
		    [/if]
		    [if]
		        [variable]
		            name=new_weapon.faerie_magic_adjust
		            greater_than=0
		        [/variable]
		        [then]
                    {VARIABLE_OP new_weapon.faerie_magic_adjust multiply $new_weapon_rank_frac}
		        [/then]
				[else]
					{VARIABLE new_weapon.faerie_magic_adjust 0}
				[/else]
		    [/if]
		    [if]
		        [variable]
		            name=new_weapon.dark_magic_adjust
		            greater_than=0
		        [/variable]
		        [then]
                    {VARIABLE_OP new_weapon.dark_magic_adjust multiply $new_weapon_rank_frac}
		        [/then]
				[else]
					{VARIABLE new_weapon.dark_magic_adjust 0}
				[/else]
		    [/if]
		    [if]
		        [variable]
		            name=new_weapon.human_magic_adjust
		            greater_than=0
		        [/variable]
		        [then]
                    {VARIABLE_OP new_weapon.human_magic_adjust multiply $new_weapon_rank_frac}
		        [/then]
				[else]
					{VARIABLE new_weapon.human_magic_adjust 0}
				[/else]
		    [/if]
			[if]
		        [variable]
		            name=new_weapon.spirit_magic_adjust
		            greater_than=0
		        [/variable]
		        [then]
                    {VARIABLE_OP new_weapon.spirit_magic_adjust multiply $new_weapon_rank_frac}
		        [/then]
				[else]
					{VARIABLE new_weapon.spirit_magic_adjust 0}
				[/else]
		    [/if]
		    [switch]
		        variable=new_weapon.number
		        [case]
		            value=0
		            {VARIABLE_OP new_weapon_rank multiply 2}
		            {VARIABLE_OP new_weapon.damage add $new_weapon_rank}
		        [/case]
		        [case]
		            value=1
		            {VARIABLE_OP new_weapon_rank multiply 2}
		            {VARIABLE_OP new_weapon.damage add $new_weapon_rank}
		        [/case]
		        [else]
		            {VARIABLE new_weapon_number $new_weapon_rank}
		            {VARIABLE new_weapon_itt 0}
		            [while]
		                [variable]
		                    name=new_weapon_number
		                    greater_than=0
		                [/variable]
		                [do]
		                    {VARIABLE_OP new_weapon_itt add 1}
		                    [if]
		                        [variable]
		                            name=new_weapon_itt
		                            numerical_equals=4
		                        [/variable]
		                        [then]
		                            {VARIABLE_OP new_weapon.number add 1}
		                            {VARIABLE new_weapon_itt 0}
		                        [/then]
		                        [else]
		                            {VARIABLE_OP new_weapon.damage add 1}
		                        [/else]
		                    [/if]
							{VARIABLE_OP new_weapon_number add -1}
		                [/do]
		            [/while]
		        [/else]
		    [/switch]
		[/then]
	[/if]
    {VARIABLE new_weapon_rank 0}

	#apply attribute
    [switch]
        variable=new_weapon_attribute
        [case]
            value=heavy
            {VARIABLE new_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
            {VARIABLE_OP new_weapon.damage multiply 1.7}
            {VARIABLE_OP new_weapon.number add -1}
            [if]
                [variable]
                    name=new_weapon.special_type.throwable
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE_OP new_weapon.thrown.damage multiply 1.7}
                    {VARIABLE_OP new_weapon.thrown.number add -1}
                    [if]
                        [variable]
                            name=new_weapon.number
                            less_than=1
                        [/variable]
                        [then]
                            {VARIABLE new_weapon.thrown.number 1}
                        [/then]
                    [/if]
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.number
                    less_than=1
                [/variable]
                [then]
                    {VARIABLE new_weapon.number 1}
                [/then]
            [/if]
			#description changes
            [if]
                [variable]
                    name=new_weapon.class
                    equals=bow
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "long$weapon_user_name_temp|"}
                [/then]
            [/if]
			[if]
                [variable]
                    name=new_weapon.user_name
                    equals=sword
                [/variable]
				[or]
					[variable]
	                    name=new_weapon.user_name
	                    equals=scimitar
	                [/variable]
				[/or]
                [then]
                    {VARIABLE new_weapon.description "great $weapon_user_name_temp|"}
                [/then]
            [/if]
        [/case]
        [case]
            value=light
            {VARIABLE new_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
            {VARIABLE_OP new_weapon.damage multiply .5}
            {VARIABLE_OP new_weapon.number add 1}
            [if]
                [variable]
                    name=new_weapon.special_type.throwable
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE_OP new_weapon.thrown.damage multiply .5}
                    {VARIABLE_OP new_weapon.thrown.number add 1}
                [/then]
            [/if]
			#description changes
            [if]
                [variable]
                    name=new_weapon.user_name
                    equals=sword
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "short $weapon_user_name_temp|"}
                [/then]
            [/if]
			[if]
                [variable]
                    name=new_weapon.class
                    equals=bow
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "short $weapon_user_name_temp|"}
                [/then]
            [/if]
        [/case]
        [case]
            value=rusty
            {VARIABLE new_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
            {VARIABLE_OP new_weapon.damage multiply .7}
            {VARIABLE_OP new_weapon.human_magic_adjust multiply .7}
            {VARIABLE_OP new_weapon.dark_magic_adjust multiply .7}
            {VARIABLE_OP new_weapon.faerie_magic_adjust multiply .7}
            {VARIABLE_OP new_weapon.runic_magic_adjust multiply .7}
			{VARIABLE_OP new_weapon.spirit_magic_adjust multiply .7}
            [if]
                [variable]
                    name=new_weapon.special_type.throwable
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE_OP new_weapon.thrown.damage multiply .7}
                [/then]
            [/if]
			#description changes
            [if]
                [variable]
                    name=new_weapon.user_name
                    equals=club
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "rotten $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.user_name
                    equals=bow
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "cracked $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.user_name
                    equals=crossbow
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "cracked $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.user_name
                    equals=sling
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "worn $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
				[variable]
                    name=new_weapon.user_name
                    equals=magestaff
                [/variable]
				[or]
	                [variable]
	                    name=new_weapon.user_name
	                    equals=necrostaff
	                [/variable]
				[/or]
                [or]
                    [variable]
                        name=new_weapon.user_name
                        equals=faerie_staff
                    [/variable]
                [/or]
				[or]
                    [variable]
                        name=new_weapon.user_name
                        equals=spirit_staff
                    [/variable]
                [/or]
                [then]
                    {VARIABLE new_weapon.description "rotten $weapon_user_name_temp|"}
                [/then]
            [/if]
        [/case]
        [case]
            value=sharp
            {VARIABLE new_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
            {VARIABLE_OP new_weapon.damage multiply 1.3}
            {VARIABLE_OP new_weapon.human_magic_adjust multiply 1.3}
            {VARIABLE_OP new_weapon.dark_magic_adjust multiply 1.3}
            {VARIABLE_OP new_weapon.faerie_magic_adjust multiply 1.3}
            {VARIABLE_OP new_weapon.runic_magic_adjust multiply 1.3}
			{VARIABLE_OP new_weapon.spirit_magic_adjust multiply 1.3}
            [if]
                [variable]
                    name=new_weapon.special_type.throwable
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE_OP new_weapon.thrown.damage multiply 1.5}
                [/then]
            [/if]
			#description changes
            [if]
                [variable]
                    name=new_weapon.user_name
                    equals=club
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "crafted $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.class
                    equals=bow
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "recurve $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.class
                    equals=crossbow
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "recurve $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.user_name
                    equals=sling
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "woven $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.user_name
                    equals=magestaff
                [/variable]
				[or]
	                [variable]
	                    name=new_weapon.user_name
	                    equals=necrostaff
	                [/variable]
				[/or]
                [or]
                    [variable]
                        name=new_weapon.user_name
                        equals=faerie_staff
                    [/variable]
                [/or]
				[or]
                    [variable]
                        name=new_weapon.user_name
                        equals=spirit_staff
                    [/variable]
                [/or]
                [then]
                    {VARIABLE new_weapon.description "ebony $weapon_user_name_temp|"}
                [/then]
            [/if]
        [/case]
        [case]
            value=balanced
            {VARIABLE new_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
			{VARIABLE_OP new_weapon.damage multiply .8}
            {VARIABLE_OP new_weapon.number add 1}
            [if]
                [variable]
                    name=new_weapon.special_type.throwable
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE_OP new_weapon.thrown.damage multiply .8}
                    {VARIABLE_OP new_weapon.thrown.number add 1}
                [/then]
            [/if]
			#description changes
            [if]
                [variable]
                    name=new_weapon.class
                    equals=bow
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "flexible $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.class
                    equals=crossbow
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "geared $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.user_name
                    equals=sling
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "knotted $weapon_user_name_temp|"}
                [/then]
            [/if]
        [/case]
        [case]
            value=unbalanced
            {VARIABLE new_weapon.description "$new_weapon_attribute| $weapon_user_name_temp|"}
            {VARIABLE_OP new_weapon.damage multiply .8}
            {VARIABLE_OP new_weapon.number add -1}
            [if]
                [variable]
                    name=new_weapon.special_type.throwable
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE_OP new_weapon.thrown.damage multiply .8}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.special_type.throwable
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE_OP new_weapon.thrown.number add -1}
                    [if]
                        [variable]
                            name=new_weapon.thrown.number
                            less_than=1
                        [/variable]
                        [then]
                            {VARIABLE new_weapon.thrown.number 1}
                        [/then]
                    [/if]
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.number
                    less_than=1
                [/variable]
                [then]
                    {VARIABLE new_weapon.number 1}
                [/then]
            [/if]
			#description changes
            [if]
                [variable]
                    name=new_weapon.class
                    equals=bow
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "rigid $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.class
                    equals=crossbow
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "rigid $weapon_user_name_temp|"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=new_weapon.user_name
                    equals=sling
                [/variable]
                [then]
                    {VARIABLE new_weapon.description "loose $weapon_user_name_temp|"}
                [/then]
            [/if]
        [/case]
    [/switch]
	
	#adjust rates if bumped across 1/2 strike line
	{VARIABLE dmg_rate "$($new_weapon.body_damage_rate+$new_weapon.deft_damage_rate)"}
	[if]
		[variable]
			name=new_weapon.number
			less_than=2
		[/variable]
		[and]
			[variable]
				name=dmg_rate
				less_than=25
			[/variable]
		[/and]
		[then]
			[if]
                [variable]
                    name=new_weapon.class
                    equals="crossbow"
                [/variable]
                [or]
                    [variable]
                        name=new_weapon.class
                        equals="none"
                    [/variable]
                [/or]
                [then]
                [/then]
				[else]
					{VARIABLE_OP new_weapon.body_damage_rate multiply 2}
					{VARIABLE_OP new_weapon.deft_damage_rate multiply 2}
					{VARIABLE_OP new_weapon.body_number_rate divide 2}
					{VARIABLE_OP new_weapon.deft_number_rate divide 2}
					{VARIABLE number_rate "$($new_weapon.body_number_rate+$new_weapon.deft_number_rate)"}
					[if]
						[variable]
							name=number_rate
							less_than=5
						[/variable]
						[then]
							{VARIABLE_OP number_rate add -5}
							{VARIABLE_OP number_rate multiply -1}
							{VARIABLE_OP new_weapon.deft_number_rate add $number_rate}
						[/then]
					[/if]
					#thrown
					[if]
						[variable]
							name=new_weapon.special_type.throwable
							greater_than=0
						[/variable]
						[then]
							{VARIABLE_OP new_weapon.thrown.body_damage_rate multiply 2}
							{VARIABLE_OP new_weapon.thrown.deft_damage_rate multiply 2}
							{VARIABLE_OP new_weapon.thrown.body_number_rate divide 2}
							{VARIABLE_OP new_weapon.thrown.deft_number_rate divide 2}
							{VARIABLE number_rate "$($new_weapon.thrown.body_number_rate+$new_weapon.thrown.deft_number_rate)"}
							[if]
								[variable]
									name=number_rate
									less_than=5
								[/variable]
								[then]
									{VARIABLE_OP number_rate add -5}
									{VARIABLE_OP number_rate multiply -1}
									{VARIABLE_OP new_weapon.thrown.deft_number_rate add $number_rate}
								[/then]
							[/if]
						[/then]
					[/if]
				[/else]
			[/if]
		[/then]
	[/if]
	[if]
		[variable]
			name=new_weapon.number
			greater_than=1
		[/variable]
		[and]
			[variable]
				name=dmg_rate
				greater_than=25
			[/variable]
		[/and]
		[then]
			[if]
                [variable]
                    name=new_weapon.class
                    equals="crossbow"
                [/variable]
                [or]
                    [variable]
                        name=new_weapon.class
                        equals="none"
                    [/variable]
                [/or]
                [then]
                [/then]
				[else]
					{VARIABLE_OP new_weapon.body_damage_rate divide 2}
					{VARIABLE_OP new_weapon.deft_damage_rate divide 2}
					{VARIABLE_OP new_weapon.body_number_rate multiply 2}
					{VARIABLE_OP new_weapon.deft_number_rate multiply 2}
					{VARIABLE dmg_rate "$($new_weapon.body_damage_rate+$new_weapon.deft_damage_rate)"}
					[if]
						[variable]
							name=damage_rate
							less_than=20
						[/variable]
						[then]
							{VARIABLE_OP damage_rate add -20}
							{VARIABLE_OP damage_rate multiply -1}
							{VARIABLE_OP new_weapon.body_damage_rate add $damage_rate}
						[/then]
					[/if]
					#thrown
					[if]
						[variable]
							name=new_weapon.special_type.throwable
							greater_than=0
						[/variable]
						[then]
							{VARIABLE_OP new_weapon.thrown.body_damage_rate divide 2}
							{VARIABLE_OP new_weapon.thrown.deft_damage_rate divide 2}
							{VARIABLE_OP new_weapon.thrown.body_number_rate multiply 2}
							{VARIABLE_OP new_weapon.thrown.deft_number_rate multiply 2}
							{VARIABLE dmg_rate "$($new_weapon.thrown.body_damage_rate+$new_weapon.thrown.deft_damage_rate)"}
							[if]
								[variable]
									name=damage_rate
									less_than=20
								[/variable]
								[then]
									{VARIABLE_OP damage_rate add -20}
									{VARIABLE_OP damage_rate multiply -1}
									{VARIABLE_OP new_weapon.thrown.body_damage_rate add $damage_rate}
								[/then]
							[/if]
						[/then]
					[/if]
				[/else]
			[/if]
		[/then]
	[/if]

    {VARIABLE_OP new_weapon.damage round 0}
    {VARIABLE_OP new_weapon.human_magic_adjust round 0}
    {VARIABLE_OP new_weapon.dark_magic_adjust round 0}
    {VARIABLE_OP new_weapon.faerie_magic_adjust round 0}
    {VARIABLE_OP new_weapon.runic_magic_adjust round 0}
	{VARIABLE_OP new_weapon.body_damage_rate round 0}
	{VARIABLE_OP new_weapon.deft_damage_rate round 0}
	{VARIABLE_OP new_weapon.body_number_rate round 0}
	{VARIABLE_OP new_weapon.deft_number_rate round 0}
	[if]
		[variable]
			name=new_weapon.special_type.throwable
			greater_than=0
		[/variable]
		[then]
			{VARIABLE_OP new_weapon.thrown.damage round 0}
			{VARIABLE_OP new_weapon.thrown.body_damage_rate round 0}
			{VARIABLE_OP new_weapon.thrown.deft_damage_rate round 0}
			{VARIABLE_OP new_weapon.thrown.body_number_rate round 0}
			{VARIABLE_OP new_weapon.thrown.deft_number_rate round 0}
		[/then]
	[/if]

    {FIND_ABSOLUTE_VALUE new_weapon}
    {APPLY_WEAPON_SPECIAL_DESCRIPTION new_weapon}
[/event]

[event]
    name=create_armor
    first_time_only=no
    #requires new_armor_rank to be set
    #need to set if random or predetermined
    [if]
        [variable]
            name=random_armor_type
            numerical_equals=1
        [/variable]
        [then]
            {PROB_LIST_RANDOM $new_armor_path}
			{VARIABLE new_armor_type $random}
        [/then]
    [/if]
    [if]
        [variable]
            name=random_armor_attribute
            numerical_equals=1
        [/variable]
        [then]
            {VARIABLE_OP new_armor_attribute rand "thick,light,polished,rusty,new,battered,none,none,none,none,none,none"}
        [/then]
    [/if]
    {VARIABLE random_armor_type 0}
    {VARIABLE random_armor_attribute 0}
	
    [switch]
        variable=new_armor_type
        [case]
            value="studded_leather"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="torso_armor"
                    name="studded_leather"
                    description=_ "studded leather"
                    icon="studded-leather"
                    ground_icon="armor"
                    sprite_image="leather"
                    magic_adjust=-20
                    evade_adjust=-4
                    material=leather
                    [restricts]
                        head=0
                        arms=0
                        legs=0
                        shield=0
                    [/restricts]
                    [resistance]
                        arcane=0
                        blade=15
                        fire=0
                        cold=0
                        impact=8
                        pierce=10
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=3
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=3
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=3
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=3
                            movement=0
                        [/flat]
                        [forest]
                            defense=3
                            movement=0
                        [/forest]
                        [hills]
                            defense=3
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=3
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
						[reef]
                            defense=0
                            movement=0
                        [/reef]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=3
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=3
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="leather_leggings"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="legs_armor"
                    name="leather_leggings"
                    description=_ "leather leggings"
                    icon="shoes"
                    ground_icon="boots"
                    magic_adjust=0
                    evade_adjust=-2
                    material=leather
                    [resistance]
                        arcane=0
                        blade=10
                        fire=0
                        cold=0
                        impact=5
                        pierce=10
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=2
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=2
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=2
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=2
                            movement=0
                        [/flat]
                        [forest]
                            defense=2
                            movement=0
                        [/forest]
                        [hills]
                            defense=2
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=2
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
						[reef]
                            defense=0
                            movement=0
                        [/reef]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=2
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=2
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="leather_cap"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="head_armor"
                    name="leather_cap"
                    description=_ "leather cap"
                    icon="metal-helm"
                    ground_icon="cap"
                    ranged_adjust=0
                    evade_adjust=-1
                    material=leather
                    [resistance]
                        arcane=0
                        blade=5
                        fire=0
                        cold=0
                        impact=7
                        pierce=0
                    [/resistance]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="iron_plate"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="torso_armor"
                    name="iron_plate"
                    description=_ "iron plate"
                    icon="armour"
                    ground_icon="armor"
                    sprite_image="metal"
                    magic_adjust=-40
                    evade_adjust=-12
                    material=metal
                    [restricts]
                        head=0
                        arms=0
                        legs=0
                        shield=0
                    [/restricts]
                    [resistance]
                        arcane=0
                        blade=40
                        fire=-5
                        cold=-5
                        impact=11
                        pierce=30
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=7
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=10
                            movement=0
                        [/castle]
                        [village]
                            defense=7
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=7
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=7
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=10
                            movement=0
                        [/flat]
                        [forest]
                            defense=7
                            movement=0
                        [/forest]
                        [hills]
                            defense=10
                            movement=0
                        [/hills]
                        [mountains]
                            defense=10
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=10
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
						[reef]
                            defense=0
                            movement=0
                        [/reef]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=0
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=10
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="iron_greaves"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="legs_armor"
                    name="iron_greaves"
                    description=_ "iron greaves"
                    icon="greaves"
                    ground_icon="greaves"
                    magic_adjust=-10
                    evade_adjust=-8
                    material=metal
                    [resistance]
                        arcane=0
                        blade=27
                        fire=-5
                        cold=-5
                        impact=8
                        pierce=30
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=7
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=10
                            movement=0
                        [/castle]
                        [village]
                            defense=7
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=7
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=7
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=10
                            movement=0
                        [/flat]
                        [forest]
                            defense=7
                            movement=0
                        [/forest]
                        [hills]
                            defense=10
                            movement=0
                        [/hills]
                        [mountains]
                            defense=7
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=7
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
						[reef]
                            defense=0
                            movement=0
                        [/reef]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=0
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=10
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="iron_helm"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="head_armor"
                    name="iron_helm"
                    description=_ "iron helm"
                    icon="metal-helm"
                    ground_icon="helmet"
                    ranged_adjust=-30
                    evade_adjust=-3
                    material=metal
                    [resistance]
                        arcane=0
                        blade=13
                        fire=0
                        cold=0
                        impact=11
                        pierce=0
                    [/resistance]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="scale_mail"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="torso_armor"
                    name="scale_mail"
                    description=_ "scale mail"
                    icon="armour"
                    ground_icon="armor"
                    sprite_image="metal"
                    magic_adjust=-20
                    evade_adjust=-7
                    material=metal
                    [restricts]
                        head=0
                        arms=0
                        legs=0
                        shield=0
                    [/restricts]
                    [resistance]
                        arcane=0
                        blade=25
                        fire=0
                        cold=0
                        impact=15
                        pierce=15
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=5
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=5
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=5
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=5
                            movement=0
                        [/flat]
                        [forest]
                            defense=5
                            movement=0
                        [/forest]
                        [hills]
                            defense=5
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=5
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
						[reef]
                            defense=0
                            movement=0
                        [/reef]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=5
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=5
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="mail_greaves"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="legs_armor"
                    name="mail_greaves"
                    description=_ "mail greaves"
                    icon="greaves"
                    ground_icon="greaves"
                    magic_adjust=-10
                    evade_adjust=-7
                    material=metal
                    [resistance]
                        arcane=0
                        blade=18
                        fire=0
                        cold=0
                        impact=10
                        pierce=15
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=5
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=5
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=5
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=5
                            movement=0
                        [/flat]
                        [forest]
                            defense=5
                            movement=0
                        [/forest]
                        [hills]
                            defense=5
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=5
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
						[reef]
                            defense=0
                            movement=0
                        [/reef]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=5
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=5
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="full_helm"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="head_armor"
                    name="full_helm"
                    description=_ "full helm"
                    icon="metal-helm"
                    ground_icon="helmet"
                    ranged_adjust=-10
                    evade_adjust=-3
                    material=metal
                    [resistance]
                        arcane=0
                        blade=7
                        fire=0
                        cold=0
                        impact=15
                        pierce=0
                    [/resistance]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="tempered_plate"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="torso_armor"
                    name="tempered_plate"
                    description=_ "tempered plate"
                    icon="plate-tempered"
                    ground_icon="armor"
                    sprite_image="metal"
                    magic_adjust=-40
                    evade_adjust=-10
                    material=metal
                    [restricts]
                        head=0
                        arms=0
                        legs=0
                        shield=0
                    [/restricts]
                    [resistance]
                        arcane=0
                        blade=15
                        fire=0
                        cold=0
                        impact=7
                        pierce=45
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=5
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=5
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=5
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=5
                            movement=0
                        [/flat]
                        [forest]
                            defense=5
                            movement=0
                        [/forest]
                        [hills]
                            defense=5
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=5
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
						[reef]
                            defense=0
                            movement=0
                        [/reef]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=5
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=5
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="mage_robe"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="torso_armor"
                    name="mage_robe"
                    description=_ "mage robe"
                    icon="cloak"
                    ground_icon="robe"
                    sprite_image="wizrobe"
                    magic_adjust=0
                    evade_adjust=-15
                    material=cloth
                    [restricts]
                        head=1
                        arms=0
                        legs=1
                        shield=0
                    [/restricts]
                    [resistance]
                        arcane=0
                        blade=25
                        fire=0
                        cold=0
                        impact=17
                        pierce=17
                    [/resistance]
                    [terrain]
                        [unwalkable]
                            defense=10
                            movement=0
                        [/unwalkable]
                        [castle]
                            defense=0
                            movement=0
                        [/castle]
                        [village]
                            defense=0
                            movement=0
                        [/village]
                        [shallow_water]
                            defense=10
                            movement=0
                        [/shallow_water]
                        [deep_water]
                            defense=10
                            movement=0
                        [/deep_water]
                        [flat]
                            defense=10
                            movement=0
                        [/flat]
                        [forest]
                            defense=10
                            movement=0
                        [/forest]
                        [hills]
                            defense=10
                            movement=0
                        [/hills]
                        [mountains]
                            defense=0
                            movement=0
                        [/mountains]
                        [swamp_water]
                            defense=10
                            movement=0
                        [/swamp_water]
                        [sand]
                            defense=0
                            movement=0
                        [/sand]
                        [cave]
                            defense=0
                            movement=0
                        [/cave]
						[reef]
                            defense=0
                            movement=0
                        [/reef]
                        [impassable]
                            defense=0
                            movement=0
                        [/impassable]
                        [frozen]
                            defense=10
                            movement=0
                        [/frozen]
                        [fungus]
                            defense=10
                            movement=0
                        [/fungus]
                    [/terrain]
                [/value]
            [/set_variables]
        [/case]
		[case]
            value="buckler"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="shield"
                    name="buckler"
                    description=_ "buckler"
                    icon="buckler"
                    ground_icon="buckler"
                    magic_adjust=-30
                    material=metal
                    evade_adjust=-2
                    terrain_recoup=4
                    ranged_adjust=-10
                    block_wield=0
                    block_ranged=0
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="round_shield"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="shield"
                    name="shield_round"
                    description=_ "round shield"
                    icon="shield"
                    ground_icon="buckler"
                    magic_adjust=-60
                    material=metal
                    evade_adjust=-5
                    terrain_recoup=8
                    ranged_adjust=-15
                    block_wield=1
                    block_ranged=0
                [/value]
            [/set_variables]
        [/case]
        [case]
            value="tower_shield"
            [set_variables]
                name=new_armor
                mode=replace
                [value]
                    category="shield"
                    name="shield_tower"
                    description=_ "tower shield"
                    icon="rectangular-shield"
                    ground_icon="buckler"
                    magic_adjust=-80
                    material=metal
                    evade_adjust=-8
                    terrain_recoup=18
                    ranged_adjust=-20
                    block_wield=2
                    block_ranged=1
                    [special_type]
                        steadfast=1
                    [/special_type]
                [/value]
            [/set_variables]
        [/case]
    [/switch]
	{VARIABLE new_armor.prob_name $new_armor_type}
	
	#apply rank
	{VARIABLE new_armor_rank_frac $new_armor_rank}
	{VARIABLE_OP new_armor_rank_frac multiply .2}
	{VARIABLE_OP new_armor_rank_frac round 0}
	[if]
		[variable]
			name=new_armor_rank
			greater_than=0
		[/variable]
		[then]	
			[if]
		        [variable]
		            name=new_armor.category
		            equals=shield
		        [/variable]
		        [then]
					[if]
						[variable]
							name=new_armor_rank_frac
							greater_than=0
						[/variable]
						[then]
							{VARIABLE_OP new_armor.terrain_recoup multiply $new_armor_rank_frac}
						[/then]
					[/if]
		        [/then]
		    [/if]
		    [if]
		        [variable]
		            name=new_armor.category
		            equals=torso_armor
		        [/variable]
		        [or]
		            [variable]
		                name=new_armor.category
		                equals=head_armor
		            [/variable]
		            [or]
		                [variable]
		                    name=new_armor.category
		                    equals=legs_armor
		                [/variable]
		            [/or]
		        [/or]
		        [then]
					{RANDOM 0..3}
					[if]
						[variable]
							name=random
							numerical_equals=0
						[/variable]
						[then]
							{VARIABLE_OP rand2 rand 0..5}
							[switch]
								variable=rand2
								[case]
									value=0
									{VARIABLE_OP new_armor.resistance.arcane add $new_armor_rank}
								[/case]								
								[case]
									value=1
									{VARIABLE_OP new_armor.resistance.blade add $new_armor_rank}
								[/case]
								[case]
									value=2
									{VARIABLE_OP new_armor.resistance.pierce add $new_armor_rank}
								[/case]
								[case]
									value=3
									{VARIABLE_OP new_armor.resistance.fire add $new_armor_rank}
								[/case]
								[case]
									value=4
									{VARIABLE_OP new_armor.resistance.cold add $new_armor_rank}
								[/case]
								[case]
									value=5
									{VARIABLE_OP new_armor.resistance.impact add $new_armor_rank}
								[/case]
							[/switch]
						[/then]
						[else]
							[if]
								[variable]
									name=new_armor_rank
									less_than=10
								[/variable]
								[then]
									{VARIABLE new_armor_rank_2 "1.0$new_armor_rank"}
								[/then]
								[else]
									{VARIABLE new_armor_rank_2 "1.$new_armor_rank"}
								[/else]
							[/if]
							[if]
								[variable]
									name=new_armor.resistance.arcane
									greater_than=0
								[/variable]
								[then]
									{VARIABLE_OP new_armor.resistance.arcane multiply $new_armor_rank_2}
									{VARIABLE_OP new_armor.resistance.arcane round 0}
								[/then]
							[/if]
							[if]
								[variable]
									name=new_armor.resistance.blade
									greater_than=0
								[/variable]
								[then]
									{VARIABLE_OP new_armor.resistance.blade multiply $new_armor_rank_2}
									{VARIABLE_OP new_armor.resistance.blade round 0}
								[/then]
							[/if]
							[if]
								[variable]
									name=new_armor.resistance.pierce
									greater_than=0
								[/variable]
								[then]
									{VARIABLE_OP new_armor.resistance.pierce multiply $new_armor_rank_2}
									{VARIABLE_OP new_armor.resistance.pierce round 0}
								[/then]
							[/if]
							[if]
								[variable]
									name=new_armor.resistance.fire
									greater_than=0
								[/variable]
								[then]
									{VARIABLE_OP new_armor.resistance.fire multiply $new_armor_rank_2}
									{VARIABLE_OP new_armor.resistance.fire round 0}
								[/then]
							[/if]
							[if]
								[variable]
									name=new_armor.resistance.cold
									greater_than=0
								[/variable]
								[then]
									{VARIABLE_OP new_armor.resistance.cold multiply $new_armor_rank_2}
									{VARIABLE_OP new_armor.resistance.cold round 0}
								[/then]
							[/if]
							[if]
								[variable]
									name=new_armor.resistance.impact
									greater_than=0
								[/variable]
								[then]
									{VARIABLE_OP new_armor.resistance.impact multiply $new_armor_rank_2}
									{VARIABLE_OP new_armor.resistance.impact round 0}
								[/then]
							[/if]
						[/else]
					[/if]
		        [/then]
		    [/if]
		[/then]
	[/if]
	{VARIABLE new_armor_rank 0}

	#apply attribute
    [if]
        [variable]
            name=new_armor.category
            equals=shield
        [/variable]
        [then]
            {VARIABLE armor_user_name_temp "$new_armor.description|"}
            [switch]
                variable=new_armor_attribute
                [case]
                    value=thick
                    {VARIABLE new_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=new_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.magic_adjust multiply 1.25}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.evade_adjust multiply 1.25}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.terrain_recoup multiply 1.25}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.ranged_adjust multiply 1.25}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=light
                    {VARIABLE new_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=new_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.magic_adjust multiply .8}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.evade_adjust multiply .8}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.terrain_recoup multiply .8}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.ranged_adjust multiply .8}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=polished
                    {VARIABLE new_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=new_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.magic_adjust multiply .8}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.evade_adjust multiply .8}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.terrain_recoup multiply 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.ranged_adjust multiply .8}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=rusty
                    {VARIABLE new_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=new_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.magic_adjust multiply 1.25}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.evade_adjust multiply 1.25}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.terrain_recoup multiply 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.ranged_adjust multiply 1.25}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=new
                    {VARIABLE new_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=new_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.magic_adjust multiply 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.evade_adjust multiply 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.terrain_recoup multiply 1.25}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.ranged_adjust multiply 1}
                        [/then]
                    [/if]
                [/case]
                [case]
                    value=battered
                    {VARIABLE new_armor.description "$new_armor_attribute $armor_user_name_temp|"}
                    [if]
                        [variable]
                            name=new_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.magic_adjust multiply 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.evade_adjust multiply 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.terrain_recoup
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.terrain_recoup multiply .8}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.ranged_adjust multiply 1}
                        [/then]
                    [/if]
                [/case]
            [/switch]
			{VARIABLE_OP new_armor.ranged_adjust round 0}
			{VARIABLE_OP new_armor.terrain_recoup round 0}
			{VARIABLE_OP new_armor.magic_adjust round 0}
			{VARIABLE_OP new_armor.evade_adjust round 0}
            {FIND_ABSOLUTE_VALUE_ARMOR_SHIELD "new_armor"}
            {ARMOR_SPECIAL_DISPLAY "new_armor"}
        [/then]
    [/if]
    [if]
        [variable]
            name=new_armor.category
            equals=torso_armor
        [/variable]
        [or]
            [variable]
                name=new_armor.category
                equals=head_armor
            [/variable]
            [or]
                [variable]
                    name=new_armor.category
                    equals=legs_armor
                [/variable]
            [/or]
        [/or]
        [then]
            {VARIABLE weapon_user_name_temp "$new_armor.description|"}
            [switch]
                variable=new_armor_attribute
                [case]
                    value=thick
					[if]
                        [variable]
                            name=new_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.ranged_adjust multiply 1.25}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.magic_adjust multiply 1.25}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.evade_adjust multiply 1.25}
                        [/then]
                    [/if]
					{CREATE_ADJUST_RESISTANCE "new_armor" "1.2"}
                    {CREATE_ADJUST_DEFENSE "new_armor" "1.2"}
                    {VARIABLE new_armor.description "thick $weapon_user_name_temp|"}
                [/case]
                [case]
                    value=light
					[if]
                        [variable]
                            name=new_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.ranged_adjust multiply .75}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.magic_adjust multiply .75}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.evade_adjust multiply .75}
                        [/then]
                    [/if]
                    {CREATE_ADJUST_RESISTANCE "new_armor" ".8"}
                    {CREATE_ADJUST_DEFENSE "new_armor" ".8"}
                    [if]
                        [variable]
                            name=new_armor.material
                            equals=cloth
                        [/variable]
                        [then]
                            {VARIABLE new_armor.description "thin $weapon_user_name_temp|"}
                        [/then]
                        [else]
                            {VARIABLE new_armor.description "light $weapon_user_name_temp|"}
                        [/else]
                    [/if]
                [/case]
                [case]
                    value=polished
					[if]
                        [variable]
                            name=new_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.ranged_adjust multiply .6}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.magic_adjust multiply .6}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.evade_adjust multiply .6}
                        [/then]
                    [/if]
                    {CREATE_ADJUST_DEFENSE "new_armor" ".6"}
                    [switch]
                        variable=new_armor.material
                        [case]
                            value=leather
                            {VARIABLE new_armor.description "oiled $weapon_user_name_temp|"}
                        [/case]
                        [case]
                            value=cloth
                            {VARIABLE new_armor.description "fine $weapon_user_name_temp|"}
                        [/case]
                        [else]
                            {VARIABLE new_armor.description "polished $weapon_user_name_temp|"}
                        [/else]
                    [/switch]
                [/case]
                [case]
                    value=rusty
					[if]
                        [variable]
                            name=new_armor.ranged_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.ranged_adjust multiply 1.5}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.magic_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.magic_adjust multiply 1.5}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=new_armor.evade_adjust
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP new_armor.evade_adjust multiply 1.5}
                        [/then]
                    [/if]
                    {CREATE_ADJUST_DEFENSE "new_armor" "1.3"}
                    [switch]
                        variable=new_armor.material
                        [case]
                            value=leather
                            {VARIABLE new_armor.description "stiff $weapon_user_name_temp|"}
                        [/case]
                        [case]
                            value=cloth
                            {VARIABLE new_armor.description "stiff $weapon_user_name_temp|"}
                        [/case]
                        [else]
                            {VARIABLE new_armor.description "rusty $weapon_user_name_temp|"}
                        [/else]
                    [/switch]
                [/case]
                [case]
                    value=new
                    {CREATE_ADJUST_RESISTANCE "new_armor" "1.2"}
                    {VARIABLE new_armor.description "$new_armor_attribute| $weapon_user_name_temp|"}
                [/case]
                [case]
                    value=battered
                    {CREATE_ADJUST_RESISTANCE "new_armor" ".8"}
                    [switch]
                        variable=new_armor.material
                        [case]
                            value=leather
                            {VARIABLE new_armor.description "worn $weapon_user_name_temp|"}
                        [/case]
                        [case]
                            value=cloth
                            {VARIABLE new_armor.description "tattered $weapon_user_name_temp|"}
                        [/case]
                        [else]
                            {VARIABLE new_armor.description "$new_armor_attribute| $weapon_user_name_temp|"}
                        [/else]
                    [/switch]
                [/case]
            [/switch]
			[if]
				[variable]
					name=new_armor.ranged_adjust
					less_than=0
				[/variable]
				[then]
					{VARIABLE_OP new_armor.ranged_adjust round 0}
				[/then]
			[/if]
			[if]
				[variable]
					name=new_armor.magic_adjust
					less_than=0
				[/variable]
				[then]
					{VARIABLE_OP new_armor.magic_adjust round 0}
				[/then]
			[/if]
			[if]
				[variable]
					name=new_armor.evade_adjust
					less_than=0
				[/variable]
				[then]
					{VARIABLE_OP new_armor.evade_adjust round 0}
				[/then]
			[/if]
			{CREATE_ADJUST_RESISTANCE "new_armor" "1"}
            {CREATE_ADJUST_DEFENSE "new_armor" "1"}
            {FIND_ABSOLUTE_VALUE_ARMOR "new_armor"}
        [/then]
    [/if]
[/event]

[event]
    name=create_potion
    first_time_only=no
    #requires new_potion_rank to be set
    #need to set if random or predetermined
    [if]
        [variable]
            name=random_potion_type
            numerical_equals=1
        [/variable]
        [then]
            {PROB_LIST_RANDOM $new_potion_path}
			{VARIABLE new_potion_type $random}
        [/then]
    [/if]
    [switch]
        variable=new_potion_type
        [case]
            value=healing
			{VARIABLE temp_healing_amount $new_potion_rank}
			{VARIABLE_OP temp_healing_amount multiply 2}
			{VARIABLE_OP temp_healing_amount add 4}
			{VARIABLE temp_uses 1}
			[if]
				[variable]
					name=temp_healing_amount
					greater_than=17
				[/variable]
				[then]
					{RANDOM 0..2}
					[if]
						[variable]
							name=random
							numerical_equals=0
						[/variable]
						[then]
							{VARIABLE_OP temp_healing_amount add -10}
							{VARIABLE_OP temp_uses add 1}
						[/then]
					[/if]
				[/then]
			[/if]
			{VARIABLE temp_value $new_potion_rank}
			{EXPONENTIAL_VALUE 1 3 0 8}
			{VARIABLE temp_temp_uses $temp_uses}
			[while]
				[variable]
					name=temp_temp_uses
					greater_than=1
				[/variable]
				[do]
					{VARIABLE_OP temp_value multiply .8}
					{VARIABLE_OP temp_value round 0}
					{VARIABLE_OP temp_temp_uses add -1}
				[/do]
			[/while]			
			{VARIABLE_OP temp_value round 0}
			{VARIABLE cures_too " or cures poison"}
			[if]
				[variable]
					name=temp_healing_amount
					less_than=8
				[/variable]
				[then]
					{CLEAR_VARIABLE cures_too}
				[/then]
			[/if]
            [set_variables]
				name=new_potion
				mode=replace
				[value]
					user_name="potion"
					icon="potions/potion-red-minor"
					description=_ "Potion of Healing:
`Heals $temp_healing_amount damage$cures_too|.
`Uses - $temp_uses|"
					usable_self=1
					usable_other_adj=0
					usable_other_dis=0
					usable_adj=0
					usable_dis=0
					command=potion_healing
					uses=$temp_uses
					healing_number=$temp_healing_amount
					ground_icon="potion-red"
					category=usables
					action_use="simple action"
					absolute_value=$temp_value
				[/value]
			[/set_variables]
        [/case]
		[case]
            value=protection_armor
			{VARIABLE temp_uses 1}
			{VARIABLE_OP new_potion_rank multiply .25}
			{VARIABLE_OP new_potion_rank round ceil}
			{VARIABLE_OP new_potion_rank add 1}
			{VARIABLE temp_value $new_potion_rank}
			{EXPONENTIAL_VALUE 5 1 0 10}
			{VARIABLE temp_protection $new_potion_rank}
			{VARIABLE_OP temp_protection multiply 5}
            [set_variables]
				name=new_potion
				mode=replace
				[value]
					user_name="potion"
					icon="potions/potion-blue-big"
					description=_ "Potion of Magic Armor:
`Protection from damage by an extra $temp_protection|%. 
`This value degrades by 5% every round.
`Uses - $temp_uses|"
					usable_self=1
					usable_other_adj=0
					usable_other_dis=0
					usable_adj=0
					usable_dis=0
					command=potion_protection_armor
					uses=$temp_uses
					protection_value=$new_potion_rank
					ground_icon="potion-blue"
					category=usables
					action_use="simple action"
					absolute_value=$temp_value
				[/value]
			[/set_variables]
        [/case]
		[case]
            value=protection_poison
			{VARIABLE temp_uses 1}
			{VARIABLE_OP new_potion_rank multiply .25}
			{VARIABLE_OP new_potion_rank round ceil}
			{VARIABLE_OP new_potion_rank add 1}
			{VARIABLE temp_value $new_potion_rank}			
			{EXPONENTIAL_VALUE 4 1 2 5}
            [set_variables]
				name=new_potion
				mode=replace
				[value]
					user_name="potion"
					icon="potions/potion-blue"
					description=_ "Potion of Protection from Poison:
`Protection from poison for $new_potion_rank rounds. 
`Uses - $temp_uses|"
					usable_self=1
					usable_other_adj=0
					usable_other_dis=0
					usable_adj=0
					usable_dis=0
					command=potion_protection_poison
					uses=$temp_uses
					protection_value=$new_potion_rank
					ground_icon="potion-blue"
					category=usables
					action_use="simple action"
					absolute_value=$temp_value
				[/value]
			[/set_variables]
        [/case]
		[case]
			value=phoenix_fire
			{VARIABLE_OP new_potion_rank divide 3}
			{VARIABLE_OP new_potion_rank add 1}
			{VARIABLE temp_value $new_potion_rank}
			{EXPONENTIAL_VALUE 7 1 0 15}
			{VARIABLE phoenix_amount $new_potion_rank}
			{VARIABLE_OP phoenix_amount multiply 4}
			[set_variables]
				name=new_potion
				mode=replace
				[value]
					user_name="potion"
					icon="potions/potion-red-huge"
					description=_ "Potion of Phoenix Fire:
`If you die after drinking this, you return at $phoenix_amount life.
`This value degrades by 4 every round after use.
`Uses - 1"
					usable_self=1
					usable_other_adj=0
					usable_other_dis=0
					usable_adj=0
					usable_dis=0
					command=potion_phoenix_fire
					uses=1
					healing_number=$phoenix_amount
					ground_icon="potion-red"
					category=usables
					action_use="simple action"
					absolute_value=$temp_value
				[/value]
			[/set_variables]
		[/case]
		[case]
            value=detect_units
			{VARIABLE temp_uses 1}
			{VARIABLE_OP new_potion_rank multiply .25}
			{VARIABLE_OP new_potion_rank round ceil}
			{VARIABLE temp_value $new_potion_rank}
			{EXPONENTIAL_VALUE 4 1 2 5}
			{VARIABLE temp_radius $new_potion_rank}
			{VARIABLE_OP temp_radius multiply 5}
			{VARIABLE_OP temp_radius add 15}
            [set_variables]
				name=new_potion
				mode=replace
				[value]
					user_name="potion"
					icon="potions/potion-green-medium"
					description=_ "Potion of Detect Units:
`Detect the presence of units within $temp_radius hexes. 
`Uses - $temp_uses|"
					usable_self=1
					usable_other_adj=0
					usable_other_dis=0
					usable_adj=0
					usable_dis=0
					command=potion_detect_units
					uses=$temp_uses
					radius=$temp_radius
					ground_icon="potion-green"
					category=usables
					action_use="simple action"
					absolute_value=$temp_value
				[/value]
			[/set_variables]
        [/case]
		[case]
            value=improved_detect_units
			{VARIABLE temp_uses 1}
			{VARIABLE_OP new_potion_rank multiply .25}
			{VARIABLE_OP new_potion_rank round ceil}
			{VARIABLE temp_value $new_potion_rank}
			{EXPONENTIAL_VALUE 6 1 2 10}
			{VARIABLE temp_radius $new_potion_rank}
			{VARIABLE_OP temp_radius multiply 4}
			{VARIABLE_OP temp_radius add 12}
            [set_variables]
				name=new_potion
				mode=replace
				[value]
					user_name="potion"
					icon="potions/potion-green-moderate"
					description=_ "Potion of Improved Detect Units:
`Detect the presence of unit with levels within $temp_radius hexes. 
`Uses - $temp_uses|"
					usable_self=1
					usable_other_adj=0
					usable_other_dis=0
					usable_adj=0
					usable_dis=0
					command=potion_improved_detect_units
					uses=$temp_uses
					radius=$temp_radius
					ground_icon="potion-green"
					category=usables
					action_use="simple action"
					absolute_value=$temp_value
				[/value]
			[/set_variables]
        [/case]
    [/switch]
	{VARIABLE new_potion.prob_name $new_potion_type}
[/event]

[event]
    name=create_scroll
    first_time_only=no
    #requires new_potion_rank to be set
    #need to set if random or predetermined
    [if]
        [variable]
            name=random_scroll_type
            numerical_equals=1
        [/variable]
        [then]
            {PROB_LIST_RANDOM $new_scroll_path}
			{VARIABLE new_scroll_type $random}
        [/then]
    [/if]
    [switch]
        variable=new_scroll_type
		[case]
            value=detect_gold
			{VARIABLE temp_uses 1}
			{VARIABLE_OP new_scroll_rank multiply .25}
			{VARIABLE_OP new_scroll_rank round ceil}
			{VARIABLE temp_value $new_scroll_rank}
			{EXPONENTIAL_VALUE 5 1 4 10}
			{VARIABLE temp_radius $new_scroll_rank}
			{VARIABLE_OP temp_radius multiply 4}
			{VARIABLE_OP temp_radius add 20}
            [set_variables]
				name=new_scroll
				mode=replace
				[value]
					user_name="scroll"
					icon="categories/misc-scroll"
					description=_ "Scroll of Detect Gold:
`Detects gold within a radius of $temp_radius| hexes.
`Uses - $temp_uses|"
					usable_self=1
					usable_other_adj=0
					usable_other_dis=0
					usable_adj=0
					usable_dis=0
					command=scroll_detect_gold
					uses=$temp_uses
					radius=$temp_radius
					ground_icon="scroll"
					category=usables
					action_use="complex action"
					absolute_value=$temp_value
				[/value]
			[/set_variables]
        [/case]
		{SUMMON_ELEMENTAL_SCROLL_CASE fire a}
		{SUMMON_ELEMENTAL_SCROLL_CASE water a}
		{SUMMON_ELEMENTAL_SCROLL_CASE air an}
		{SUMMON_ELEMENTAL_SCROLL_CASE earth an}
		[case]
            value=mapping
			{VARIABLE temp_uses 1}
			{VARIABLE_OP new_scroll_rank multiply .25}
			{VARIABLE_OP new_scroll_rank round ceil}
			{VARIABLE temp_value $new_scroll_rank}
			{EXPONENTIAL_VALUE 4 1 2 5}
			{VARIABLE temp_radius $new_scroll_rank}
			{VARIABLE_OP temp_radius multiply 5}
			{VARIABLE_OP temp_radius add 10}
            [set_variables]
				name=new_scroll
				mode=replace
				[value]
					user_name="scroll"
					icon="categories/misc-scroll"
					description=_ "Scroll of Magic Mapping:
`Maps a radius of $temp_radius| hexes.
`Uses - $temp_uses|"
					usable_self=1
					usable_other_adj=0
					usable_other_dis=0
					usable_adj=0
					usable_dis=0
					command=scroll_mapping
					uses=$temp_uses
					radius=$temp_radius
					ground_icon="scroll"
					category=usables
					action_use="complex action"
					absolute_value=$temp_value
				[/value]
			[/set_variables]
        [/case]
    [/switch]
	{VARIABLE new_scroll.prob_name $new_scroll_type}
[/event]