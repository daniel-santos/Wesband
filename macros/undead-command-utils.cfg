#define UNDEAD_FOCUS_MACRO
    [store_unit]
        variable=focus_hench
        [filter]
            x,y=$x1,$y1
        [/filter]
    [/store_unit]
    {VARIABLE focus_hench.overlays "misc/hero-icon.png"}
    {VARIABLE focus_hench.variables.is_hench 1}
    [if]
        [variable]
            name=focus_hench.max_hitpoints
            less_than=$focus_hench.variables.max_hitpoints
        [/variable]
        [then]
            {VARIABLE focus_hench.max_hitpoints $focus_hench.variables.max_hitpoints}
        [/then]
    [/if]
    [unstore_unit]
        variable=focus_hench
    [/unstore_unit]

    [store_unit]
        variable=hench_query
        [filter]
            side=$side_number
            [not]
                canrecruit=yes
            [/not]
            [filter_wml]
                [variables]
                    is_hench=1
                    sp_side=$focus_hench.variables.sp_side
                [/variables]
            [/filter_wml]
            [not]
                x,y=$x1,$y1
            [/not]
        [/filter]
    [/store_unit]
    {VARIABLE max_hench_minus $max_hench}
    {VARIABLE_OP max_hench_minus sub 1}
    [if]
        [variable]
            name=hench_query.length
            greater_than=$max_hench_minus
        [/variable]
        [then]
            {VARIABLE last_hench $hench_query.length}
            {VARIABLE_OP last_hench sub 1}
            [if]
                [variable]
                    name=hench_query[$last_hench].race
                    equals=undead
                [/variable]
                [then]
                    {VARIABLE hench_query[$last_hench].variables.is_hench 0}
                    {CLEAR_VARIABLE hench_query[$last_hench].name}
                    {CLEAR_VARIABLE hench_query[$last_hench].overlays}
                    [unstore_unit]
                        variable=hench_query[$last_hench]
                    [/unstore_unit]
                    [remove_unit_overlay]
                        x,y=$hench_query[$last_hench].x,$hench_query[$last_hench].y
                        image=misc/hero-icon.png
                    [/remove_unit_overlay]
                [/then]
                [else]
                    [message]
                        message=_ "You are dismissed."
                        side=$side_number
                        canrecruit=yes
                        side_for=$side_number
                    [/message]
                    [kill]
                        x,y=$hench_query[$last_hench].x,$hench_query[$last_hench].y
                        animate=yes
                    [/kill]
                [/else]
            [/if]
            {CLEAR_VARIABLE last_hench}
        [/then]
    [/if]
    {CLEAR_VARIABLE max_hench_minus}
    {CLEAR_VARIABLE hench_query}
    {CLEAR_VARIABLE focus_hench}
#enddef

#define MODRPG_COMMAND_FOCUS_UNDEAD
    [set_menu_item]
        id=x_release_focus_undead
        image=commands/skull.png
        description=_ "Release Focus On Minion"
        [filter_location]
            x,y=$x1,$y1
            [filter]
                side=$side_number
                race=undead
                [not]
                    canrecruit=yes
                [/not]
                [filter_wml]
                    [variables]
                        is_hench=1
                    [/variables]
                [/filter_wml]
            [/filter]
        [/filter_location]
        [command]
            [store_unit]
                variable=focus_hench
                [filter]
                    x,y=$x1,$y1
                [/filter]
            [/store_unit]
            {VARIABLE focus_hench.variables.is_hench 0}
            {CLEAR_VARIABLE focus_hench.name}
            {CLEAR_VARIABLE focus_hench.overlays}
            [unstore_unit]
                variable=focus_hench
            [/unstore_unit]
            [remove_unit_overlay]
                x,y=$focus_hench.x,$focus_hench.y
                image=misc/hero-icon.png
            [/remove_unit_overlay]
            {CLEAR_VARIABLE focus_hench}
        [/command]
    [/set_menu_item]
    [event]
        name=scenario_end
        [clear_menu_item]
            id=x_release_focus_undead
        [/clear_menu_item]
    [/event]
    [set_menu_item]
        id=x_focus_undead
        image=commands/skull.png
        description=_ "Make Permanent Minion"
        [filter_location]
            [filter]
                side=$side_number
                race=undead
                [not]
                    canrecruit=yes
                [/not]
                [not]
                    [filter_wml]
                        [variables]
                            is_hench=1
                        [/variables]
                    [/filter_wml]
                [/not]
            [/filter]
        [/filter_location]
        [command]
            [store_unit]
                [filter]
                    side=$const.player_sides
                    canrecruit=yes
                [/filter]
                variable=hench_num_query
            [/store_unit]
            [switch]
                variable=hench_num_query.length
                [case]
                    value=1
                    {VARIABLE max_hench 5}
                [/case]
                [case]
                    value=2
                    {VARIABLE max_hench 4}
                [/case]
                [case]
                    value=3
                    {VARIABLE max_hench 3}
                [/case]
                [case]
                    value=4
                    {VARIABLE max_hench 2}
                [/case]
                [else]
                    {VARIABLE max_hench 1}
                [/else]
            [/switch]
            {CLEAR_VARIABLE hench_num_query}
            [store_unit]
                variable=focus_hench
                [filter]
                    x,y=$x1,$y1
                [/filter]
            [/store_unit]
            [store_unit]
                variable=hench_query
                [filter]
                    side=$side_number
                    [not]
                        canrecruit=yes
                    [/not]
                    [filter_wml]
                        [variables]
                            is_hench=1
                            sp_side=$focus_hench.variables.sp_side
                        [/variables]
                    [/filter_wml]
                    [not]
                        x,y=$x1,$y1
                    [/not]
                [/filter]
            [/store_unit]
            #{INITIALIZE_PLAGUED hench_query}
            {VARIABLE minion_s ""}
            {VARIABLE which_hench ""}
            [if]
                [variable]
                    name=hench_query.length
                    greater_than_equal_to=$max_hench
                [/variable]
                [then]
                    {VARIABLE last_hench $hench_query.length}
                    {VARIABLE_OP last_hench sub 1}
                    {VARIABLE which_hench $hench_query[$last_hench].language_name}
                    {VARIABLE_OP query_name_length string_length $hench_query[$last_hench].name}
                    [if]
                        [variable]
                            name=query_name_length
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE which_hench_temp $which_hench}
                            {VARIABLE which_hench "$hench_query[$last_hench].name the $which_hench_temp"}
                            {CLEAR_VARIABLE which_hench_temp}
                        [/then]
                    [/if]
                [/then]
                [else]
                    {VARIABLE which_hench "no unit"}
                [/else]
            [/if]
            {IF_VAR max_hench numerical_equals 1 (
                [then]
                    {VARIABLE minion_s ""}
                [/then]
                [else]
                    {VARIABLE minion_s "s"}
                [/else]
            )}
            {IF_VAR which_hench equals "no unit" (
                [then]
                    {UNDEAD_FOCUS_MACRO}
                [/then]
                [else]
                    [message]
                        x,y=$x1,$y1
                        message=_ "You can have a maximum of $max_hench minion$minion_s|. Living units over this max will leave. Undead units over this max will deteriorate. If you put your focus on this unit, $which_hench will lose focus. You can manually release the focus on unwanted minions.
Do you want to keep this minion permanently?"
                        [option]
                            label=_ "No."
                            [command]
                            [/command]
                        [/option]
                        [option]
                            label=_ "Yes."
                            [command]
                                {UNDEAD_FOCUS_MACRO}
                            [/command]
                        [/option]
                    [/message]
                [/else]
            )}
            {CLEAR_VARIABLE minion_s}
            {CLEAR_VARIABLE which_hench}
            {CLEAR_VARIABLE focus_hench}
            {CLEAR_VARIABLE hench_query}
        [/command]
    [/set_menu_item]
    [event]
        name=scenario_end
        [clear_menu_item]
            id=x_focus_undead
        [/clear_menu_item]
    [/event]
#enddef

#define MODRPG_COMMAND_UPGRADE_UNDEAD
    [set_menu_item]
        id=w_upgrade_undead
        image=commands/skull.png
        description=_ "Upgrade Undead"
        [filter_location]
            x,y=$x1,$y1
            [filter]
                side=$side_number
                race=undead
                [not]
                    canrecruit=yes
                [/not]
            [/filter]
        [/filter_location]
        [command]
            [store_unit]
                variable=undead_side
                [filter]
                    x,y=$x1,$y1
                [/filter]
            [/store_unit]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                    [filter_wml]
                        [variables]
                            sp_side=$undead_side.variables.sp_side
                        [/variables]
                    [/filter_wml]
                [/filter]
            [/store_unit]
            {CLEAR_VARIABLE undead_side}
            [if]
                [variable]
                    name=current_unit.variables.abilities.dark_magic
                    numerical_equals=1
                [/variable]
                [then]
                    [store_unit]
                        variable=undead_unit
                        [filter]
                            x,y=$x1,$y1
                        [/filter]
                    [/store_unit]
                    [store_unit]
                        variable=cancel_undead_unit
                        [filter]
                            x,y=$x1,$y1
                        [/filter]
                    [/store_unit]
                    #{INITIALIZE_PLAGUED cancel_undead_unit}
                    #{INITIALIZE_PLAGUED undead_unit}
                    {VARIABLE upgrading 1}
                    [while]
                        [variable]
                            name=upgrading
                            numerical_equals=1
                        [/variable]
                        [do]
                            #figure points total and then points used, declare points left
                            {VARIABLE undead_points $current_unit.variables.abilities.magic_casting.power}
                            {VARIABLE_OP undead_points multiply 3}
                            {VARIABLE_OP undead_points add 2}
                            {VARIABLE undead_level $undead_unit.level}
                            {VARIABLE_OP undead_level multiply 3}
                            {VARIABLE_OP undead_points add $undead_level}
                            {VARIABLE_OP undead_points sub $undead_unit.variables.undead_points_used}
                            [construct_unit]
                                variable=undead_unit
                            [/construct_unit]
                            {VARIABLE has_skirmisher 0}
                            [for]
                                array=undead_unit.abilities
                                variable=i
                                [do]
                                    [if]
                                        [variable]
                                            name=undead_unit.abilities[$i].skirmisher.id
                                            equals=skirmisher
                                        [/variable]
                                        [then]
                                            {VARIABLE has_skirmisher 1}
                                        [/then]
                                    [/if]
                                [/do]
                            [/for]
                            {VARIABLE has_stalk 0}
                            [for]
                                array=undead_unit.abilities
                                variable=i
                                [do]
                                    [if]
                                        [variable]
                                            name=undead_unit.abilities[$i].nightstalk.id
                                            equals=nightstalk
                                        [/variable]
                                        [then]
                                            {VARIABLE has_stalk 1}
                                        [/then]
                                    [/if]
                                [/do]
                            [/for]
                            {VARIABLE has_wallpass 0}
                            [for]
                                array=undead_unit.abilities
                                variable=i
                                [do]
                                    [if]
                                        [variable]
                                            name=undead_unit.abilities[$i].dummy.id
                                            equals=wallpass
                                        [/variable]
                                        [then]
                                            {VARIABLE has_wallpass 1}
                                        [/then]
                                    [/if]
                                [/do]
                            [/for]
                            #vigor mortis level
                            {VARIABLE temp_blade_resist $undead_unit.resistance.blade}
                            {VARIABLE_OP temp_blade_resist divide 10}
                            {VARIABLE_OP temp_blade_resist sub 10}
                            {VARIABLE_OP temp_blade_resist multiply -1}
                            #[if]
                            #    [variable]
                            #        name=undead_unit.type
                            #        equals=Skeleton_MODRPG
                            #    [/variable]
                            #    [then]
                            #        [construct_unit]
                            #            variable=undead_unit
                            #        [/construct_unit]
                            #        [store_unit]
                            #            variable=undead_unit
                            #            [filter]
                            #                x,y=$undead_unit.x,$undead_unit.y
                            #            [/filter]
                            #        [/store_unit]
                            #    [/then]
                            #[/if]
                            [message]
                                x,y=$x1,$y1
                                message= _ "This unit has $undead_points points left for upgrades.
To gain more points, level the unit up or improve your own necromantic casting power."

                                #list of options based on unit type and upgrades
                                [option]
                                    label=_ "(End)"
                                    image=check.png
                                    [command]
                                        {VARIABLE upgrading 0}
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "(Cancel Changes)"
                                    image=x.png
                                    [command]
                                        [unstore_unit]
                                            variable=cancel_undead_unit
                                        [/unstore_unit]
                                        {CLEAR_VARIABLE undead_unit}
                                        {CLEAR_VARIABLE cancel_undead_unit}
                                        {VARIABLE upgrading 0}
                                    [/command]
                                [/option]

                                #walking corpse upgrades
                                [option]
                                    label=_ "Solidify
Enters Walking Corpse upgrade tree, +1 strike, +1 damage"
                                    description=_ "2"
                                    image=attacks/touch-zombie.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Walking Corpse_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=2
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.variables.corpse_type
                                                    not_equals="wc"
                                                [/variable]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.attack.damage add 1}
                                        {VARIABLE_OP undead_unit.attack.number add 1}
                                        {VARIABLE attack_range $undead_unit.attack.range}
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|.damage add 1}
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|.number add 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 2}
                                        {VARIABLE undead_unit.variables.corpse_type "wc"}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Damage Upgrade: touch
+1 to damage"
                                    description=_ "1"
                                    image=attacks/touch-zombie.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.variables.corpse_type
                                            equals="wc"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=1
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.attack.damage add 1}
                                        {VARIABLE attack_range $undead_unit.attack.range}
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|.damage add 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 1}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Strike Upgrade: touch
+1 to strikes"
                                    description=_ "3"
                                    image=attacks/touch-zombie.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.variables.corpse_type
                                            equals="wc"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=3
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.attack.number add 1}
                                        {VARIABLE attack_range $undead_unit.attack.range}
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|.number add 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 3}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Vigor Mortis
+10 to all resistances except arcane, max of 50%
Current level - $temp_blade_resist"
                                    description=_ "2"
                                    image=attacks/touch-zombie.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.variables.corpse_type
                                            equals="wc"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=2
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.resistance.blade
                                                    greater_than=50
                                                [/variable]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.resistance.blade sub 10}
                                        {VARIABLE_OP undead_unit.resistance.impact sub 10}
                                        {VARIABLE_OP undead_unit.resistance.fire sub 10}
                                        {VARIABLE_OP undead_unit.resistance.cold sub 10}
                                        {VARIABLE_OP undead_unit.resistance.pierce sub 10}
                                        {VARIABLE_OP undead_unit.variables.resistance.blade sub 10}
                                        {VARIABLE_OP undead_unit.variables.resistance.impact sub 10}
                                        {VARIABLE_OP undead_unit.variables.resistance.fire sub 10}
                                        {VARIABLE_OP undead_unit.variables.resistance.cold sub 10}
                                        {VARIABLE_OP undead_unit.variables.resistance.pierce sub 10}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 2}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Fortify
+6 hitpoints"
                                    description=_ "1"
                                    image=attacks/touch-zombie.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.variables.corpse_type
                                            equals="wc"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=1
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.hitpoints add 6}
                                        {VARIABLE_OP undead_unit.max_hitpoints add 6}
                                        {VARIABLE_OP undead_unit.variables.hitpoints add 6}
                                        {VARIABLE_OP undead_unit.variables.max_hitpoints add 6}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 1}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Hasten
+1 movement point"
                                    description=_ "3"
                                    image=attacks/touch-zombie.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.variables.corpse_type
                                            equals="wc"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=3
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.moves add 1}
                                        {VARIABLE_OP undead_unit.max_moves add 1}
                                        {VARIABLE_OP undead_unit.variables.max_moves add 1}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 3}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]

                                #ghoul upgrades
                                [option]
                                    label=_ "Putrefy
Enters Ghoul upgrade tree
-2 damage, +1 strike, ghoul resistances"
                                    description=_ "3"
                                    image=attacks/claws-undead.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Walking Corpse_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=3
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.variables.corpse_type
                                                    not_equals="wc"
                                                [/variable]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 3}
                                        {VARIABLE undead_unit.variables.corpse_type "ghoul"}
                                        [set_variables]
                                            name=temp_undead_upgrade
                                            mode=replace
                                            to_variable=undead_unit
                                        [/set_variables]
                                        [set_variables]
                                            name=temp_undead_upgrade
                                            mode=merge
                                            [value]
                                                level=$undead_unit.level
                                                moves=$undead_unit.moves
                                                hitpoints=$undead_unit.hitpoints
                                                max_hitpoints=$undead_unit.max_hitpoints
                                                experience=$undead_unit.experience
                                                max_experience=$undead_unit.max_experience
                                                name=$undead_unit.name
                                                attacks_left=$undead_unit.attacks_left
                                                zoc=$undead_unit.zoc
                                                resting=$undead_unit.resting
                                                overlays=$undead_unit.overlays
                                                name=$undead_unit.name
                                                [variables]
                                                    hitpoints=$undead_unit.variables.hitpoints
                                                    max_hitpoints=$undead_unit.variables.max_hitpoints
                                                    max_moves=$undead_unit.variables.max_moves
                                                    undead_points_used=$undead_unit.variables.undead_points_used
                                                    is_hench=$undead_unit.variables.is_hench
                                                    simple_action=$undead_unit.variables.simple_action
                                                    max_simple_action=$undead_unit.variables.max_simple_action
                                                [/variables]
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE temp_undead_upgrade_attack_damage $undead_unit.attack.damage}
                                        {VARIABLE_OP temp_undead_upgrade_attack_damage sub 2}
                                        {VARIABLE temp_undead_upgrade_attack_number $undead_unit.attack.number}
                                        {VARIABLE_OP temp_undead_upgrade_attack_number add 1}
                                        {VARIABLE temp_undead_unit_sp_side $undead_unit.variables.sp_side}
                                        [kill]
                                            x=$undead_unit.x
                                            y=$undead_unit.y
                                            fire_event=no
                                        [/kill]
                                        [unit]
                                            side=$undead_unit.side
                                            type=Ghoul_MODRPG
                                            x=$undead_unit.x
                                            y=$undead_unit.y
                                            generate_name=yes
                                            random_traits=yes
                                            random_gender=yes
                                            upkeep=full
                                            [status]
                                                construct_unit=yes
                                            [/status]
                                        [/unit]
                                        [store_unit]
                                            [filter]
                                                x=$undead_unit.x
                                                y=$undead_unit.y
                                            [/filter]
                                            variable=undead_unit
                                        [/store_unit]
                                        #[unit_npc_init]
                                        #    variable=undead_unit
                                        #[/unit_npc_init]
                                        {CREATE_BASE "undead_unit"}
                                        {VARIABLE undead_unit.variables.sp_side $temp_undead_unit_sp_side}
                                        {CLEAR_VARIABLE temp_undead_unit_sp_side}
                                        {VARIABLE unit_path "undead_unit"}
                                        {NPC_RACE_BASE "undead_unit"}
                                        [fire_event]
                                            name=npc_apply_traits
                                        [/fire_event]
                                        [fire_event]
                                            name=npc_apply_items
                                        [/fire_event]
                                        #{VARIABLE undead_unit.variables.abilities.empty_ability 1}
                                        {VARIABLE undead_unit.variables.mobility 1}
                                        [set_variables]
                                            name=undead_unit
                                            mode=merge
                                            [value]
                                                level=$temp_undead_upgrade.level
                                                moves=$temp_undead_upgrade.moves
                                                hitpoints=$temp_undead_upgrade.hitpoints
                                                max_hitpoints=$temp_undead_upgrade.max_hitpoints
                                                experience=$temp_undead_upgrade.experience
                                                max_experience=$temp_undead_upgrade.max_experience
                                                name=$temp_undead_upgrade.name
                                                attacks_left=$temp_undead_upgrade.attacks_left
                                                zoc=$temp_undead_upgrade.zoc
                                                resting=$temp_undead_upgrade.resting
                                                overlays=$temp_undead_upgrade.overlays
                                                name=$temp_undead_upgrade.name
                                                [variables]
                                                    hitpoints=$temp_undead_upgrade.variables.hitpoints
                                                    max_hitpoints=$temp_undead_upgrade.variables.max_hitpoints
                                                    max_moves=$temp_undead_upgrade.variables.max_moves
                                                    undead_points_used=$temp_undead_upgrade.variables.undead_points_used
                                                    simple_action=$temp_undead_upgrade.variables.simple_action
                                                    max_simple_action=$temp_undead_upgrade.variables.max_simple_action
                                                    is_hench=$temp_undead_upgrade.variables.is_hench
                                                [/variables]
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE undead_unit.attack.damage $temp_undead_upgrade_attack_damage}
                                        {VARIABLE undead_unit.attack.number $temp_undead_upgrade_attack_number}
                                        #Remove fists
                                        {CLEAR_VARIABLE undead_unit.variables.inventory.weapons.melee[0]}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                        {CLEAR_VARIABLE temp_undead_upgrade}
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Fortify
+6 hitpoints"
                                    description=_ "1"
                                    image=attacks/claws-undead.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Ghoul_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=1
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.hitpoints add 6}
                                        {VARIABLE_OP undead_unit.max_hitpoints add 6}
                                        {VARIABLE_OP undead_unit.variables.hitpoints add 6}
                                        {VARIABLE_OP undead_unit.variables.max_hitpoints add 6}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 1}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Hasten
+1 movement point"
                                    description=_ "3"
                                    image=attacks/claws-undead.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Ghoul_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=3
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.moves add 1}
                                        {VARIABLE_OP undead_unit.max_moves add 1}
                                        {VARIABLE_OP undead_unit.variables.max_moves add 1}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 3}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Damage Upgrade
+1 to damage"
                                    description=_ "1"
                                    image=attacks/claws-undead.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Ghoul_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=1
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.attack.damage add 1}
                                        {VARIABLE attack_range $undead_unit.attack.range}
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|.damage add 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 1}
                                        [if]
                                            [variable]
                                                name=undead_unit.attack[1].name
                                                equals=bite
                                            [/variable]
                                            [then]
                                                {VARIABLE_OP undead_unit.attack[1].damage add 1}
                                                {VARIABLE attack_range $undead_unit.attack[1].range}
                                                {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|[1].damage add 1}
                                                {CLEAR_VARIABLE attack_range}
                                            [/then]
                                        [/if]
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Strike Upgrade
+1 to strikes"
                                    description=_ "3"
                                    image=attacks/claws-undead.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Ghoul_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=3
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.attack.number add 1}
                                        {VARIABLE attack_range $undead_unit.attack.range}
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|.number add 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 3}
                                        [if]
                                            [variable]
                                                name=undead_unit.attack[1].name
                                                equals=bite
                                            [/variable]
                                            [then]
                                                {VARIABLE_OP undead_unit.attack[1].number add 1}
                                                {VARIABLE attack_range $undead_unit.attack[1].range}
                                                {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|[1].number add 1}
                                                {CLEAR_VARIABLE attack_range}
                                            [/then]
                                        [/if]
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Poison Claws"
                                    description=_ "3"
                                    image=attacks/claws-undead.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Ghoul_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=3
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.attack.specials.poison.id
                                                    not_equals=poison
                                                [/variable]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        [set_variables]
                                            name=undead_unit.attack.specials.poison
                                            mode=merge
                                            [value]
                                                id=poison
                                                name= _ "poison"
                                                description= _ "Poison:
This attack poisons living targets. Poisoned units lose 8 HP every turn until they are cured or are reduced to 1 HP. Poison can not, of itself, kill a unit."
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE attack_range $undead_unit.attack.range}
                                        {VARIABLE undead_unit.variables.inventory.weapons.$attack_range|.special_type.poison 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 3}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "New Attack: bite
$(0$undead_unit.attack.damage+2)-$(0$undead_unit.attack.number-1) melee blade, drains"
                                    description=_ "3"
                                    image=attacks/fangs.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Ghoul_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=3
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.attack[1].name
                                                    not_equals=bite
                                                [/variable]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {CLEAR_VARIABLE new_attack}
                                        [set_variables]
                                            name=new_attack
                                            mode=append
                                            [value]
                                                name=bite
                                                description=_"bite"
                                                icon="attacks/fangs.png"
                                                type=blade
                                                range=melee
                                                damage="$(0$undead_unit.attack.damage+2)"
                                                number="$(0$undead_unit.attack.number-1)"
                                                [specials]
                                                    {WEAPON_SPECIAL_DRAIN}
                                                [/specials]
                                            [/value]
                                        [/set_variables]
                                        [create_attack_weapon]
                                            variable=new_attack
                                            attack=new_attack
                                        [/create_attack_weapon]
                                        [adjust_weapon_description]
                                            variable=new_attack
                                        [/adjust_weapon_description]
                                        [set_variables]
                                            name=undead_unit.variables.inventory.weapons.melee
                                            mode=append
                                            to_variable=new_attack
                                        [/set_variables]
                                        {CLEAR_VARIABLE new_attack}
                                        {VARIABLE undead_unit.variables.abilities.drains 1}
                                        {VARIABLE undead_unit.variables.abilities.wield 1}
                                        {VARIABLE undead_unit.variables.equipment_slots.melee_2 0}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 3}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Ability: feeding
+1 hitpoints, +1 max hitpoints when living target killed"
                                    description=_ "2"
                                    image=attacks/fangs.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Ghoul_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=2
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.abilities.dummy.id
                                                    not_equals=feeding_MODRPG
                                                [/variable]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        [set_variables]
                                            name=undead_unit.abilities
                                            mode=append
                                            [value]
                                                [dummy]
                                                    #it gave me some grief when I tried to add it to the unit normally
                                                    id=feeding_MODRPG
                                                    name= _ "feeding"
                                                    female_name= _ "female^feeding"
                                                    description=_ "Feeding:
This unit gains 1 hitpoint added to its maximum whenever it kills a living unit."
                                                [/dummy]
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE undead_unit.variables.abilities.feeding 1}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 2}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]

                                #skeleton upgrades
                                [option]
                                    label=_ "Ossify
Enters Skeleton upgrade tree, can use weapons"
                                    description=_ "4"
                                    image=attacks/fist-skeletal.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Walking Corpse_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=4
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.variables.corpse_type
                                                    not_equals="wc"
                                                [/variable]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 4}
                                        {VARIABLE undead_unit.variables.corpse_type "skel"}
                                        [set_variables]
                                            name=temp_undead_upgrade
                                            mode=replace
                                            to_variable=undead_unit
                                        [/set_variables]
                                        [set_variables]
                                            name=temp_undead_upgrade
                                            mode=merge
                                            [value]
                                                level=$undead_unit.level
                                                moves=$undead_unit.moves
                                                hitpoints=$undead_unit.hitpoints
                                                max_hitpoints=$undead_unit.max_hitpoints
                                                experience=$undead_unit.experience
                                                max_experience=$undead_unit.max_experience
                                                name=$undead_unit.name
                                                attacks_left=$undead_unit.attacks_left
                                                zoc=$undead_unit.zoc
                                                resting=$undead_unit.resting
                                                overlays=$undead_unit.overlays
                                                [variables]
                                                    hitpoints=$undead_unit.variables.hitpoints
                                                    max_hitpoints=$undead_unit.variables.max_hitpoints
                                                    max_moves=$undead_unit.variables.max_moves
                                                    is_hench=$undead_unit.variables.is_hench
                                                    max_simple_action=$undead_unit.variables.max_simple_action
                                                    undead_points_used=$undead_unit.variables.undead_points_used
                                                    simple_action=$undead_unit.variables.simple_action
                                                [/variables]
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE temp_undead_unit_sp_side $undead_unit.variables.sp_side}
                                        [kill]
                                            x=$undead_unit.x
                                            y=$undead_unit.y
                                            fire_event=no
                                        [/kill]
                                        [unit]
                                            side=$undead_unit.side
                                            type=Skeleton_MODRPG
                                            x=$undead_unit.x
                                            y=$undead_unit.y
                                            generate_name=yes
                                            random_traits=yes
                                            random_gender=yes
                                            upkeep=full
                                            [status]
                                                construct_unit=yes
                                            [/status]
                                        [/unit]
                                        [store_unit]
                                            [filter]
                                                x=$undead_unit.x
                                                y=$undead_unit.y
                                            [/filter]
                                            variable=undead_unit
                                        [/store_unit]
                                        #[unit_npc_init]
                                        #    variable=undead_unit
                                        #[/unit_npc_init]
                                        {CREATE_BASE "undead_unit"}
                                        {VARIABLE undead_unit.variables.sp_side $temp_undead_unit_sp_side}
                                        {CLEAR_VARIABLE temp_undead_unit_sp_side}
                                        {VARIABLE unit_path "undead_unit"}
                                        {NPC_RACE_BASE "undead_unit"}
                                        [fire_event]
                                            name=npc_apply_traits
                                        [/fire_event]
                                        [fire_event]
                                            name=npc_apply_items
                                        [/fire_event]
                                        [set_variables]
                                            name=undead_unit
                                            mode=merge
                                            [value]
                                                level=$temp_undead_upgrade.level
                                                moves=$temp_undead_upgrade.moves
                                                hitpoints=$temp_undead_upgrade.hitpoints
                                                max_hitpoints=$temp_undead_upgrade.max_hitpoints
                                                experience=$temp_undead_upgrade.experience
                                                max_experience=$temp_undead_upgrade.max_experience
                                                name=$temp_undead_upgrade.name
                                                attacks_left=$temp_undead_upgrade.attacks_left
                                                zoc=$temp_undead_upgrade.zoc
                                                resting=$temp_undead_upgrade.resting
                                                overlays=$temp_undead_upgrade.overlays
                                                [variables]
                                                    body=6
                                                    deft=6
                                                    mind=2
                                                    hitpoints=$temp_undead_upgrade.variables.hitpoints
                                                    max_hitpoints=$temp_undead_upgrade.variables.max_hitpoints
                                                    max_moves=$temp_undead_upgrade.variables.max_moves
                                                    undead_points_used=$temp_undead_upgrade.variables.undead_points_used
                                                    simple_action=$temp_undead_upgrade.variables.simple_action
                                                    max_simple_action=$temp_undead_upgrade.variables.max_simple_action
                                                    is_hench=$temp_undead_upgrade.variables.is_hench
                                                [/variables]
                                            [/value]
                                        [/set_variables]
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                        {CLEAR_VARIABLE temp_undead_upgrade}
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Upgrade Body
Current Body: $undead_unit.variables.body"
                                    description=_ "1"
                                    image=attacks/fist-skeletal.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Skeleton_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=1
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 1}
                                        {VARIABLE_OP undead_unit.variables.body add 2}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Upgrade Deft
Current Deft: $undead_unit.variables.deft"
                                    description=_ "1"
                                    image=attacks/fist-skeletal.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Skeleton_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=1
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 1}
                                        {VARIABLE_OP undead_unit.variables.deft add 2}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Fortify
+6 hitpoints"
                                    description=_ "2"
                                    image=attacks/fist-skeletal.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Skeleton_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=2
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.hitpoints add 6}
                                        {VARIABLE_OP undead_unit.max_hitpoints add 6}
                                        {VARIABLE_OP undead_unit.variables.hitpoints add 6}
                                        {VARIABLE_OP undead_unit.variables.max_hitpoints add 6}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 2}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Hasten
+1 movement point"
                                    description=_ "3"
                                    image=attacks/fist-skeletal.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Skeleton_MODRPG"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=3
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.moves add 1}
                                        {VARIABLE_OP undead_unit.max_moves add 1}
                                        {VARIABLE_OP undead_unit.variables.max_moves add 1}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 3}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]

                                #spirit upgrades
                                [option]
                                    label=_ "Fortify
+3 hitpoints"
                                    description=_ "1"
                                    image=attacks/touch-undead.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=1
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.hitpoints add 3}
                                        {VARIABLE_OP undead_unit.max_hitpoints add 3}
                                        {VARIABLE_OP undead_unit.variables.hitpoints add 3}
                                        {VARIABLE_OP undead_unit.variables.max_hitpoints add 3}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 1}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Hasten
+1 movement point"
                                    description=_ "2"
                                    image=attacks/touch-undead.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=2
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.moves add 1}
                                        {VARIABLE_OP undead_unit.max_moves add 1}
                                        {VARIABLE_OP undead_unit.variables.max_moves add 1}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 2}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Alter Attack: baneblade
+2 damage, +1 strike to melee attack 
disallows skirmisher, disallows wall pass, disallows claws"
                                    description=_ "4"
                                    image=attacks/baneblade.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=4
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.attack.name
                                                    equals=touch
                                                [/variable]
                                                [and]
                                                    [variable]
                                                        name=has_skirmisher
                                                        numerical_equals=0
                                                    [/variable]
                                                    [and]
                                                        [variable]
                                                            name=has_wallpass
                                                            numerical_equals=0
                                                        [/variable]
                                                    [/and]
                                                [/and]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        [set_variables]
                                            name=undead_unit.attack
                                            mode=merge
                                            [value]
                                                name=baneblade
                                                description=_"baneblade"
                                                icon=attacks/baneblade.png
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE_OP undead_unit.attack.damage add 2}
                                        {VARIABLE_OP undead_unit.attack.number add 1}
                                        {VARIABLE attack_range $undead_unit.attack.range}
                                        [set_variables]
                                            name=undead_unit.variables.inventory.weapons.$attack_range|
                                            mode=merge
                                            [value]
                                                name=baneblade
                                                description=_"baneblade"
                                                icon=attacks/baneblade.png
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|.damage add 2}
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|.number add 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 4}
                                        [set_variables]
                                            name=temp_undead_upgrade
                                            mode=replace
                                            [value]
                                                level=$undead_unit.level
                                                moves=$undead_unit.moves
                                                max_moves=$undead_unit.max_moves
                                                hitpoints=$undead_unit.hitpoints
                                                max_hitpoints=$undead_unit.max_hitpoints
                                                experience=$undead_unit.experience
                                                max_experience=$undead_unit.max_experience
                                                [variables]
                                                    undead_points_used=$undead_unit.variables.undead_points_used
                                                [/variables]
                                            [/value]
                                        [/set_variables]
                                        [set_variables]
                                            name=temp_undead_upgrade.attack
                                            mode=replace
                                            to_variable=undead_unit.attack
                                        [/set_variables]
                                        [set_variables]
                                            name=temp_undead_upgrade.abilities
                                            mode=replace
                                            to_variable=undead_unit.abilities
                                        [/set_variables]
                                        [unstore_unit]
                                            variable=undead_unit
                                        [/unstore_unit]
                                        [object]
                                            id=appearance
                                            name="appearance"
                                            silent=yes
                                            [filter]
                                                x=$undead_unit.x
                                                y=$undead_unit.y
                                            [/filter]
                                            [effect]
                                                apply_to=variation
                                                name=baneblade
                                            [/effect]
                                        [/object]
                                        [store_unit]
                                            [filter]
                                                x=$undead_unit.x
                                                y=$undead_unit.y
                                            [/filter]
                                            variable=undead_unit
                                        [/store_unit]
                                        [set_variables]
                                            name=undead_unit
                                            mode=merge
                                            [value]
                                                level=$temp_undead_upgrade.level
                                                moves=$temp_undead_upgrade.moves
                                                max_moves=$temp_undead_upgrade.max_moves
                                                hitpoints=$temp_undead_upgrade.hitpoints
                                                max_hitpoints=$temp_undead_upgrade.max_hitpoints
                                                experience=$temp_undead_upgrade.experience
                                                max_experience=$temp_undead_upgrade.max_experience
                                                [variables]
                                                    undead_points_used=$undead_unit.variables.undead_points_used
                                                [/variables]
                                            [/value]
                                        [/set_variables]
                                        [set_variables]
                                            name=undead_unit.attack
                                            mode=replace
                                            to_variable=temp_undead_upgrade.attack
                                        [/set_variables]
                                        [set_variables]
                                            name=undead_unit.abilities
                                            mode=replace
                                            to_variable=temp_undead_upgrade.abilities
                                        [/set_variables]
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                        {CLEAR_VARIABLE temp_undead_upgrade}
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Alter Attack: claws
+2 damage, blade type, allows nightstalk, allows backstab
disallows drain, disallows baneblade, disallows wall pass"
                                    description=_ "2"
                                    image=attacks/claws-undead.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=2
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.attack.name
                                                    equals=touch
                                                [/variable]
                                                [and]
                                                    [variable]
                                                        name=has_wallpass
                                                        numerical_equals=0
                                                    [/variable]
                                                [/and]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        [set_variables]
                                            name=undead_unit.attack
                                            mode=merge
                                            [value]
                                                name=claws
                                                description=_"claws"
                                                type=blade
                                                icon=attacks/claws-undead.png
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE_OP undead_unit.attack.damage add 2}
                                        {CLEAR_VARIABLE undead_unit.attack.specials}
                                        {VARIABLE attack_range $undead_unit.attack.range}
                                        [set_variables]
                                            name=undead_unit.variables.inventory.weapons.$attack_range|
                                            mode=merge
                                            [value]
                                                name=claws
                                                description=_"claws"
                                                type=blade
                                                icon=attacks/claws-undead.png
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|.damage add 2}
                                        {CLEAR_VARIABLE undead_unit.variables.inventory.weapons.$attack_range|.special_type}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 2}
                                        [set_variables]
                                            name=temp_undead_upgrade
                                            mode=replace
                                            [value]
                                                level=$undead_unit.level
                                                moves=$undead_unit.moves
                                                max_moves=$undead_unit.max_moves
                                                hitpoints=$undead_unit.hitpoints
                                                max_hitpoints=$undead_unit.max_hitpoints
                                                experience=$undead_unit.experience
                                                max_experience=$undead_unit.max_experience
                                                [variables]
                                                    undead_points_used=$undead_unit.variables.undead_points_used
                                                [/variables]
                                            [/value]
                                        [/set_variables]
                                        [set_variables]
                                            name=temp_undead_upgrade.attack
                                            mode=replace
                                            to_variable=undead_unit.attack
                                        [/set_variables]
                                        [set_variables]
                                            name=temp_undead_upgrade.abilities
                                            mode=replace
                                            to_variable=undead_unit.abilities
                                        [/set_variables]
                                        # just put in for the rousing check
                                        {VARIABLE undead_unit.variables.mobility 1}
                                        [unstore_unit]
                                            variable=undead_unit
                                        [/unstore_unit]
                                        [object]
                                            id=appearance
                                            name="appearance"
                                            silent=yes
                                            [filter]
                                                x=$undead_unit.x
                                                y=$undead_unit.y
                                            [/filter]
                                            [effect]
                                                apply_to=variation
                                                name=shadow
                                            [/effect]
                                        [/object]
                                        [store_unit]
                                            [filter]
                                                x=$undead_unit.x
                                                y=$undead_unit.y
                                            [/filter]
                                            variable=undead_unit
                                        [/store_unit]
                                        [set_variables]
                                            name=undead_unit
                                            mode=merge
                                            [value]
                                                level=$temp_undead_upgrade.level
                                                moves=$temp_undead_upgrade.moves
                                                max_moves=$temp_undead_upgrade.max_moves
                                                hitpoints=$temp_undead_upgrade.hitpoints
                                                max_hitpoints=$temp_undead_upgrade.max_hitpoints
                                                experience=$temp_undead_upgrade.experience
                                                max_experience=$temp_undead_upgrade.max_experience
                                                [variables]
                                                    undead_points_used=$temp_undead_upgrade.variables.undead_points_used
                                                [/variables]
                                            [/value]
                                        [/set_variables]
                                        [set_variables]
                                            name=undead_unit.attack
                                            mode=replace
                                            to_variable=temp_undead_upgrade.attack
                                        [/set_variables]
                                        [set_variables]
                                            name=undead_unit.abilities
                                            mode=replace
                                            to_variable=temp_undead_upgrade.abilities
                                        [/set_variables]
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                        {CLEAR_VARIABLE temp_undead_upgrade}
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Upgrade Attack: backstab"
                                    description=_ "2"
                                    image=attacks/claws-undead.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=2
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.attack.name
                                                    equals=claws
                                                [/variable]
                                                [and]
                                                    [variable]
                                                        name=undead_unit.attack.specials.damage.id
                                                        not_equals=backstab
                                                    [/variable]
                                                [/and]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        [set_variables]
                                            name=undead_unit.attack.specials
                                            mode=merge
                                            [value]
                                                {WEAPON_SPECIAL_BACKSTAB}
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE attack_range $undead_unit.attack.range}
                                        {VARIABLE undead_unit.variables.inventory.weapons.$attack_range|.special_type.backstab 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 2}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "New Ability: skirmisher
allows wallpass
disallows baneblade"
                                    description=_ "2"
                                    image=upgrades/skirmisher.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=2
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.attack.name
                                                    not_equals=baneblade
                                                [/variable]
                                                [and]
                                                    [variable]
                                                        name=has_skirmisher
                                                        numerical_not_equals=1
                                                    [/variable]
                                                [/and]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        [set_variables]
                                            name=undead_unit.abilities
                                            mode=append
                                            [value]
                                                {ABILITY_SKIRMISHER}
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE undead_unit.variables.abilities.skirmisher 1}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 2}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "New Ability: nightstalk"
                                    description=_ "2"
                                    image=attacks/claws-undead.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=2
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.attack.name
                                                    equals=claws
                                                [/variable]
                                                [and]
                                                    [variable]
                                                        name=has_stalk
                                                        numerical_not_equals=1
                                                    [/variable]
                                                [/and]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        [set_variables]
                                            name=undead_unit.abilities
                                            mode=append
                                            [value]
                                                {ABILITY_NIGHTSTALK}
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE undead_unit.variables.abilities.nightstalk 1}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 2}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "New Ability: wall pass
Allows this spirit to pass through solid matter
disallows claws, disallows baneblade"
                                    description=_ "3"
                                    image=attacks/dark-missile.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=3
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.attack.name
                                                    not_equals=claws
                                                [/variable]
                                                [and]
                                                    [variable]
                                                        name=undead_unit.attack.name
                                                        not_equals=baneblade
                                                    [/variable]
                                                    [and]
                                                        [variable]
                                                            name=undead_unit.movement_costs.impassable
                                                            greater_than=2
                                                        [/variable]
                                                        [and]
                                                            [variable]
                                                                name=has_skirmisher
                                                                numerical_equals=1
                                                            [/variable]
                                                            [and]
                                                                [variable]
                                                                    name=has_wallpass
                                                                    numerical_not_equals=1
                                                                [/variable]
                                                            [/and]
                                                        [/and]
                                                    [/and]
                                                [/and]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        [set_variables]
                                            name=undead_unit.abilities.dummy
                                            mode=append
                                            [value]
                                                id=wallpass
                                                name="wall pass"
                                                description=_ "Wall Pass:
This unit can pass through solid objects with a cost of 2 movement points."
                                            [/value]
                                        [/set_variables]
                                        {VARIABLE undead_unit.movement_costs.impassable 2}
                                        {VARIABLE undead_unit.variables.abilities.wallpas 1}
                                        {VARIABLE undead_unit.variables.terrain.impassable 2}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 3}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Damage Upgrade: $undead_unit.attack.name|
+1 to damage"
                                    description=_ "1"
                                    image=attacks/baneblade.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=1
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.attack.damage add 1}
                                        {VARIABLE attack_range $undead_unit.attack.range}
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|.damage add 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 1}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Strike Upgrade: $undead_unit.attack.name|
+1 to strikes"
                                    description=_ "3"
                                    image=attacks/baneblade.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=3
                                            [/variable]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.attack.number add 1}
                                        {VARIABLE attack_range $undead_unit.attack.range}
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|.number add 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 3}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "New Attack: wail
2-3 ranged cold"
                                    description=_ "1"
                                    image=attacks/wail.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.attack[1].name
                                                    not_equals=wail
                                                [/variable]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {CLEAR_VARIABLE new_attack}
                                        [set_variables]
                                            name=new_attack
                                            mode=append
                                            [value]
                                                name=wail
                                                description=_"wail"
                                                type=cold
                                                range=ranged
                                                damage=2
                                                number=3
                                                icon=attacks/wail.png
                                            [/value]
                                        [/set_variables]
                                        [create_attack_weapon]
                                            variable=new_attack
                                            attack=new_attack
                                        [/create_attack_weapon]
                                        [adjust_weapon_description]
                                            variable=new_attack
                                        [/adjust_weapon_description]
                                        [set_variables]
                                            name=undead_unit.variables.inventory.weapons.ranged
                                            mode=append
                                            to_variable=new_attack
                                        [/set_variables]
                                        {CLEAR_VARIABLE new_attack}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 1}
                                        {CLEAR_VARIABLE undead_unit.variables.no_ranged}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Damage Upgrade: wail
+1 to damage"
                                    description=_ "1"
                                    image=attacks/wail.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.attack[1].name
                                                    equals=wail
                                                [/variable]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.attack[1].damage add 1}
                                        {VARIABLE attack_range $undead_unit.attack[1].range}
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|[1].damage add 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 1}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                                [option]
                                    label=_ "Strike Upgrade: wail
+1 to strikes"
                                    description=_ "3"
                                    image=attacks/wail.png
                                    [show_if]
                                        [variable]
                                            name=undead_unit.type
                                            equals="Trapped Spirit"
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=undead_points
                                                greater_than_equal_to=3
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=undead_unit.attack[1].name
                                                    equals=wail
                                                [/variable]
                                            [/and]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        {VARIABLE_OP undead_unit.attack[1].number add 1}
                                        {VARIABLE attack_range $undead_unit.attack[1].range}
                                        {VARIABLE_OP undead_unit.variables.inventory.weapons.$attack_range|[1].number add 1}
                                        {CLEAR_VARIABLE attack_range}
                                        {VARIABLE_OP undead_unit.variables.undead_points_used add 3}
                                        [construct_unit]
                                            variable=undead_unit
                                        [/construct_unit]
                                    [/command]
                                [/option]
                            [/message]
                            {CLEAR_VARIABLE temp_blade_resist}
                        [/do]
                    [/while]
                [/then]
                [else]
                    {WML_MSG "You are not a necromancer!!"}
                [/else]
            [/if]
        [/command]
    [/set_menu_item]
    [event]
        name=scenario_end
        [clear_menu_item]
            id=w_upgrade_undead
        [/clear_menu_item]
    [/event]
#enddef
