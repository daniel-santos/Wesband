#define CREATE_SKELETON_FIST
	[set_variables]
		name=fist_temp
		mode=replace
		[value]
			name="fist"
            user_name="fist"
            description=_ "fist"
            icon="fist-skeletal"
            class="bludgeon"
            class_description="Bludgeon"
            undropable=1
            range=melee
            type=impact
            damage=2
            number=1
            body_damage_rate=20
            deft_damage_rate=10
            deft_number_rate=10
			body_number_rate=0
            [special_type]
                skirm=1
            [/special_type]
		[/value]
	[/set_variables]
	{VARIABLE path fist_temp}
	[fire_event]
		name=npc_eval_weapon
	[/fire_event]
#enddef

#define CHANGE_BASE_SKEL_SPRITE PATH
#base image for skel henches
[if]
	[variable]
		name={PATH}.type
		equals=Skeleton_MODRPG
	[/variable]
	[then]	
		{VARIABLE power_check 0}
		{FOREACH {PATH}.attack i}
			{VARIABLE power_check2 ${PATH}.attack[$i].damage}
			{VARIABLE_OP power_check2 multiply ${PATH}.attack[$i].number}
			[if]
				[variable]
					name=power_check2
					greater_than_equal_to=$power_check
				[/variable]
				[then]
					{VARIABLE appear_number $i}
					{VARIABLE power_check $power_check2}
				[/then]
			[/if]
		{NEXT i}
		{VARIABLE {PATH}.variation ${PATH}.attack[$appear_number].name}
		[unstore_unit]
			variable={PATH}
		[/unstore_unit]
		[redraw]
		[/redraw]
	[/then]
[/if]
#enddef

#define LITERAL_CBSS PATH
[if]
	[variable]
		name={PATH}.type
		equals=Skeleton_MODRPG
	[/variable]
	[then]	
		{VARIABLE power_check 0}
		{VARIABLE i 0}
		[while]
		    [variable]
		    name=i
		    less_than=$|{PATH}.attack.length
		    [/variable]
		    [do]
			{VARIABLE power_check2 $|{PATH}.attack[$|i].damage}
			{VARIABLE_OP power_check2 multiply $|{PATH}.attack[$|i].number}
			[if]
				[variable]
					name=power_check2
					greater_than_equal_to=$|power_check
				[/variable]
				[then]
					{VARIABLE appear_number $|i}
					{VARIABLE power_check $|power_check2}
				[/then]
			[/if]
		{NEXT i}
		{VARIABLE {PATH}.variation $|{PATH}.attack[$|appear_number].name}
		[unstore_unit]
			variable={PATH}
		[/unstore_unit]
		[redraw]
		[/redraw]
	[/then]
[/if]
#enddef

#define NPC_EVAL_EQUIPMENT XY
	[if]
		[variable]
			name=unit.variables.inventory.weapons.melee
			equals=$empty
		[/variable]
		[then]
			{FOREACH unit.variables.inventory.weapons.melee m}
				{VARIABLE path "unit.variables.inventory.weapons.melee[$m]"}
				[store_unit]
		            variable=npc_temp
		            [filter]
		                x,y={XY}
		            [/filter]
		        [/store_unit]
				[fire_event]
					name=npc_eval_weapon
				[/fire_event]
				{DROP_UNWANTED}
			{NEXT m}
		[/then]
	[/if]
	[if]
		[variable]
			name=unit.variables.inventory.weapons.ranged
			equals=$empty
		[/variable]
		[then]
			{FOREACH unit.variables.inventory.weapons.ranged r}
				{VARIABLE path "unit.variables.inventory.weapons.ranged[$r]"}
				[store_unit]
		            variable=npc_temp
		            [filter]
		                x,y={XY}
		            [/filter]
		        [/store_unit]
				[fire_event]
					name=npc_eval_weapon
				[/fire_event]
				{DROP_UNWANTED}
			{NEXT r}
		[/then]
	[/if]
	[if]
		[variable]
			name=unit.variables.inventory.armor.torso[0].category
			equals=torso_armor
		[/variable]
		[then]
			{VARIABLE path "unit.variables.inventory.armor.torso[0]"}
			[store_unit]
				variable=npc_temp
				[filter]
					x,y={XY}
				[/filter]
			[/store_unit]
			[fire_event]
				name=npc_eval_armor
			[/fire_event]
			{DROP_UNWANTED}
		[/then]
	[/if]
	[if]
		[variable]
			name=unit.variables.inventory.armor.legs[0].category
			equals=legs_armor
		[/variable]
		[then]
			{VARIABLE path "unit.variables.inventory.armor.legs[0]"}
			[store_unit]
				variable=npc_temp
				[filter]
					x,y={XY}
				[/filter]
			[/store_unit]
			[fire_event]
				name=npc_eval_armor
			[/fire_event]
			{DROP_UNWANTED}
		[/then]
	[/if]
	[if]
		[variable]
			name=unit.variables.inventory.armor.head[0].category
			equals=head_armor
		[/variable]
		[then]
			{VARIABLE path "unit.variables.inventory.armor.head[0]"}
			[store_unit]
				variable=npc_temp
				[filter]
					x,y={XY}
				[/filter]
			[/store_unit]
			[fire_event]
				name=npc_eval_armor
			[/fire_event]
			{DROP_UNWANTED}
		[/then]
	[/if]
	[if]
		[variable]
			name=unit.variables.inventory.armor.shield[0].category
			equals=shield
		[/variable]
		[then]
			{VARIABLE path "unit.variables.inventory.armor.shield[0]"}
			[store_unit]
				variable=npc_temp
				[filter]
					x,y={XY}
				[/filter]
			[/store_unit]
			[fire_event]
				name=npc_eval_shield
			[/fire_event]
			{DROP_UNWANTED}
		[/then]
	[/if]
#enddef

#define MODRPG_NPC_FIND_ARMOR_RES_DIFF TYPE VALUE
{VARIABLE npc_temp_res_{TYPE} $npc_temp.resistance.{TYPE}}
{VARIABLE_OP npc_temp_res_{TYPE} add -$npc_variables.base_race_res.$npc_temp.race|.{TYPE}}
{VARIABLE_OP npc_temp_res_{TYPE} multiply -1}
{VARIABLE_OP npc_temp_res_{TYPE} multiply {VALUE}}
{VARIABLE_OP npc_temp_res_{TYPE} round "ceil"}
{VARIABLE npc_temp_res_diff_{TYPE} $$path|.resistance.{TYPE}}
{VARIABLE_OP npc_temp_res_diff_{TYPE} add -$npc_temp_res_{TYPE}}
#enddef

#define MODRPG_NPC_FIND_SHIELD_DEF_DIFF TERRAIN
[if]
	[variable]
		name=npc_temp.defense.{TERRAIN}
		greater_than=$npc_variables.base_race_def.$npc_temp.race|.{TERRAIN}
	[/variable]
	[then]
		{VARIABLE_OP npc_temp.defense.{TERRAIN} add -$$path|.terrain_recoup}
		[if]
			[variable]
				name=npc_temp.defense.{TERRAIN}
				less_than=$npc_variables.base_race_def.$npc_temp.race|.{TERRAIN}
			[/variable]
			[then]
				{VARIABLE npc_temp.defense.{TERRAIN} $npc_variables.base_race_def.$npc_temp.race|.{TERRAIN}}
			[/then]
		[/if]
	[/then]
[/if]
#enddef

#define CLEAR_ARMOR_CT CATEGORY TYPE
	{FOREACH npc_temp.abilities.resistance i}
		[if]
			[variable]
				name=npc_temp.abilities.resistance[$i].id
				equals=npc_{CATEGORY}_{TYPE}
			[/variable]
			[then]
				{CLEAR_VARIABLE npc_temp.abilities.resistance[$i]}
				{VARIABLE i $npc_temp.abilities.resistance.length}
			[/then]
		[/if]
	{NEXT i}
#enddef

#define CLEAR_ARMOR_C CATEGORY
	{CLEAR_ARMOR_CT {CATEGORY} "arcane"}
	{CLEAR_ARMOR_CT {CATEGORY} "blade"}
	{CLEAR_ARMOR_CT {CATEGORY} "fire"}
	{CLEAR_ARMOR_CT {CATEGORY} "cold"}
	{CLEAR_ARMOR_CT {CATEGORY} "impact"}
	{CLEAR_ARMOR_CT {CATEGORY} "pierce"}
#enddef

#define CLEAR_ARMOR
	{CLEAR_ARMOR_C "torso_armor"}
	{CLEAR_ARMOR_C "legs_armor"}
	{CLEAR_ARMOR_C "head_armor"}
	{FOREACH npc_temp.abilities.dummy i}
		[if]
			[variable]
				name=npc_temp.abilities.dummy[$i].id
				equals="npc_armor_display"
			[/variable]
			[then]
				{CLEAR_VARIABLE npc_temp.abilities.dummy[$i]}
				{VARIABLE i $npc_temp.abilities.dummy.length}
			[/then]
		[/if]
	{NEXT i}
#enddef

#define MODRPG_NPC_ARMOR_ABILITY CATEGORY TYPE
	{CLEAR_ARMOR_CT {CATEGORY} {TYPE}}
	[set_variables]
		name=npc_temp.abilities.resistance
		mode=append
		[value]
			id=npc_{CATEGORY}_{TYPE}
			add=$npc_temp_res_diff_{TYPE}
			apply_to={TYPE}
			max_value=200
		[/value]
	[/set_variables]	
#enddef	

#define MODRPG_NPC_HANDLE_ARMOR CATEGORY EVADE
[if]
	[variable]
		name=npc_temp_res_diff_arcane
		greater_than=0
	[/variable]
	[or]
		[variable]
			name=npc_temp_res_diff_blade
			greater_than=0
		[/variable]
	[/or]
	[or]
		[variable]
			name=npc_temp_res_diff_fire
			greater_than=0
		[/variable]
	[/or]
	[or]
		[variable]
			name=npc_temp_res_diff_cold
			greater_than=0
		[/variable]
	[/or]
	[or]
		[variable]
			name=npc_temp_res_diff_impact
			greater_than=0
		[/variable]
	[/or]
	[or]
		[variable]
			name=npc_temp_res_diff_pierce
			greater_than=0
		[/variable]
	[/or]
	[then]
		[if]
			[variable]
				name=npc_temp.defense.flat
				less_than=50
			[/variable]
			[and]
				[variable]
					name=$path|.evade_adjust
					less_than={EVADE}
				[/variable]
			[/and]
			[then]
				{VARIABLE will_carry 0}
			[/then]
		[/if]	
		[if]
			[variable]
				name=will_carry
				numerical_equals=1
			[/variable]
			[then]
				{MODRPG_NPC_ARMOR_ABILITY {CATEGORY} "arcane"}
				{MODRPG_NPC_ARMOR_ABILITY {CATEGORY} "blade"}
				{MODRPG_NPC_ARMOR_ABILITY {CATEGORY} "fire"}
				{MODRPG_NPC_ARMOR_ABILITY {CATEGORY} "cold"}
				{MODRPG_NPC_ARMOR_ABILITY {CATEGORY} "impact"}
				{MODRPG_NPC_ARMOR_ABILITY {CATEGORY} "pierce"}
			[/then]
		[/if]
	[/then]
	[else]
		{VARIABLE will_carry 0}
	[/else]
[/if]						
#enddef

#define MODRPG_NPC_UNIT_CALCULATE_RES_DISPLAY TYPE
[if]
	[variable]
		name=npc_temp.abilities.resistance[$i].add
		greater_than=0
	[/variable]
	[and]
		[variable]
			name=npc_temp.abilities.resistance[$i].apply_to
			equals={TYPE}
		[/variable]
	[/and]
	[then]
		{VARIABLE_OP npc_temp_ability_{TYPE}_display add $npc_temp.abilities.resistance[$i].add}
	[/then]
[/if]
#enddef

#define ITEM_WIELDER
    [variable]
        name=npc_temp.race
        equals=dwarf
    [/variable]
    [or]
        [variable]
            name=npc_temp.race
            equals=elf
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=troll
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=ogre
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=goblin
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=human
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=merman
        [/variable]
		#no legs!
		[not]
			[variable]
				name=$path|.category
				equals=legs_armor
			[/variable]
		[/not]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=orc
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=lizard
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=undead
        [/variable]
        [and]
            #exclude what isn't skeleton/lich
            [variable]
                name=npc_temp.resistance.impact
                greater_than=100
            [/variable]
        [/and]
		[not]
			[variable]
				name=$path|.command
				equals="potion_healing"
			[/variable]
		[/not]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=drake
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=naga
        [/variable]
		#no legs!
		[not]
			[variable]
				name=$path|.category
				equals=legs_armor
			[/variable]
		[/not]
    [/or]
	[or]
        [variable]
            name=npc_temp.race
            equals=minotaurs
        [/variable]
    [/or]
#enddef

#experimental alternate npc stat calculation
#define UPDATE_NPC_STATS
	[if]
		[variable]
			name=npc_temp.race
			not_equals=undead
		[/variable]
		[or]
			[variable]
				name=npc_temp.side
				greater_than=3
			[/variable]
		[/or]
		[then]
			[switch]
				variable=npc_temp.race
				[case]
					value=dwarf
					[set_variables]
						name=npc_temp.atts
						mode=replace
						[value]
							body=6
							deft=3
							mind=4
						[/value]
					[/set_variables]
					{VARIABLE npc_temp.npc_race_adj.user_name.axe.number_hard 1}
					{VARIABLE npc_temp.npc_race_adj.user_name.hammer.damage_percent 25}
				[/case]
				[case]
					value=elf
					[set_variables]
						name=npc_temp.atts
						mode=replace
						[value]
							body=3
							deft=6
							mind=4
						[/value]
					[/set_variables]
					{VARIABLE npc_temp.npc_race_adj.class.bow.number_hard 1}
				[/case]
				[case]
					value=troll
					[set_variables]
						name=npc_temp.atts
						mode=replace
						[value]
							body=7
							deft=2
							mind=2
						[/value]
					[/set_variables]
					{VARIABLE npc_temp.npc_race_adj.class.bludgeon.damage_percent 25}
					{VARIABLE npc_temp.npc_race_adj.class.lob.damage_percent 25}
				[/case]
				[case]
					value=ogre
					[set_variables]
						name=npc_temp.atts
						mode=replace
						[value]
							body=6
							deft=3
							mind=3
						[/value]
					[/set_variables]
				[/case]
				[case]
					value=goblin
					[set_variables]
						name=npc_temp.atts
						mode=replace
						[value]
							body=3
							deft=3
							mind=3
						[/value]
					[/set_variables]
				[/case]
				[case]
					value=merman
					[set_variables]
						name=npc_temp.atts
						mode=replace
						[value]
							body=3
							deft=6
							mind=4
						[/value]
					[/set_variables]
				[/case]
				[case]
					value=orc
					[set_variables]
						name=npc_temp.atts
						mode=replace
						[value]
							body=5
							deft=3
							mind=4
						[/value]
					[/set_variables]
				[/case]
				[case]
					value=lizard
					[set_variables]
						name=npc_temp.atts
						mode=replace
						[value]
							body=3
							deft=6
							mind=4
						[/value]
					[/set_variables]
				[/case]
				[case]
					value=undead
					[set_variables]
						name=npc_temp.atts
						mode=replace
						[value]
							body=4
							deft=4
							mind=2
						[/value]
					[/set_variables]
				[/case]
				[case]
					value=minotaurs
					[set_variables]
						name=npc_temp.atts
						mode=replace
						[value]
							body=6
							deft=3
							mind=4
						[/value]
					[/set_variables]
				[/case]
				[else]
					[set_variables]
						name=npc_temp.atts
						mode=replace
						[value]
							body=4
							deft=4
							mind=4
						[/value]
					[/set_variables]
				[/else]
			[/switch]
		[/then]
		{VARIABLE body_contribs 4}
		{VARIABLE_OP body_contribs add -$npc_temp.level}
		{VARIABLE deft_contribs 5}
		{VARIABLE_OP deft_contribs add -$npc_temp.level}
		{VARIABLE mind_contribs 3}
		{VARIABLE_OP mind_contribs add -$npc_temp.level}
		[if]
			[variable]
				name=body_contribs
				less_than=1
			[/variable]
			[then]
				{VARIABLE body_add -1}
				{VARIABLE_OP body_add add $body_contribs}
				{VARIABLE_OP body_add multiply -1}
				{VARIABLE body_contribs 1}
			[/then]
			[else]
				{VARIABLE body_add 0}
			[/else]
		[/if]
		[if]
			[variable]
				name=deft_contribs
				less_than=2
			[/variable]
			[then]
				{VARIABLE deft_add -2}
				{VARIABLE_OP deft_add add $deft_contribs}
				{VARIABLE_OP deft_add multiply -1}
				{VARIABLE deft_contribs 2}
			[/then]
			[else]
				{VARIABLE deft_add 0}
			[/else]
		[/if]
		{VARIABLE mind_add 0}
		[if]
			[variable]
				name=mind_contribs
				less_than=0
			[/variable]
			[then]
				{VARIABLE_OP mind_add add $mind_contribs}
				{VARIABLE_OP mind_add multiply -1}
				{VARIABLE mind_contribs 0}
			[/then]
		[/if]
		{VARIABLE contrib_candidate $npc_temp.max_hitpoints}
		{VARIABLE_OP contrib_candidate add -30}
		[if]
			[variable]
				name=contrib_candidate
				greater_than=0
			[/variable]
			[then]
				{VARIABLE_OP contrib_candidate multiply .3}
				{VARIABLE_OP body_add add $contrib_candidate}
			[/then]
		[/if]
		{VARIABLE contrib_candidate $npc_temp.max_moves}
		{VARIABLE_OP contrib_candidate add -5}
		[if]
			[variable]
				name=contrib_candidate
				greater_than=0
			[/variable]
			[then]
				{VARIABLE_OP contrib_candidate multiply 4}
				{VARIABLE_OP deft_add add $contrib_candidate}
			[/then]
		[/if]
		{VARIABLE contrib_candidate $npc_temp.defense.flat}
		{VARIABLE_OP contrib_candidate add -40}
		[if]
			[variable]
				name=contrib_candidate
				greater_than=0
			[/variable]
			[then]
				{VARIABLE_OP contrib_candidate multiply 1.3}
				{VARIABLE_OP deft_add add $contrib_candidate}
			[/then]
		[/if]
		{FOREACH npc_temp.attack i}
			[if]
				[variable]
					name=npc_temp.attack[$i].is_rpg_weapon
					greater_than=0
				[/variable]
				[then]
				[/then]
				[else]
					[if]
						[variable]
							name=npc_temp.attack[$i].range
							equals=melee
						[/variable]
						[then]
							{VARIABLE_OP body_count add 1}
							{VARIABLE_OP deft_count add 1}
							{VARIABLE contrib_candidate $npc_temp.attack[$i].damage}
							{VARIABLE_OP contrib_candidate add -5}
							[if]
								[variable]
									name=contrib_candidate
									greater_than=0
								[/variable]
								[then]
									{VARIABLE_OP contrib_candidate multiply 1.7}
									{VARIABLE_OP body_add add $contrib_candidate}
								[/then]
							[/if]
							{VARIABLE contrib_candidate npc_temp.attack[$i].number}
							{VARIABLE_OP contrib_candidate add -2}
							[if]
								[variable]
									name=contrib_candidate
									greater_than=0
								[/variable]
								[then]
									{VARIABLE_OP contrib_candidate multiply 3}
									{VARIABLE_OP deft_add add $contrib_candidate}
								[/then]
							[/if]
						[/then]
						[else]
							[if]
								[variable]
									name=npc_temp.attack[$i].specials.chance_to_hit
									equals="magical"
								[/variable]
								[or]
									[variable]
										name=npc_temp.attack[$i].name
										equals=thunderstick
									[/variable]
								[/or]
								[or]
									[variable]
										name=npc_temp.attack[$i].name
										equals=dragonstaff
									[/variable]
								[/or]
								[then]
									{VARIABLE_OP mind_count add 2}
									{VARIABLE contrib_candidate $npc_temp.attack[$i].damage}
									{VARIABLE_OP contrib_candidate add -4}
									[if]
										[variable]
											name=contrib_candidate
											greater_than=0
										[/variable]
										[then]
											{VARIABLE_OP contrib_candidate multiply 1.3}
											{VARIABLE_OP mind_add add $contrib_candidate}
										[/then]
									[/if]
									{VARIABLE contrib_candidate $npc_temp.attack[$i].number}
									{VARIABLE_OP contrib_candidate add -1}
									[if]
										[variable]
											name=contrib_candidate
											greater_than=0
										[/variable]
										[then]
											{VARIABLE_OP contrib_candidate multiply 5}
											{VARIABLE_OP mind_add add $contrib_candidate}
										[/then]
									[/if]
								[/then]
								[else]
									{VARIABLE_OP deft_count add 2}
									{VARIABLE contrib_candidate $npc_temp.attack[$i].damage}
									{VARIABLE_OP contrib_candidate add -5}
									[if]
										[variable]
											name=contrib_candidate
											greater_than=0
										[/variable]
										[then]
											{VARIABLE_OP contrib_candidate multiply 1.7}
											{VARIABLE_OP deft_add add $contrib_candidate}
										[/then]
									[/if]
									{VARIABLE contrib_candidate $npc_temp.attack[$i].number}
									{VARIABLE_OP contrib_candidate add -2}
									[if]
										[variable]
											name=contrib_candidate
											greater_than=0
										[/variable]
										[then]
											{VARIABLE_OP contrib_candidate multiply 3}
											{VARIABLE_OP deft_add add $contrib_candidate}
										[/then]
									[/if]
								[/else]
							[/if]
						[/else]
					[/if]
				[/else]
			[/if]
		{NEXT i}
		{VARIABLE_OP body_add divide $body_contribs}
		{VARIABLE_OP deft_add divide $deft_contribs}
		[if]
			[variable]
				name=mind_count
				greater_than=0
			[/variable]
			[then]
				{VARIABLE_OP mind_add divide $mind_contribs}
			[/then]
		[/if]
		{VARIABLE_OP npc_temp.atts.body add $body_add}
		{VARIABLE_OP npc_temp.atts.deft add $deft_add}
		{VARIABLE_OP npc_temp.atts.mind add $mind_add}
	[/if]
#enddef

#define LIKES_GOLD
	#for now basically the same as item wielders, but can adjust later
    [variable]
        name=npc_temp.race
        equals=dwarf
    [/variable]
    [or]
        [variable]
            name=npc_temp.race
            equals=elf
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=troll
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=ogre
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=goblin
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=human
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=merman
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=orc
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=lizard
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=undead
        [/variable]
        [and]
            #exclude what isn't skeleton/lich
            [variable]
                name=npc_temp.resistance.impact
                greater_than=100
            [/variable]
        [/and]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=drake
        [/variable]
    [/or]
    [or]
        [variable]
            name=npc_temp.race
            equals=naga
        [/variable]
    [/or]
	[or]
        [variable]
            name=npc_temp.race
            equals=minotaurs
        [/variable]
    [/or]
#enddef