#define MODRPG_COMMAND_MANAGE_INVENTORY
    [set_menu_item]
        id=c_manage_inventory
		image=commands/inventory.png
        description=_ "Manage Inventory"
        [filter_location]
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]

        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]

            [store_unit]
                variable=cancel_current_unit
                [filter]
                    canrecruit=yes
                    side=$side_number
                [/filter]
            [/store_unit]
			[if]
				[variable]
					name=current_unit.attacks_left
					greater_than=0
				[/variable]
				[then]
					{VARIABLE upgrading 0}
				[/then]
				[else]
					{VARIABLE upgrading -1}
					[message]
						speaker=narrator
						side_for=$side_number
						message= _ "You do not have enough actions left to do this."
					[/message]
				[/else]
			[/if]
			{VARIABLE old_equip.melee.id $current_unit.variables.inventory.weapons.equipped.id}
			{VARIABLE old_equip.melee[1].id $current_unit.variables.inventory.weapons.equipped[1].id}
			{VARIABLE old_equip.melee[2].id $current_unit.variables.inventory.weapons.equipped[2].id}
			{VARIABLE old_equip.ranged.id $current_unit.variables.inventory.weapons.equipped[5].id}
			{VARIABLE old_equip.armor.id $current_unit.variables.inventory.armor.equipped.id}
			{VARIABLE old_equip.armor[1].id $current_unit.variables.inventory.armor.equipped[1].id}
			{VARIABLE old_equip.armor[3].id $current_unit.variables.inventory.armor.equipped[3].id}
			{VARIABLE old_equip.armor[4].id $current_unit.variables.inventory.armor.equipped[4].id}
            [while]
                [variable]
                    name=upgrading
                    greater_than=-1
                [/variable]
                [do]
                    [message]
                        speaker=narrator
                        message= _ "Which type of inventory will you manage?"
                        [option]
					        message ="&"+check.png+"="+_ "(End)"

					        [command]
					            {CONSTRUCT_UNIT}
					            {VARIABLE_OP upgrading add -1}
					        [/command]
					    [/option]
                        [option]
                            message ="&"+categories/weapons-melee.png+"="+_ "Weapons"
                            [command]
                                {SWITCH_WEAPONS}
                            [/command]
                        [/option]
                        [option]
                            message ="&"+categories/armor-torso.png+"="+_ "Armor"
                            [command]
                                {SWITCH_ARMOUR}
                            [/command]
                        [/option]
                        [option]
                            [show_if]
                                [variable]
                                    name=current_unit.variables.abilities.thunderstick_tinker
                                    greater_than=0
                                [/variable]
                            [/show_if]
                            message ="&"+attacks/thunderstick.png+"="+_ "Tinker: Thunderstick"
                            [command]
                                {INVENTORY_THUNDERSTICK_TINKER}
                            [/command]
                        [/option]
                        image=wesnoth-icon.png
                    [/message]
                [/do]
            [/while]
			[if]
				[variable]
					name=dungeon_level.max
					greater_than=0
				[/variable]
				[and]
					[variable]
						name=dungeon_level.max
						numerical_equals=$dungeon_level.current
					[/variable]
				[/and]
				[and]
					[variable]
						name=old_equip.melee.id
						numerical_not_equals=$current_unit.variables.inventory.weapons.equipped.id
					[/variable]
					[or]
						[variable]
							name=old_equip.melee[1].id
							numerical_not_equals=$current_unit.variables.inventory.weapons.equipped[1].id
						[/variable]
					[/or]
					[or]
						[variable]
							name=old_equip.melee[2].id
							numerical_not_equals=$current_unit.variables.inventory.weapons.equipped[2].id
						[/variable]
					[/or]
					[or]
						[variable]
							name=old_equip.ranged.id
							numerical_not_equals=$current_unit.variables.inventory.weapons.equipped[5].id
						[/variable]
					[/or]
					[or]
						[variable]
							name=old_equip.armor.id
							numerical_not_equals=$current_unit.variables.inventory.armor.equipped.id
						[/variable]
					[/or]
					[or]
						[variable]
							name=old_equip.armor[1].id
							numerical_not_equals=$current_unit.variables.inventory.armor.equipped[1].id
						[/variable]
					[/or]
					[or]
						[variable]
							name=old_equip.armor[3].id
							numerical_not_equals=$current_unit.variables.inventory.armor.equipped[3].id
						[/variable]
					[/or]
					[or]
						[variable]
							name=old_equip.armor[4].id
							numerical_not_equals=$current_unit.variables.inventory.armor.equipped[4].id
						[/variable]
					[/or]
				[/and]
				[then]
					[store_unit]
						variable=current_unit
		                [filter]
		                    side=$side_number
		                    canrecruit=yes
		                [/filter]
					[/store_unit]
					{VARIABLE current_unit.attacks_left 0}
					[unstore_unit]
						variable=current_unit
					[/unstore_unit]
				[/then]
			[/if]
			{CLEAR_VARIABLE old_equip}
        [/command]
    [/set_menu_item]
#enddef

#define SWITCH_WEAPONS

    {VARIABLE upgrading 1}
    [while]
        [variable]
            name=upgrading
            numerical_equals=1
        [/variable]
        [do]
            {CONSTRUCT_UNIT}
            [message]
                speaker=narrator
                message= _ "Which type of weapon will you switch"
                [option]
			        message ="&"+check.png+"="+_ "(End)"

			        [command]
			            {CONSTRUCT_UNIT}
			            {VARIABLE_OP upgrading add -1}
			        [/command]
			    [/option]
                [option]
			        message ="&"+x.png+"="+_ "(Cancel Changes)"

			        [command]
			            {VARIABLE_OP upgrading add -1}
			            [unstore_unit]
			                variable=cancel_current_unit
			            [/unstore_unit]
			            {CLEAR_VARIABLE current_unit}
			            {CLEAR_VARIABLE cancel_current_unit}
			        [/command]
			    [/option]
                [option]
                    message ="&"+categories/weapons-melee.png+"="+_ "melee"
                    [command]
                        {VARIABLE upgrading_2 1}
                        [while]
                            [variable]
                                name=upgrading_2
                                numerical_equals=1
                            [/variable]
                            [do]
                                [if]
                                    [variable]
                                        name=current_unit.variables.abilities.wield
                                        greater_than=0
                                    [/variable]
                                    [then]
                                        [if]
                                            [variable]
                                                name=current_unit.variables.abilities.wield
                                                numerical_equals=2
                                            [/variable]
                                            [then]
                                                {CONSTRUCT_UNIT}

                                                {CLEAR_VARIABLE switch_weapon_insert}

                                                {FOREACH current_unit.variables.inventory.weapons.melee i}
                                                    {VARIABLE path "current_unit.variables.inventory.weapons.melee[$i]"}
                                                    [fire_event]
                                                        name=weapon_modifiers
                                                    [/fire_event]
                                                    [set_variables]
                                                        name=switch_weapon_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+attacks/$current_unit.variables.inventory.weapons.melee[$i|].icon|.png+"="+_ "$current_unit.variables.inventory.weapons.melee[$i|].description|
``Class: $current_unit.variables.inventory.weapons.melee[$i|].class_description|															
`Base: ($current_unit.variables.inventory.weapons.melee[$i|].damage|-$current_unit.variables.inventory.weapons.melee[$i|].number|), Adjusted: ($display_damage|-$display_number|) $current_unit.variables.inventory.weapons.melee[$i|].type|
``$current_unit.variables.inventory.weapons.melee[$i].special|"

                                                            [command]
                                                                [set_variable]
                                                                    name="current_unit.variables.inventory.weapons.equipped[2].id"
                                                                    value=$current_unit.variables.inventory.weapons.equipped[1].id
                                                                [/set_variable]
                                                                [set_variable]
                                                                    name="current_unit.variables.inventory.weapons.equipped[1].id"
                                                                    value=$current_unit.variables.inventory.weapons.equipped.id
                                                                [/set_variable]
                                                                [set_variable]
                                                                    name="current_unit.variables.inventory.weapons.equipped.id"
                                                                    value=$i
                                                                [/set_variable]
                                                                [set_variable]
                                                                    name="upgrading_2"
                                                                    value=0
                                                                [/set_variable]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                {NEXT i}

                                                [message]
                                                    speaker=narrator
                                                    message= _ "You have $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[0].id|].description|, $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[1].id|].description| and $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[2].id|].description| equipped. Which weapon will you take out?"
                                                    [option]
												        message = _ "(Back)"

												        [command]
												            {VARIABLE upgrading_2 0}
												        [/command]
												    [/option]
                                                    [insert_tag]
                                                        name=option
                                                        variable=switch_weapon_insert
                                                    [/insert_tag]
                                                    image=wesnoth-icon.png
                                                [/message]
                                            [/then]
                                            [else]
                                                {CONSTRUCT_UNIT}

                                                {CLEAR_VARIABLE switch_weapon_insert}

                                                {FOREACH current_unit.variables.inventory.weapons.melee i}
                                                    {VARIABLE path "current_unit.variables.inventory.weapons.melee[$i]"}
                                                    [fire_event]
                                                        name=weapon_modifiers
                                                    [/fire_event]
                                                    [set_variables]
                                                        name=switch_weapon_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+attacks/$current_unit.variables.inventory.weapons.melee[$i|].icon|.png+"="+_ "$current_unit.variables.inventory.weapons.melee[$i|].description|
``Class: $current_unit.variables.inventory.weapons.melee[$i|].class_description|															
`Base: ($current_unit.variables.inventory.weapons.melee[$i|].damage|-$current_unit.variables.inventory.weapons.melee[$i|].number|), Adjusted: ($display_damage|-$display_number|) $current_unit.variables.inventory.weapons.melee[$i|].type|
``$current_unit.variables.inventory.weapons.melee[$i].special|"

                                                            [command]
                                                                [set_variable]
                                                                    name="current_unit.variables.inventory.weapons.equipped[1].id"
                                                                    value=$current_unit.variables.inventory.weapons.equipped.id
                                                                [/set_variable]
                                                                [set_variable]
                                                                    name="current_unit.variables.inventory.weapons.equipped.id"
                                                                    value=$i
                                                                [/set_variable]
                                                                [set_variable]
                                                                    name="upgrading_2"
                                                                    value=0
                                                                [/set_variable]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                {NEXT i}

                                                [message]
                                                    speaker=narrator
                                                    message= _ "You have $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[0].id|].description| and $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[1].id|].description| equipped. Which weapon will you take out?"
                                                    [option]
												        message = _ "(Back)"

												        [command]
												            {VARIABLE upgrading_2 0}
												        [/command]
												    [/option]
                                                    [insert_tag]
                                                        name=option
                                                        variable=switch_weapon_insert
                                                    [/insert_tag]
                                                    image=wesnoth-icon.png
                                                [/message]
                                            [/else]
                                        [/if]
                                    [/then]
                                    [else]
                                        {CLEAR_VARIABLE switch_weapon_insert}

                                        {FOREACH current_unit.variables.inventory.weapons.melee i}
                                            {VARIABLE path "current_unit.variables.inventory.weapons.melee[$i]"}
                                            [fire_event]
                                                name=weapon_modifiers
                                            [/fire_event]
                                            [set_variables]
                                                name=switch_weapon_insert
                                                mode=append
                                                [value]
                                                    message="&"+attacks/$current_unit.variables.inventory.weapons.melee[$i|].icon|.png+"="+_ "$current_unit.variables.inventory.weapons.melee[$i|].description|
``Class: $current_unit.variables.inventory.weapons.melee[$i|].class_description|													
`Base: ($current_unit.variables.inventory.weapons.melee[$i|].damage|-$current_unit.variables.inventory.weapons.melee[$i|].number|), Adjusted: ($display_damage|-$display_number|) $current_unit.variables.inventory.weapons.melee[$i|].type|
``$current_unit.variables.inventory.weapons.melee[$i].special|"

                                                    [command]
                                                        [set_variable]
                                                            name="current_unit.variables.inventory.weapons.equipped.id"
                                                            value=$i
                                                        [/set_variable]
                                                        [set_variable]
                                                            name="upgrading_2"
                                                            value=0
                                                        [/set_variable]
                                                    [/command]
                                                [/value]
                                            [/set_variables]
                                        {NEXT i}

                                        [message]
                                            speaker=narrator
                                            message= _ "You have $current_unit.variables.inventory.weapons.melee[$current_unit.variables.inventory.weapons.equipped[0].id|].description| equipped. Which weapon will you take out?"
                                            [option]
										        message = _ "(Back)"

										        [command]
										            {VARIABLE upgrading_2 0}
										        [/command]
										    [/option]
                                            [insert_tag]
                                                name=option
                                                variable=switch_weapon_insert
                                            [/insert_tag]
                                            image=wesnoth-icon.png
                                        [/message]
                                    [/else]
                                [/if]
                            [/do]
                        [/while]
                    [/command]
                [/option]
                [option]
                    message ="&"+attacks/bow.png+"="+_ "ranged"
                    [command]
                        {VARIABLE upgrading_2 1}
                        [while]
                            [variable]
                                name=upgrading_2
                                numerical_equals=1
                            [/variable]
                            [do]
                                {CLEAR_VARIABLE switch_weapon_insert}

                                {FOREACH current_unit.variables.inventory.weapons.ranged i}
                                    {VARIABLE path "current_unit.variables.inventory.weapons.ranged[$i]"}
                                    [fire_event]
                                        name=weapon_modifiers
                                    [/fire_event]
                                    [set_variables]
                                        name=switch_weapon_insert
                                        mode=append
                                        [value]
                                            message="&"+attacks/$current_unit.variables.inventory.weapons.ranged[$i|].icon|.png+"="+_ "$current_unit.variables.inventory.weapons.ranged[$i|].description|
``Class: $current_unit.variables.inventory.weapons.ranged[$i|].class_description|											
`Base: ($current_unit.variables.inventory.weapons.ranged[$i|].damage|-$current_unit.variables.inventory.weapons.ranged[$i|].number|), Adjusted: ($display_damage|-$display_number|) $current_unit.variables.inventory.weapons.ranged[$i|].type|
``$current_unit.variables.inventory.weapons.ranged[$i].special|"

                                            [command]
                                                [set_variable]
                                                    name="current_unit.variables.inventory.weapons.equipped[5].id"
                                                    value=$i
                                                [/set_variable]
                                                [set_variable]
                                                    name="upgrading_2"
                                                    value=0
                                                [/set_variable]
                                            [/command]
                                        [/value]
                                    [/set_variables]
                                {NEXT i}

                                [message]
                                    speaker=narrator
                                    message= _ "You have $current_unit.variables.inventory.weapons.ranged[$current_unit.variables.inventory.weapons.equipped[5].id|].description| equipped. Which weapon will you take out?"
                                    [option]
								        message = _ "(Back)"

								        [command]
								            {VARIABLE upgrading_2 0}
								        [/command]
								    [/option]
                                    [insert_tag]
                                        name=option
                                        variable=switch_weapon_insert
                                    [/insert_tag]
                                    image=wesnoth-icon.png
                                [/message]
                            [/do]
                        [/while]
                    [/command]
                [/option]
            [/message]
        [/do]
    [/while]
#enddef

#define SWITCH_ARMOUR
    {VARIABLE upgrading 1}
    [while]
        [variable]
            name=upgrading
            numerical_equals=1
        [/variable]
        [do]
            {CONSTRUCT_UNIT}

            {VARIABLE display.arcane $current_unit.variables.resistance.arcane}
            {VARIABLE display.blade $current_unit.variables.resistance.blade}
            {VARIABLE display.cold $current_unit.variables.resistance.cold}
            {VARIABLE display.fire $current_unit.variables.resistance.fire}
            {VARIABLE display.impact $current_unit.variables.resistance.impact}
            {VARIABLE display.pierce $current_unit.variables.resistance.pierce}

            {VARIABLE_OP display.arcane multiply -1}
            {VARIABLE_OP display.blade multiply -1}
            {VARIABLE_OP display.cold multiply -1}
            {VARIABLE_OP display.fire multiply -1}
            {VARIABLE_OP display.impact multiply -1}
            {VARIABLE_OP display.pierce multiply -1}

            {VARIABLE_OP display.arcane add 100}
            {VARIABLE_OP display.blade add 100}
            {VARIABLE_OP display.cold add 100}
            {VARIABLE_OP display.fire add 100}
            {VARIABLE_OP display.impact add 100}
            {VARIABLE_OP display.pierce add 100}

            {VARIABLE display.adjusted_arcane $current_unit.resistance.arcane}
            {VARIABLE display.adjusted_blade $current_unit.resistance.blade}
            {VARIABLE display.adjusted_cold $current_unit.resistance.cold}
            {VARIABLE display.adjusted_fire $current_unit.resistance.fire}
            {VARIABLE display.adjusted_impact $current_unit.resistance.impact}
            {VARIABLE display.adjusted_pierce $current_unit.resistance.pierce}

            {VARIABLE_OP display.adjusted_arcane multiply -1}
            {VARIABLE_OP display.adjusted_blade multiply -1}
            {VARIABLE_OP display.adjusted_cold multiply -1}
            {VARIABLE_OP display.adjusted_fire multiply -1}
            {VARIABLE_OP display.adjusted_impact multiply -1}
            {VARIABLE_OP display.adjusted_pierce multiply -1}

            {VARIABLE_OP display.adjusted_arcane add 100}
            {VARIABLE_OP display.adjusted_blade add 100}
            {VARIABLE_OP display.adjusted_cold add 100}
            {VARIABLE_OP display.adjusted_fire add 100}
            {VARIABLE_OP display.adjusted_impact add 100}
            {VARIABLE_OP display.adjusted_pierce add 100}

            {VARIABLE display.evade $current_unit.variables.evade_level}
            {VARIABLE_OP display.evade multiply 3}

            [if]
                [variable]
                    name=current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].restricts.head
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE current_unit.variables.inventory.armor.equipped[1].id 0}
                [/then]
            [/if]
            [if]
                [variable]
                    name=current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].restricts.legs
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE current_unit.variables.inventory.armor.equipped[3].id 0}
                [/then]
            [/if]
            [if]
                [variable]
                    name=current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].restricts.shield
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE current_unit.variables.inventory.armor.equipped[4].id 0}
                [/then]
            [/if]
			{VARIABLE display.armor_magic_adjust $magic_adjust_armor}
			{VARIABLE_OP display.armor_magic_adjust add -100}
			[if]
                [variable]
                    name=current_unit.race
                    equals="dwarf"
                [/variable]
                [then]
                    {VARIABLE_OP display.armor_magic_adjust divide 2}
                [/then]
            [/if]
			{VARIABLE display.adjusted_armor_magic $current_unit.variables.abilities.magic_casting.focus}
			{VARIABLE_OP display.adjusted_armor_magic multiply 3}
			{VARIABLE_OP display.adjusted_armor_magic add $display.armor_magic_adjust}
			[if]
				[variable]
					name=display.adjusted_armor_magic
					greater_than=0
				[/variable]
				[then]
					{VARIABLE display.adjusted_armor_magic 0}
				[/then]
			[/if]
			{VARIABLE display.def_adjust $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].terrain.flat.defense}
			{VARIABLE_OP display.def_adjust add $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id|].terrain.flat.defense}
			{VARIABLE_OP display.def_adjust multiply -1}
			{VARIABLE display.def_adjust_shield $display.def_adjust}
			{VARIABLE_OP display.def_adjust_shield add $current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id|].terrain_recoup}
			[if]
				[variable]
					name=display.def_adjust_shield
					greater_than=0
				[/variable]
				[then]
					{VARIABLE display.def_adjust_shield 0}
				[/then]
			[/if]
			{VARIABLE display.armor_ranged_adjust $ranged_adjust}
			{VARIABLE_OP display.armor_ranged_adjust add -100}
			{VARIABLE move_loss_rate 100}
			{VARIABLE_OP move_loss_rate divide $current_unit.variables.max_moves}
			{VARIABLE_OP move_loss_rate round ceil}
            [message]
                speaker=narrator
                message= _ "`Resistances: Adjusted (Natural)
`Arcane: $display.adjusted_arcane| ($display.arcane|)
`Blade: $display.adjusted_blade| ($display.blade|)
`Cold: $display.adjusted_cold| ($display.cold|)
`Fire: $display.adjusted_fire| ($display.fire|)
`Impact: $display.adjusted_impact| ($display.impact|)
`Pierce: $display.adjusted_pierce| ($display.pierce|)
`Evade: $add_evade| ($display.evade|)
`Terrain Defense Adjust: $display.def_adjust (After Shield: $display.def_adjust_shield|)
`Movement Lost: $max_moves_temp (Loss rate: evade penalty/$move_loss_rate| rounded up)
`Magic Armor Penalty: $display.armor_magic_adjust|% (After Focus: $display.adjusted_armor_magic|%)
`Ranged Armor Penalty: $display.armor_ranged_adjust|%"
                [option]
			        message ="&"+check.png+"="+_ "(End)"

			        [command]
			            {CONSTRUCT_UNIT}
			            {VARIABLE_OP upgrading add -1}
			        [/command]
			    [/option]
                [option]
			        message ="&"+x.png+"="+_ "(Cancel Changes)"

			        [command]
			            {VARIABLE_OP upgrading add -1}
			            [unstore_unit]
			                variable=cancel_current_unit
			            [/unstore_unit]
			            {CLEAR_VARIABLE current_unit}
			            {CLEAR_VARIABLE cancel_current_unit}
			        [/command]
			    [/option]
                [option]
                    message ="&"+categories/armor-torso.png+"="+_ "torso"
                    [command]
                        {VARIABLE upgrading_2 1}
                        [while]
                            [variable]
                                name=upgrading_2
                                numerical_equals=1
                            [/variable]
                            [do]
                                {CLEAR_VARIABLE switch_armor_insert}

                                {FOREACH current_unit.variables.inventory.armor.torso i}
									[if]
										[variable]
											name=i
											numerical_equals=$current_unit.variables.inventory.armor.equipped[0].id|
										[/variable]
										[then]
											[set_variables]
		                                        name=switch_armor_insert
		                                        mode=append
		                                        [value]
		                                            message ="&"+armor/$current_unit.variables.inventory.armor.torso[$i].icon|.png+"="+_ "@$current_unit.variables.inventory.armor.torso[$i].description|
``@$current_unit.variables.inventory.armor.torso[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.torso[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.torso[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.torso[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.torso[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.torso[$i].resistance.pierce|% pierce
``@$current_unit.variables.inventory.armor.torso[$i].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.torso[$i].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.torso[$i].terrain.flat.defense|% def adj"
		                                            [command]
		                                                [set_variable]
		                                                    name="upgrading_2"
		                                                    value=0
		                                                [/set_variable]
		                                            [/command]
		                                        [/value]
		                                    [/set_variables]
										[/then]
										[else]
											[set_variables]
		                                        name=switch_armor_insert
		                                        mode=append
		                                        [value]
		                                            message ="&"+armor/$current_unit.variables.inventory.armor.torso[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.torso[$i].description|
``$current_unit.variables.inventory.armor.torso[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.torso[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.torso[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.torso[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.torso[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.torso[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.torso[$i].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.torso[$i].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.torso[$i].terrain.flat.defense|% def adj"
		                                            [command]
		                                                [set_variable]
		                                                    name="current_unit.variables.inventory.armor.equipped[0].id"
		                                                    value=$i
		                                                [/set_variable]
		                                                [set_variable]
		                                                    name="upgrading_2"
		                                                    value=0
		                                                [/set_variable]
		                                            [/command]
		                                        [/value]
		                                    [/set_variables]
										[/else]	
									[/if]
                                {NEXT i}

                                [message]
                                    speaker=narrator
                                    message= _ "You have $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].description| equipped. Which armor will you don?"
                                    [option]
								        message = _ "(Back)"

								        [command]
								            {VARIABLE upgrading_2 0}
								        [/command]
								    [/option]
                                    [insert_tag]
                                        name=option
                                        variable=switch_armor_insert
                                    [/insert_tag]
                                    image=wesnoth-icon.png
                                [/message]
                            [/do]
                        [/while]
                    [/command]
                [/option]
                [option]
                    message ="&"+categories/armor-head.png+"="+_ "head"
                    [show_if]
                        [variable]
                            name=current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].restricts.head
                            numerical_equals=0
                        [/variable]
                    [/show_if]
                    [command]
                        {VARIABLE upgrading_2 1}
                        [while]
                            [variable]
                                name=upgrading_2
                                numerical_equals=1
                            [/variable]
                            [do]
                                {CLEAR_VARIABLE switch_armor_insert}

                                {FOREACH current_unit.variables.inventory.armor.head i}
									[if]
										[variable]
											name=i
											numerical_equals=$current_unit.variables.inventory.armor.equipped[1].id|
										[/variable]
										[then]
											[set_variables]
		                                        name=switch_armor_insert
		                                        mode=append
		                                        [value]
		                                            message ="&"+armor/$current_unit.variables.inventory.armor.head[$i].icon|.png+"="+_ "@$current_unit.variables.inventory.armor.head[$i].description|
``@$current_unit.variables.inventory.armor.head[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.head[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.head[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.head[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.head[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.head[$i].resistance.pierce|% pierce
``@$current_unit.variables.inventory.armor.head[$i].evade_adjust| evade adj, $current_unit.variables.inventory.armor.head[$i].ranged_adjust|% ranged adj"
		                                            [command]
		                                                [set_variable]
		                                                    name="upgrading_2"
		                                                    value=0
		                                                [/set_variable]
		                                            [/command]
		                                        [/value]
		                                    [/set_variables]
										[/then]
										[else]
											[set_variables]
		                                        name=switch_armor_insert
		                                        mode=append
		                                        [value]
		                                            message ="&"+armor/$current_unit.variables.inventory.armor.head[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.head[$i].description|
``$current_unit.variables.inventory.armor.head[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.head[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.head[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.head[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.head[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.head[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.head[$i].evade_adjust| evade adj, $current_unit.variables.inventory.armor.head[$i].ranged_adjust|% ranged adj"
		                                            [command]
		                                                [set_variable]
		                                                    name="current_unit.variables.inventory.armor.equipped[1].id"
		                                                    value=$i
		                                                [/set_variable]
		                                                [set_variable]
		                                                    name="upgrading_2"
		                                                    value=0
		                                                [/set_variable]
		                                            [/command]
		                                        [/value]
		                                    [/set_variables]
										[/else]
									[/if]
                                {NEXT i}

                                [message]
                                    speaker=narrator
                                    message= _ "You have $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id|].description| equipped. Which armor will you don?"
                                    [option]
								        message = _ "(Back)"

								        [command]
								            {VARIABLE upgrading_2 0}
								        [/command]
								    [/option]
                                    [insert_tag]
                                        name=option
                                        variable=switch_armor_insert
                                    [/insert_tag]
                                    image=wesnoth-icon.png
                                [/message]
                            [/do]
                        [/while]
                    [/command]
                [/option]
                [option]
                    message ="&"+categories/armor-legs.png+"="+_ "legs"
                    [show_if]
                        [variable]
                            name=current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].restricts.legs
                            numerical_equals=0
                        [/variable]
                    [/show_if]
                    [command]
                        {VARIABLE upgrading_2 1}
                        [while]
                            [variable]
                                name=upgrading_2
                                numerical_equals=1
                            [/variable]
                            [do]
                                {CLEAR_VARIABLE switch_armor_insert}

                                {FOREACH current_unit.variables.inventory.armor.legs i}
									[if]
										[variable]
											name=i
											numerical_equals=$current_unit.variables.inventory.armor.equipped[3].id|
										[/variable]
										[then]
											[set_variables]
		                                        name=switch_armor_insert
		                                        mode=append
		                                        [value]
		                                            message ="&"+armor/$current_unit.variables.inventory.armor.legs[$i].icon|.png+"="+_ "@$current_unit.variables.inventory.armor.legs[$i].description|
``@$current_unit.variables.inventory.armor.legs[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.legs[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.legs[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.legs[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.legs[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.legs[$i].resistance.pierce|% pierce
``@$current_unit.variables.inventory.armor.legs[$i].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.legs[$i].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.legs[$i].terrain.flat.defense|% def adj"									
		                                            [command]
		                                                [set_variable]
		                                                    name="upgrading_2"
		                                                    value=0
		                                                [/set_variable]
		                                            [/command]
		                                        [/value]
		                                    [/set_variables]
										[/then]
										[else]
											[set_variables]
		                                        name=switch_armor_insert
		                                        mode=append
		                                        [value]
		                                            message ="&"+armor/$current_unit.variables.inventory.armor.legs[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.legs[$i].description|
``$current_unit.variables.inventory.armor.legs[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.legs[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.legs[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.legs[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.legs[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.legs[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.legs[$i].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.legs[$i].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.legs[$i].terrain.flat.defense|% def adj"									
		                                            [command]
		                                                [set_variable]
		                                                    name="current_unit.variables.inventory.armor.equipped[3].id"
		                                                    value=$i
		                                                [/set_variable]
		                                                [set_variable]
		                                                    name="upgrading_2"
		                                                    value=0
		                                                [/set_variable]
		                                            [/command]
		                                        [/value]
		                                    [/set_variables]
										[/else]
									[/if]                                    
                                {NEXT i}

                                [message]
                                    speaker=narrator
                                    message= _ "You have $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id|].description| equipped. Which armor will you don?"
                                    [option]
								        message = _ "(Back)"

								        [command]
								            {VARIABLE upgrading_2 0}
								        [/command]
								    [/option]
                                    [insert_tag]
                                        name=option
                                        variable=switch_armor_insert
                                    [/insert_tag]
                                    image=wesnoth-icon.png
                                [/message]
                            [/do]
                        [/while]
                    [/command]
                [/option]
                [option]
                    message ="&"+armor/shield.png+"="+_ "shield"
                    [show_if]
                        [variable]
                            name=current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id|].restricts.shield
                            numerical_equals=0
                        [/variable]
                    [/show_if]
                    [command]
                        {VARIABLE upgrading_2 1}
                        [while]
                            [variable]
                                name=upgrading_2
                                numerical_equals=1
                            [/variable]
                            [do]
                                {CLEAR_VARIABLE switch_armor_insert}

                                {FOREACH current_unit.variables.inventory.armor.shield i}
									[if]
										[variable]
											name=i
											numerical_equals=$current_unit.variables.inventory.armor.equipped[4].id|
										[/variable]
										[then]
											[set_variables]
		                                        name=switch_armor_insert
		                                        mode=append
		                                        [value]
		                                            message ="&"+armor/$current_unit.variables.inventory.armor.shield[$i].icon|.png+"="+_ "@$current_unit.variables.inventory.armor.shield[$i].description|
``@$current_unit.variables.inventory.armor.shield[$i].evade_adjust| evade adjust, $current_unit.variables.inventory.armor.shield[$i].terrain_recoup| terrain adjust, $current_unit.variables.inventory.armor.shield[$i].ranged_adjust|% ranged adj, $current_unit.variables.inventory.armor.shield[$i].magic_adjust|% magic adj
``@$current_unit.variables.inventory.armor.shield[$i].special"									
		                                            [command]
		                                                [set_variable]
		                                                    name="upgrading_2"
		                                                    value=0
		                                                [/set_variable]
		                                            [/command]
		                                        [/value]
		                                    [/set_variables]
										[/then]
										[else]
											[set_variables]
		                                        name=switch_armor_insert
		                                        mode=append
		                                        [value]
		                                            message ="&"+armor/$current_unit.variables.inventory.armor.shield[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.shield[$i].description|
``$current_unit.variables.inventory.armor.shield[$i].evade_adjust| evade adjust, $current_unit.variables.inventory.armor.shield[$i].terrain_recoup| terrain adjust, $current_unit.variables.inventory.armor.shield[$i].ranged_adjust|% ranged adj, $current_unit.variables.inventory.armor.shield[$i].magic_adjust|% magic adj
``$current_unit.variables.inventory.armor.shield[$i].special"									
		                                            [command]
		                                                [set_variable]
		                                                    name="current_unit.variables.inventory.armor.equipped[4].id"
		                                                    value=$i
		                                                [/set_variable]
		                                                [set_variable]
		                                                    name="upgrading_2"
		                                                    value=0
		                                                [/set_variable]
		                                            [/command]
		                                        [/value]
		                                    [/set_variables]
										[/else]
									[/if]
                                {NEXT i}

                                [message]
                                    speaker=narrator
                                    message= _ "You have $current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id|].description| equipped. Which armor will you don?"
                                    [option]
										message = _ "(Back)"

										[command]
											{VARIABLE upgrading_2 0}
										[/command]
									[/option]
                                    [insert_tag]
                                        name=option
                                        variable=switch_armor_insert
                                    [/insert_tag]
                                    image=wesnoth-icon.png
                                [/message]
                            [/do]
                        [/while]
                    [/command]
                [/option]
            [/message]
        [/do]
    [/while]

#enddef

#define MODRPG_COMMAND_GET_ITEM
    [set_menu_item]
        id=get_item
		image=commands/get.png
        description=_ "Get Item"
        [filter_location]
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]

        [command]
			{VARIABLE seen_list 0}
            [store_unit]
                variable=current_unit
                [filter]
                    x=$x1
                    y=$y1
                [/filter]
            [/store_unit]

            {VARIABLE upgrading 1}
            [while]
                [variable]
                    name=upgrading
                    numerical_equals=1
                [/variable]
                [do]
					{CLEAR_VARIABLE get_item_insert}
                    {FOREACH "ground_$x1|_$y1|.items" i}
                        [if]
                            [variable]
                                name=ground_$x1|_$y1|.items[$i].category
                                equals="usables"
                            [/variable]
                            [then]
                                [set_variables]
                                    name=get_item_insert
                                    mode=append
                                    [value]
                                        message="&"+$ground_$x1|_$y1|.items[$i].icon|.png+"="+_ "$ground_$x1|_$y1|.items[$i].description"
                                        [command]
                                            [set_variables]
                                                name=current_unit.variables.inventory.usables
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=ground_$x1|_$y1|.items[$i]
                                                [/insert_tag]
                                            [/set_variables]
											[removeitem]
												x,y=$x1,$y1
												image=items/$ground_$x1|_$y1|.items[$i].ground_icon|.png
											[/removeitem]
                                            {CLEAR_VARIABLE "ground_$x1|_$y1|.items[$i]"}
                                            {VARIABLE ground_changed 1}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=ground_$x1|_$y1|.items[$i].category
                                equals="melee_weapon"
                            [/variable]
                            [then]
                                {VARIABLE path "ground_$x1|_$y1|.items[$i]"}
                                [fire_event]
                                    name=weapon_modifiers
                                [/fire_event]
                                [set_variables]
                                    name=get_item_insert
                                    mode=append
                                    [value]
                                        message="&"+attacks/$ground_$x1|_$y1|.items[$i].icon|.png+"="+_ "$ground_$x1|_$y1|.items[$i].description|
``Class: $ground_$x1|_$y1|.items[$i].class_description|										
`Base: ($ground_$x1|_$y1|.items[$i].damage|-$ground_$x1|_$y1|.items[$i].number|), Adjusted: ($display_damage|-$display_number|) $ground_$x1|_$y1|.items[$i].type|
``$ground_$x1|_$y1|.items[$i].special|"		
                                        [command]
                                            [set_variables]
                                                name=current_unit.variables.inventory.weapons.melee
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=ground_$x1|_$y1|.items[$i]
                                                [/insert_tag]
                                            [/set_variables]
											[removeitem]
												x,y=$x1,$y1
												image=items/$ground_$x1|_$y1|.items[$i].ground_icon|.png
											[/removeitem]
                                            {CLEAR_VARIABLE "ground_$x1|_$y1|.items[$i]"}
                                            {VARIABLE ground_changed 1}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=ground_$x1|_$y1|.items[$i].category
                                equals="ranged_weapon"
                            [/variable]
                            [then]
                                {VARIABLE path "ground_$x1|_$y1|.items[$i]"}
                                [fire_event]
                                    name=weapon_modifiers
                                [/fire_event]
                                [set_variables]
                                    name=get_item_insert
                                    mode=append
                                    [value]
                                        message="&"+attacks/$ground_$x1|_$y1|.items[$i].icon|.png+"="+_ "$ground_$x1|_$y1|.items[$i].description|
``Class: $ground_$x1|_$y1|.items[$i].class_description|
`Base: ($ground_$x1|_$y1|.items[$i].damage|-$ground_$x1|_$y1|.items[$i].number|), Adjusted: ($display_damage|-$display_number|) $ground_$x1|_$y1|.items[$i].type|
``$ground_$x1|_$y1|.items[$i].special|"		
                                        [command]
                                            [set_variables]
                                                name=current_unit.variables.inventory.weapons.ranged
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=ground_$x1|_$y1|.items[$i]
                                                [/insert_tag]
                                            [/set_variables]
											[removeitem]
												x,y=$x1,$y1
												image=items/$ground_$x1|_$y1|.items[$i].ground_icon|.png
											[/removeitem]
                                            {CLEAR_VARIABLE "ground_$x1|_$y1|.items[$i]"}
                                            {VARIABLE ground_changed 1}
                                            [if]
                                                [variable]
                                                    name=ground_$x1|_$y1|.items[$i].user_name
                                                    equals=thunderstick
                                                [/variable]
                                                [then]
                                                    {CONSTRUCT_UNIT}
                                                [/then]
                                            [/if]
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=ground_$x1|_$y1|.items[$i].category
                                equals="torso_armor"
                            [/variable]
                            [then]
                                [set_variables]
                                    name=get_item_insert
                                    mode=append
                                    [value]
                                        message="&"+armor/$ground_$x1|_$y1|.items[$i].icon|.png+"="+_ "$ground_$x1|_$y1|.items[$i].description|
``$ground_$x1|_$y1|.items[$i].resistance.arcane|% arcane, $ground_$x1|_$y1|.items[$i].resistance.blade|% blade, $ground_$x1|_$y1|.items[$i].resistance.fire|% fire, $ground_$x1|_$y1|.items[$i].resistance.cold|% cold, $ground_$x1|_$y1|.items[$i].resistance.impact|% impact, $ground_$x1|_$y1|.items[$i].resistance.pierce|% pierce
``$ground_$x1|_$y1|.items[$i].magic_adjust|% magic adj, $ground_$x1|_$y1|.items[$i].evade_adjust| evade adj, -$ground_$x1|_$y1|.items[$i].terrain.flat.defense|% def adj"				
                                        [command]
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.torso
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=ground_$x1|_$y1|.items[$i]
                                                [/insert_tag]
                                            [/set_variables]
											[removeitem]
												x,y=$x1,$y1
												image=items/$ground_$x1|_$y1|.items[$i].ground_icon|.png
											[/removeitem]
                                            {CLEAR_VARIABLE "ground_$x1|_$y1|.items[$i]"}
                                            {VARIABLE ground_changed 1}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=ground_$x1|_$y1|.items[$i].category
                                equals="legs_armor"
                            [/variable]
                            [then]
                                [set_variables]
                                    name=get_item_insert
                                    mode=append
                                    [value]
                                        message="&"+armor/$ground_$x1|_$y1|.items[$i].icon|.png+"="+_ "$ground_$x1|_$y1|.items[$i].description|
``$ground_$x1|_$y1|.items[$i].resistance.arcane|% arcane, $ground_$x1|_$y1|.items[$i].resistance.blade|% blade, $ground_$x1|_$y1|.items[$i].resistance.fire|% fire, $ground_$x1|_$y1|.items[$i].resistance.cold|% cold, $ground_$x1|_$y1|.items[$i].resistance.impact|% impact, $ground_$x1|_$y1|.items[$i].resistance.pierce|% pierce
``$ground_$x1|_$y1|.items[$i].magic_adjust|% magic adj, $ground_$x1|_$y1|.items[$i].evade_adjust| evade adj, -$ground_$x1|_$y1|.items[$i].terrain.flat.defense|% def adj"		
                                        [command]
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.legs
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=ground_$x1|_$y1|.items[$i]
                                                [/insert_tag]
                                            [/set_variables]
											[removeitem]
												x,y=$x1,$y1
												image=items/$ground_$x1|_$y1|.items[$i].ground_icon|.png
											[/removeitem]
                                            {CLEAR_VARIABLE "ground_$x1|_$y1|.items[$i]"}
                                            {VARIABLE ground_changed 1}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=ground_$x1|_$y1|.items[$i].category
                                equals="head_armor"
                            [/variable]
                            [then]
                                [set_variables]
                                    name=get_item_insert
                                    mode=append
                                    [value]
                                        message="&"+armor/$ground_$x1|_$y1|.items[$i].icon|.png+"="+_ "$ground_$x1|_$y1|.items[$i].description|
``$ground_$x1|_$y1|.items[$i].resistance.arcane|% arcane, $ground_$x1|_$y1|.items[$i].resistance.blade|% blade, $ground_$x1|_$y1|.items[$i].resistance.fire|% fire, $ground_$x1|_$y1|.items[$i].resistance.cold|% cold, $ground_$x1|_$y1|.items[$i].resistance.impact|% impact, $ground_$x1|_$y1|.items[$i].resistance.pierce|% pierce
``$ground_$x1|_$y1|.items[$i].evade_adjust| evade adj, $ground_$x1|_$y1|.items[$i].ranged_adjust|% ranged adj"			
                                        [command]
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.head
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=ground_$x1|_$y1|.items[$i]
                                                [/insert_tag]
                                            [/set_variables]
											[removeitem]
												x,y=$x1,$y1
												image=items/$ground_$x1|_$y1|.items[$i].ground_icon|.png
											[/removeitem]
                                            {CLEAR_VARIABLE "ground_$x1|_$y1|.items[$i]"}
                                            {VARIABLE ground_changed 1}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=ground_$x1|_$y1|.items[$i].category
                                equals="shield"
                            [/variable]
                            [then]
                                [set_variables]
                                    name=get_item_insert
                                    mode=append
                                    [value]
                                        message="&"+armor/$ground_$x1|_$y1|.items[$i].icon|.png+"="+_ "$ground_$x1|_$y1|.items[$i].description|
``$ground_$x1|_$y1|.items[$i].evade_adjust| evade adjust, $ground_$x1|_$y1|.items[$i].terrain_recoup| terrain adjust, $ground_$x1|_$y1|.items[$i].ranged_adjust|% ranged adj, $ground_$x1|_$y1|.items[$i].magic_adjust|% magic adj
``$ground_$x1|_$y1|.items[$i].special"			
                                        [command]
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.shield
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=ground_$x1|_$y1|.items[$i]
                                                [/insert_tag]
                                            [/set_variables]
											[removeitem]
												x,y=$x1,$y1
												image=items/$ground_$x1|_$y1|.items[$i].ground_icon|.png
											[/removeitem]
                                            {CLEAR_VARIABLE "ground_$x1|_$y1|.items[$i]"}
                                            {VARIABLE ground_changed 1}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/then]
                        [/if]
						[if]
                            [variable]
                                name=ground_$x1|_$y1|.items[$i].category
                                equals="gold"
                            [/variable]
                            [then]
                                [set_variables]
                                    name=get_item_insert
                                    mode=append
                                    [value]
                                        message="&"+$ground_$x1|_$y1|.items[$i].icon|.png+"="+_ "$ground_$x1|_$y1|.items[$i].description"
                                        [command]
                                            {VARIABLE_OP current_unit.personal_gold add $ground_$x1|_$y1|.items[$i].amount}
											[modify_side]
						                        side=$current_unit.side
						                        gold=$|current_unit.personal_gold
						                    [/modify_side]
											[sound]
								                name=gold.ogg
								            [/sound]
											[removeitem]
												x,y=$x1,$y1
												image=items/$ground_$x1|_$y1|.items[$i].ground_icon|.png
											[/removeitem]
                                            {CLEAR_VARIABLE "ground_$x1|_$y1|.items[$i]"}
                                            {VARIABLE ground_changed 1}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/then]
                        [/if]
                    {NEXT i}

                    [if]
                        [variable]
                            name=get_item_insert.length
                            less_than=1
                        [/variable]
                        [then]
							[if]
								[variable]
									name=seen_list
									numerical_equals=0
								[/variable]
								[then]
									[message]
										side_for=$side_number
										message=_ "There are no items here to pick up."
										image=wesnoth-icon.png
									[/message]
								[/then]
							[/if]
							{VARIABLE upgrading 0}
                        [/then]
                        [else]
							{VARIABLE seen_list 1}
                            [message]
                                speaker=narrator
                                message= _ "Get which item?"
                                [option]
							        message ="&"+check.png+"="+_ "(End)"

							        [command]
							            {CONSTRUCT_UNIT}
							            {VARIABLE_OP upgrading add -1}
							        [/command]
							    [/option]
                                [insert_tag]
                                    name=option
                                    variable=get_item_insert
                                [/insert_tag]
                                image=wesnoth-icon.png
                            [/message]
                        [/else]
                    [/if]
                [/do]
            [/while]

            [if]
                [variable]
                    name=ground_changed
                    numerical_equals=1
                [/variable]
                [then]
                    [if]
                        [variable]
                            name="ground_$x1|_$y1|.items.length"
                            greater_than=0
                        [/variable]
                        [then]
                            {FOREACH ground_$x1|_$y1|.items i}
	                            [item]
	                                x=$x1
	                                y=$y1
	                                image=items/$ground_$x1|_$y1|.items[$i].ground_icon|.png
									visible_in_fog=no
	                            [/item]
                            {NEXT i}
                        [/then]
                    [/if]
                    {VARIABLE ground_changed 0}
                [/then]
            [/if]
            [unstore_unit]
                variable=current_unit
            [/unstore_unit]
        [/command]
    [/set_menu_item]
#enddef

#define MODRPG_COMMAND_LEVELUP
    [set_menu_item]
        id=b_levelup
		image=commands/button_up.png
        description=_ "Upgrade"
        [filter_location]
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]

        [command]
            {LEVELUP_MENU}
        [/command]
    [/set_menu_item]
#enddef

#define MODRPG_COMMAND_USE_OTHER_ADJ
    [set_menu_item]
        id=use_other_adj
		image=commands/cast.png
        description=_ "Use/Cast on Unit"
        [filter_location]
            [filter]
                [not]
                    side=$side_number
                    canrecruit=yes
                [/not]
            [/filter]
        [/filter_location]
        [show_if]
            [have_unit]
                side=$side_number
                canrecruit=yes
                [filter_location]
                    radius=1
                    x=$x1
                    y=$y1
                [/filter_location]
            [/have_unit]
        [/show_if]
        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE target_x $x1}
            {VARIABLE target_y $y1}
            {VARIABLE acting_x $current_unit.x}
            {VARIABLE acting_y $current_unit.y}

            {CLEAR_VARIABLE use_insert}

            #insert macro to make a bunch of these for all casting skills and atts

            {VARIABLE upgrading 1}
            [while]
                [variable]
                    name=upgrading
                    numerical_equals=1
                [/variable]
                [do]
					{FOREACH current_unit.variables.inventory.spells i}
                        [if]
                            [variable]
                                name=current_unit.variables.inventory.spells[$i].usable_other_adj
                                numerical_not_equals=1
                            [/variable]
                            [then]
                            [/then]
                            [else]
                                [if]
                                    [variable]
                                        name=current_unit.variables.inventory.spells[$i].infinite
                                        numerical_equals=1
                                    [/variable]
                                    [then]
                                        {VARIABLE uses_left "-"}
                                    [/then]
									[else]
										{VARIABLE uses_left $current_unit.variables.inventory.spells[$i].uses}
									[/else]
                                [/if]
								#need uses left gauge
                                [set_variables]
                                    name=use_insert
                                    mode=append
                                    [value]
                                        message="&"+$current_unit.variables.inventory.spells[$i].icon|.png+"="+_ "$current_unit.variables.inventory.spells[$i].description
`Action uses $current_unit.variables.inventory.spells[$i].action_use, $current_unit.variables.inventory.spells[$i].mana_cost mana"="$uses_left"
                                        [command]
											{VARIABLE item_id $i}
											[fire_event]
												name=$current_unit.variables.inventory.spells[$i].command
											[/fire_event]
                                            {VARIABLE upgrading 0}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/else]
                        [/if]
                    {NEXT i}
                    {FOREACH current_unit.variables.inventory.usables i}
                        [if]
                            [variable]
                                name=current_unit.variables.inventory.usables[$i].usable_other_adj
                                numerical_not_equals=1
                            [/variable]
                            [then]
                            [/then]
                            [else]
                                [if]
                                    [variable]
                                        name=current_unit.variables.inventory.usables[$i].infinite
                                        numerical_equals=1
                                    [/variable]
                                    [then]
                                        {VARIABLE uses_left "-"}
                                    [/then]
									[else]
										{VARIABLE uses_left $current_unit.variables.inventory.usables[$i].uses}
									[/else]
                                [/if]
								#need uses left gauge
                                [set_variables]
                                    name=use_insert
                                    mode=append
                                    [value]
                                        message="&"+$current_unit.variables.inventory.usables[$i].icon|.png+"="+_ "$current_unit.variables.inventory.usables[$i].description
`Action uses $current_unit.variables.inventory.usables[$i].action_use"="$uses_left"
                                        [command]
											{VARIABLE item_id $i}
											[fire_event]
												name=$current_unit.variables.inventory.usables[$i].command
											[/fire_event]
                                            {VARIABLE upgrading 0}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/else]
                        [/if]
                    {NEXT i}
                    [if]
                        [variable]
                            name=use_insert.length
                            less_than=1
                        [/variable]
                        [then]
                            [message]
                                speaker=narrator
								side_for=$side_number
                                message=_ "You have nothing to use here."
                                image=wesnoth-icon.png
                            [/message]
                            {VARIABLE upgrading 0}
                        [/then]
                        [else]
							[if]
								[variable]
									name=current_unit.variables.blocked_attacks
									numerical_equals=1
								[/variable]
								[or]
									[variable]
										name=current_unit.attacks_left
										numerical_equals=0
									[/variable]
								[/or]
								[then]
									{VARIABLE actions_temp.attacks ("0 attacks, ")}
								[/then]
								[else]
									{VARIABLE actions_temp.attacks ("1 attack, ")}
								[/else]
							[/if]
							{VARIABLE actions_temp.simple ("$current_unit.simple_action| simple, ")}
							[if]
								[variable]
									name=current_unit.casting_actions
									numerical_equals=1
								[/variable]
								[then]
									{VARIABLE actions_temp.casting ("1 casting time.")}
								[/then]
								[else]
									{VARIABLE actions_temp.casting ("$current_unit.casting_actions| casting time.")}
								[/else]
							[/if]
                            [message]
                                speaker=narrator
                                message= _ "Use which?
Available actions: "+$actions_temp.attacks|+$actions_temp.simple|+$actions_temp.casting|
                                [option]
							        message ="&"+check.png+"="+_ "(End)"="uses left"
							        [command]
							            {CONSTRUCT_UNIT}
							            {VARIABLE_OP upgrading add -1}
							        [/command]
							    [/option]
                                [insert_tag]
                                    name=option
                                    variable=use_insert
                                [/insert_tag]
                                image=wesnoth-icon.png
                            [/message]
                        [/else]
                    [/if]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define MODRPG_COMMAND_USE_OTHER_DIS
    [set_menu_item]
        id=use_other_dis
		image=commands/cast.png
        description=_ "Use/Cast on Unit"
        [filter_location]
            [filter]
                [not]
                    side=$side_number
                    canrecruit=yes
                [/not]
            [/filter]
        [/filter_location]
        [show_if]
            [have_unit]
                side=$side_number
                canrecruit=yes
                [filter_location]
                    [and]
                        x=$x1
                        y=$y1
                        radius=100
                    [/and]
                    [not]
                        x=$x1
                        y=$y1
                        radius=1
                    [/not]
                [/filter_location]
            [/have_unit]
        [/show_if]
        [command]
			[store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE target_x $x1}
            {VARIABLE target_y $y1}
            {VARIABLE acting_x $current_unit.x}
            {VARIABLE acting_y $current_unit.y}

            {CLEAR_VARIABLE use_insert}

            #insert macro to make a bunch of these for all casting skills and atts

            {VARIABLE upgrading 1}
            [while]
                [variable]
                    name=upgrading
                    numerical_equals=1
                [/variable]
                [do]
					{FOREACH current_unit.variables.inventory.spells i}
                        [if]
                            [variable]
                                name=current_unit.variables.inventory.spells[$i].usable_other_dis
                                numerical_not_equals=1
                            [/variable]
                            [then]
                            [/then]
                            [else]
                                [if]
                                    [variable]
                                        name=current_unit.variables.inventory.spells[$i].infinite
                                        numerical_equals=1
                                    [/variable]
                                    [then]
                                        {VARIABLE uses_left "-"}
                                    [/then]
									[else]
										{VARIABLE uses_left $current_unit.variables.inventory.spells[$i].uses}
									[/else]
                                [/if]
								#need uses left gauge
                                [set_variables]
                                    name=use_insert
                                    mode=append
                                    [value]
                                        message="&"+$current_unit.variables.inventory.spells[$i].icon|.png+"="+_ "$current_unit.variables.inventory.spells[$i].description
`Action uses $current_unit.variables.inventory.spells[$i].action_use, $current_unit.variables.inventory.spells[$i].mana_cost mana"="$uses_left"
                                        [command]
											{VARIABLE item_id $i}
											[fire_event]
												name=$current_unit.variables.inventory.spells[$i].command
											[/fire_event]
                                            {VARIABLE upgrading 0}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/else]
                        [/if]
                    {NEXT i}
                    {FOREACH current_unit.variables.inventory.usables i}
                        [if]
                            [variable]
                                name=current_unit.variables.inventory.usables[$i].usable_other_dis
                                numerical_not_equals=1
                            [/variable]
                            [then]
                            [/then]
                            [else]
                                [if]
                                    [variable]
                                        name=current_unit.variables.inventory.usables[$i].infinite
                                        numerical_equals=1
                                    [/variable]
                                    [then]
                                        {VARIABLE uses_left "-"}
                                    [/then]
									[else]
										{VARIABLE uses_left $current_unit.variables.inventory.usables[$i].uses}
									[/else]
                                [/if]
								#need uses left gauge
                                [set_variables]
                                    name=use_insert
                                    mode=append
                                    [value]
                                        message="&"+$current_unit.variables.inventory.usables[$i].icon|.png+"="+_ "$current_unit.variables.inventory.usables[$i].description
`Action uses $current_unit.variables.inventory.usables[$i].action_use"="$uses_left"
                                        [command]
											{VARIABLE item_id $i}
											[fire_event]
												name=$current_unit.variables.inventory.usables[$i].command
											[/fire_event]
                                            {VARIABLE upgrading 0}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/else]
                        [/if]
                    {NEXT i}
                    [if]
                        [variable]
                            name=use_insert.length
                            less_than=1
                        [/variable]
                        [then]
                            [message]
                                speaker=narrator
								side_for=$side_number
                                message=_ "You have nothing to use here."
                                image=wesnoth-icon.png
                            [/message]
                            {VARIABLE upgrading 0}
                        [/then]
                        [else]
							[if]
								[variable]
									name=current_unit.variables.blocked_attacks
									numerical_equals=1
								[/variable]
								[or]
									[variable]
										name=current_unit.attacks_left
										numerical_equals=0
									[/variable]
								[/or]
								[then]
									{VARIABLE actions_temp.attacks ("0 attacks, ")}
								[/then]
								[else]
									{VARIABLE actions_temp.attacks ("1 attack, ")}
								[/else]
							[/if]
							{VARIABLE actions_temp.simple ("$current_unit.simple_action| simple, ")}
							[if]
								[variable]
									name=current_unit.casting_actions
									numerical_equals=1
								[/variable]
								[then]
									{VARIABLE actions_temp.casting ("1 casting time.")}
								[/then]
								[else]
									{VARIABLE actions_temp.casting ("$current_unit.casting_actions| casting time.")}
								[/else]
							[/if]
                            [message]
                                speaker=narrator
                                message= _ "Use which?
Available actions: "+$actions_temp.attacks|+$actions_temp.simple|+$actions_temp.casting|
                                [option]
							        message ="&"+check.png+"="+_ "(End)"="uses left"
							        [command]
							            {CONSTRUCT_UNIT}
							            {VARIABLE_OP upgrading add -1}
							        [/command]
							    [/option]
                                [insert_tag]
                                    name=option
                                    variable=use_insert
                                [/insert_tag]
                                image=wesnoth-icon.png
                            [/message]
                        [/else]
                    [/if]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define MODRPG_COMMAND_GIVE_ITEM
    [set_menu_item]
        id=give_item
		image=commands/give.png
        description=_ "Give Item"
        [filter_location]
            [filter]
                [not]
                    side=$side_number
                    canrecruit=yes
                [/not]
            [/filter]
        [/filter_location]
        [show_if]
            [have_unit]
                side=$side_number
                canrecruit=yes
                [filter_location]
                    radius=1
                    x=$x1
                    y=$y1
                [/filter_location]
            [/have_unit]
        [/show_if]
        [command]
			[if]
				[variable]
					name=current_unit.simple_action
					numerical_equals=0
				[/variable]
				[and]
					[variable]
						name=current_unit.attacks_left
						numerical_equals=0
					[/variable]
				[/and]
				[then]
					{DEBUG_MSG "You do not have enough actions left to give an item."}
				[/then]
				[else]
		            [store_unit]
		                variable=current_unit
		                [filter]
		                    side=$side_number
		                    canrecruit=yes
		                [/filter]
		            [/store_unit]
		            [store_unit]
		                variable=npc_temp
		                [filter]
		                    x=$x1
		                    y=$y1
		                [/filter]
		            [/store_unit]
		            {CLEAR_VARIABLE give_item_insert}
		            {VARIABLE upgrading 1}
		            [while]
		                [variable]
		                    name=upgrading
		                    numerical_equals=1
		                [/variable]
		                [do]
		                    {FOREACH current_unit.variables.inventory.weapons.melee i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.weapons.equipped.id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.weapons.equipped[1].id
		                                    numerical_equals=$i
		                                [/variable]
		                                [or]
		                                    [variable]
		                                        name=current_unit.variables.inventory.weapons.equipped[2].id
		                                        numerical_equals=$i
		                                    [/variable]
		                                    [or]
		                                        [variable]
		                                            name=current_unit.variables.inventory.weapons.melee[$i].undropable
		                                            numerical_equals=1
		                                        [/variable]
		                                    [/or]
		                                [/or]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=give_item_insert
		                                    mode=append
		                                    [value]
		                                        message="&"+attacks/$current_unit.variables.inventory.weapons.melee[$i].icon|.png+"="+_ "$current_unit.variables.inventory.weapons.melee[$i].description|
`Base: $current_unit.variables.inventory.weapons.melee[$i].damage|-$current_unit.variables.inventory.weapons.melee[$i].number| $current_unit.variables.inventory.weapons.melee[$i].type|
``$current_unit.variables.inventory.weapons.melee[$i].special|"		
		                                        [command]
													[if]
														[variable]
															name=npc_temp.canrecruit
															equals=yes
														[/variable]
														[then]
															[set_variables]
																name=npc_temp.variables.inventory.weapons.melee
																mode=append
																to_variable=current_unit.variables.inventory.weapons.melee[$i]
															[/set_variables]
															[unstore_unit]
																variable=npc_temp
															[/unstore_unit]
															[clear_variable]
																name=current_unit.variables.inventory.weapons.melee[$i]
															[/clear_variable]
															[if]
																[variable]
																	name=current_unit.variables.inventory.weapons.equipped.id
																	greater_than_equal_to=$i
																[/variable]
																[then]
																	{VARIABLE_OP current_unit.variables.inventory.weapons.equipped.id add -1}
																[/then]
															[/if]
															[if]
																[variable]
																	name=current_unit.variables.inventory.weapons.equipped[1].id
																	greater_than_equal_to=$i
																[/variable]
																[then]
																	{VARIABLE_OP current_unit.variables.inventory.weapons.equipped[1].id add -1}
																[/then]
															[/if]
															[if]
																[variable]
																	name=current_unit.variables.inventory.weapons.equipped[2].id
																	greater_than_equal_to=$i
																[/variable]
																[then]
																	{VARIABLE_OP current_unit.variables.inventory.weapons.equipped[2].id add -1}
																[/then]
															[/if]
															[if]
																[variable]
																	name=acting_unit.simple_action
																	greater_than_equal_to=1
																[/variable]
																[then]
																	{VARIABLE_OP acting_unit.simple_action add -1}
																[/then]
																[else]
																	{VARIABLE_OP acting_unit.attacks_left add -1}
																[/else]
															[/if]
															[unstore_unit]
																variable=current_unit
															[/unstore_unit]
														[/then]
														[else]
				                                            {VARIABLE path "current_unit.variables.inventory.weapons.melee[$i]"}
				                                            [fire_event]
				                                                name=npc_eval_weapon
				                                            [/fire_event]
				                                            [if]
				                                                [variable]
				                                                    name=will_carry
				                                                    numerical_equals=1
				                                                [/variable]
				                                                [then]
																	{LITERAL_CBSS npc_temp}
				                                                    [clear_variable]
				                                                        name=current_unit.variables.inventory.weapons.melee[$i]
				                                                    [/clear_variable]
				                                                    [if]
				                                                        [variable]
				                                                            name=current_unit.variables.inventory.weapons.equipped.id
				                                                            greater_than_equal_to=$i
				                                                        [/variable]
				                                                        [then]
				                                                            {VARIABLE_OP current_unit.variables.inventory.weapons.equipped.id add -1}
				                                                        [/then]
				                                                    [/if]
				                                                    [if]
				                                                        [variable]
				                                                            name=current_unit.variables.inventory.weapons.equipped[1].id
				                                                            greater_than_equal_to=$i
				                                                        [/variable]
				                                                        [then]
				                                                            {VARIABLE_OP current_unit.variables.inventory.weapons.equipped[1].id add -1}
				                                                        [/then]
				                                                    [/if]
				                                                    [if]
				                                                        [variable]
				                                                            name=current_unit.variables.inventory.weapons.equipped[2].id
				                                                            greater_than_equal_to=$i
				                                                        [/variable]
				                                                        [then]
				                                                            {VARIABLE_OP current_unit.variables.inventory.weapons.equipped[2].id add -1}
				                                                        [/then]
				                                                    [/if]
																	[if]
																		[variable]
																			name=acting_unit.simple_action
																			greater_than_equal_to=1
																		[/variable]
																		[then]
																			{VARIABLE_OP acting_unit.simple_action add -1}
																		[/then]
																		[else]
																			{VARIABLE_OP acting_unit.attacks_left add -1}
																		[/else]
																	[/if]
				                                                    [unstore_unit]
				                                                        variable=current_unit
				                                                    [/unstore_unit]
				                                                [/then]
				                                                [else]
				                                                    {DEBUG_MSG "This unit does not want to carry that."}
				                                                [/else]
				                                            [/if]
														[/else]
													[/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
		                    {FOREACH current_unit.variables.inventory.weapons.ranged i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.weapons.equipped[5].id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.weapons.ranged[$i].undropable
		                                    numerical_equals=1
		                                [/variable]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=give_item_insert
		                                    mode=append
		                                    [value]
		                                        message="&"+attacks/$current_unit.variables.inventory.weapons.ranged[$i].icon|.png+"="+_ "$current_unit.variables.inventory.weapons.ranged[$i].description|
`Base: $current_unit.variables.inventory.weapons.ranged[$i].damage|-$current_unit.variables.inventory.weapons.ranged[$i].number| $current_unit.variables.inventory.weapons.ranged[$i].type|
``$current_unit.variables.inventory.weapons.ranged[$i].special|"		
		                                        [command]
													[if]
														[variable]
															name=npc_temp.canrecruit
															equals=yes
														[/variable]
														[then]
															[set_variables]
																name=npc_temp.variables.inventory.weapons.ranged
																mode=append
																to_variable=current_unit.variables.inventory.weapons.ranged[$i]
															[/set_variables]
															[unstore_unit]
																variable=npc_temp
															[/unstore_unit]
															[clear_variable]
																name=current_unit.variables.inventory.weapons.ranged[$i]
															[/clear_variable]
															[if]
																[variable]
																	name=current_unit.variables.inventory.weapons.equipped[5].id
																	greater_than_equal_to=$i
																[/variable]
																[then]
																	{VARIABLE_OP current_unit.variables.inventory.weapons.equipped[5].id add -1}
																[/then]
															[/if]
															[if]
																[variable]
																	name=acting_unit.simple_action
																	greater_than_equal_to=1
																[/variable]
																[then]
																	{VARIABLE_OP acting_unit.simple_action add -1}
																[/then]
																[else]
																	{VARIABLE_OP acting_unit.attacks_left add -1}
																[/else]
															[/if]
															[unstore_unit]
																variable=current_unit
															[/unstore_unit]
														[/then]
														[else]
				                                            {VARIABLE path "current_unit.variables.inventory.weapons.ranged[$i]"}
				                                            [fire_event]
				                                                name=npc_eval_weapon
				                                            [/fire_event]
				                                            [if]
				                                                [variable]
				                                                    name=will_carry
				                                                    numerical_equals=1
				                                                [/variable]
				                                                [then]
																	{LITERAL_CBSS npc_temp}
				                                                    [clear_variable]
				                                                        name=current_unit.variables.inventory.weapons.ranged[$i]
				                                                    [/clear_variable]
				                                                    [if]
				                                                        [variable]
				                                                            name=current_unit.variables.inventory.weapons.equipped[5].id
				                                                            greater_than_equal_to=$i
				                                                        [/variable]
				                                                        [then]
				                                                            {VARIABLE_OP current_unit.variables.inventory.weapons.equipped[5].id add -1}
				                                                        [/then]
				                                                    [/if]
																	[if]
																		[variable]
																			name=acting_unit.simple_action
																			greater_than_equal_to=1
																		[/variable]
																		[then]
																			{VARIABLE_OP acting_unit.simple_action add -1}
																		[/then]
																		[else]
																			{VARIABLE_OP acting_unit.attacks_left add -1}
																		[/else]
																	[/if]
				                                                    [unstore_unit]
				                                                        variable=current_unit
				                                                    [/unstore_unit]
				                                                [/then]
				                                                [else]
				                                                    {DEBUG_MSG "This unit does not want to carry that."}
				                                                [/else]
				                                            [/if]
														[/else]
													[/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
							{FOREACH current_unit.variables.inventory.armor.torso i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.armor.equipped.id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.armor.torso[$i].undropable
		                                    numerical_equals=1
		                                [/variable]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=give_item_insert
		                                    mode=append
		                                    [value]
		                                        message="&"+armor/$current_unit.variables.inventory.armor.torso[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.torso[$i].description|
``$current_unit.variables.inventory.armor.torso[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.torso[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.torso[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.torso[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.torso[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.torso[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.torso[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.torso[$i].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.torso[$i].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.torso[$i].terrain.flat.defense|% def adj"	
		                                        [command]
		                                            [if]
														[variable]
															name=npc_temp.canrecruit
															equals=yes
														[/variable]
														[then]
															[set_variables]
																name=npc_temp.variables.inventory.armor.torso
																mode=append
																to_variable=current_unit.variables.inventory.armor.torso[$i]
															[/set_variables]
															[unstore_unit]
																variable=npc_temp
															[/unstore_unit]
															[clear_variable]
				                                                name=current_unit.variables.inventory.armor.torso[$i]
				                                            [/clear_variable]
				                                            [if]
				                                                [variable]
				                                                    name=current_unit.variables.inventory.armor.equipped.id
				                                                    greater_than_equal_to=$i
				                                                [/variable]
				                                                [then]
				                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped.id add -1}
				                                                [/then]
				                                            [/if]
															[if]
																[variable]
																	name=acting_unit.simple_action
																	greater_than_equal_to=1
																[/variable]
																[then]
																	{VARIABLE_OP acting_unit.simple_action add -1}
																[/then]
																[else]
																	{VARIABLE_OP acting_unit.attacks_left add -1}
																[/else]
															[/if]
															[unstore_unit]
																variable=current_unit
															[/unstore_unit]
														[/then]
														[else]
				                                            {VARIABLE path "current_unit.variables.inventory.armor.torso[$i]"}
				                                            [fire_event]
				                                                name=npc_eval_armor
				                                            [/fire_event]
				                                            [if]
				                                                [variable]
				                                                    name=will_carry
				                                                    numerical_equals=1
				                                                [/variable]
				                                                [then]
				                                                    [clear_variable]
						                                                name=current_unit.variables.inventory.armor.torso[$i]
						                                            [/clear_variable]
						                                            [if]
						                                                [variable]
						                                                    name=current_unit.variables.inventory.armor.equipped.id
						                                                    greater_than_equal_to=$i
						                                                [/variable]
						                                                [then]
						                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped.id add -1}
						                                                [/then]
						                                            [/if]
																	[if]
																		[variable]
																			name=acting_unit.simple_action
																			greater_than_equal_to=1
																		[/variable]
																		[then]
																			{VARIABLE_OP acting_unit.simple_action add -1}
																		[/then]
																		[else]
																			{VARIABLE_OP acting_unit.attacks_left add -1}
																		[/else]
																	[/if]
				                                                    [unstore_unit]
				                                                        variable=current_unit
				                                                    [/unstore_unit]
				                                                [/then]
				                                                [else]
				                                                    {DEBUG_MSG "This unit does not want to carry that."}
				                                                [/else]
				                                            [/if]
														[/else]
													[/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
							{FOREACH current_unit.variables.inventory.armor.legs i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.armor.equipped[3].id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.armor.legs[$i].undropable
		                                    numerical_equals=1
		                                [/variable]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=give_item_insert
		                                    mode=append
		                                    [value]
		                                        message="&"+armor/$current_unit.variables.inventory.armor.legs[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.legs[$i].description|
``$current_unit.variables.inventory.armor.legs[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.legs[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.legs[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.legs[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.legs[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.legs[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.legs[$i].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.legs[$i].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.legs[$i].terrain.flat.defense|% def adj"				
		                                        [command]
		                                            [if]
														[variable]
															name=npc_temp.canrecruit
															equals=yes
														[/variable]
														[then]
															[set_variables]
																name=npc_temp.variables.inventory.armor.legs
																mode=append
																to_variable=current_unit.variables.inventory.armor.legs[$i]
															[/set_variables]
															[unstore_unit]
																variable=npc_temp
															[/unstore_unit]
															[clear_variable]
				                                                name=current_unit.variables.inventory.armor.legs[$i]
				                                            [/clear_variable]
				                                            [if]
				                                                [variable]
				                                                    name=current_unit.variables.inventory.armor.equipped[3].id
				                                                    greater_than_equal_to=$i
				                                                [/variable]
				                                                [then]
				                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped[3].id add -1}
				                                                [/then]
				                                            [/if]
															[if]
																[variable]
																	name=acting_unit.simple_action
																	greater_than_equal_to=1
																[/variable]
																[then]
																	{VARIABLE_OP acting_unit.simple_action add -1}
																[/then]
																[else]
																	{VARIABLE_OP acting_unit.attacks_left add -1}
																[/else]
															[/if]
															[unstore_unit]
																variable=current_unit
															[/unstore_unit]
														[/then]
														[else]
				                                            {VARIABLE path "current_unit.variables.inventory.armor.legs[$i]"}
				                                            [fire_event]
				                                                name=npc_eval_armor
				                                            [/fire_event]
				                                            [if]
				                                                [variable]
				                                                    name=will_carry
				                                                    numerical_equals=1
				                                                [/variable]
				                                                [then]
				                                                    [clear_variable]
						                                                name=current_unit.variables.inventory.armor.legs[$i]
						                                            [/clear_variable]
						                                            [if]
						                                                [variable]
						                                                    name=current_unit.variables.inventory.armor.equipped[3].id
						                                                    greater_than_equal_to=$i
						                                                [/variable]
						                                                [then]
						                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped[3].id add -1}
						                                                [/then]
						                                            [/if]
																	[if]
																		[variable]
																			name=acting_unit.simple_action
																			greater_than_equal_to=1
																		[/variable]
																		[then]
																			{VARIABLE_OP acting_unit.simple_action add -1}
																		[/then]
																		[else]
																			{VARIABLE_OP acting_unit.attacks_left add -1}
																		[/else]
																	[/if]
				                                                    [unstore_unit]
				                                                        variable=current_unit
				                                                    [/unstore_unit]
				                                                [/then]
				                                                [else]
				                                                    {DEBUG_MSG "This unit does not want to carry that."}
				                                                [/else]
				                                            [/if]
														[/else]
													[/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
							{FOREACH current_unit.variables.inventory.armor.head i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.armor.equipped[1].id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.armor.head[$i].undropable
		                                    numerical_equals=1
		                                [/variable]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=give_item_insert
		                                    mode=append
		                                    [value]
		                                        message="&"+armor/$current_unit.variables.inventory.armor.head[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.head[$i].description|
``$current_unit.variables.inventory.armor.head[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.head[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.head[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.head[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.head[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.head[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.head[$i].evade_adjust| evade adj, $current_unit.variables.inventory.armor.head[$i].ranged_adjust|% ranged adj"
		                                        [command]
		                                            [if]
														[variable]
															name=npc_temp.canrecruit
															equals=yes
														[/variable]
														[then]
															[set_variables]
																name=npc_temp.variables.inventory.armor.head
																mode=append
																to_variable=current_unit.variables.inventory.armor.head[$i]
															[/set_variables]
															[unstore_unit]
																variable=npc_temp
															[/unstore_unit]
															[clear_variable]
				                                                name=current_unit.variables.inventory.armor.head[$i]
				                                            [/clear_variable]
				                                            [if]
				                                                [variable]
				                                                    name=current_unit.variables.inventory.armor.equipped[1].id
				                                                    greater_than_equal_to=$i
				                                                [/variable]
				                                                [then]
				                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped[1].id add -1}
				                                                [/then]
				                                            [/if]
															[if]
																[variable]
																	name=acting_unit.simple_action
																	greater_than_equal_to=1
																[/variable]
																[then]
																	{VARIABLE_OP acting_unit.simple_action add -1}
																[/then]
																[else]
																	{VARIABLE_OP acting_unit.attacks_left add -1}
																[/else]
															[/if]
															[unstore_unit]
																variable=current_unit
															[/unstore_unit]
														[/then]
														[else]
				                                            {VARIABLE path "current_unit.variables.inventory.armor.head[$i]"}
				                                            [fire_event]
				                                                name=npc_eval_armor
				                                            [/fire_event]
				                                            [if]
				                                                [variable]
				                                                    name=will_carry
				                                                    numerical_equals=1
				                                                [/variable]
				                                                [then]
				                                                    [clear_variable]
						                                                name=current_unit.variables.inventory.armor.head[$i]
						                                            [/clear_variable]
						                                            [if]
						                                                [variable]
						                                                    name=current_unit.variables.inventory.armor.equipped[1].id
						                                                    greater_than_equal_to=$i
						                                                [/variable]
						                                                [then]
						                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped[1].id add -1}
						                                                [/then]
						                                            [/if]
																	[if]
																		[variable]
																			name=acting_unit.simple_action
																			greater_than_equal_to=1
																		[/variable]
																		[then]
																			{VARIABLE_OP acting_unit.simple_action add -1}
																		[/then]
																		[else]
																			{VARIABLE_OP acting_unit.attacks_left add -1}
																		[/else]
																	[/if]
				                                                    [unstore_unit]
				                                                        variable=current_unit
				                                                    [/unstore_unit]
				                                                [/then]
				                                                [else]
				                                                    {DEBUG_MSG "This unit does not want to carry that."}
				                                                [/else]
				                                            [/if]
														[/else]
													[/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
							{FOREACH current_unit.variables.inventory.armor.shield i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.armor.equipped[4].id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.armor.head[$i].undropable
		                                    numerical_equals=1
		                                [/variable]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=give_item_insert
		                                    mode=append
		                                    [value]
		                                        message ="&"+armor/$current_unit.variables.inventory.armor.shield[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.shield[$i].description|
``$current_unit.variables.inventory.armor.shield[$i].evade_adjust| evade adjust, $current_unit.variables.inventory.armor.shield[$i].terrain_recoup| terrain adjust, $current_unit.variables.inventory.armor.shield[$i].ranged_adjust|% ranged adj, $current_unit.variables.inventory.armor.shield[$i].magic_adjust|% magic adj
``$current_unit.variables.inventory.armor.shield[$i].special"
		                                        [command]
		                                            [if]
														[variable]
															name=npc_temp.canrecruit
															equals=yes
														[/variable]
														[then]
															[set_variables]
																name=npc_temp.variables.inventory.armor.shield
																mode=append
																to_variable=current_unit.variables.inventory.armor.shield[$i]
															[/set_variables]
															[unstore_unit]
																variable=npc_temp
															[/unstore_unit]
															[clear_variable]
				                                                name=current_unit.variables.inventory.armor.shield[$i]
				                                            [/clear_variable]
				                                            [if]
				                                                [variable]
				                                                    name=current_unit.variables.inventory.armor.equipped[4].id
				                                                    greater_than_equal_to=$i
				                                                [/variable]
				                                                [then]
				                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped[4].id add -1}
				                                                [/then]
				                                            [/if]
															[if]
																[variable]
																	name=acting_unit.simple_action
																	greater_than_equal_to=1
																[/variable]
																[then]
																	{VARIABLE_OP acting_unit.simple_action add -1}
																[/then]
																[else]
																	{VARIABLE_OP acting_unit.attacks_left add -1}
																[/else]
															[/if]
															[unstore_unit]
																variable=current_unit
															[/unstore_unit]
														[/then]
														[else]
				                                            {VARIABLE path "current_unit.variables.inventory.armor.shield[$i]"}
				                                            [fire_event]
				                                                name=npc_eval_shield
				                                            [/fire_event]
				                                            [if]
				                                                [variable]
				                                                    name=will_carry
				                                                    numerical_equals=1
				                                                [/variable]
				                                                [then]
				                                                    [clear_variable]
						                                                name=current_unit.variables.inventory.armor.shield[$i]
						                                            [/clear_variable]
						                                            [if]
						                                                [variable]
						                                                    name=current_unit.variables.inventory.armor.equipped[4].id
						                                                    greater_than_equal_to=$i
						                                                [/variable]
						                                                [then]
						                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped[4].id add -1}
						                                                [/then]
						                                            [/if]
																	[if]
																		[variable]
																			name=acting_unit.simple_action
																			greater_than_equal_to=1
																		[/variable]
																		[then]
																			{VARIABLE_OP acting_unit.simple_action add -1}
																		[/then]
																		[else]
																			{VARIABLE_OP acting_unit.attacks_left add -1}
																		[/else]
																	[/if]
				                                                    [unstore_unit]
				                                                        variable=current_unit
				                                                    [/unstore_unit]
				                                                [/then]
				                                                [else]
				                                                    {DEBUG_MSG "This unit does not want to carry that."}
				                                                [/else]
				                                            [/if]
														[/else]
													[/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
							{FOREACH current_unit.variables.inventory.usables i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.usables[$i].undropable
		                                numerical_equals=1
		                            [/variable]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=give_item_insert
		                                    mode=append
		                                    [value]
		                                       message="&"+$current_unit.variables.inventory.usables[$i].icon|.png+"="+_ "$current_unit.variables.inventory.usables[$i].description"
		                                        [command]
		                                            [if]
														[variable]
															name=npc_temp.canrecruit
															equals=yes
														[/variable]
														[then]
															[set_variables]
																name=npc_temp.variables.inventory.usables
																mode=append
																to_variable=current_unit.variables.inventory.usables[$i]
															[/set_variables]
															[unstore_unit]
																variable=npc_temp
															[/unstore_unit]
															[clear_variable]
				                                                name=current_unit.variables.inventory.usables[$i]
				                                            [/clear_variable]
															[if]
																[variable]
																	name=acting_unit.simple_action
																	greater_than_equal_to=1
																[/variable]
																[then]
																	{VARIABLE_OP acting_unit.simple_action add -1}
																[/then]
																[else]
																	{VARIABLE_OP acting_unit.attacks_left add -1}
																[/else]
															[/if]
															[unstore_unit]
																variable=current_unit
															[/unstore_unit]
														[/then]
														[else]
				                                            {VARIABLE path "current_unit.variables.inventory.usables[$i]"}
				                                            [fire_event]
				                                                name=npc_eval_usable
				                                            [/fire_event]
				                                            [if]
				                                                [variable]
				                                                    name=will_carry
				                                                    numerical_equals=1
				                                                [/variable]
				                                                [then]
				                                                    [clear_variable]
						                                                name=current_unit.variables.inventory.usables[$i]
						                                            [/clear_variable]
																	[if]
																		[variable]
																			name=acting_unit.simple_action
																			greater_than_equal_to=1
																		[/variable]
																		[then]
																			{VARIABLE_OP acting_unit.simple_action add -1}
																		[/then]
																		[else]
																			{VARIABLE_OP acting_unit.attacks_left add -1}
																		[/else]
																	[/if]
				                                                    [unstore_unit]
				                                                        variable=current_unit
				                                                    [/unstore_unit]
				                                                [/then]
				                                                [else]
				                                                    {DEBUG_MSG "This unit does not want to carry that."}
				                                                [/else]
				                                            [/if]
														[/else]
													[/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
							[if]
								[variable]
									name=current_unit.personal_gold
									greater_then=0
								[/variable]
								[and]
									[variable]
										name=npc_temp.canrecruit
										equals=yes
									[/variable]
								[/and]
								[then]
									[set_variables]
										name=give_item_insert
										mode=append
										[literal]
											message="&"+icons/gold-give.png+"="+ _ "Transfer gold"
											[command]
												{VARIABLE gold_xfer_flag 1}
												{VARIABLE xfer_amount 0}
												[while]
													[variable]
														name=gold_xfer_flag
														numerical_equals=1
													[/variable]
													[do]
														{VARIABLE shifted_difference $xfer_amount}
														{VARIABLE_OP shifted_difference multiply 10}
														{VARIABLE_OP shifted_difference add -$current_unit.personal_gold}
														{VARIABLE gold_result_1 $current_unit.personal_gold}
														{VARIABLE_OP gold_result_1 add -$xfer_amount}
														{VARIABLE gold_result_2 $npc_temp.personal_gold}
														{VARIABLE_OP gold_result_2 add $xfer_amount}
														[message]
															speaker=narrator
															message= _ "Transfer how much gold? $xfer_amount| <"
															[option]
																message="&"+check.png+"="+_ "(Transfer Gold)"
																[show_if]
																	[variable]
																		name=xfer_amount
																		greater_than=0
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP current_unit.personal_gold add -$xfer_amount}
																	{VARIABLE_OP npc_temp.personal_gold add $xfer_amount}
																	[modify_side]
																		side=$current_unit.side
																		gold=$gold_result_1
																	[/modify_side]
																	[modify_side]
																		side=$npc_temp.side
																		gold=$gold_result_2
																	[/modify_side]
																	[unstore_unit]
																		variable=current_unit
																	[/unstore_unit]
																	[unstore_unit]
																		variable=npc_temp
																	[/unstore_unit]
																	[sound]
														                name=gold.ogg
														            [/sound]
																	{VARIABLE gold_xfer_flag 0}
																	{VARIABLE upgrading 0}
																[/command]
															[/option]
															[option]
																message="&"+x.png+"="+_ "(Cancel Gold Transfer)"
																[command]
																	{VARIABLE gold_xfer_flag 0}
																	{VARIABLE upgrading 0}
																[/command]
															[/option]
															[option]
																message="0"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=1
																	[/variable]
																	[and]
																		[variable]
																			name=xfer_amount
																			greater_than=0
																		[/variable]
																	[/and]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																[/command]
															[/option]
															[option]
																message="1"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=0
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 1}
																[/command]
															[/option]
															[option]
																message="2"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-1
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 2}
																[/command]
															[/option]
															[option]
																message="3"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-2
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 3}
																[/command]
															[/option]
															[option]
																message="4"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-3
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 4}
																[/command]
															[/option]
															[option]
																message="5"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-4
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 5}
																[/command]
															[/option]
															[option]
																message="6"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-5
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 6}
																[/command]
															[/option]
															[option]
																message="7"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-6
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 7}
																[/command]
															[/option]
															[option]
																message="8"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-7
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 8}
																[/command]
															[/option]
															[option]
																message="9"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-9
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 9}
																[/command]
															[/option]
														[/message]
													[/do]
												[/while]
												{CLEAR_VARIABLE gold_xfer_flag,shifted_difference,gold_result}
											[/command]
										[/literal]
									[/set_variables]
								[/then]
							[/if]
		                    [if]
		                        [variable]
		                            name=give_item_insert.length
		                            less_than=1
		                        [/variable]
		                        [then]
		                            [message]
		                                speaker=narrator
										side_for=$side_number
		                                message=_ "You have no items to give."
		                                image=wesnoth-icon.png
		                            [/message]
		                            {VARIABLE upgrading 0}
		                        [/then]
		                        [else]
		                            [message]
		                                speaker=narrator
		                                message= _ "Give which item?"
		                                [option]
									        message ="&"+check.png+"="+_ "(End)"

									        [command]
									            {CONSTRUCT_UNIT}
									            {VARIABLE_OP upgrading add -1}
									        [/command]
									    [/option]
		                                [insert_tag]
		                                    name=option
		                                    variable=give_item_insert
		                                [/insert_tag]
		                                image=wesnoth-icon.png
		                            [/message]
		                        [/else]
		                    [/if]
		                [/do]
		            [/while]
				[/else]
			[/if]
        [/command]
    [/set_menu_item]
#enddef

#define MODRPG_COMMAND_USE_ADJ
    [set_menu_item]
        id=use_adj
		image=commands/cast.png
        description=_ "Use/Cast"
        [filter_location]
            [not]
                [filter]
                [/filter]
            [/not]
            [and]
                [filter]
                    canrecruit=yes
                    side=$side_number
                [/filter]
                radius=1
            [/and]
        [/filter_location]
        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE target_x $x1}
            {VARIABLE target_y $y1}
            {VARIABLE acting_x $current_unit.x}
            {VARIABLE acting_y $current_unit.y}

            {CLEAR_VARIABLE use_insert}

            #insert macro to make a bunch of these for all casting skills and atts

            {VARIABLE upgrading 1}
            [while]
                [variable]
                    name=upgrading
                    numerical_equals=1
                [/variable]
                [do]
					{FOREACH current_unit.variables.inventory.spells i}
                        [if]
                            [variable]
                                name=current_unit.variables.inventory.spells[$i].usable_adj
                                numerical_not_equals=1
                            [/variable]
                            [then]
                            [/then]
                            [else]
                                [if]
                                    [variable]
                                        name=current_unit.variables.inventory.spells[$i].infinite
                                        numerical_equals=1
                                    [/variable]
                                    [then]
                                        {VARIABLE uses_left "-"}
                                    [/then]
									[else]
										{VARIABLE uses_left $current_unit.variables.inventory.spells[$i].uses}
									[/else]
                                [/if]
								#need uses left gauge
                                [set_variables]
                                    name=use_insert
                                    mode=append
                                    [value]
                                        message="&"+$current_unit.variables.inventory.spells[$i].icon|.png+"="+_ "$current_unit.variables.inventory.spells[$i].description
`Action uses $current_unit.variables.inventory.spells[$i].action_use, $current_unit.variables.inventory.spells[$i].mana_cost mana"="$uses_left"
                                        [command]
											{VARIABLE item_id $i}
											[fire_event]
												name=$current_unit.variables.inventory.spells[$i].command
											[/fire_event]
                                            {VARIABLE upgrading 0}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/else]
                        [/if]
                    {NEXT i}
                    {FOREACH current_unit.variables.inventory.usables i}
                        [if]
                            [variable]
                                name=current_unit.variables.inventory.usables[$i].usable_adj
                                numerical_not_equals=1
                            [/variable]
                            [then]
                            [/then]
                            [else]
                                [if]
                                    [variable]
                                        name=current_unit.variables.inventory.usables[$i].infinite
                                        numerical_equals=1
                                    [/variable]
                                    [then]
                                        {VARIABLE uses_left "-"}
                                    [/then]
									[else]
										{VARIABLE uses_left $current_unit.variables.inventory.usables[$i].uses}
									[/else]
                                [/if]
								#need uses left gauge
                                [set_variables]
                                    name=use_insert
                                    mode=append
                                    [value]
                                        message="&"+$current_unit.variables.inventory.usables[$i].icon|.png+"="+_ "$current_unit.variables.inventory.usables[$i].description
`Action uses $current_unit.variables.inventory.usables[$i].action_use"="$uses_left"
                                        [command]
											{VARIABLE item_id $i}
											[fire_event]
												name=$current_unit.variables.inventory.usables[$i].command
											[/fire_event]
                                            {VARIABLE upgrading 0}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/else]
                        [/if]
                    {NEXT i}
                    [if]
                        [variable]
                            name=use_insert.length
                            less_than=1
                        [/variable]
                        [then]
                            [message]
                                speaker=narrator
								side_for=$side_number
                                message=_ "You have nothing to use here."
                                image=wesnoth-icon.png
                            [/message]
                            {VARIABLE upgrading 0}
                        [/then]
                        [else]
                            [if]
								[variable]
									name=current_unit.variables.blocked_attacks
									numerical_equals=1
								[/variable]
								[or]
									[variable]
										name=current_unit.attacks_left
										numerical_equals=0
									[/variable]
								[/or]
								[then]
									{VARIABLE actions_temp.attacks ("0 attacks, ")}
								[/then]
								[else]
									{VARIABLE actions_temp.attacks ("1 attack, ")}
								[/else]
							[/if]
							{VARIABLE actions_temp.simple ("$current_unit.simple_action| simple, ")}
							[if]
								[variable]
									name=current_unit.casting_actions
									numerical_equals=1
								[/variable]
								[then]
									{VARIABLE actions_temp.casting ("1 casting time.")}
								[/then]
								[else]
									{VARIABLE actions_temp.casting ("$current_unit.casting_actions| casting time.")}
								[/else]
							[/if]
                            [message]
                                speaker=narrator
                                message= _ "Use which?
Available actions: "+$actions_temp.attacks|+$actions_temp.simple|+$actions_temp.casting|
                                [option]
							        message ="&"+check.png+"="+_ "(End)"="uses left"
							        [command]
							            {CONSTRUCT_UNIT}
							            {VARIABLE_OP upgrading add -1}
							        [/command]
							    [/option]
                                [insert_tag]
                                    name=option
                                    variable=use_insert
                                [/insert_tag]
                                image=wesnoth-icon.png
                            [/message]
                        [/else]
                    [/if]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define MODRPG_COMMAND_USE_DIS
    [set_menu_item]
        id=use_dis
		image=commands/cast.png
        description=_ "Use/Cast"
        [filter_location]
            [not]
                [filter]
                [/filter]
            [/not]
            [and]
                [filter]
                    canrecruit=yes
                    side=$side_number
                [/filter]
                radius=100
            [/and]
            [not]
                [filter]
                    canrecruit=yes
                    side=$side_number
                [/filter]
                radius=1
            [/not]
        [/filter_location]

        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE target_x $x1}
            {VARIABLE target_y $y1}
            {VARIABLE acting_x $current_unit.x}
            {VARIABLE acting_y $current_unit.y}

            {CLEAR_VARIABLE use_insert}

            #insert macro to make a bunch of these for all casting skills and atts

            {VARIABLE upgrading 1}
            [while]
                [variable]
                    name=upgrading
                    numerical_equals=1
                [/variable]
                [do]
					{FOREACH current_unit.variables.inventory.spells i}
                        [if]
                            [variable]
                                name=current_unit.variables.inventory.spells[$i].usable_dis
                                numerical_not_equals=1
                            [/variable]
                            [then]
                            [/then]
                            [else]
                                [if]
                                    [variable]
                                        name=current_unit.variables.inventory.spells[$i].infinite
                                        numerical_equals=1
                                    [/variable]
                                    [then]
                                        {VARIABLE uses_left "-"}
                                    [/then]
									[else]
										{VARIABLE uses_left $current_unit.variables.inventory.spells[$i].uses}
									[/else]
                                [/if]
								#need uses left gauge
                                [set_variables]
                                    name=use_insert
                                    mode=append
                                    [value]
                                        message="&"+$current_unit.variables.inventory.spells[$i].icon|.png+"="+_ "$current_unit.variables.inventory.spells[$i].description
`Action uses $current_unit.variables.inventory.spells[$i].action_use, $current_unit.variables.inventory.spells[$i].mana_cost mana"="$uses_left"
                                        [command]
											{VARIABLE item_id $i}
											[fire_event]
												name=$current_unit.variables.inventory.spells[$i].command
											[/fire_event]
                                            {VARIABLE upgrading 0}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/else]
                        [/if]
                    {NEXT i}
                    {FOREACH current_unit.variables.inventory.usables i}
                        [if]
                            [variable]
                                name=current_unit.variables.inventory.usables[$i].usable_dis
                                numerical_not_equals=1
                            [/variable]
                            [then]
                            [/then]
                            [else]
                                [if]
                                    [variable]
                                        name=current_unit.variables.inventory.usables[$i].infinite
                                        numerical_equals=1
                                    [/variable]
                                    [then]
                                        {VARIABLE uses_left "-"}
                                    [/then]
									[else]
										{VARIABLE uses_left $current_unit.variables.inventory.usables[$i].uses}
									[/else]
                                [/if]
								#need uses left gauge
                                [set_variables]
                                    name=use_insert
                                    mode=append
                                    [value]
                                        message="&"+$current_unit.variables.inventory.usables[$i].icon|.png+"="+_ "$current_unit.variables.inventory.usables[$i].description
`Action uses $current_unit.variables.inventory.usables[$i].action_use"="$uses_left"
                                        [command]
											{VARIABLE item_id $i}
											[fire_event]
												name=$current_unit.variables.inventory.usables[$i].command
											[/fire_event]
                                            {VARIABLE upgrading 0}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/else]
                        [/if]
                    {NEXT i}
                    [if]
                        [variable]
                            name=use_insert.length
                            less_than=1
                        [/variable]
                        [then]
                            [message]
                                speaker=narrator
								side_for=$side_number
                                message=_ "You have nothing to use here."
                                image=wesnoth-icon.png
                            [/message]
                            {VARIABLE upgrading 0}
                        [/then]
                        [else]
                            [if]
								[variable]
									name=current_unit.variables.blocked_attacks
									numerical_equals=1
								[/variable]
								[or]
									[variable]
										name=current_unit.attacks_left
										numerical_equals=0
									[/variable]
								[/or]
								[then]
									{VARIABLE actions_temp.attacks ("0 attacks, ")}
								[/then]
								[else]
									{VARIABLE actions_temp.attacks ("1 attack, ")}
								[/else]
							[/if]
							{VARIABLE actions_temp.simple ("$current_unit.simple_action| simple, ")}
							[if]
								[variable]
									name=current_unit.casting_actions
									numerical_equals=1
								[/variable]
								[then]
									{VARIABLE actions_temp.casting ("1 casting time.")}
								[/then]
								[else]
									{VARIABLE actions_temp.casting ("$current_unit.casting_actions| casting time.")}
								[/else]
							[/if]
                            [message]
                                speaker=narrator
                                message= _ "Use which?
Available actions: "+$actions_temp.attacks|+$actions_temp.simple|+$actions_temp.casting|
                                [option]
							        message ="&"+check.png+"="+_ "(End)"="uses left"
							        [command]
							            {CONSTRUCT_UNIT}
							            {VARIABLE_OP upgrading add -1}
							        [/command]
							    [/option]
                                [insert_tag]
                                    name=option
                                    variable=use_insert
                                [/insert_tag]
                                image=wesnoth-icon.png
                            [/message]
                        [/else]
                    [/if]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define MODRPG_COMMAND_USE_SELF
    [set_menu_item]
        id=use_self
		image=commands/cast.png
        description=_ "Use/Cast on Self"
        [filter_location]
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE target_x $x1}
            {VARIABLE target_y $y1}
            {VARIABLE acting_x $current_unit.x}
            {VARIABLE acting_y $current_unit.y}

            {CLEAR_VARIABLE use_insert}

            #insert macro to make a bunch of these for all casting skills and atts

            {VARIABLE upgrading 1}
            [while]
                [variable]
                    name=upgrading
                    numerical_equals=1
                [/variable]
                [do]
					{FOREACH current_unit.variables.inventory.spells i}
                        [if]
                            [variable]
                                name=current_unit.variables.inventory.spells[$i].usable_self
                                numerical_not_equals=1
                            [/variable]
                            [then]
                            [/then]
                            [else]
                                [if]
                                    [variable]
                                        name=current_unit.variables.inventory.spells[$i].infinite
                                        numerical_equals=1
                                    [/variable]
                                    [then]
                                        {VARIABLE uses_left "-"}
                                    [/then]
									[else]
										{VARIABLE uses_left $current_unit.variables.inventory.spells[$i].uses}
									[/else]
                                [/if]
								#need uses left gauge
                                [set_variables]
                                    name=use_insert
                                    mode=append
                                    [value]
                                        message="&"+$current_unit.variables.inventory.spells[$i].icon|.png+"="+_ "$current_unit.variables.inventory.spells[$i].description
`Action uses $current_unit.variables.inventory.spells[$i].action_use, $current_unit.variables.inventory.spells[$i].mana_cost mana"="$uses_left"
                                        [command]
											{VARIABLE item_id $i}
											[fire_event]
												name=$current_unit.variables.inventory.spells[$i].command
											[/fire_event]
                                            {VARIABLE upgrading 0}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/else]
                        [/if]
                    {NEXT i}
                    {FOREACH current_unit.variables.inventory.usables i}
                        [if]
                            [variable]
                                name=current_unit.variables.inventory.usables[$i].usable_self
                                numerical_not_equals=1
                            [/variable]
                            [then]
                            [/then]
                            [else]
                                [if]
                                    [variable]
                                        name=current_unit.variables.inventory.usables[$i].infinite
                                        numerical_equals=1
                                    [/variable]
                                    [then]
                                        {VARIABLE uses_left "-"}
                                    [/then]
									[else]
										{VARIABLE uses_left $current_unit.variables.inventory.usables[$i].uses}
									[/else]
                                [/if]
								#need uses left gauge
                                [set_variables]
                                    name=use_insert
                                    mode=append
                                    [value]
                                        message="&"+$current_unit.variables.inventory.usables[$i].icon|.png+"="+_ "$current_unit.variables.inventory.usables[$i].description
`Action uses $current_unit.variables.inventory.usables[$i].action_use"="$uses_left"
                                        [command]
											{VARIABLE item_id $i}
											[fire_event]
												name=$current_unit.variables.inventory.usables[$i].command
											[/fire_event]
                                            {VARIABLE upgrading 0}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/else]
                        [/if]
                    {NEXT i}
                    [if]
                        [variable]
                            name=use_insert.length
                            less_than=1
                        [/variable]
                        [then]
                            [message]
                                speaker=narrator
								side_for=$side_number
                                message=_ "You have nothing to use here."
                                image=wesnoth-icon.png
                            [/message]
                            {VARIABLE upgrading 0}
                        [/then]
                        [else]
							[if]
								[variable]
									name=current_unit.variables.blocked_attacks
									numerical_equals=1
								[/variable]
								[or]
									[variable]
										name=current_unit.attacks_left
										numerical_equals=0
									[/variable]
								[/or]
								[then]
									{VARIABLE actions_temp.attacks ("0 attacks, ")}
								[/then]
								[else]
									{VARIABLE actions_temp.attacks ("1 attack, ")}
								[/else]
							[/if]
							{VARIABLE actions_temp.simple ("$current_unit.simple_action| simple, ")}
							[if]
								[variable]
									name=current_unit.casting_actions
									numerical_equals=1
								[/variable]
								[then]
									{VARIABLE actions_temp.casting ("1 casting time.")}
								[/then]
								[else]
									{VARIABLE actions_temp.casting ("$current_unit.casting_actions| casting time.")}
								[/else]
							[/if]
                            [message]
                                speaker=narrator
                                message= _ "Use which?
Available actions: "+$actions_temp.attacks|+$actions_temp.simple|+$actions_temp.casting|
                                [option]
							        message ="&"+check.png+"="+_ "(End)"="uses left"
							        [command]
							            {CONSTRUCT_UNIT}
							            {VARIABLE_OP upgrading add -1}
							        [/command]
							    [/option]
                                [insert_tag]
                                    name=option
                                    variable=use_insert
                                [/insert_tag]
                                image=wesnoth-icon.png
                            [/message]
                        [/else]
                    [/if]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define MODRPG_COMMAND_DROP_ITEM
    [set_menu_item]
        id=drop_item
		image=commands/drop.png
        description=_ "Drop Item"

        [filter_location]
            [not]
                [filter]
                [/filter]
            [/not]
            [and]
                [filter]
                    canrecruit=yes
                    side=$side_number
                [/filter]
                radius=1
            [/and]
        [/filter_location]
        [command]
			[if]
				[variable]
					name=current_unit.simple_action
					numerical_equals=0
				[/variable]
				[and]
					[variable]
						name=current_unit.attacks_left
						numerical_equals=0
					[/variable]
				[/and]
				[then]
					{DEBUG_MSG "You do not have enough actions left to drop an item."}
				[/then]
				[else]
		            [store_unit]
		                variable=current_unit
		                [filter]
		                    side=$side_number
		                    canrecruit=yes
		                [/filter]
		            [/store_unit]

		            {CLEAR_VARIABLE drop_item_insert}

		            {VARIABLE upgrading 1}
		            [while]
		                [variable]
		                    name=upgrading
		                    numerical_equals=1
		                [/variable]
		                [do]
		                    {FOREACH current_unit.variables.inventory.usables i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.usables[$i].undropable
		                                numerical_equals=1
		                            [/variable]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=drop_item_insert
		                                    mode=append
		                                    [value]
		                                        message="&"+$current_unit.variables.inventory.usables[$i].icon|.png+"="+_ "$current_unit.variables.inventory.usables[$i].description"
		                                        [command]
		                                            [item]
		                                                x=$x1
		                                                y=$y1
		                                                image=items/$current_unit.variables.inventory.usables[$i].ground_icon|.png
														visible_in_fog=no
		                                            [/item]
		                                            [set_variables]
		                                                name=ground_$x1|_$y1|.items
		                                                mode=append
		                                                [insert_tag]
		                                                    name=literal
		                                                    variable=current_unit.variables.inventory.usables[$i]
		                                                [/insert_tag]
		                                            [/set_variables]
		                                            [clear_variable]
		                                                name=current_unit.variables.inventory.usables[$i]
		                                            [/clear_variable]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
		                    {FOREACH current_unit.variables.inventory.weapons.melee i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.weapons.equipped.id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.weapons.equipped[1].id
		                                    numerical_equals=$i
		                                [/variable]
		                                [or]
		                                    [variable]
		                                        name=current_unit.variables.inventory.weapons.equipped[2].id
		                                        numerical_equals=$i
		                                    [/variable]
		                                    [or]
		                                        [variable]
		                                            name=current_unit.variables.inventory.weapons.melee[$i].undropable
		                                            numerical_equals=1
		                                        [/variable]
		                                    [/or]
		                                [/or]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=drop_item_insert
		                                    mode=append
		                                    [value]
		                                        message="&"+attacks/$current_unit.variables.inventory.weapons.melee[$i].icon|.png+"="+_ "$current_unit.variables.inventory.weapons.melee[$i].description|
`Base: $current_unit.variables.inventory.weapons.melee[$i].damage|-$current_unit.variables.inventory.weapons.melee[$i].number| $current_unit.variables.inventory.weapons.melee[$i].type|
``$current_unit.variables.inventory.weapons.melee[$i].special|"		
		                                        [command]
		                                            [item]
		                                                x=$x1
		                                                y=$y1
		                                                image=items/$current_unit.variables.inventory.weapons.melee[$i].ground_icon|.png
														visible_in_fog=no
		                                            [/item]
		                                            [set_variables]
		                                                name=ground_$x1|_$y1|.items
		                                                mode=append
		                                                [insert_tag]
		                                                    name=literal
		                                                    variable=current_unit.variables.inventory.weapons.melee[$i]
		                                                [/insert_tag]
		                                            [/set_variables]
		                                            [clear_variable]
		                                                name=current_unit.variables.inventory.weapons.melee[$i]
		                                            [/clear_variable]
		                                            [if]
		                                                [variable]
		                                                    name=current_unit.variables.inventory.weapons.equipped.id
		                                                    greater_than_equal_to=$i
		                                                [/variable]
		                                                [then]
		                                                    {VARIABLE_OP current_unit.variables.inventory.weapons.equipped.id add -1}
		                                                [/then]
		                                            [/if]
		                                            [if]
		                                                [variable]
		                                                    name=current_unit.variables.inventory.weapons.equipped[1].id
		                                                    greater_than_equal_to=$i
		                                                [/variable]
		                                                [then]
		                                                    {VARIABLE_OP current_unit.variables.inventory.weapons.equipped[1].id add -1}
		                                                [/then]
		                                            [/if]
		                                            [if]
		                                                [variable]
		                                                    name=current_unit.variables.inventory.weapons.equipped[2].id
		                                                    greater_than_equal_to=$i
		                                                [/variable]
		                                                [then]
		                                                    {VARIABLE_OP current_unit.variables.inventory.weapons.equipped[2].id add -1}
		                                                [/then]
		                                            [/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
		                    {FOREACH current_unit.variables.inventory.weapons.ranged i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.weapons.equipped[5].id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.weapons.melee[$i].undropable
		                                    numerical_equals=1
		                                [/variable]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=drop_item_insert
		                                    mode=append
		                                    [value]
		                                        message="&"+attacks/$current_unit.variables.inventory.weapons.ranged[$i].icon|.png+"="+_ "$current_unit.variables.inventory.weapons.ranged[$i].description|
`Base: $current_unit.variables.inventory.weapons.ranged[$i].damage|-$current_unit.variables.inventory.weapons.ranged[$i].number| $current_unit.variables.inventory.weapons.ranged[$i].type|
``$current_unit.variables.inventory.weapons.ranged[$i].special|"		
		                                        [command]
		                                            [item]
		                                                x=$x1
		                                                y=$y1
		                                                image=items/$current_unit.variables.inventory.weapons.ranged[$i].ground_icon|.png
														visible_in_fog=no
		                                            [/item]
		                                            [set_variables]
		                                                name=ground_$x1|_$y1|.items
		                                                mode=append
		                                                [insert_tag]
		                                                    name=literal
		                                                    variable=current_unit.variables.inventory.weapons.ranged[$i]
		                                                [/insert_tag]
		                                            [/set_variables]
		                                            [clear_variable]
		                                                name=current_unit.variables.inventory.weapons.ranged[$i]
		                                            [/clear_variable]
		                                            [if]
		                                                [variable]
		                                                    name=current_unit.variables.inventory.weapons.equipped[5].id
		                                                    greater_than_equal_to=$i
		                                                [/variable]
		                                                [then]
		                                                    {VARIABLE_OP current_unit.variables.inventory.weapons.equipped[5].id add -1}
		                                                [/then]
		                                            [/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
		                    {FOREACH current_unit.variables.inventory.armor.torso i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.armor.equipped.id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.armor.torso[$i].undropable
		                                    numerical_equals=1
		                                [/variable]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=drop_item_insert
		                                    mode=append
		                                    [value]
		                                        message="&"+armor/$current_unit.variables.inventory.armor.torso[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.torso[$i].description|
``$current_unit.variables.inventory.armor.torso[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.torso[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.torso[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.torso[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.torso[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.torso[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.torso[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.torso[$i].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.torso[$i].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.torso[$i].terrain.flat.defense|% def adj"	
		                                        [command]
		                                            [item]
		                                                x=$x1
		                                                y=$y1
		                                                image=items/$current_unit.variables.inventory.armor.torso[$i].ground_icon|.png
														visible_in_fog=no
		                                            [/item]
		                                            [set_variables]
		                                                name=ground_$x1|_$y1|.items
		                                                mode=append
		                                                [insert_tag]
		                                                    name=literal
		                                                    variable=current_unit.variables.inventory.armor.torso[$i]
		                                                [/insert_tag]
		                                            [/set_variables]
		                                            [clear_variable]
		                                                name=current_unit.variables.inventory.armor.torso[$i]
		                                            [/clear_variable]
		                                            [if]
		                                                [variable]
		                                                    name=current_unit.variables.inventory.armor.equipped.id
		                                                    greater_than_equal_to=$i
		                                                [/variable]
		                                                [then]
		                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped.id add -1}
		                                                [/then]
		                                            [/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
		                    {FOREACH current_unit.variables.inventory.armor.head i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.armor.equipped[1].id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.armor.head[$i].undropable
		                                    numerical_equals=1
		                                [/variable]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=drop_item_insert
		                                    mode=append
		                                    [value]
		                                        message="&"+armor/$current_unit.variables.inventory.armor.head[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.head[$i].description|
``$current_unit.variables.inventory.armor.head[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.head[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.head[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.head[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.head[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.head[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.head[$i].evade_adjust| evade adj, $current_unit.variables.inventory.armor.head[$i].ranged_adjust|% ranged adj"
		                                        [command]
		                                            [item]
		                                                x=$x1
		                                                y=$y1
		                                                image=items/$current_unit.variables.inventory.armor.head[$i].ground_icon|.png
														visible_in_fog=no
		                                            [/item]
		                                            [set_variables]
		                                                name=ground_$x1|_$y1|.items
		                                                mode=append
		                                                [insert_tag]
		                                                    name=literal
		                                                    variable=current_unit.variables.inventory.armor.head[$i]
		                                                [/insert_tag]
		                                            [/set_variables]
		                                            [clear_variable]
		                                                name=current_unit.variables.inventory.armor.head[$i]
		                                            [/clear_variable]
		                                            [if]
		                                                [variable]
		                                                    name=current_unit.variables.inventory.armor.equipped[1].id
		                                                    greater_than_equal_to=$i
		                                                [/variable]
		                                                [then]
		                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped[1].id add -1}
		                                                [/then]
		                                            [/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
		                    {FOREACH current_unit.variables.inventory.armor.legs i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.armor.equipped[3].id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.armor.legs[$i].undropable
		                                    numerical_equals=1
		                                [/variable]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=drop_item_insert
		                                    mode=append
		                                    [value]
		                                        message="&"+armor/$current_unit.variables.inventory.armor.legs[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.legs[$i].description|
``$current_unit.variables.inventory.armor.legs[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.legs[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.legs[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.legs[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.legs[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.legs[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.legs[$i].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.legs[$i].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.legs[$i].terrain.flat.defense|% def adj"				
		                                        [command]
		                                            [item]
		                                                x=$x1
		                                                y=$y1
		                                                image=items/$current_unit.variables.inventory.armor.legs[$i].ground_icon|.png
														visible_in_fog=no
		                                            [/item]
		                                            [set_variables]
		                                                name=ground_$x1|_$y1|.items
		                                                mode=append
		                                                [insert_tag]
		                                                    name=literal
		                                                    variable=current_unit.variables.inventory.armor.legs[$i]
		                                                [/insert_tag]
		                                            [/set_variables]
		                                            [clear_variable]
		                                                name=current_unit.variables.inventory.armor.legs[$i]
		                                            [/clear_variable]
		                                            [if]
		                                                [variable]
		                                                    name=current_unit.variables.inventory.armor.equipped[3].id
		                                                    greater_than_equal_to=$i
		                                                [/variable]
		                                                [then]
		                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped[3].id add -1}
		                                                [/then]
		                                            [/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
		                    {FOREACH current_unit.variables.inventory.armor.shield i}
		                        [if]
		                            [variable]
		                                name=current_unit.variables.inventory.armor.equipped[4].id
		                                numerical_equals=$i
		                            [/variable]
		                            [or]
		                                [variable]
		                                    name=current_unit.variables.inventory.armor.shield[$i].undropable
		                                    numerical_equals=1
		                                [/variable]
		                            [/or]
		                            [then]
		                            [/then]
		                            [else]
		                                [set_variables]
		                                    name=drop_item_insert
		                                    mode=append
		                                    [value]
		                                        message ="&"+armor/$current_unit.variables.inventory.armor.shield[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.shield[$i].description|
``$current_unit.variables.inventory.armor.shield[$i].evade_adjust| evade adjust, $current_unit.variables.inventory.armor.shield[$i].terrain_recoup| terrain adjust, $current_unit.variables.inventory.armor.shield[$i].ranged_adjust|% ranged adj, $current_unit.variables.inventory.armor.shield[$i].magic_adjust|% magic adj
``$current_unit.variables.inventory.armor.shield[$i].special"				
		                                        [command]
		                                            [item]
		                                                x=$x1
		                                                y=$y1
		                                                image=items/$current_unit.variables.inventory.armor.shield[$i].ground_icon|.png
														visible_in_fog=no
		                                            [/item]
		                                            [set_variables]
		                                                name=ground_$x1|_$y1|.items
		                                                mode=append
		                                                [insert_tag]
		                                                    name=literal
		                                                    variable=current_unit.variables.inventory.armor.shield[$i]
		                                                [/insert_tag]
		                                            [/set_variables]
		                                            [clear_variable]
		                                                name=current_unit.variables.inventory.armor.shield[$i]
		                                            [/clear_variable]
		                                            [if]
		                                                [variable]
		                                                    name=current_unit.variables.inventory.armor.equipped[4].id
		                                                    greater_than_equal_to=$i
		                                                [/variable]
		                                                [then]
		                                                    {VARIABLE_OP current_unit.variables.inventory.armor.equipped[4].id add -1}
		                                                [/then]
		                                            [/if]
		                                            {VARIABLE upgrading 0}
		                                        [/command]
		                                    [/value]
		                                [/set_variables]
		                            [/else]
		                        [/if]
		                    {NEXT i}
							[if]
								[variable]
									name=current_unit.personal_gold
									greater_then=0
								[/variable]
								[then]
									[set_variables]
										name=drop_item_insert
										mode=append
										[literal]
											message="&"+icons/gold-drop.png+"="+ _ "Drop gold"
											[command]
												{VARIABLE gold_xfer_flag 1}
												{VARIABLE xfer_amount 0}
												[while]
													[variable]
														name=gold_xfer_flag
														numerical_equals=1
													[/variable]
													[do]
														{VARIABLE shifted_difference $xfer_amount}
														{VARIABLE_OP shifted_difference multiply 10}
														{VARIABLE_OP shifted_difference add -$current_unit.personal_gold}
														{VARIABLE gold_result $current_unit.personal_gold}
														{VARIABLE_OP gold_result add -$xfer_amount}
														[message]
															speaker=narrator
															message= _ "Drop how much gold? $xfer_amount| <"
															[option]
																message="&"+check.png+"="+_ "(Drop Gold)"
																[show_if]
																	[variable]
																		name=xfer_amount
																		greater_than=0
																	[/variable]
																[/show_if]
																[command]
																	{DROP_GOLD xfer_amount $x1| $y1|}
																	{VARIABLE_OP current_unit.personal_gold add -$xfer_amount}
																	[modify_side]
																		side=$current_unit.side
																		gold=$gold_result
																	[/modify_side]
																	[unstore_unit]
																		variable=current_unit
																	[/unstore_unit]
																	[sound]
														                name=gold.ogg
														            [/sound]
																	{VARIABLE gold_xfer_flag 0}
																	{VARIABLE upgrading 0}
																[/command]
															[/option]
															[option]
																message="&"+x.png+"="+_ "(Cancel Gold Drop)"
																[command]
																	{VARIABLE gold_xfer_flag 0}
																	{VARIABLE upgrading 0}
																[/command]
															[/option]
															[option]
																message="0"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=1
																	[/variable]
																	[and]
																		[variable]
																			name=xfer_amount
																			greater_than=0
																		[/variable]
																	[/and]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																[/command]
															[/option]
															[option]
																message="1"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=0
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 1}
																[/command]
															[/option]
															[option]
																message="2"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-1
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 2}
																[/command]
															[/option]
															[option]
																message="3"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-2
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 3}
																[/command]
															[/option]
															[option]
																message="4"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-3
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 4}
																[/command]
															[/option]
															[option]
																message="5"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-4
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 5}
																[/command]
															[/option]
															[option]
																message="6"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-5
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 6}
																[/command]
															[/option]
															[option]
																message="7"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-6
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 7}
																[/command]
															[/option]
															[option]
																message="8"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-7
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 8}
																[/command]
															[/option]
															[option]
																message="9"
																[show_if]
																	[variable]
																		name=shifted_difference
																		less_than=-9
																	[/variable]
																[/show_if]
																[command]
																	{VARIABLE_OP xfer_amount multiply 10}
																	{VARIABLE_OP xfer_amount add 9}
																[/command]
															[/option]
														[/message]
													[/do]
												[/while]
												{CLEAR_VARIABLE gold_xfer_flag,shifted_difference,gold_result}
											[/command]
										[/literal]
									[/set_variables]
								[/then]
							[/if]
		                    [if]
		                        [variable]
		                            name=drop_item_insert.length
		                            less_than=1
		                        [/variable]
		                        [then]
		                            [message]
		                                speaker=narrator
										side_for=$side_number
		                                message=_ "You have no items to drop."
		                                image=wesnoth-icon.png
		                            [/message]
		                            {VARIABLE upgrading 0}
		                        [/then]
		                        [else]
		                            [message]
		                                speaker=narrator
		                                message= _ "Drop which item?"
		                                [option]
									        message ="&"+check.png+"="+_ "(End)"

									        [command]
									            {CONSTRUCT_UNIT}
									            {VARIABLE_OP upgrading add -1}
									        [/command]
									    [/option]
		                                [insert_tag]
		                                    name=option
		                                    variable=drop_item_insert
		                                [/insert_tag]
		                                image=wesnoth-icon.png
		                            [/message]
		                        [/else]
		                    [/if]
		                [/do]
		            [/while]
		            [unstore_unit]
		                variable=current_unit
		            [/unstore_unit]
				[/else]
			[/if]
        [/command]
    [/set_menu_item]
#enddef


#define MODRPG_COMMAND_HENCH_RELEASE
    [set_menu_item]
        id=y_release_hench
		image=commands/button_x.png
        description=_ "Release Henchman"
        [filter_location]
            [filter]
                side=$side_number
                [not]
                    canrecruit=yes
                [/not]
				[filter_wml]
					[not]
						is_summon=1
					[/not]
				[/filter_wml]
            [/filter]
        [/filter_location]
        [command]
            [message]
                message=_ "Do you really want to release this unit?"
				x,y=$x1,$y1
                [option]
                    message=_ "No."
                    [command]
                    [/command]
                [/option]
                [option]
                    message=_ "Yes."
                    [command]
                        [message]
							side=$side_number
							canrecruit=yes
							side_for=$side_number
                            message=_ "You are dismissed."
                        [/message]
                        [kill]
                            x,y=$x1,$y1
                            animate=yes
                        [/kill]
                    [/command]
                [/option]
            [/message]
        [/command]
    [/set_menu_item]
#enddef

#define MODRPG_COMMAND_FOCUS_UNDEAD
	[set_menu_item]
        id=x_release_focus_undead
		image=commands/skull.png
        description=_ "Release Focus On Minion"
        [filter_location]
            [filter]
                side=$side_number
				race=undead
                [not]
                    canrecruit=yes
                [/not]
				[filter_wml]
					is_hench=1
				[/filter_wml]
            [/filter]
        [/filter_location]
        [command]
			[store_unit]
				variable=temp_hench
				[filter]
                    x=$x1
                    y=$y1
                [/filter]
			[/store_unit]
			{VARIABLE temp_hench.is_hench 0}
			[unstore_unit]
				variable=temp_hench
			[/unstore_unit]
			[remove_unit_overlay]
		        x,y=$temp_hench.x,$temp_hench.y
		        image=misc/hero-icon.png
		    [/remove_unit_overlay]
		[/command]
	[/set_menu_item]
    [set_menu_item]
        id=x_focus_undead
		image=commands/skull.png
        description=_ "Make Permanent Minion"
        [filter_location]
            [filter]
                side=$side_number
				race=undead
                [not]
                    canrecruit=yes
                [/not]
				[filter_wml]
					[not]
						is_hench=1
					[/not]
				[/filter_wml]
            [/filter]
        [/filter_location]
        [command]
			[store_unit]
	            [filter]
					side=1,2,3
	                canrecruit=yes
	            [/filter]
	            variable=hench_num_query
	        [/store_unit]
			[if]
				[variable]
					name=hench_num_query.length
					numerical_equals=1
				[/variable]
				[then]
					{VARIABLE max_hench 2}
				[/then]
				[else]
					{VARIABLE max_hench 1}
				[/else]
			[/if]
			{CLEAR_VARIABLE hench_num_query}
			[store_unit]
				variable=hench_query
				[filter]
					side=$side_number
					[not]
						canrecruit=yes
					[/not]
					[filter_wml]
						is_hench=1
					[/filter_wml]
				[/filter]
			[/store_unit]
			[if]
				[variable]
					name=hench_query.length
					greater_than_equal_to=$max_hench
				[/variable]
				[then]
					{VARIABLE which_hench $hench_query.language_name}
					{VARIABLE_OP query_name_length string_length $hench_query.name}
					[if]
						[variable]
							name=query_name_length
							greater_than=0
						[/variable]
						[then]
							{VARIABLE which_hench_temp $which_hench}
							{VARIABLE which_hench "$hench_query.name the $which_hench_temp"}
						[/then]
					[/if]
				[/then]
				[else]
					{VARIABLE which_hench "no unit"}
				[/else]
			[/if]
            [message]
				x,y=$x1,$y1
                message=_ "You can have a maximum of $max_hench minion(s). Living units over this max will leave. Undead units over this max will deteriorate. If you put your focus on this unit, $which_hench will lose focus. You can manually release the focus on unwanted minions.
Do you want to keep this minion permanently?"
                [option]
                    message=_ "No."
                    [command]
                    [/command]
                [/option]
                [option]
                    message=_ "Yes."
                    [command]
						[store_unit]
							variable=focus_hench
							[filter]
								x,y=$x1,$y1
							[/filter]
						[/store_unit]
						{VARIABLE focus_hench[$i].overlays "misc/hero-icon.png"}
						{VARIABLE focus_hench.is_hench 1}
						[if]
							[variable]
								name=focus_hench[$i].max_hitpoints
								less_than=$focus_hench[$i].stored_max_hitpoints
							[/variable]
							[then]
								{VARIABLE focus_hench[$i].max_hitpoints $focus_hench[$i].stored_max_hitpoints}
							[/then]
						[/if]
						[unstore_unit]
							variable=focus_hench
						[/unstore_unit]
						{VARIABLE max_hench_minus $max_hench}
						{VARIABLE_OP max_hench_minus add -1}
						[if]
							[variable]
								name=hench_query.length
								greater_than=$max_hench_minus
							[/variable]
							[then]
								[if]
									[variable]
										name=hench_query.race
										equals=undead
									[/variable]
									[then]
										{VARIABLE hench_query.is_hench 0}
										[unstore_unit]
											variable=hench_query
										[/unstore_unit]
										[remove_unit_overlay]
									        x,y=$hench_query.x,$hench_query.y
									        image=misc/hero-icon.png
									    [/remove_unit_overlay]
									[/then]
									[else]
										[message]
				                            message=_ "You are dismissed."
											side=$side_number
											canrecruit=yes
											side_for=$side_number
				                        [/message]
				                        [kill]
											x,y=$hench_query.x,$hench_query.y
											animate=yes
				                        [/kill]
									[/else]
								[/if]
							[/then]
						[/if]
                    [/command]
                [/option]
            [/message]
        [/command]
    [/set_menu_item]
#enddef

#define MODRPG_COMMAND_UPGRADE_UNDEAD
    [set_menu_item]
        id=w_upgrade_undead
		image=commands/skull.png
        description=_ "Upgrade Undead"
        [filter_location]
            [filter]
                side=$side_number
				race=undead
                [not]
                    canrecruit=yes
                [/not]
            [/filter]
        [/filter_location]
        [command]
			[store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
			[if]
				[variable]
					name=current_unit.variables.abilities.dark_magic
	                numerical_equals=1
	            [/variable]
				[then]
					[store_unit]
		                variable=undead_unit
		                [filter]
		                    x,y=$x1,$y1
		                [/filter]
		            [/store_unit]
					[store_unit]
		                variable=cancel_undead_unit
		                [filter]
		                    x,y=$x1,$y1
		                [/filter]
		            [/store_unit]
					{VARIABLE upgrading 1}
				    [while]
				        [variable]
				            name=upgrading
				            numerical_equals=1
				        [/variable]
				        [do]
							#figure points total and then points used, declare points left		
							{VARIABLE undead_points $current_unit.variables.abilities.magic_casting.power}
							{VARIABLE_OP undead_points multiply 3}
							{VARIABLE_OP undead_points add 2}
							{VARIABLE undead_level $undead_unit.level}
							{VARIABLE_OP undead_level multiply 3}
							{VARIABLE_OP undead_points add $undead_level}
							{VARIABLE_OP undead_points add -$undead_unit.undead_points_used}
							[unstore_unit]
				                variable=undead_unit
				            [/unstore_unit]
							{VARIABLE has_skirm 0}
							{FOREACH undead_unit.abilities i}
								[if]
									[variable]
										name=undead_unit.abilities[$i].skirmisher.id
										equals=skirmisher
									[/variable]
									[then]
										{VARIABLE has_skirm 1}
									[/then]
								[/if]
							{NEXT i}
							{VARIABLE has_stalk 0}
							{FOREACH undead_unit.abilities i}
								[if]
									[variable]
										name=undead_unit.abilities[$i].nightstalk.id
										equals=nightstalk
									[/variable]
									[then]
										{VARIABLE has_stalk 1}
									[/then]
								[/if]
							{NEXT i}
							{VARIABLE has_wallpass 0}
							{FOREACH undead_unit.abilities i}
								[if]
									[variable]
										name=undead_unit.abilities[$i].dummy.id
										equals=wallpass
									[/variable]
									[then]
										{VARIABLE has_wallpass 1}
									[/then]
								[/if]
							{NEXT i}
							#vigor mortis level
							{VARIABLE temp_blade_resist $undead_unit.resistance.blade}
							{VARIABLE_OP temp_blade_resist divide 10}
							{VARIABLE_OP temp_blade_resist add -10}
							{VARIABLE_OP temp_blade_resist multiply -1}
							[if]
								[variable]
									name=undead_unit.type
									equals=Skeleton_MODRPG
								[/variable]
								[then]
									[unstore_unit]
										variable=undead_unit
									[/unstore_unit]
									[store_unit]
						                variable=npc_temp
						                [filter]
						                    x,y=$undead_unit.x,$undead_unit.y
						                [/filter]
						            [/store_unit]
									[store_unit]
						                variable=unit
						                [filter]
						                    x,y=$undead_unit.x,$undead_unit.y
						                [/filter]
						            [/store_unit]
									{FOREACH npc_temp.attack a}
										[if]
											[variable]
												name=npc_temp.attack[$a].is_rpg_weapon
												greater_than=0
											[/variable]
											[then]
												{CLEAR_VARIABLE npc_temp.attack[$a]}
												{VARIABLE_OP a add -1}
											[/then]
										[/if]
									{NEXT a}
									{CLEAR_ARMOR}
									{CLEAR_VARIABLE npc_temp.variables.inventory}
									[unstore_unit]
										variable=npc_temp
									[/unstore_unit]
									{NPC_EVAL_EQUIPMENT $undead_unit.x|,$undead_unit.y|}
									[store_unit]
						                variable=npc_temp
						                [filter]
						                    x,y=$undead_unit.x,$undead_unit.y
						                [/filter]
						            [/store_unit]
									[set_variables]
										name=npc_temp.variables.inventory.usables
										mode=replace
										to_variable=unit.variables.inventory.usables
									[/set_variables]
									[unstore_unit]
										variable=npc_temp
									[/unstore_unit]
									{CHANGE_BASE_SKEL_SPRITE npc_temp}
									[store_unit]
						                variable=undead_unit
						                [filter]
						                    x,y=$undead_unit.x,$undead_unit.y
						                [/filter]
						            [/store_unit]
								[/then]
							[/if]
							[message]
								x,y=$x1,$y1
								message= _ "This unit has $undead_points points left for upgrades.
To gain more points, level the unit up or improve your own necromantic casting power."
								
								#list of options based on unit type and upgrades
								[option]
									message ="&"+check.png+"="+_ "(End)"
									[command]
										{VARIABLE upgrading 0}
									[/command]
								[/option]
								[option]
									message ="&"+x.png+"="+_ "(Cancel Changes)"
									[command]
										[unstore_unit]
											variable=cancel_undead_unit
										[/unstore_unit]
										{CLEAR_VARIABLE undead_unit}
										{CLEAR_VARIABLE cancel_undead_unit}
										{VARIABLE upgrading 0}
									[/command]
								[/option]
								
								#walking corpse upgrades
								[option]
									message ="&"+attacks/touch-zombie.png+"="+_ "Solidify
Enters Walking Corpse upgrade tree, +1 strike, +1 damage"="2"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Walking Corpse_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=2
											[/variable]
											[and]
												[variable]
													name=undead_unit.corpse_type
													not_equals="wc"
												[/variable]
											[/and]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.attack.damage add 1}
										{VARIABLE_OP undead_unit.attack.number add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 2}
										{VARIABLE undead_unit.corpse_type "wc"}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/touch-zombie.png+"="+_ "Damage Upgrade: touch
+1 to damage"="1"
									[show_if]
										[variable]
											name=undead_unit.corpse_type
											equals="wc"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=1
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.attack.damage add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 1}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/touch-zombie.png+"="+_ "Strike Upgrade: touch
+1 to strikes"="3"
									[show_if]
										[variable]
											name=undead_unit.corpse_type
											equals="wc"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=3
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.attack.number add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 3}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/touch-zombie.png+"="+_ "Vigor Mortis
+10 to all resistances except arcane, max of 50%
Current level - $temp_blade_resist"="2"
									[show_if]
										[variable]
											name=undead_unit.corpse_type
											equals="wc"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=2
											[/variable]
											[and]
												[variable]
													name=undead_unit.resistance.blade
													greater_than=50
												[/variable]
											[/and]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.resistance.blade add -10}
										{VARIABLE_OP undead_unit.resistance.impact add -10}
										{VARIABLE_OP undead_unit.resistance.fire add -10}
										{VARIABLE_OP undead_unit.resistance.cold add -10}
										{VARIABLE_OP undead_unit.resistance.pierce add -10}
										{VARIABLE_OP undead_unit.undead_points_used add 2}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/touch-zombie.png+"="+_ "Fortify
+6 hitpoints"="1"
									[show_if]
										[variable]
											name=undead_unit.corpse_type
											equals="wc"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=1
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.hitpoints add 6}
										{VARIABLE_OP undead_unit.max_hitpoints add 6}
										{VARIABLE_OP undead_unit.stored_max_hitpoints add 6}
										{VARIABLE_OP undead_unit.undead_points_used add 1}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/touch-zombie.png+"="+_ "Hasten
+1 movement point"="3"
									[show_if]
										[variable]
											name=undead_unit.corpse_type
											equals="wc"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=3
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.moves add 1}
										{VARIABLE_OP undead_unit.max_moves add 1}
										{VARIABLE_OP undead_unit.moves_left add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 3}
									[/command]
								[/option]

								#ghoul upgrades
								[option]
									message ="&"+attacks/claws-undead.png+"="+_ "Putrify
Enters Ghoul upgrade tree
-2 damage, +1 strike, ghoul resistances"="3"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Walking Corpse_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=3
											[/variable]
											[and]
												[variable]
													name=undead_unit.corpse_type
													not_equals="wc"
												[/variable]
											[/and]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.undead_points_used add 3}
										{VARIABLE undead_unit.corpse_type "ghoul"}
										[set_variables]
											name=temp_undead_upgrade
											mode=replace
											[value]
												level=$undead_unit.level
												moves=$undead_unit.moves
												hitpoints=$undead_unit.hitpoints
												max_hitpoints=$undead_unit.max_hitpoints
												experience=$undead_unit.experience
												max_experience=$undead_unit.max_experience
												undead_points_used=$undead_unit.undead_points_used
												simple_action=$undead_unit.simple_action
												name=$undead_unit.name
												max_simple_action=$undead_unit.max_simple_action
												attacks_left=$undead_unit.attacks_left
												is_hench=$undead_unit.is_hench
												zoc=$undead_unit.zoc
												resting=$undead_unit.resting
												overlays=$undead_unit.overlays
												name=$undead_unit.name
											[/value]
										[/set_variables]
										{VARIABLE temp_undead_upgrade_attack_damage $undead_unit.attack.damage}
										{VARIABLE_OP temp_undead_upgrade_attack_damage add -2}
										{VARIABLE temp_undead_upgrade_attack_number $undead_unit.attack.number}
										{VARIABLE_OP temp_undead_upgrade_attack_number add 1}
										[kill]
											x=$undead_unit.x
									        y=$undead_unit.y
											fire_event=no
										[/kill]
										{GENERIC_UNIT $undead_unit.side Ghoul_MODRPG $undead_unit.x $undead_unit.y}
										[store_unit]
											[filter]
									            x=$undead_unit.x
									            y=$undead_unit.y
									        [/filter]
											variable=undead_unit
										[/store_unit]			
										[set_variables]
											name=undead_unit
											mode=merge
											[value]
												level=$temp_undead_upgrade.level
												moves=$temp_undead_upgrade.moves
												hitpoints=$temp_undead_upgrade.hitpoints
												max_hitpoints=$temp_undead_upgrade.max_hitpoints
												experience=$temp_undead_upgrade.experience
												max_experience=$temp_undead_upgrade.max_experience
												undead_points_used=$temp_undead_upgrade.undead_points_used
												simple_action=$temp_undead_upgrade.simple_action
												name=$temp_undead_upgrade.name
												max_simple_action=$temp_undead_upgrade.max_simple_action
												attacks_left=$temp_undead_upgrade.attacks_left
												is_hench=$temp_undead_upgrade.is_hench
												zoc=$temp_undead_upgrade.zoc
												resting=$temp_undead_upgrade.resting
												overlays=$temp_undead_upgrade.overlays
												name=$temp_undead_upgrade.name
											[/value]
										[/set_variables]
										{VARIABLE undead_unit.attack.damage $temp_undead_upgrade_attack_damage}
										{VARIABLE undead_unit.attack.number $temp_undead_upgrade_attack_number}
										[unstore_unit]
											variable=undead_unit
										[/unstore_unit]			
									[/command]
								[/option]
								[option]
									message ="&"+attacks/claws-undead.png+"="+_ "Fortify
+6 hitpoints"="1"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Ghoul_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=1
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.hitpoints add 6}
										{VARIABLE_OP undead_unit.max_hitpoints add 6}
										{VARIABLE_OP undead_unit.stored_max_hitpoints add 3}
										{VARIABLE_OP undead_unit.undead_points_used add 1}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/claws-undead.png+"="+_ "Hasten
+1 movement point"="3"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Ghoul_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=3
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.moves add 1}
										{VARIABLE_OP undead_unit.max_moves add 1}
										{VARIABLE_OP undead_unit.moves_left add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 3}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/claws-undead.png+"="+_ "Damage Upgrade
+1 to damage"="1"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Ghoul_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=1
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.attack.damage add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 1}
										[if]
											[variable]
												name=undead_unit.attack[1].name
												equals=bite
											[/variable]
											[then]
												{VARIABLE_OP undead_unit.attack[1].damage add 1}
											[/then]
										[/if]
									[/command]
								[/option]
								[option]
									message ="&"+attacks/claws-undead.png+"="+_ "Strike Upgrade
+1 to strikes"="3"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Ghoul_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=3
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.attack.number add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 3}
										[if]
											[variable]
												name=undead_unit.attack[1].name
												equals=bite
											[/variable]
											[then]
												{VARIABLE_OP undead_unit.attack[1].number add 1}
											[/then]
										[/if]
									[/command]
								[/option]
								[option]
									message ="&"+attacks/claws-undead.png+"="+_ "Poison Claws"="3"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Ghoul_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=3
											[/variable]
											[and]
												[variable]
													name=undead_unit.attack.specials.poison.id
													not_equals=poison
												[/variable]
											[/and]
										[/and]
									[/show_if]
									[command]
										[set_variables]
											name=undead_unit.attack.specials.poison
											mode=merge
											[value]
												id=poison
												name= _ "poison"
												description= _ "Poison:
This attack poisons living targets. Poisoned units lose 8 HP every turn until they are cured or are reduced to 1 HP. Poison can not, of itself, kill a unit."
											[/value]
										[/set_variables]
										{VARIABLE_OP undead_unit.undead_points_used add 3}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/fangs.png+"="+_ "New Attack: bite
$($undead_unit.attack.damage+2)-$($undead_unit.attack.number-1) melee blade, drains"="3"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Ghoul_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=3
											[/variable]
											[and]
												[variable]
													name=undead_unit.attack[1].name
													not_equals=bite
												[/variable]
											[/and]
										[/and]
									[/show_if]
									[command]
										[set_variables]
											name=undead_unit.attack
											mode=append
											[value]
												name=bite
												description=_"bite"
												image="attacks/fangs.png"
												type=blade
												range=melee
												damage="$($undead_unit.attack.damage+2)"
												number="$($undead_unit.attack.number-1)"
												[specials]
													{WEAPON_SPECIAL_DRAIN}
												[/specials]
											[/value]
										[/set_variables]
										{VARIABLE_OP undead_unit.undead_points_used add 3}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/fangs.png+"="+_ "Ability: feeding
+1 hitpoints, +1 max hitpoints when living target killed"="2"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Ghoul_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=2
											[/variable]
											[and]
												[variable]
													name=undead_unit.abilities.dummy.id
													not_equals=feeding_MODRPG
												[/variable]
											[/and]
										[/and]
									[/show_if]
									[command]
										[set_variables]
											name=undead_unit.abilities
											mode=append
											[value]
												[dummy]
													#it gave me some grief when I tried to add it to the unit normally
													id=feeding_MODRPG
													name= _ "feeding"
													female_name= _ "female^feeding"
													description=_ "Feeding:
This unit gains 1 hitpoint added to its maximum whenever it kills a living unit."
												[/dummy]
											[/value]
										[/set_variables]
										{VARIABLE_OP undead_unit.undead_points_used add 2}
									[/command]
								[/option]
								
								#skeleton upgrades
								[option]
									message ="&"+attacks/fist-skeletal.png+"="+_ "Ossify
Enters Skeleton upgrade tree, can use weapons"="4"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Walking Corpse_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=4
											[/variable]
											[and]
												[variable]
													name=undead_unit.corpse_type
													not_equals="wc"
												[/variable]
											[/and]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.undead_points_used add 4}
										{VARIABLE undead_unit.corpse_type "skel"}
										[set_variables]
											name=temp_undead_upgrade
											mode=replace
											[value]
												level=$undead_unit.level
												moves=$undead_unit.moves
												hitpoints=$undead_unit.hitpoints
												max_hitpoints=$undead_unit.max_hitpoints
												experience=$undead_unit.experience
												max_experience=$undead_unit.max_experience
												undead_points_used=$undead_unit.undead_points_used
												simple_action=$undead_unit.simple_action
												name=$undead_unit.name
												max_simple_action=$undead_unit.max_simple_action
												attacks_left=$undead_unit.attacks_left
												is_hench=$undead_unit.is_hench
												zoc=$undead_unit.zoc
												resting=$undead_unit.resting
												overlays=$undead_unit.overlays
											[/value]
										[/set_variables]
										[kill]
											x=$undead_unit.x
									        y=$undead_unit.y
											fire_event=no
										[/kill]
										{GENERIC_UNIT $undead_unit.side Skeleton_MODRPG $undead_unit.x $undead_unit.y}
										[store_unit]
											[filter]
									            x=$undead_unit.x
									            y=$undead_unit.y
									        [/filter]
											variable=undead_unit
										[/store_unit]			
										[set_variables]
											name=undead_unit
											mode=merge
											[value]
												level=$temp_undead_upgrade.level
												moves=$temp_undead_upgrade.moves
												hitpoints=$temp_undead_upgrade.hitpoints
												max_hitpoints=$temp_undead_upgrade.max_hitpoints
												experience=$temp_undead_upgrade.experience
												max_experience=$temp_undead_upgrade.max_experience
												undead_points_used=$temp_undead_upgrade.undead_points_used
												simple_action=$temp_undead_upgrade.simple_action
												name=$temp_undead_upgrade.name
												max_simple_action=$temp_undead_upgrade.max_simple_action
												attacks_left=$temp_undead_upgrade.attacks_left
												is_hench=$temp_undead_upgrade.is_hench
												zoc=$temp_undead_upgrade.zoc
												resting=$temp_undead_upgrade.resting
												overlays=$temp_undead_upgrade.overlays
												[atts]
													body=6
													deft=6
													mind=2
												[/atts]
											[/value]
										[/set_variables]
										[unstore_unit]
											variable=undead_unit
										[/unstore_unit]
										[store_unit]
											[filter]
									            x=$undead_unit.x
									            y=$undead_unit.y
									        [/filter]
											variable=npc_temp
										[/store_unit]
										{CREATE_SKELETON_FIST}
										[store_unit]
											[filter]
									            x=$npc_temp.x
									            y=$npc_temp.y
									        [/filter]
											variable=undead_unit
										[/store_unit]
									[/command]
								[/option]
								[option]
									message ="&"+attacks/fist-skeletal.png+"="+_ "Upgrade Body
Current Body: $undead_unit.atts.body"="1"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Skeleton_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=1
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.undead_points_used add 1}
										{VARIABLE_OP undead_unit.atts.body add 1}			
									[/command]
								[/option]
								[option]
									message ="&"+attacks/fist-skeletal.png+"="+_ "Upgrade Deft
Current Deft: $undead_unit.atts.deft"="1"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Skeleton_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=1
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.undead_points_used add 1}
										{VARIABLE_OP undead_unit.atts.deft add 1}			
									[/command]
								[/option]
								[option]
									message ="&"+attacks/fist-skeletal.png+"="+_ "Fortify
+6 hitpoints"="2"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Skeleton_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=2
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.hitpoints add 6}
										{VARIABLE_OP undead_unit.max_hitpoints add 6}
										{VARIABLE_OP undead_unit.stored_max_hitpoints add 6}
										{VARIABLE_OP undead_unit.undead_points_used add 2}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/fist-skeletal.png+"="+_ "Hasten
+1 movement point"="3"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Skeleton_MODRPG"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=3
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.moves add 1}
										{VARIABLE_OP undead_unit.max_moves add 1}
										{VARIABLE_OP undead_unit.moves_left add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 3}
									[/command]
								[/option]
								
								
								#spirit upgrades
								[option]
									message ="&"+attacks/touch-undead.png+"="+_ "Fortify
+3 hitpoints"="1"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=1
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.hitpoints add 3}
										{VARIABLE_OP undead_unit.max_hitpoints add 3}
										{VARIABLE_OP undead_unit.stored_max_hitpoints add 3}
										{VARIABLE_OP undead_unit.undead_points_used add 1}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/touch-undead.png+"="+_ "Hasten
+1 movement point"="2"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=2
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.moves add 1}
										{VARIABLE_OP undead_unit.max_moves add 1}
										{VARIABLE_OP undead_unit.moves_left add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 2}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/baneblade.png+"="+_ "Alter Attack: baneblade
+2 damage, +1 strike to melee attack 
disallows skirmisher, disallows wall pass, disallows claws"="4"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=4
											[/variable]
											[and]
												[variable]
													name=undead_unit.attack.name
													equals=touch
												[/variable]
												[and]
													[variable]
														name=has_skirm
														numerical_equals=0
													[/variable]
													[and]
														[variable]
															name=has_wallpass
															numerical_equals=0
														[/variable]
													[/and]
												[/and]
											[/and]
										[/and]
									[/show_if]
									[command]
										[set_variables]
											name=undead_unit.attack
											mode=merge
											[value]
												name=baneblade
												description=_"baneblade"
											[/value]
										[/set_variables]
										{VARIABLE_OP undead_unit.attack.damage add 2}
										{VARIABLE_OP undead_unit.attack.number add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 4}
										[set_variables]
											name=temp_undead_upgrade
											mode=replace
											[value]
												level=$undead_unit.level
												moves=$undead_unit.moves
												max_moves=$undead_unit.max_moves
												hitpoints=$undead_unit.hitpoints
												max_hitpoints=$undead_unit.max_hitpoints
												experience=$undead_unit.experience
												max_experience=$undead_unit.max_experience
												undead_points_used=$undead_unit.undead_points_used
											[/value]
										[/set_variables]
										[set_variables]
											name=temp_undead_upgrade.attack
											mode=replace
											to_variable=undead_unit.attack
										[/set_variables]
										[set_variables]
											name=temp_undead_upgrade.abilities
											mode=replace
											to_variable=undead_unit.abilities
										[/set_variables]
										[unstore_unit]
									        variable=undead_unit
									    [/unstore_unit]
									    [object]
									        id=appearance
									        name="appearance"
									        silent=yes
									        [filter]
									            x=$undead_unit.x
									            y=$undead_unit.y
									        [/filter]
									        [effect]
									            apply_to=variation
									            name=baneblade
									        [/effect]
									    [/object]
										[store_unit]
											[filter]
									            x=$undead_unit.x
									            y=$undead_unit.y
									        [/filter]
											variable=undead_unit
										[/store_unit]			
										[set_variables]
											name=undead_unit
											mode=merge
											[value]
												level=$temp_undead_upgrade.level
												moves=$temp_undead_upgrade.moves
												max_moves=$temp_undead_upgrade.max_moves
												hitpoints=$temp_undead_upgrade.hitpoints
												max_hitpoints=$temp_undead_upgrade.max_hitpoints
												experience=$temp_undead_upgrade.experience
												max_experience=$temp_undead_upgrade.max_experience
												undead_points_used=$temp_undead_upgrade.undead_points_used
											[/value]
										[/set_variables]
										[set_variables]
											name=undead_unit.attack
											mode=replace
											to_variable=temp_undead_upgrade.attack
										[/set_variables]
										[set_variables]
											name=undead_unit.abilities
											mode=replace
											to_variable=temp_undead_upgrade.abilities
										[/set_variables]		
									[/command]
								[/option]
								[option]
									message ="&"+attacks/claws-undead.png+"="+_ "Alter Attack: claws
+2 damage, blade type, allows nightstalk, allows backstab
disallows drain, disallows baneblade, disallows wall pass"="2"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=2
											[/variable]
											[and]
												[variable]
													name=undead_unit.attack.name
													equals=touch
												[/variable]
												[and]
													[variable]
														name=has_wallpass
														numerical_equals=0
													[/variable]
												[/and]
											[/and]
										[/and]
									[/show_if]
									[command]
										[set_variables]
											name=undead_unit.attack
											mode=merge
											[value]
												name=claws
												description=_"claws"
												type=blade
												icon=attacks/claws-undead.png
											[/value]
										[/set_variables]
										{CLEAR_VARIABLE undead_unit.attack.specials}
										{VARIABLE_OP undead_unit.attack.damage add 2}
										{VARIABLE_OP undead_unit.undead_points_used add 2}
										[set_variables]
											name=temp_undead_upgrade
											mode=replace
											[value]
												level=$undead_unit.level
												moves=$undead_unit.moves
												max_moves=$undead_unit.max_moves
												hitpoints=$undead_unit.hitpoints
												max_hitpoints=$undead_unit.max_hitpoints
												experience=$undead_unit.experience
												max_experience=$undead_unit.max_experience
												undead_points_used=$undead_unit.undead_points_used
											[/value]
										[/set_variables]
										[set_variables]
											name=temp_undead_upgrade.attack
											mode=replace
											to_variable=undead_unit.attack
										[/set_variables]
										[set_variables]
											name=temp_undead_upgrade.abilities
											mode=replace
											to_variable=undead_unit.abilities
										[/set_variables]
										[unstore_unit]
									        variable=undead_unit
									    [/unstore_unit]
									    [object]
									        id=appearance
									        name="appearance"
									        silent=yes
									        [filter]
									            x=$undead_unit.x
									            y=$undead_unit.y
									        [/filter]
									        [effect]
									            apply_to=variation
									            name=shadow
									        [/effect]
									    [/object]
										[store_unit]
											[filter]
									            x=$undead_unit.x
									            y=$undead_unit.y
									        [/filter]
											variable=undead_unit
										[/store_unit]			
										[set_variables]
											name=undead_unit
											mode=merge
											[value]
												level=$temp_undead_upgrade.level
												moves=$temp_undead_upgrade.moves
												max_moves=$temp_undead_upgrade.max_moves
												hitpoints=$temp_undead_upgrade.hitpoints
												max_hitpoints=$temp_undead_upgrade.max_hitpoints
												experience=$temp_undead_upgrade.experience
												max_experience=$temp_undead_upgrade.max_experience
												undead_points_used=$temp_undead_upgrade.undead_points_used
											[/value]
										[/set_variables]
										[set_variables]
											name=undead_unit.attack
											mode=replace
											to_variable=temp_undead_upgrade.attack
										[/set_variables]
										[set_variables]
											name=undead_unit.abilities
											mode=replace
											to_variable=temp_undead_upgrade.abilities
										[/set_variables]										
									[/command]
								[/option]
								[option]
									message ="&"+attacks/claws-undead.png+"="+_ "Upgrade Attack: backstab"="2"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=2
											[/variable]
											[and]
												[variable]
													name=undead_unit.attack.name
													equals=claws
												[/variable]
												[and]
													[variable]
														name=undead_unit.attack.specials.damage.id
														not_equals=backstab
													[/variable]
												[/and]
											[/and]
										[/and]
									[/show_if]
									[command]
										[set_variables]
											name=undead_unit.attack.specials
											mode=merge
											[value]
												{WEAPON_SPECIAL_BACKSTAB}
											[/value]
										[/set_variables]
										{VARIABLE_OP undead_unit.undead_points_used add 2}
									[/command]
								[/option]
								[option]
									message ="&"+upgrades/skirmisher.png+"="+_ "New Ability: skirmisher
allows wallpass
disallows baneblade"="2"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=2
											[/variable]
											[and]
												[variable]
													name=undead_unit.attack.name
													not_equals=baneblade
												[/variable]
												[and]
													[variable]
														name=has_skirm
														numerical_not_equals=1
													[/variable]
												[/and]
											[/and]
										[/and]
									[/show_if]
									[command]
										[set_variables]
											name=undead_unit.abilities
											mode=append
											[value]
												{ABILITY_SKIRMISHER}
											[/value]
										[/set_variables]
										{VARIABLE_OP undead_unit.undead_points_used add 2}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/claws-undead.png+"="+_ "New Ability: nightstalk"="2"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=2
											[/variable]
											[and]
												[variable]
													name=undead_unit.attack.name
													equals=claws
												[/variable]
												[and]
													[variable]
														name=has_stalk
														numerical_not_equals=1
													[/variable]
												[/and]
											[/and]
										[/and]
									[/show_if]
									[command]
										[set_variables]
											name=undead_unit.abilities
											mode=append
											[value]
												{ABILITY_NIGHTSTALK}
											[/value]
										[/set_variables]
										{VARIABLE_OP undead_unit.undead_points_used add 2}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/dark-missile.png+"="+_ "New Ability: wall pass
Allows this spirit to pass through solid matter
disallows claws, disallows baneblade"="3"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=3
											[/variable]
											[and]
												[variable]
													name=undead_unit.attack.name
													not_equals=claws
												[/variable]
												[and]
													[variable]
														name=undead_unit.attack.name
														not_equals=baneblade
													[/variable]
													[and]
														[variable]
															name=undead_unit.movement_costs.impassable
															greater_than=2
														[/variable]
														[and]
															[variable]
																name=has_skirm
																numerical_equals=1
															[/variable]
															[and]
																[variable]
																	name=has_wallpass
																	numerical_not_equals=1
																[/variable]
															[/and]
														[/and]
													[/and]
												[/and]
											[/and]
										[/and]
									[/show_if]
									[command]
										[set_variables]
											name=undead_unit.abilities.dummy
											mode=append
											[value]
												id=wallpass
												name="wall pass"
												description="Wall Pass:
This unit can pass through solid objects with a cost of 2 movement points."
											[/value]
										[/set_variables]
										{VARIABLE undead_unit.movement_costs.impassable 2}
										{VARIABLE_OP undead_unit.undead_points_used add 3}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/baneblade.png+"="+_ "Damage Upgrade: $undead_unit.attack.name|
+1 to damage"="1"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=1
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.attack.damage add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 1}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/baneblade.png+"="+_ "Strike Upgrade: $undead_unit.attack.name|
+1 to strikes"="3"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=3
											[/variable]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.attack.number add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 3}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/wail.png+"="+_ "New Attack: wail
2-3 ranged cold"="1"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=1
											[/variable]
											[and]
												[variable]
													name=undead_unit.attack[1].name
													not_equals=wail
												[/variable]
											[/and]
										[/and]
									[/show_if]
									[command]
										[set_variables]
											name=undead_unit.attack
											mode=append
											[value]
												name=wail
												description=_"wail"
												type=cold
												range=ranged
												damage=2
												number=3
											[/value]
										[/set_variables]
										{VARIABLE_OP undead_unit.undead_points_used add 1}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/wail.png+"="+_ "Damage Upgrade: wail
+1 to damage"="1"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=1
											[/variable]
											[and]
												[variable]
													name=undead_unit.attack[1].name
													equals=wail
												[/variable]
											[/and]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.attack[1].damage add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 1}
									[/command]
								[/option]
								[option]
									message ="&"+attacks/wail.png+"="+_ "Strike Upgrade: wail
+1 to strikes"="3"
									[show_if]
										[variable]
											name=undead_unit.type
											equals="Trapped Spirit"
										[/variable]
										[and]
											[variable]
												name=undead_points
												greater_than_equal_to=3
											[/variable]
											[and]
												[variable]
													name=undead_unit.attack[1].name
													equals=wail
												[/variable]
											[/and]
										[/and]
									[/show_if]
									[command]
										{VARIABLE_OP undead_unit.attack[1].number add 1}
										{VARIABLE_OP undead_unit.undead_points_used add 3}
									[/command]
								[/option]
							[/message]
						[/do]
					[/while]
				[/then]
				[else]
					{DEBUG_MSG "You are not a necromancer!!"}
				[/else]
			[/if]
        [/command]
    [/set_menu_item]
#enddef

#define INVENTORY_THUNDERSTICK_TINKER

    # eventually might want to help visualize the upgrades. also might want to construct unit so it shows on the side when you upgrade
    #		{VARIABLE new_damage $current_unit.variables.inventory.weapons.ranged[ID].damage}
    #		{VARIABLE new_half_damage $current_unit.variables.inventory.weapons.ranged[ID].damage}
    #		{VARIABLE new_number $current_unit.variables.inventory.weapons.ranged[ID].number}
    #		{VARIABLE_OP new_damage multiply 1.25}
    #		{VARIABLE_OP new_half_damage multiply .5}
    #		{VARIABLE_OP new_number multiply 2}
    {VARIABLE upgrading_2 1}
    [while]
        [variable]
            name=upgrading_2
            numerical_equals=1
        [/variable]
        [do]
            {CLEAR_VARIABLE thunderstick_insert}
            {FOREACH current_unit.variables.inventory.weapons.ranged i}
                [if]
                    [variable]
                        name=current_unit.variables.inventory.weapons.ranged[$i|].user_name
                        equals=thunderstick
                    [/variable]
                    [then]
                        [if]
                            [variable]
                                name=current_unit.variables.inventory.weapons.ranged[$i|].level
                                less_than=$current_unit.variables.abilities.thunderstick_tinker
                            [/variable]
                            [then]
                                [set_variables]
                                    name=thunderstick_insert
                                    mode=append
                                    [value]
                                        message="&"+attacks/$current_unit.variables.inventory.weapons.ranged[$i|].icon|.png+"="+_ "$current_unit.variables.inventory.weapons.ranged[$i|].description|
`Damage: $current_unit.variables.inventory.weapons.ranged[$i|].damage|, Shots: $current_unit.variables.inventory.weapons.ranged[$i|].number|, Level: $current_unit.variables.inventory.weapons.ranged[$i|].level|"
                                        [command]
                                        [/command]
                                    [/value]
                                [/set_variables]
                                [set_variables]
                                    name=thunderstick_insert
                                    mode=append
                                    [value]
                                        message="&" "="+_ "Add 25% to damage."
                                        [command]
                                            {VARIABLE_OP current_unit.variables.inventory.weapons.ranged[$i|].damage multiply 1.25}
                                            {VARIABLE_OP current_unit.variables.inventory.weapons.ranged[$i|].max_damage multiply 1.25}
                                            {VARIABLE_OP current_unit.variables.inventory.weapons.ranged[$i|].level add 1}
                                        [/command]
                                    [/value]
                                [/set_variables]
                                [set_variables]
                                    name=thunderstick_insert
                                    mode=append
                                    [value]
                                        message="&" "="+_ "Double the shots and halve the damage."
                                        [command]
											{VARIABLE temp_tstick_dam $current_unit.variables.inventory.weapons.ranged[$i|].damage}
											{VARIABLE_OP temp_tstick_dam multiply .5}
											[if]
												[variable]
													name=temp_tstick_dam
													less_than=10
												[/variable]
												[then]
													{DEBUG_MSG "You cannot decrease thunderstick damage below 10."}
												[/then]
												[else]
													{VARIABLE_OP current_unit.variables.inventory.weapons.ranged[$i|].number multiply 2}
													{VARIABLE_OP current_unit.variables.inventory.weapons.ranged[$i|].damage multiply .5}
													{VARIABLE_OP current_unit.variables.inventory.weapons.ranged[$i|].max_damage multiply .5}
													{VARIABLE_OP current_unit.variables.inventory.weapons.ranged[$i|].level add 1}
												[/else]
											[/if]
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/then]
                            [else]
                                [set_variables]
                                    name=thunderstick_insert
                                    mode=append
                                    [value]
                                        message=_ "&"+attacks/$current_unit.variables.inventory.weapons.ranged[$i|].icon|.png+"="+_ "#$current_unit.variables.inventory.weapons.ranged[$i|].description|
`#Damage: $current_unit.variables.inventory.weapons.ranged[$i|].damage|, Shots: $current_unit.variables.inventory.weapons.ranged[$i|].number|, Level: $current_unit.variables.inventory.weapons.ranged[$i|].level|
#Requires upgrade to tinker skill"
                                        [command]
                                        [/command]
                                    [/value]
                                [/set_variables]
                            [/else]
                        [/if]
                    [/then]
                [/if]
            {NEXT i}
            [message]
                speaker=narrator
                message= _ "You can improve thundersticks that are under level $current_unit.variables.abilities.thunderstick_tinker|. You may either add 25% to the damage or double the number of shots in combat but this cuts their damage in half.
You may not decrease the damage below 10."
                [option]
					message = _ "(Back)"

					[command]
						{VARIABLE upgrading_2 0}
					[/command]
				[/option]
                [insert_tag]
                    name=option
                    variable=thunderstick_insert
                [/insert_tag]
            [/message]
        [/do]
    [/while]
#enddef
