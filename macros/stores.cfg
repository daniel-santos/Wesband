#in game shops/stores

#define RED_COST PATH
{CLEAR_VARIABLE red_cost}
[if]
	[variable]
		name={PATH}
		greater_than=$current_unit.personal_gold
	[/variable]
	[then]
		{VARIABLE red_cost "<250,0,0>"}
	[/then]
[/if]
#enddef

#define CREATE_WEAPON_INSERT_TO_SHOP
    {RANDOM 0..3}
    [if]
        [variable]
            name=random
            numerical_equals=0
        [/variable]
        [then]
            {VARIABLE_OP new_weapon_rank rand 0..$dungeon_level.max}
        [/then]
        [else]
            {VARIABLE level_minus_3 $dungeon_level.max}
            {VARIABLE_OP level_minus_3 add  -3}
            [if]
                [variable]
                    name=level_minus_3
                    less_than=0
                [/variable]
                [then]
                    {VARIABLE level_minus_3 0}
                [/then]
            [/if]
            {VARIABLE_OP new_weapon_rank rand $level_minus_3..$dungeon_level.max}
        [/else]
    [/if]
    {RANDOM 0..2}
    {VARIABLE_OP new_weapon_rank add $random}
	{VARIABLE new_weapon_path "prob_overworld_shop_weapon"}
    {VARIABLE random_weapon_attribute 1}
    {VARIABLE random_weapon_type 1}
    [fire_event]
        name=create_weapon
    [/fire_event]

    [if]
        [variable]
            name=new_weapon.category
            equals=melee_weapon
        [/variable]
        [then]
            [set_variables]
                name=weapon_shop.weapons.melee
                mode=append
                [insert_tag]
                    name=value
                    variable=new_weapon
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
    [if]
        [variable]
            name=new_weapon.category
            equals=ranged_weapon
        [/variable]
        [then]
            [set_variables]
                name=weapon_shop.weapons.ranged
                mode=append
                [insert_tag]
                    name=value
                    variable=new_weapon
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
#enddef

#define CREATE_ARMOR_INSERT_TO_SHOP
    {RANDOM 0..3}
    [if]
        [variable]
            name=random
            numerical_equals=0
        [/variable]
        [then]
            {VARIABLE_OP new_armor_rank rand 0..$dungeon_level.max}
        [/then]
        [else]
            {VARIABLE level_minus_3 $dungeon_level.max}
            {VARIABLE_OP level_minus_3 add  -3}
            [if]
                [variable]
                    name=level_minus_3
                    less_than=0
                [/variable]
                [then]
                    {VARIABLE level_minus_3 0}
                [/then]
            [/if]
            {VARIABLE_OP new_armor_rank rand $level_minus_3..$dungeon_level.max}
        [/else]
    [/if]
    {RANDOM 0..2}
    {VARIABLE_OP new_armor_rank add $random}
	{VARIABLE new_armor_path "prob_overworld_shop_armor"}
    {VARIABLE random_armor_attribute 1}
    {VARIABLE random_armor_type 1}
    [fire_event]
        name=create_armor
    [/fire_event]
	
    [if]
        [variable]
            name=new_armor.category
            equals=torso_armor
        [/variable]
        [then]
            [set_variables]
                name=armor_shop.armor.torso
                mode=append
                [insert_tag]
                    name=value
                    variable=new_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
    [if]
        [variable]
            name=new_armor.category
            equals=legs_armor
        [/variable]
        [then]
            [set_variables]
                name=armor_shop.armor.legs
                mode=append
                [insert_tag]
                    name=value
                    variable=new_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
    [if]
        [variable]
            name=new_armor.category
            equals=head_armor
        [/variable]
        [then]
            [set_variables]
                name=armor_shop.armor.head
                mode=append
                [insert_tag]
                    name=value
                    variable=new_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
    [if]
        [variable]
            name=new_armor.category
            equals=shield
        [/variable]
        [then]
            [set_variables]
                name=armor_shop.armor.shield
                mode=append
                [insert_tag]
                    name=value
                    variable=new_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
#enddef

#define WESBAND_WEAPON_SHOP
    [set_menu_item]
        id=a_wesband_weapon_shop
		image=commands/button_village.png
        description=_ "Enter shop"
        [filter_location]
            x,y=$weapon_shop_loc_x,$weapon_shop_loc_y
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
		[show_if]
		[/show_if]
        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE in_shop 1}
            [while]
                [variable]
                    name=in_shop
                    greater_than=0
                [/variable]
                [do]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.personal_gold
					[/modify_side]
                    {CLEAR_VARIABLE shop_item_insert_melee}
                    {FOREACH weapon_shop.weapons.melee i}
                        {VARIABLE path "weapon_shop.weapons.melee[$i]"}
                        [fire_event]
                            name=weapon_modifiers
                        [/fire_event]
						{RED_COST "weapon_shop.weapons.melee[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_melee
                            mode=append
                            [value]
                                message="&"+attacks/$weapon_shop.weapons.melee[$i].icon|.png+"="+_ "$weapon_shop.weapons.melee[$i].description|
``Class: $weapon_shop.weapons.melee[$i].class_description|
`Base: ($weapon_shop.weapons.melee[$i].damage|-$weapon_shop.weapons.melee[$i].number|), Adjusted: ($display_damage|-$display_number|) $weapon_shop.weapons.melee[$i].type|
``$weapon_shop.weapons.melee[$i].special|"="$red_cost|$weapon_shop.weapons.melee[$i].absolute_value"	
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$weapon_shop.weapons.melee[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											{PROB_LIST_OP percent prob_overworld_store_weapon $weapon_shop.weapons.melee[$i].prob_name 110}
                                            {VARIABLE_OP current_unit.personal_gold add -$weapon_shop.weapons.melee[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.weapons.melee
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=weapon_shop.weapons.melee[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "weapon_shop.weapons.melee[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_melee.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_melee
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    {CLEAR_VARIABLE shop_item_insert_ranged}
                    {FOREACH weapon_shop.weapons.ranged i}
                        {VARIABLE path "weapon_shop.weapons.ranged[$i]"}
                        [fire_event]
                            name=weapon_modifiers
                        [/fire_event]
						{RED_COST "weapon_shop.weapons.ranged[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_ranged
                            mode=append
                            [value]
                                message="&"+attacks/$weapon_shop.weapons.ranged[$i].icon|.png+"="+_ "$weapon_shop.weapons.ranged[$i].description|
``Class: $weapon_shop.weapons.ranged[$i].class_description|								
`Base: ($weapon_shop.weapons.ranged[$i].damage|-$weapon_shop.weapons.ranged[$i].number|), Adjusted: ($display_damage|-$display_number|) $weapon_shop.weapons.ranged[$i].type|
``$weapon_shop.weapons.ranged[$i].special|"="$red_cost|$weapon_shop.weapons.ranged[$i].absolute_value"		
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$weapon_shop.weapons.ranged[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											{PROB_LIST_OP percent prob_overworld_store_weapon $weapon_shop.weapons.ranged[$i].prob_name 110}
                                            {VARIABLE_OP current_unit.personal_gold add -$weapon_shop.weapons.ranged[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.weapons.ranged
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=weapon_shop.weapons.ranged[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "weapon_shop.weapons.ranged[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_ranged.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_ranged
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    #{VARIABLE creation_gold $current_unit.personal_gold} want to be side gold to personal_golde
                    [message]
                        image=portraits/$shop_names.weapon3
						speaker=narrator
                        message= _ "Welcome to $shop_names.weapon|'s $shop_names.weapon2|. Be sure to check back later, as I frequently get new stock.

`You have $current_unit.personal_gold| gold to spend. Which item will you buy? "
                        [option]
                            message ="&"+check.png+"="+_ "End purchase."
                            [command]
                                [unstore_unit]
                                    variable=current_unit
                                [/unstore_unit]
                                [modify_side]
                                    side=$current_unit.side
                                    gold=$current_unit.personal_gold
                                [/modify_side]
                                {VARIABLE in_shop 0}
                            [/command]
                        [/option]
                        [option]
                            message ="&"+check.png+"="+_ "Sell to store."
                            [command]
                                {VARIABLE in_shop 2}
                                [while]
                                    [variable]
                                        name=in_shop
                                        greater_than=1
                                    [/variable]
                                    [do]
										[modify_side]
											side=$current_unit.side
											gold=$current_unit.personal_gold
										[/modify_side]
                                        {CLEAR_VARIABLE sell_item_insert}
                                        {FOREACH current_unit.variables.inventory.weapons.melee i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.inventory.weapons.equipped.id
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.inventory.weapons.equipped[1].id
                                                        numerical_equals=$i
                                                    [/variable]
                                                    [or]
                                                        [variable]
                                                            name=current_unit.variables.inventory.weapons.equipped[2].id
                                                            numerical_equals=$i
                                                        [/variable]
                                                        [or]
                                                            [variable]
                                                                name=current_unit.variables.inventory.weapons.melee[$i].undropable
                                                                numerical_equals=1
                                                            [/variable]
                                                        [/or]
                                                    [/or]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.weapons.melee[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .3}
                                                    {VARIABLE_OP temp_value round "floor"}
													{VARIABLE temp_i_$i| $i}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+attacks/$current_unit.variables.inventory.weapons.melee[$i].icon|.png+"="+_ "$current_unit.variables.inventory.weapons.melee[$i].description|
`Base: $current_unit.variables.inventory.weapons.melee[$i].damage|-$current_unit.variables.inventory.weapons.melee[$i].number| $current_unit.variables.inventory.weapons.melee[$i].type|
``$current_unit.variables.inventory.weapons.melee[$i].special|"="$temp_value"		
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=weapon_shop.weapons.melee
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.weapons.melee[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
																[clear_variable]
                                                                    name=current_unit.variables.inventory.weapons.melee[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.inventory.weapons.equipped.id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.inventory.weapons.equipped.id add -1}
                                                                    [/then]
                                                                [/if]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.inventory.weapons.equipped[1].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.inventory.weapons.equipped[1].id add -1}
                                                                    [/then]
                                                                [/if]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.inventory.weapons.equipped[2].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.inventory.weapons.equipped[2].id add -1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.variables.inventory.weapons.ranged i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.inventory.weapons.equipped[5].id
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.inventory.weapons.melee[$i].undropable
                                                        numerical_equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.weapons.ranged[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .3}
                                                    {VARIABLE_OP temp_value round "floor"}
													{VARIABLE temp_i_$i| $i}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+attacks/$current_unit.variables.inventory.weapons.ranged[$i].icon|.png+"="+_ "$current_unit.variables.inventory.weapons.ranged[$i].description|
`Base: $current_unit.variables.inventory.weapons.ranged[$i].damage|-$current_unit.variables.inventory.weapons.ranged[$i].number| $current_unit.variables.inventory.weapons.ranged[$i].type|
``$current_unit.variables.inventory.weapons.ranged[$i].special|"="$temp_value"		
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=weapon_shop.weapons.ranged
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.weapons.ranged[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.variables.inventory.weapons.ranged[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.inventory.weapons.equipped[5].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.inventory.weapons.equipped[5].id add -1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        [if]
                                            [variable]
                                                name=sell_item_insert.length
                                                less_than=1
                                            [/variable]
                                            [then]
                                                [message]
                                                    speaker=narrator
                                                    message=_ "You have no items to sell."
                                                    image=wesnoth-icon.png
													side_for=$current_unit.side
                                                [/message]
                                                {VARIABLE in_shop 1}
                                            [/then]
                                            [else]
                                                [message]
                                                    speaker=narrator
                                                    message= _ "Sell which item?"
                                                    [option]
                                                        message ="&"+check.png+"="+_ "End selling."
                                                        [command]
                                                            [modify_side]
                                                                side=$current_unit.side
                                                                gold=$current_unit.personal_gold
                                                            [/modify_side]
                                                            {VARIABLE in_shop 1}
                                                        [/command]
                                                    [/option]
                                                    [insert_tag]
                                                        name=option
                                                        variable=sell_item_insert
                                                    [/insert_tag]
                                                    image=wesnoth-icon.png
                                                [/message]
                                            [/else]
                                        [/if]
                                    [/do]
                                [/while]
                            [/command]
                        [/option]
                        {SHOP_DIVIDER_MELEE_WEAPONS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_melee
                        [/insert_tag]
                        {SHOP_DIVIDER_RANGED_WEAPONS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_ranged
                        [/insert_tag]
                    [/message]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define WESBAND_ARMOR_SHOP
    [set_menu_item]
        id=a_wesband_armor_shop
		image=commands/button_village.png
        description=_ "Enter shop"
        [filter_location]
            x,y=$armor_shop_loc_x,$armor_shop_loc_y
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
		[show_if]
		[/show_if]
        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE in_shop 1}
            [while]
                [variable]
                    name=in_shop
                    greater_than=0
                [/variable]
                [do]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.personal_gold
					[/modify_side]
                    {CLEAR_VARIABLE shop_item_insert_torso}
                    {FOREACH armor_shop.armor.torso i}
						{RED_COST "armor_shop.armor.torso[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_torso
                            mode=append
                            [value]
                                message ="&"+armor/$armor_shop.armor.torso[$i].icon|.png+"="+_ "$armor_shop.armor.torso[$i].description|
``$armor_shop.armor.torso[$i].resistance.arcane|% arcane, $armor_shop.armor.torso[$i].resistance.blade|% blade, $armor_shop.armor.torso[$i].resistance.fire|% fire, $armor_shop.armor.torso[$i].resistance.cold|% cold, $armor_shop.armor.torso[$i].resistance.impact|% impact, $armor_shop.armor.torso[$i].resistance.pierce|% pierce
``$armor_shop.armor.torso[$i].magic_adjust|% magic adj, $armor_shop.armor.torso[$i].evade_adjust| evade adj, -$armor_shop.armor.torso[$i].terrain.flat.defense|% def adj"="$red_cost|$armor_shop.armor.torso[$i].absolute_value"		
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$armor_shop.armor.torso[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											{PROB_LIST_OP percent prob_overworld_store_armor $armor_shop.armor.torso[$i].prob_name 110}
                                            {VARIABLE_OP current_unit.personal_gold add -$armor_shop.armor.torso[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.torso
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=armor_shop.armor.torso[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "armor_shop.armor.torso[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_torso.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_torso
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    {CLEAR_VARIABLE shop_item_insert_legs}
                    {FOREACH armor_shop.armor.legs i}
						{RED_COST "armor_shop.armor.legs[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_legs
                            mode=append
                            [value]
                                message ="&"+armor/$armor_shop.armor.legs[$i].icon|.png+"="+_ "$armor_shop.armor.legs[$i].description|
``$armor_shop.armor.legs[$i].resistance.arcane|% arcane, $armor_shop.armor.legs[$i].resistance.blade|% blade, $armor_shop.armor.legs[$i].resistance.fire|% fire, $armor_shop.armor.legs[$i].resistance.cold|% cold, $armor_shop.armor.legs[$i].resistance.impact|% impact, $armor_shop.armor.legs[$i].resistance.pierce|% pierce
``$armor_shop.armor.legs[$i].magic_adjust|% magic adj, $armor_shop.armor.legs[$i].evade_adjust| evade adj, -$armor_shop.armor.legs[$i].terrain.flat.defense|% def adj"="$red_cost|$armor_shop.armor.legs[$i].absolute_value"									
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$armor_shop.armor.legs[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											{PROB_LIST_OP percent prob_overworld_store_armor $armor_shop.armor.legs[$i].prob_name 110}
                                            {VARIABLE_OP current_unit.personal_gold add -$armor_shop.armor.legs[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.legs
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=armor_shop.armor.legs[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "armor_shop.armor.legs[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_legs.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_legs
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    {CLEAR_VARIABLE shop_item_insert_head}
                    {FOREACH armor_shop.armor.head i}
						{RED_COST "armor_shop.armor.head[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_head
                            mode=append
                            [value]
                                message ="&"+armor/$armor_shop.armor.head[$i].icon|.png+"="+_ "$armor_shop.armor.head[$i].description|
``$armor_shop.armor.head[$i].resistance.arcane|% arcane, $armor_shop.armor.head[$i].resistance.blade|% blade, $armor_shop.armor.head[$i].resistance.fire|% fire, $armor_shop.armor.head[$i].resistance.cold|% cold, $armor_shop.armor.head[$i].resistance.impact|% impact, $armor_shop.armor.head[$i].resistance.pierce|% pierce
``$armor_shop.armor.head[$i].evade_adjust| evade adj, $armor_shop.armor.head[$i].ranged_adjust|% ranged adj"="$red_cost|$armor_shop.armor.head[$i].absolute_value"									
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$armor_shop.armor.head[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											{PROB_LIST_OP percent prob_overworld_store_armor $armor_shop.armor.head[$i].prob_name 110}
                                            {VARIABLE_OP current_unit.personal_gold add -$armor_shop.armor.head[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.head
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=armor_shop.armor.head[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "armor_shop.armor.head[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_head.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_head
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    {CLEAR_VARIABLE shop_item_insert_shield}
                    {FOREACH armor_shop.armor.shield i}
						{RED_COST "armor_shop.armor.shield[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_shield
                            mode=append
                            [value]
                                message ="&"+armor/$armor_shop.armor.shield[$i].icon|.png+"="+_ "$armor_shop.armor.shield[$i].description|
``$armor_shop.armor.shield[$i].evade_adjust| evade adjust, $armor_shop.armor.shield[$i].terrain_recoup| terrain adjust, $armor_shop.armor.shield[$i].ranged_adjust|% ranged adj, $armor_shop.armor.shield[$i].magic_adjust|% magic adj
``$armor_shop.armor.shield[$i].special"="$red_cost|$armor_shop.armor.shield[$i].absolute_value"									
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$armor_shop.armor.shield[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											{PROB_LIST_OP percent prob_overworld_store_armor $armor_shop.armor.shield[$i].prob_name 110}
                                            {VARIABLE_OP current_unit.personal_gold add -$armor_shop.armor.shield[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.shield
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=armor_shop.armor.shield[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "armor_shop.armor.shield[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_shield.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_shield
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    #{VARIABLE creation_gold $current_unit.personal_gold} want to be side gold to personal_golde
                    [message]
                        image=portraits/$shop_names.armor3
						speaker=narrator
                        message= _ "Welcome to $shop_names.armor|'s $shop_names.armor2|. Be sure to check back later, as I frequently get new stock.

`You have $current_unit.personal_gold| gold to spend. Which item will you buy? "
                        [option]
                            message ="&"+check.png+"="+_ "End purchase."
                            [command]
                                [unstore_unit]
                                    variable=current_unit
                                [/unstore_unit]
                                [modify_side]
                                    side=$current_unit.side
                                    gold=$current_unit.personal_gold
                                [/modify_side]
                                {VARIABLE in_shop 0}
                            [/command]
                        [/option]
                        [option]
                            message ="&"+check.png+"="+_ "Sell to store."
                            [command]
                                {VARIABLE in_shop 2}
                                [while]
                                    [variable]
                                        name=in_shop
                                        greater_than=1
                                    [/variable]
                                    [do]
										[modify_side]
											side=$current_unit.side
											gold=$current_unit.personal_gold
										[/modify_side]
                                        {CLEAR_VARIABLE sell_item_insert}
                                        {FOREACH current_unit.variables.inventory.armor.torso i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.inventory.armor.equipped.id
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.inventory.armor.torso[$i].undropable
                                                        numerical_equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.armor.torso[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .3}
                                                    {VARIABLE_OP temp_value round "floor"}
													{VARIABLE temp_i_$i| $i}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+armor/$current_unit.variables.inventory.armor.torso[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.torso[$i].description|
``$current_unit.variables.inventory.armor.torso[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.torso[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.torso[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.torso[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.torso[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.torso[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.torso[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.torso[$i].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.torso[$i].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.torso[$i].terrain.flat.defense|% def adj"="$temp_value"	
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=armor_shop.armor.torso
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.armor.torso[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.variables.inventory.armor.torso[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.inventory.armor.equipped.id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.inventory.armor.equipped.id add -1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.variables.inventory.armor.head i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.inventory.armor.equipped[1].id
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.inventory.armor.head[$i].undropable
                                                        numerical_equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.armor.head[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .3}
                                                    {VARIABLE_OP temp_value round "floor"}
													{VARIABLE temp_i_$i| $i}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+armor/$current_unit.variables.inventory.armor.head[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.head[$i].description|
``$current_unit.variables.inventory.armor.head[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.head[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.head[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.head[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.head[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.head[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.head[$i].evade_adjust| evade adj, $current_unit.variables.inventory.armor.head[$i].ranged_adjust|% ranged adj"="$temp_value"
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=armor_shop.armor.head
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.armor.head[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.variables.inventory.armor.head[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.inventory.armor.equipped[1].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.inventory.armor.equipped[1].id add -1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.variables.inventory.armor.shield i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.inventory.armor.equipped[4].id
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.inventory.armor.shield[$i].undropable
                                                        numerical_equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.armor.shield[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .3}
                                                    {VARIABLE_OP temp_value round "floor"}
													{VARIABLE temp_i_$i| $i}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
															message ="&"+armor/$current_unit.variables.inventory.armor.shield[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.shield[$i].description|
``$current_unit.variables.inventory.armor.shield[$i].evade_adjust| evade adjust, $current_unit.variables.inventory.armor.shield[$i].terrain_recoup| terrain adjust, $current_unit.variables.inventory.armor.shield[$i].ranged_adjust|% ranged adj, $current_unit.variables.inventory.armor.shield[$i].magic_adjust|% magic adj
``$current_unit.variables.inventory.armor.shield[$i].special"="$temp_value"	
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=armor_shop.armor.shield
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.armor.shield[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.variables.inventory.armor.shield[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.inventory.armor.equipped[4].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.inventory.armor.equipped[4].id add -1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.variables.inventory.armor.legs i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.inventory.armor.equipped[3].id
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.inventory.armor.legs[$i].undropable
                                                        numerical_equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.armor.legs[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .3}
                                                    {VARIABLE_OP temp_value round "floor"}
													{VARIABLE temp_i_$i| $i}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+armor/$current_unit.variables.inventory.armor.legs[$i].icon|.png+"="+_ "$current_unit.variables.inventory.armor.legs[$i].description|
``$current_unit.variables.inventory.armor.legs[$i].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.legs[$i].resistance.blade|% blade, $current_unit.variables.inventory.armor.legs[$i].resistance.fire|% fire, $current_unit.variables.inventory.armor.legs[$i].resistance.cold|% cold, $current_unit.variables.inventory.armor.legs[$i].resistance.impact|% impact, $current_unit.variables.inventory.armor.legs[$i].resistance.pierce|% pierce
``$current_unit.variables.inventory.armor.legs[$i].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.legs[$i].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.legs[$i].terrain.flat.defense|% def adj"="$temp_value"				
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=armor_shop.armor.legs
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.armor.legs[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.variables.inventory.armor.legs[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.inventory.armor.equipped[3].id
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.inventory.armor.equipped[3].id add -1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        [if]
                                            [variable]
                                                name=sell_item_insert.length
                                                less_than=1
                                            [/variable]
                                            [then]
                                                [message]
                                                    speaker=narrator
                                                    message=_ "You have no items to sell."
                                                    image=wesnoth-icon.png
													side_for=$current_unit.side
                                                [/message]
                                                {VARIABLE in_shop 1}
                                            [/then]
                                            [else]
                                                [message]
                                                    speaker=narrator
                                                    message= _ "Sell which item?"
                                                    [option]
                                                        message ="&"+check.png+"="+_ "End selling."
                                                        [command]
                                                            [modify_side]
                                                                side=$current_unit.side
                                                                gold=$current_unit.personal_gold
                                                            [/modify_side]
                                                            {VARIABLE in_shop 1}
                                                        [/command]
                                                    [/option]
                                                    [insert_tag]
                                                        name=option
                                                        variable=sell_item_insert
                                                    [/insert_tag]
                                                    image=wesnoth-icon.png
                                                [/message]
                                            [/else]
                                        [/if]
                                    [/do]
                                [/while]
                            [/command]
                        [/option]
                        {SHOP_DIVIDER_TORSO_ARMOR}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_torso
                        [/insert_tag]
                        {SHOP_DIVIDER_LEG_ARMOR}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_legs
                        [/insert_tag]
                        {SHOP_DIVIDER_HEAD_ARMOR}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_head
                        [/insert_tag]
                        {SHOP_DIVIDER_SHIELDS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_shield
                        [/insert_tag]
                    [/message]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define WESBAND_MAGIC_SHOP
    [set_menu_item]
        id=a_wesband_magic_shop
		image=commands/button_village.png
        description=_ "Enter shop"
        [filter_location]
            x,y=$magic_shop_loc_x,$magic_shop_loc_y
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
		[show_if]
		[/show_if]
        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE in_shop 1}
            [while]
                [variable]
                    name=in_shop
                    greater_than=0
                [/variable]
                [do]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.personal_gold
					[/modify_side]
                    {CLEAR_VARIABLE shop_item_insert_potions}
                    {FOREACH magic_shop.potions i}
						{RED_COST "magic_shop.potions[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_potions
                            mode=append
                            [value]
                                message="&"+$magic_shop.potions[$i].icon|.png+"="+_ "$magic_shop.potions[$i].description|"="$red_cost|$magic_shop.potions[$i].absolute_value"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$magic_shop.potions[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											{PROB_LIST_OP percent prob_overworld_store_potion $magic_shop.potions[$i].prob_name 110}
                                            {VARIABLE_OP current_unit.personal_gold add -$magic_shop.potions[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.usables
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=magic_shop.potions[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "magic_shop.potions[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_potions.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_potions
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]
					
					{CLEAR_VARIABLE shop_item_insert_scrolls}
                    {FOREACH magic_shop.scrolls i}
						{RED_COST "magic_shop.scrolls[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_scrolls
                            mode=append
                            [value]
                                message="&"+$magic_shop.scrolls[$i].icon|.png+"="+_ "$magic_shop.scrolls[$i].description|"="$red_cost|$magic_shop.scrolls[$i].absolute_value"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$magic_shop.scrolls[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											{PROB_LIST_OP percent prob_overworld_store_scroll $magic_shop.scrolls[$i].prob_name 110}
                                            {VARIABLE_OP current_unit.personal_gold add -$magic_shop.scrolls[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.usables
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=magic_shop.scrolls[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "magic_shop.scrolls[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_scrolls.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_scrolls
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]
					
                    {CLEAR_VARIABLE shop_item_insert_tomes}
                    {FOREACH magic_shop.tomes i}
                        [set_variables]
                            name=shop_item_insert_tomes
                            mode=append
                            [value]
                                message="&"+$magic_shop.tomes[$i].icon|.png+"="+_ "$magic_shop.tomes[$i].description|"="$magic_shop.tomes[$i].absolute_value"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$magic_shop.tomes[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
                                            {VARIABLE_OP current_unit.personal_gold add -$magic_shop.tomes[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.usables
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=magic_shop.tomes[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "magic_shop.tomes[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_tomes.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_tomes
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    #{VARIABLE creation_gold $current_unit.personal_gold} want to be side gold to personal_golde
                    [message]
                        image=portraits/$shop_names.magic3
						speaker=narrator
                        message= _ "Welcome to $shop_names.magic|'s $shop_names.magic2|. Be sure to check back later, as I frequently get new stock.

`You have $current_unit.personal_gold| gold to spend. Which item will you buy? "
                        [option]
                            message ="&"+check.png+"="+_ "End purchase."
                            [command]
                                [unstore_unit]
                                    variable=current_unit
                                [/unstore_unit]
                                {CONSTRUCT_UNIT}
                                [modify_side]
                                    side=$current_unit.side
                                    gold=$current_unit.personal_gold
                                [/modify_side]
                                {VARIABLE in_shop 0}
                            [/command]
                        [/option]
						[option]
                            message ="&"+check.png+"="+_ "Sell to store."
                            [command]
                                {VARIABLE in_shop 2}
                                [while]
                                    [variable]
                                        name=in_shop
                                        greater_than=1
                                    [/variable]
                                    [do]
										[modify_side]
											side=$current_unit.side
											gold=$current_unit.personal_gold
										[/modify_side]
                                        {CLEAR_VARIABLE sell_item_insert}
                                        {FOREACH current_unit.variables.inventory.usables i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.inventory.usables[$i].user_name
                                                    numerical_equals=potion
                                                [/variable]
												[or]
													[variable]
	                                                    name=current_unit.variables.inventory.usables[$i].user_name
	                                                    numerical_equals=scroll
	                                                [/variable]
												[/or]
                                                [then]
													{VARIABLE temp_value $current_unit.variables.inventory.usables[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .3}
                                                    {VARIABLE_OP temp_value round "floor"}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+$current_unit.variables.inventory.usables[$i].icon|.png+"="+_ "$current_unit.variables.inventory.usables[$i].description|"="$temp_value"		
                                                            [command]
                                                                {VARIABLE_OP current_unit.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=magic_shop.$current_unit.variables.inventory.usables[$i].user_name|s.melee
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.usables[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
																[clear_variable]
                                                                    name=current_unit.variables.inventory.usables[$i]
                                                                [/clear_variable]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/then]
                                            [/if]
                                        {NEXT i}
                                        [if]
                                            [variable]
                                                name=sell_item_insert.length
                                                less_than=1
                                            [/variable]
                                            [then]
                                                [message]
                                                    speaker=narrator
                                                    message=_ "You have no items to sell."
                                                    image=wesnoth-icon.png
													side_for=$current_unit.side
                                                [/message]
                                                {VARIABLE in_shop 1}
                                            [/then]
                                            [else]
                                                [message]
                                                    speaker=narrator
                                                    message= _ "Sell which item?"
                                                    [option]
                                                        message ="&"+check.png+"="+_ "End selling."
                                                        [command]
                                                            [modify_side]
                                                                side=$current_unit.side
                                                                gold=$current_unit.personal_gold
                                                            [/modify_side]
                                                            {VARIABLE in_shop 1}
                                                        [/command]
                                                    [/option]
                                                    [insert_tag]
                                                        name=option
                                                        variable=sell_item_insert
                                                    [/insert_tag]
                                                    image=wesnoth-icon.png
                                                [/message]
                                            [/else]
                                        [/if]
                                    [/do]
                                [/while]
                            [/command]
                        [/option]
                        {SHOP_DIVIDER_POTIONS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_potions
                        [/insert_tag]
						{SHOP_DIVIDER_SCROLLS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_scrolls
                        [/insert_tag]
                        {SHOP_DIVIDER_TOMES}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_tomes
                        [/insert_tag]
                    [/message]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define WESBAND_TAVERN
    [set_menu_item]
        id=a_wesband_tavern
		image=commands/button_village.png
        description=_ "Enter tavern"
        [filter_location]
            x,y=$tavern_loc_x,$tavern_loc_y
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
		[show_if]
		[/show_if]
        [command]
			[store_unit]
	            [filter]
					side=1,2,3
	                canrecruit=yes
	            [/filter]
	            variable=hench_num_query
	        [/store_unit]
			[if]
				[variable]
					name=hench_num_query.length
					numerical_equals=1
				[/variable]
				[then]
					{VARIABLE max_hench 2}
				[/then]
				[else]
					{VARIABLE max_hench 1}
				[/else]
			[/if]
			{CLEAR_VARIABLE hench_num_query}
            [store_unit]
                variable=hench_query
                [filter]
                    side=$side_number
                    [not]
                        canrecruit=yes
                    [/not]
                    [filter_wml]
                        is_hench=1
                    [/filter_wml]
                [/filter]
            [/store_unit]
            {VARIABLE hench_number 0}
            {FOREACH hench_query i}
                {VARIABLE_OP hench_number add 1}
            {NEXT i}
            {CLEAR_VARIABLE hench_query}
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE in_shop 1}
            [while]
                [variable]
                    name=in_shop
                    greater_than=0
                [/variable]
                [do]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.personal_gold
					[/modify_side]
                    {CLEAR_VARIABLE tavern_insert}
                    {FOREACH tavern.hench i}
						{RED_COST "tavern.hench[$i].cost"}
                        [set_variables]
                            name=tavern_insert
                            mode=append
                            [value]
                                message="&"+$tavern.hench[$i].image|~TC($side_number,magenta)+"="+_ "$tavern.hench[$i].name|
Type: $tavern.hench[$i].language_name|
Traits:$tavern.hench[$i].modifications.trait.id|, $tavern.hench[$i].modifications.trait[1].id|"="$red_cost|$tavern.hench[$i].cost"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.personal_gold
                                            less_than=$tavern.hench[$i].cost
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to hire that person!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
                                            [if]
                                                [variable]
                                                    name=hench_number
                                                    greater_than_equal_to=$max_hench
                                                [/variable]
                                                [then]
                                                    [message]
                                                        speaker=narrator
                                                        message=_ "You already have the maximum amount of henchman! Release one to recruit another."
                                                        image=wesnoth-icon.png
                                                    [/message]
                                                    {VARIABLE in_shop 0}
                                                [/then]
                                                [else]
                                                    {VARIABLE_OP current_unit.personal_gold add -$tavern.hench[$i].cost}
                                                    {VARIABLE tavern.hench[$i].side $current_unit.side}
                                                    {VARIABLE tavern.hench[$i].is_hench 1}
													{VARIABLE tavern.hench[$i].overlays "misc/hero-icon.png"}
                                                    {VARIABLE tavern.hench[$i].upkeep 0}
                                                    [unstore_unit]
                                                        variable=tavern.hench[$i]
                                                        find_vacant=yes
                                                        x=$current_unit.x
                                                        y=$current_unit.y
                                                    [/unstore_unit]
                                                    [unstore_unit]
                                                        variable=current_unit
                                                    [/unstore_unit]
                                                    {VARIABLE in_shop 0}
                                                    {CLEAR_VARIABLE "tavern.hench[$i]"}
                                                [/else]
                                            [/if]
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
                    [message]
                        image=portraits/$shop_names.tavern3
						speaker=narrator
                        message= _ "In $shop_names.tavern|'s $shop_names.tavern2| you may hire $max_hench henchman at a time.
`Right-click to "Release Henchman"
`You have $current_unit.personal_gold| gold to spend. Who will you take with you?"
                        [option]
                            message ="&"+check.png+"="+_ "End purchase."
                            [command]
                                [unstore_unit]
                                    variable=current_unit
                                [/unstore_unit]
                                {CONSTRUCT_UNIT}
                                {VARIABLE in_shop 0}
                                [modify_side]
                                    side=$current_unit.side
                                    gold=$current_unit.personal_gold
                                [/modify_side]
                            [/command]
                        [/option]
                        [insert_tag]
                            name=option
                            variable=tavern_insert
                        [/insert_tag]
                    [/message]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.personal_gold
					[/modify_side]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#store utils

#define SHOP_DIVIDER_MELEE_WEAPONS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Weapons: Melee"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_RANGED_WEAPONS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Weapons: Ranged"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_TORSO_ARMOR
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Armour: Torso"=_ "``cost"
        [command]
        [/command]
    [/option]
	[option]
        message ="&"+armor/$current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id].icon|.png+"="+_ "@$current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id].description|
``@$current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id].resistance.blade|% blade, $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id].resistance.fire|% fire, $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id].resistance.cold|% cold, $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id].resistance.impact|% impact, $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id].resistance.pierce|% pierce
``@$current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.torso[$current_unit.variables.inventory.armor.equipped[0].id].terrain.flat.defense|% def adj"=_ "``@equipped"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_LEG_ARMOR
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Armour: Leg"=_ "``cost"
        [command]
        [/command]
    [/option]
	[option]
        message ="&"+armor/$current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id].icon|.png+"="+_ "@$current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id].description|
``@$current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id].resistance.blade|% blade, $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id].resistance.fire|% fire, $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id].resistance.cold|% cold, $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id].resistance.impact|% impact, $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id].resistance.pierce|% pierce
``@$current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id].magic_adjust|% magic adj, $current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id].evade_adjust| evade adj, -$current_unit.variables.inventory.armor.legs[$current_unit.variables.inventory.armor.equipped[3].id].terrain.flat.defense|% def adj"=_ "``@equipped"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_HEAD_ARMOR
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Armour: Head"=_ "``cost"
        [command]
        [/command]
    [/option]
	[option]
        message ="&"+armor/$current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id].icon|.png+"="+_ "@$current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id].description|
``@$current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id].resistance.arcane|% arcane, $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id].resistance.blade|% blade, $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id].resistance.fire|% fire, $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id].resistance.cold|% cold, $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id].resistance.impact|% impact, $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id].resistance.pierce|% pierce
``@$current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id].evade_adjust| evade adj, $current_unit.variables.inventory.armor.head[$current_unit.variables.inventory.armor.equipped[1].id].ranged_adjust|% ranged adj"=_ "``@equipped"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_SCROLLS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Scrolls"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_TOMES
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Tomes"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_WANDS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Wands"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_POTIONS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Potions"=_ "``cost"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_SHIELDS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Armour: Shields"=_ "``cost"
        [command]
        [/command]
    [/option]
	[option]
        message ="&"+armor/$current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id].icon|.png+"="+_ "@$current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id].description|
``@$current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id].evade_adjust| evade adjust, $current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id].terrain_recoup| terrain adjust, $current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id].ranged_adjust|% ranged adj, $current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id].magic_adjust|% magic adj
``@$current_unit.variables.inventory.armor.shield[$current_unit.variables.inventory.armor.equipped[4].id].special"=_ "``@equipped"
        [command]
        [/command]
    [/option]
#enddef

#define CREATE_POTION_INSERT_TO_SHOP
	{RANDOM 0..3}
    [if]
        [variable]
            name=random
            numerical_equals=0
        [/variable]
        [then]
            {VARIABLE_OP new_potion_rank rand 0..$dungeon_level.max}
        [/then]
        [else]
            {VARIABLE level_minus_3 $dungeon_level.max}
            {VARIABLE_OP level_minus_3 add  -3}
            [if]
                [variable]
                    name=level_minus_3
                    less_than=0
                [/variable]
                [then]
                    {VARIABLE level_minus_3 0}
                [/then]
            [/if]
            {VARIABLE_OP new_potion_rank rand $level_minus_3..$dungeon_level.max}
        [/else]
    [/if]
    {RANDOM 0..2}
    {VARIABLE_OP new_potion_rank add $random}
    {VARIABLE random_potion_type 1}
	{VARIABLE new_potion_path "prob_overworld_shop_potion"}
    [fire_event]
        name=create_potion
    [/fire_event]
    [set_variables]
        name=magic_shop.potions
        mode=append
        [insert_tag]
            name=value
            variable=new_potion
        [/insert_tag]
    [/set_variables]
#enddef

#define CREATE_SCROLL_INSERT_TO_SHOP
	{RANDOM 0..3}
    [if]
        [variable]
            name=random
            numerical_equals=0
        [/variable]
        [then]
            {VARIABLE_OP new_scroll_rank rand 0..$dungeon_level.max}
        [/then]
        [else]
            {VARIABLE level_minus_3 $dungeon_level.max}
            {VARIABLE_OP level_minus_3 add  -3}
            [if]
                [variable]
                    name=level_minus_3
                    less_than=0
                [/variable]
                [then]
                    {VARIABLE level_minus_3 0}
                [/then]
            [/if]
            {VARIABLE_OP new_scroll_rank rand $level_minus_3..$dungeon_level.max}
        [/else]
    [/if]
    {RANDOM 0..2}
    {VARIABLE_OP new_scroll_rank add $random}
    {VARIABLE random_scroll_type 1}
	{VARIABLE new_scroll_path "prob_overworld_shop_scroll"}
    [fire_event]
        name=create_scroll
    [/fire_event]
    [set_variables]
        name=magic_shop.scrolls
        mode=append
        [insert_tag]
            name=value
            variable=new_scroll
        [/insert_tag]
    [/set_variables]
#enddef

#define CREATE_TOME_INSERT_TO_SHOP
    [set_variables]
        name=a_tome
        mode=replace
        [value]
            user_name="tome"
            icon="icons/tome"
            description=_ "Tome: Teleport 2 hexes/casting power
Uses simple action"
            usable_self=1
            usable_other_adj=0
            usable_other_dis=0
            usable_adj=0
            usable_dis=0
            command="tome"
            uses=1
            #make book image random
            ground_icon="book1"
            category=usables
            absolute_value=0
            [spell]
                user_name="silver_teleport"
                icon="upgrades/silver_order"
                usable_self=0
                usable_other_adj=0
                usable_other_dis=0
                usable_adj=1
                usable_dis=1
                infinite=1
                command=silver_teleport
                description=_ "Teleport 2 hexes/casting power
Uses simple action"
            [/spell]
        [/value]
    [/set_variables]
    [set_variables]
        name=magic_shop.tomes
        mode=append
        [insert_tag]
            name=value
            variable=a_tome
        [/insert_tag]
    [/set_variables]
#enddef

#define CREATE_HENCH_INSERT_TO_TAVERN
    [if]
        [variable]
            name=dungeon_level.max
            less_than=2
        [/variable]
        [then]
            {VARIABLE_OP new_hench rand "Woodsman,Ruffian,Peasant,WBD_Brute,WBD_Civilian,WBD_Initiate,WBD_Nobleman,WBD_Elf,WBD_She_Elf"}
        [/then]
    [/if]
    [if]
        [variable]
            name=dungeon_level.max
            less_than=4
        [/variable]
        [not]
            [variable]
                name=dungeon_level.max
                less_than=2
            [/variable]
        [/not]
        [then]
            {VARIABLE_OP new_hench rand "Woodsman,Ruffian,Peasant,WBD_Brute,WBD_Civilian,WBD_Initiate,WBD_Nobleman,WBD_Elf,WBD_She_Elf,Dwarvish Fighter,Dwarvish Guardsman,Dwarvish Thunderer,WBD Dwarvish Ulfserker,Elvish Archer,Elvish Fighter,Elvish Shaman,Fencer,Heavy Infantryman,Mage,Bowman,Spearman,Footpad,Thug,Thief,Poacher,Sergeant"}
        [/then]
    [/if]
    [if]
        [variable]
            name=dungeon_level.max
            less_than=6
        [/variable]
        [not]
            [variable]
                name=dungeon_level.max
                less_than=4
            [/variable]
        [/not]
        [then]
            {VARIABLE_OP new_hench rand "Woodsman,Ruffian,Peasant,WBD_Brute,WBD_Civilian,WBD_Initiate,WBD_Nobleman,WBD_Elf,WBD_She_Elf,Dwarvish Fighter,Dwarvish Guardsman,Dwarvish Thunderer,WBD Dwarvish Ulfserker,Elvish Archer,Elvish Fighter,Elvish Shaman,Fencer,Heavy Infantryman,Mage,Bowman,Spearman,Footpad,Thug,Thief,Poacher,Sergeant,Dwarvish Steelclad,Dwarvish Stalwart,Dwarvish Thunderguard,WBD Dwarvish Berserker,Elvish Marksman,Elvish Ranger,Elvish Captain,Elvish Hero,Elvish Druid,Elvish Sorceress,Duelist,Shock Trooper,Red Mage,White Mage,Longbowman,Javelineer,Pikeman,Swordsman,Outlaw,Bandit,Lieutenant,Rogue,Trapper"}
        [/then]
    [/if]
    [if]
        [variable]
            name=dungeon_level.max
            greater_than_equal_to=6
        [/variable]
        [then]
            {VARIABLE_OP new_hench rand "Woodsman,Ruffian,Peasant,WBD_Brute,WBD_Civilian,WBD_Initiate,WBD_Nobleman,WBD_Elf,WBD_She_Elf,Dwarvish Fighter,Dwarvish Guardsman,Dwarvish Thunderer,WBD Dwarvish Ulfserker,Elvish Archer,Elvish Fighter,Elvish Shaman,Fencer,Heavy Infantryman,Mage,Bowman,Spearman,Footpad,Thug,Thief,Poacher,Sergeant,Dwarvish Steelclad,Dwarvish Stalwart,Dwarvish Thunderguard,WBD Dwarvish Berserker,Elvish Marksman,Elvish Ranger,Elvish Captain,Elvish Hero,Elvish Druid,Elvish Sorceress,Duelist,Shock Trooper,Red Mage,White Mage,Longbowman,Javelineer,Pikeman,Swordsman,Outlaw,Bandit,Lieutenant,Rogue,Trapper,Dwarvish Lord,Dwarvish Sentinel,Dwarvish Dragonguard,Elvish Sharpshooter,Elvish Avenger,Elvish Marshal,Elvish Champion,Elvish Shyde,Elvish Enchantress,Master at Arms,Iron Mauler,Arch Mage,Silver Mage,Mage of Light,Master Bowman,Halberdier,Royal Guard,Royal Warrior,Fugitive,Highwayman,General,Assassin,Huntsman,Ranger"}
        [/then]
    [/if]

    [unit]
        side=4
        type=$new_hench
        x=1
        y=1
        generate_name=yes
        random_traits=yes
        trandom_gender=yes
        generate_name=yes
    [/unit]
    [store_unit]
        variable=tavern.hench
        mode=append
        [filter]
            x,y=1,1
        [/filter]
        kill=yes
    [/store_unit]
#enddef
