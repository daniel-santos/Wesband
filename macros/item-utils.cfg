#define STANDARD_CONSUMABLE_USE UNIT
	{EXPEND_CONSUMABLE {UNIT}.variables.inventory.usables[$item_id]}
#enddef

#define POTION_HEALING_SETUP
	{VARIABLE healing_number $current_unit.variables.inventory.usables[$item_id].healing_number}
#enddef
#define POTION_HEALING_EFFECT
	{WITH_TARGETED_EVENT SIMPLE healing_display STANDARD_CONSUMABLE_USE DISPLAY_HEALING}
#enddef

#define POTION_PROTECTION_ARMOR_SETUP
	{VARIABLE protection_value $current_unit.variables.inventory.usables[$item_id].protection_value}
#enddef
#define POTION_PROTECTION_ARMOR_EFFECT
	{PROTECTION_ARMOR_MAGIC_EFFECT}
	{STANDARD_CONSUMABLE_USE current_unit}
#enddef

#define POTION_PROTECTION_POISON_SETUP
	{VARIABLE protection_value $current_unit.variables.inventory.usables[$item_id].protection_value}
#enddef
#define POTION_PROTECTION_POISON_EFFECT
	{PROTECTION_FROM_POISON_EFFECT}
	{STANDARD_CONSUMABLE_USE current_unit}
#enddef

#define POTION_PHOENIX_FIRE_SETUP
	{VARIABLE phoenix_amount $current_unit.variables.inventory.usables[$item_id].healing_number}
#enddef
#define POTION_PHOENIX_FIRE_EFFECT
	{PHOENIX_FIRE_EFFECT}
	{STANDARD_CONSUMABLE_USE current_unit}
#enddef

#define SCROLL_DETECT_GOLD_SETUP
	{VARIABLE detect_gold_radius $current_unit.variables.inventory.usables[$item_id].radius}
#enddef
#define SCROLL_DETECT_GOLD_EFFECT
	{DETECT_GOLD_EFFECT}
	{STANDARD_CONSUMABLE_USE current_unit}
#enddef

#define SCROLL_SUMMON_FIRE_ELEMENTAL_SETUP
	{VARIABLE max_summon_level $current_unit.variables.inventory.usables[$item_id].casting_level}
#enddef
#define SCROLL_SUMMON_FIRE_ELEMENTAL_EFFECT
	{SUMMON_ELEMENTAL_EFFECT FIRE}
	{STANDARD_CONSUMABLE_USE current_unit}
#enddef
#define SCROLL_SUMMON_AIR_ELEMENTAL_SETUP
	{VARIABLE max_summon_level $current_unit.variables.inventory.usables[$item_id].casting_level}
#enddef
#define SCROLL_SUMMON_AIR_ELEMENTAL_EFFECT
	{SUMMON_ELEMENTAL_EFFECT AIR}
	{STANDARD_CONSUMABLE_USE current_unit}
#enddef
#define SCROLL_SUMMON_WATER_ELEMENTAL_SETUP
	{VARIABLE max_summon_level $current_unit.variables.inventory.usables[$item_id].casting_level}
#enddef
#define SCROLL_SUMMON_WATER_ELEMENTAL_EFFECT
	{SUMMON_ELEMENTAL_EFFECT WATER}
	{STANDARD_CONSUMABLE_USE current_unit}
#enddef
#define SCROLL_SUMMON_EARTH_ELEMENTAL_SETUP
	{VARIABLE max_summon_level $current_unit.variables.inventory.usables[$item_id].casting_level}
#enddef
#define SCROLL_SUMMON_EARTH_ELEMENTAL_EFFECT
	{SUMMON_ELEMENTAL_EFFECT EARTH}
	{STANDARD_CONSUMABLE_USE current_unit}
#enddef

#define POTION_DETECT_UNITS_SETUP
	{VARIABLE detect_units_radius $current_unit.variables.inventory.usables[$item_id].radius}
#enddef
#define POTION_DETECT_UNITS_EFFECT
	{DETECT_UNITS_EFFECT}
	{STANDARD_CONSUMABLE_USE current_unit}
#enddef

#define POTION_IMPROVED_DETECT_UNITS_SETUP
	{VARIABLE improved_detect_units_radius $current_unit.variables.inventory.usables[$item_id].radius}
#enddef
#define POTION_IMPROVED_DETECT_UNITS_EFFECT
	{IMPROVED_DETECT_UNITS_EFFECT}
	{STANDARD_CONSUMABLE_USE current_unit}
#enddef

#define SCROLL_MAPPING_SETUP
	{VARIABLE mapping_radius $current_unit.variables.inventory.usables[$item_id].radius}
#enddef
#define SCROLL_MAPPING_EFFECT
	{MAPPING_EFFECT}
	{STANDARD_CONSUMABLE_USE current_unit}
#enddef

#item creation events 

#define EXPONENTIAL_VALUE MULTIPLY_1 MULTIPLY_2 ADD_1 ADD_2
	{VARIABLE exponent_value $temp_value}
	{VARIABLE_OP exponent_value multiply {MULTIPLY_1}}
	{VARIABLE_OP exponent_value add {ADD_1}}
	{VARIABLE_OP exponent_value multiply $temp_value}
	{VARIABLE_OP exponent_value multiply {MULTIPLY_2}}
	{VARIABLE_OP exponent_value add {ADD_2}}
	{VARIABLE temp_value $exponent_value}
	{VARIABLE_OP temp_value round 0}
#enddef

#define SUMMON_ELEMENTAL_SCROLL_CASE ELEMENT A_AN
	[case]
		value=summon_{ELEMENT}_elemental
		{VARIABLE temp_uses 1}
		{VARIABLE_OP new_scroll_rank multiply .25}
		{VARIABLE_OP new_scroll_rank round ceil}
		{VARIABLE temp_value $new_scroll_rank}
		{EXPONENTIAL_VALUE 3 1 10 20}
		{VARIABLE_OP new_scroll_rank add 1}
		[set_variables]
			name=new_scroll
			mode=replace
			[value]
				user_name="scroll"
				icon="categories/misc-scroll"
				description=_ "Scroll of Summon Elemental:
`Summons {A_AN} {ELEMENT} elemental. Casting level $new_scroll_rank|.
`Uses - $temp_uses|"
				usable_self=0
				usable_other_adj=0
				usable_other_dis=0
				usable_adj=1
				usable_dis=0
				command=scroll_summon_{ELEMENT}_elemental
				uses=$temp_uses
				casting_level=$new_scroll_rank
				ground_icon="scroll"
				category=usables
				action_use="complex action"
				absolute_value=$temp_value
			[/value]
		[/set_variables]
	[/case]
#enddef

#define FIND_ABSOLUTE_VALUE_ARMOR PATH
    #find the absolute value of the armor
    {VARIABLE {PATH}.absolute_value 0}
    {VARIABLE i ${PATH}.resistance.arcane}
    {VARIABLE_OP i add ${PATH}.resistance.blade}
    {VARIABLE_OP i add ${PATH}.resistance.fire}
    {VARIABLE_OP i add ${PATH}.resistance.cold}
    {VARIABLE_OP i add ${PATH}.resistance.impact}
    {VARIABLE_OP i add ${PATH}.resistance.pierce}
    {VARIABLE temp_value ${PATH}.magic_adjust}
    {VARIABLE_OP temp_value multiply .2}
    {VARIABLE_OP i add $temp_value}
    {VARIABLE temp_value ${PATH}.evade_adjust}
    {VARIABLE_OP temp_value multiply .6}
    {VARIABLE_OP i add $temp_value}
    {VARIABLE_OP i add -${PATH}.terrain.flat.defense}
    [while]
        [variable]
            name=i
            greater_than=0
        [/variable]
        [do]
            {VARIABLE_OP {PATH}.absolute_value add $i}
            {VARIABLE_OP i add -1}
        [/do]
    [/while]
    {VARIABLE_OP {PATH}.absolute_value multiply .1}
    {VARIABLE_OP {PATH}.absolute_value round 0}
#enddef

#define FIND_ABSOLUTE_VALUE_ARMOR_SHIELD PATH
    #find the absolute value of the armor
    {VARIABLE {PATH}.absolute_value 0}
    {VARIABLE i ${PATH}.terrain_recoup}
    {VARIABLE_OP i multiply 8}
    {VARIABLE temp_value ${PATH}.magic_adjust}
    {VARIABLE_OP temp_value multiply .2}
    {VARIABLE_OP i add $temp_value}
    {VARIABLE temp_value ${PATH}.evade_adjust}
    {VARIABLE_OP temp_value multiply 3}
    {VARIABLE_OP i add $temp_value}
    {VARIABLE temp_value ${PATH}.ranged_adjust}
    {VARIABLE_OP temp_value multiply .2}
    {VARIABLE_OP i add $temp_value}
    {VARIABLE {PATH}.absolute_value $i}
    {VARIABLE_OP "{PATH}.absolute_value" round 0}
#enddef

#define FIND_ABSOLUTE_VALUE PATH
    {VARIABLE i ${PATH}.damage}
    {VARIABLE_OP i multiply ${PATH}.number}
    {VARIABLE {PATH}.absolute_value 0}
    [while]
        [variable]
            name=i
            greater_than=0
        [/variable]
        [do]
            {VARIABLE temp_value $i}
            {VARIABLE_OP temp_value multiply 1.25}
            {VARIABLE_OP {PATH}.absolute_value add $temp_value}
            {VARIABLE_OP i add -1}
        [/do]
    [/while]
    [if]
        [variable]
            name={PATH}.category
            equals=ranged_weapon
        [/variable]
        [then]
            {VARIABLE_OP {PATH}.absolute_value multiply 1.25}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.human_magic_adjust
            greater_than=0
        [/variable]
        [then]
            {VARIABLE temp_magic_value ${PATH}.human_magic_adjust}
            {VARIABLE_OP temp_magic_value multiply 2}
            {VARIABLE_OP {PATH}.absolute_value add $temp_magic_value}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.dark_magic_adjust
            greater_than=0
        [/variable]
        [then]
            {VARIABLE temp_magic_value ${PATH}.dark_magic_adjust}
            {VARIABLE_OP temp_magic_value multiply 2}
            {VARIABLE_OP {PATH}.absolute_value add $temp_magic_value}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.faerie_magic_adjust
            greater_than=0
        [/variable]
        [then]
            {VARIABLE temp_magic_value ${PATH}.faerie_magic_adjust}
            {VARIABLE_OP temp_magic_value multiply 2}
            {VARIABLE_OP {PATH}.absolute_value add $temp_magic_value}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.runic_magic_adjust
            greater_than=0
        [/variable]
        [then]
            {VARIABLE temp_magic_value ${PATH}.runic_magic_adjust}
            {VARIABLE_OP temp_magic_value multiply 2}
            {VARIABLE_OP {PATH}.absolute_value add $temp_magic_value}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.spirit_magic_adjust
            greater_than=0
        [/variable]
        [then]
            {VARIABLE temp_magic_value ${PATH}.spirit_magic_adjust}
            {VARIABLE_OP temp_magic_value multiply 2}
            {VARIABLE_OP {PATH}.absolute_value add $temp_magic_value}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.absolute_value
            less_than=1
        [/variable]
        [then]
            {VARIABLE {PATH}.absolute_value 2}
        [/then]
    [/if]
    {VARIABLE_OP "{PATH}.absolute_value" round 0}
    #weapon attribute prereqs, shouldn't be here, but it works for now
    [if]
        [variable]
            name={PATH}.class
            equals="light_blade"
        [/variable]
        [or]
            [variable]
                name={PATH}.class
                equals="thrown_light_blade"
            [/variable]
        [/or]
        [then]
            {VARIABLE {PATH}.prereq.deft ${PATH}.damage}
        [/then]
        [else]
            [if]
                [variable]
                    name={PATH}.class
                    equals="crossbow"
                [/variable]
                [or]
                    [variable]
                        name={PATH}.class
                        equals="none"
                    [/variable]
                [/or]
                [then]
                [/then]
				[else]
					{VARIABLE {PATH}.prereq.body ${PATH}.damage}
				[/else]
            [/if]
            [if]
                [variable]
                    name={PATH}.class
                    equals="lob"
                [/variable]
                [or]
                    [variable]
                        name={PATH}.class
                        equals="thrown_heavy_blade"
                    [/variable]
                [/or]
                [then]
                    {VARIABLE {PATH}.prereq.body "$(${PATH}.damage*1.5)"}
                [/then]
            [/if]
			[if]
				[variable]
					name={PATH}.class
					equals="polearm"
				[/variable]
				[then]
                    {VARIABLE_OP {PATH}.prereq.body multiply 7}
					{VARIABLE_OP {PATH}.prereq.body divide 10}
					{VARIABLE {PATH}.prereq.deft ${PATH}.prereq.body}
                [/then]
			[/if]
        [/else]
    [/if]
    [if]
        [variable]
            name={PATH}.special_type.throwable
            greater_than=0
        [/variable]
        [then]
            {VARIABLE {PATH}.thrown.prereq.body ${PATH}.thrown.damage}
        [/then]
    [/if]
#enddef

#define ARMOR_SPECIAL_DISPLAY PATH
    {CLEAR_VARIABLE {PATH}.special}
    {CLEAR_VARIABLE temp_special_display}
    [if]
        [variable]
            name={PATH}.block_wield
            numerical_equals=1
        [/variable]
        [then]
            {VARIABLE temp_special_display "disallows triple wield"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.block_wield
            numerical_equals=2
        [/variable]
        [then]
            {VARIABLE temp_special_display "disallows dual wield"}
        [/then]
    [/if]
    {VARIABLE {PATH}.special "$temp_special_display"}
    [if]
        [variable]
            name={PATH}.block_ranged
            numerical_equals=1
        [/variable]
        [then]
            {VARIABLE temp_special_display ", disallows ranged weapon"}
            {VARIABLE {PATH}.special "${PATH}.special|$temp_special_display"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.special_type.steadfast
            numerical_equals=1
        [/variable]
        [then]
            {VARIABLE temp_special_display ", allows steadfast"}
            {VARIABLE {PATH}.special "${PATH}.special|$temp_special_display"}
        [/then]
    [/if]
#enddef

#define CREATE_ADJUST_DEFENSE VAR VALUE
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "unwalkable" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "castle" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "village" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "shallow_water" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "deep_water" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "flat" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "forest" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "hills" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "mountains" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "swamp_water" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "sand" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "cave" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "impassable" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "frozen" "{VALUE}"}
    {CREATE_ADJUST_DEFENSE_ONE "{VAR}" "fungus" "{VALUE}"}
#enddef

#define CREATE_ADJUST_DEFENSE_ONE VAR TERRAIN VALUE
    [if]
        [variable]
            name={VAR}.terrain.{TERRAIN}.defense
            greater_than=0
        [/variable]
        [then]
            {VARIABLE_OP {VAR}.terrain.{TERRAIN}.defense multiply {VALUE}}
        [/then]
    [/if]
	{VARIABLE_OP "{VAR}.terrain.{TERRAIN}.defense" round 0}
#enddef

#define CREATE_ADJUST_RESISTANCE VAR VALUE 
    {CREATE_ADJUST_RESISTANCE_ONE "{VAR}" "arcane" "{VALUE}"}
    {CREATE_ADJUST_RESISTANCE_ONE "{VAR}" "blade" "{VALUE}"}
    {CREATE_ADJUST_RESISTANCE_ONE "{VAR}" "pierce" "{VALUE}"}
    {CREATE_ADJUST_RESISTANCE_ONE "{VAR}" "impact" "{VALUE}"}
    {CREATE_ADJUST_RESISTANCE_ONE "{VAR}" "fire" "{VALUE}"}
    {CREATE_ADJUST_RESISTANCE_ONE "{VAR}" "cold" "{VALUE}"}
#enddef

#define CREATE_ADJUST_RESISTANCE_ONE VAR TYPE VALUE
    [if]
        [variable]
            name={VAR}.resistance.{TYPE}
            greater_than=0
        [/variable]
        [then]
            {VARIABLE_OP {VAR}.resistance.{TYPE} multiply {VALUE}}
        [/then]
    [/if]
    {VARIABLE_OP "{VAR}.resistance.{TYPE}" round 0}
#enddef

#define APPLY_WEAPON_SPECIAL_DESCRIPTION PATH
    #add special description
    {CLEAR_VARIABLE weapon_special_abstract}
    {VARIABLE altered 0}
	{CLEAR_VARIABLE {PATH}.special}

	[if]
        [variable]
            name={PATH}.name
            equals="thunderstick"
        [/variable]
        [then]
            {VARIABLE weapon_special_abstract ${PATH}.special}
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|requires thunderstick tinker for upkeep and upgrade"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.special_type.throwable
            numerical_equals=1
        [/variable]
        [then]
            {VARIABLE weapon_special_abstract ${PATH}.special}
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|throwable"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.special_type.skirm
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows skirmisher"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.special_type.firststrike
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows firststrike"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.special_type.allow_poison
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows poisoning"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.special_type.marksman
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows marksman"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.special_type.backstab
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows backstab"}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.special_type.fire_shot_bow
            numerical_equals=1
        [/variable]
		[or]
			[variable]
				name={PATH}.special_type.fire_shot_xbow
				numerical_equals=1
			[/variable]
		[/or]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows fire shot"}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.special_type.goliath_bane
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows goliath bane"}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.special_type.remaining_ammo_thrown_heavy_blade
            numerical_equals=1
        [/variable]
		[or]
			[variable]
				name={PATH}.special_type.remaining_ammo_thrown_light_blade
				numerical_equals=1
			[/variable]
		[/or]
		[or]
			[variable]
				name={PATH}.special_type.remaining_ammo_javelin
				numerical_equals=1
			[/variable]
		[/or]
		[or]
			[variable]
				name={PATH}.special_type.remaining_ammo_bow
				numerical_equals=1
			[/variable]
		[/or]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows remaining ammo"}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.special_type.readied_bolt
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows readied bolt"}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.special_type.ensnare
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows ensnare"}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.special_type.slashdash
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows slash&dash"}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.special_type.riposte
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows riposte"}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.special_type.storm
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows storm"}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.special_type.cleave
            numerical_equals=1
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|allows cleave"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.human_magic_adjust
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|${PATH}.human_magic_adjust|% to human magic"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.dark_magic_adjust
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|${PATH}.dark_magic_adjust|% to dark magic"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.faerie_magic_adjust
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|${PATH}.faerie_magic_adjust|% to faerie magic"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.runic_magic_adjust
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|${PATH}.runic_magic_adjust|% to runic magic"}
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.spirit_magic_adjust
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
            {VARIABLE {PATH}.special "$weapon_special_abstract|${PATH}.spirit_magic_adjust|% to spirit magic"}
        [/then]
    [/if]
	#new line
	[if]
		[variable]
			name=altered
			numerical_equals=1
		[/variable]
		[then]
			{VARIABLE altered 0}
			{VARIABLE weapon_special_abstract "${PATH}.special|
``"}
		[/then]
		[else]
			{VARIABLE weapon_special_abstract ${PATH}.special}
		[/else]
	[/if]
	{VARIABLE altered_rate 0}
    [if]
        [variable]
            name={PATH}.body_damage_rate
            greater_than=0
        [/variable]
        [then]            
            {VARIABLE altered 1}
            {VARIABLE {PATH}.special "$weapon_special_abstract|Damage: ${PATH}.body_damage_rate|% body"}
			{VARIABLE altered_rate 1}
        [/then]
		[else]
			{VARIABLE {PATH}.special "$weapon_special_abstract|"}
		[/else]
    [/if]
    [if]
        [variable]
            name={PATH}.deft_damage_rate
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
					{VARIABLE altered 1}
                [/else]
            [/if]
			[if]
                [variable]
                    name=altered_rate
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE {PATH}.special "$weapon_special_abstract|${PATH}.deft_damage_rate|% deft"}
                [/then]
                [else]
                    {VARIABLE {PATH}.special "$weapon_special_abstract|Damage: ${PATH}.deft_damage_rate|% deft"}
					{VARIABLE altered_rate 1}
                [/else]
            [/if]            
        [/then]
    [/if]
	[if]
        [variable]
            name={PATH}.mind_damage_rate
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
                [/else]
            [/if]
            {VARIABLE altered 1}
			[if]
                [variable]
                    name=altered_rate
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE {PATH}.special "$weapon_special_abstract|${PATH}.mind_damage_rate|% mind"}
                [/then]
                [else]
                    {VARIABLE {PATH}.special "$weapon_special_abstract|Damage: ${PATH}.mind_damage_rate|% mind"}
                [/else]
            [/if]     
        [/then]
    [/if]
	{VARIABLE altered_rate 0}
	[if]
        [variable]
            name={PATH}.body_number_rate
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
                [/else]
            [/if]
            {VARIABLE altered 1}
            {VARIABLE {PATH}.special "$weapon_special_abstract|Strikes: ${PATH}.body_number_rate|% body"}
			{VARIABLE altered_rate 1}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.deft_number_rate
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
                [/else]
            [/if]
            {VARIABLE altered 1}
			[if]
                [variable]
                    name=altered_rate
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE {PATH}.special "$weapon_special_abstract|${PATH}.deft_number_rate|% deft"}
                [/then]
                [else]
                    {VARIABLE {PATH}.special "$weapon_special_abstract|Strikes: ${PATH}.deft_number_rate|% deft"}
                [/else]
            [/if]
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.mind_number_rate
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
                [/else]
            [/if]
            {VARIABLE altered 1}
			[if]
                [variable]
                    name=altered_rate
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE {PATH}.special "$weapon_special_abstract|${PATH}.mind_number_rate|% mind"}
                [/then]
                [else]
                    {VARIABLE {PATH}.special "$weapon_special_abstract|Strikes: ${PATH}.mind_number_rate|% mind"}
                [/else]
            [/if]
        [/then]
    [/if]
	[if]
		[variable]
			name={PATH}.class
			equals=polearm
		[/variable]
		[then]
			{VARIABLE altered 0}
			{VARIABLE {PATH}.special "${PATH}.special|
``"}
		[/then]
	[/if]
    [if]
        [variable]
            name={PATH}.prereq.body
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
                [/else]
            [/if]
            {VARIABLE altered 1}
            {VARIABLE {PATH}.special "$weapon_special_abstract|requires ${PATH}.prereq.body body"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.prereq.deft
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
                [/else]
            [/if]
            {VARIABLE altered 1}
            {VARIABLE {PATH}.special "$weapon_special_abstract|requires ${PATH}.prereq.deft deft"}
        [/then]
    [/if]
    [if]
        [variable]
            name={PATH}.prereq.mind
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=altered
                    numerical_equals=1
                [/variable]
                [then]
                    {VARIABLE weapon_special_abstract "${PATH}.special|, "}
                [/then]
                [else]
                    {VARIABLE weapon_special_abstract ${PATH}.special}
                [/else]
            [/if]
            {VARIABLE altered 1}
            {VARIABLE {PATH}.special "$weapon_special_abstract|requires ${PATH}.prereq.mind mind"}
        [/then]
    [/if]
#enddef

#item dropping macros
#define DROP_ITEM PATH X Y
	[item]
		x=${X}
		y=${Y}
		image=items/${PATH}.ground_icon|.png
		visible_in_fog=no
	[/item]
	[set_variables]
		name=ground_${X}|_${Y}|.items
		mode=append
		[insert_tag]
			name=literal
			variable={PATH}
		[/insert_tag]
	[/set_variables]
#enddef

#define DROP_UNWANTED
	[if]
        [variable]
            name=will_carry
            numerical_equals=0
        [/variable]
		[and]
			[variable]
				name=$path|.undropable
				numerical_not_equals=1
			[/variable]
		[/and]
        [then]
			{DROP_ITEM $path| unit.x unit.y}
        [/then]
    [/if]
#enddef

#define DROP_CATEGORY CATEGORY
	[if]
		[variable]
			name=unit.variables.inventory.{CATEGORY}.length
			greater_than=0
		[/variable]
		[then]
			{FOREACH unit.variables.inventory.{CATEGORY} o}
		        [if]
		            [variable]
		                name=unit.variables.inventory.{CATEGORY}[$o].undropable
		                numerical_not_equals=1
		            [/variable]
		            [then]
						[if]
							[variable]
								name=unit.variables.inventory.{CATEGORY}.absolute_value
								greater_than=0
							[/variable]
							[then]
								{DROP_ITEM unit.variables.inventory.{CATEGORY}[$o] x1 y1}
							[/then]
						[/if]
		            [/then]
				[/if]
			{NEXT o}
		[/then]
	[/if]
#enddef

#define DROP_GOLD PATH X Y
	[if]
		[variable]
			name={PATH}
			greater_than=0
		[/variable]
		[then]
			{VARIABLE ground_gold_temp ${PATH}}
			[if]
				[variable]
					name=ground_{X}_{Y}.items.length
					greater_than=0
				[/variable]
				[then]
					{FOREACH_COLLAPSE ground_{X}_{Y}.items g}
						[if]
							[variable]
								name=ground_{X}_{Y}.items[$g].category
								equals="gold"
							[/variable]
							[then]
								{VARIABLE_OP ground_gold_temp add $ground_{X}_{Y}.items[$g].amount}
								[removeitem]
									x={X}
	                                y={Y}
									image=items/$ground_{X}_{Y}.items[$g].ground_icon|.png
								[/removeitem]
								{CLEAR_VARIABLE "ground_{X}_{Y}.items[$g]"}
								{VARIABLE ground_changed 1}
							[/then]
						[/if]
					{NEXT_COLLAPSE g}
				[/then]
			[/if]
			[if]
                [variable]
                    name=ground_changed
                    numerical_equals=1
                [/variable]
                [then]
                    [if]
                        [variable]
                            name="ground_{X}_{Y}.items.length"
                            greater_than=0
                        [/variable]
                        [then]
                            {FOREACH ground_{X}_{Y}.items g}
	                            [item]
	                                x={X}
	                                y={Y}
	                                image=items/$ground_{X}_{Y}.items[$g].ground_icon|.png
									visible_in_fog=no
	                            [/item]
                            {NEXT g}
                        [/then]
                    [/if]
                    {VARIABLE ground_changed 0}
                [/then]
            [/if]
			[if]
				[variable]
					name=ground_gold_temp
					less_than=26
				[/variable]
				[then]
					{VARIABLE gold_image small}
				[/then]
				[else]
					[if]
						[variable]
							name=ground_gold_temp
							less_than=76
						[/variable]
						[then]
							{VARIABLE gold_image medium}
						[/then]
						[else]
							{VARIABLE gold_image large}
						[/else]
					[/if]
				[/else]
			[/if]
			[item]
				x={X}
				y={Y}
				image=items/gold-coins-$gold_image|.png
				visible_in_fog=no
			[/item]
			[set_variables]
				name=ground_{X}_{Y}.items
				mode=append
				[value]
					category="gold"
					amount=$ground_gold_temp
					description="$ground_gold_temp| gold"
					icon=icons/gold-$gold_image|
					ground_icon=gold-coins-$gold_image|
				[/value]
			[/set_variables]
			{CLEAR_VARIABLE gold_image,ground_gold_temp}
		[/then]
	[/if]
#enddef

#define DROP_INVENTORY
	{DROP_GOLD unit.personal_gold $x1| $y1|}
	[if]
		[variable]
			name=unit.variables.inventory.length
			greater_than=0
		[/variable]
		[then]
		    {DROP_CATEGORY weapons.melee}
			{DROP_CATEGORY weapons.ranged}
			{DROP_CATEGORY armor.torso}
			{DROP_CATEGORY armor.head}
			{DROP_CATEGORY armor.legs}
			{DROP_CATEGORY armor.shield}
			{DROP_CATEGORY usables}
		[/then]
	[/if]
#enddef